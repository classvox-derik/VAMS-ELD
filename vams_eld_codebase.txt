import { NextResponse, type NextRequest } from "next/server";
import { createClient } from "@/lib/supabase-middleware";

// Routes that don't require authentication
const PUBLIC_ROUTES = [
  "/sign-in",
  "/sign-up",
  "/auth/callback",
  "/api/validate-email",
  "/api/webhooks",
  "/api/google-auth",
];

// Only @brightstarschools.org emails can access the app
const ALLOWED_DOMAIN =
  process.env.ALLOWED_EMAIL_DOMAIN ?? "@brightstarschools.org";

function isPublicRoute(pathname: string): boolean {
  return PUBLIC_ROUTES.some((route) => pathname.startsWith(route));
}

export async function middleware(request: NextRequest) {
  const { supabase, response } = createClient(request);
  const { pathname } = request.nextUrl;

  // Refresh session (keeps cookies alive)
  const {
    data: { user },
  } = await supabase.auth.getUser();

  // Allow public routes through
  if (isPublicRoute(pathname)) {
    // If user is already logged in and visits sign-in/sign-up, redirect to dashboard
    if (user && (pathname.startsWith("/sign-in") || pathname.startsWith("/sign-up"))) {
      const dashboardUrl = new URL("/dashboard", request.url);
      return NextResponse.redirect(dashboardUrl);
    }
    return response;
  }

  // Protected route â€” require authentication
  if (!user) {
    const signInUrl = new URL("/sign-in", request.url);
    signInUrl.searchParams.set("redirect", pathname);
    return NextResponse.redirect(signInUrl);
  }

  // Server-side email domain enforcement:
  // If a user somehow signed up with a non-Bright Star email, block access.
  const email = user.email?.toLowerCase() ?? "";
  if (email && !email.endsWith(ALLOWED_DOMAIN)) {
    // Sign them out and redirect
    await supabase.auth.signOut();
    const signInUrl = new URL("/sign-in", request.url);
    signInUrl.searchParams.set("error", "unauthorized_domain");
    return NextResponse.redirect(signInUrl);
  }

  return response;
}

export const config = {
  matcher: [
    "/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
    "/(api|trpc)(.*)",
  ],
};
"use client";

import { useEffect } from "react";
import { Button } from "@/components/ui/button";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error("Global error:", error);
  }, [error]);

  return (
    <div className="flex min-h-screen flex-col items-center justify-center gap-4 p-4">
      <div className="text-center">
        <h1 className="text-title-lg font-bold text-foreground">
          Something went wrong
        </h1>
        <p className="mt-2 text-muted-foreground">
          An unexpected error occurred. Please try again.
        </p>
        {error.digest && (
          <p className="mt-1 text-xs text-muted-foreground">
            Error ID: {error.digest}
          </p>
        )}
      </div>
      <Button onClick={reset} variant="default">
        Try again
      </Button>
    </div>
  );
}
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    /* Light Mode - ELD Brand Palette
       Page bg:  #f2e9e4  Sidebar: #4a4e69  Text: #22223b
       Hover:    #c9ada7  Header:  #4a4e69
    */
    --background: 22 35% 92%;
    --foreground: 240 27% 18%;
    --card: 0 0% 100%;
    --card-foreground: 240 27% 18%;
    --popover: 0 0% 100%;
    --popover-foreground: 240 27% 18%;
    --primary: 240 27% 18%;
    --primary-foreground: 0 0% 100%;
    --secondary: 11 24% 72%;
    --secondary-foreground: 240 27% 18%;
    --accent: 11 24% 72%;
    --accent-foreground: 240 27% 18%;
    --muted: 22 20% 88%;
    --muted-foreground: 232 17% 35%;
    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 100%;
    --border: 11 18% 84%;
    --input: 11 15% 78%;
    --ring: 240 27% 18%;
    --radius: 0.5rem;
  }

  .dark {
    /* Dark Mode - TailAdmin dark with ELD brand */
    --background: 222 47% 11%;
    --foreground: 210 40% 98%;
    --card: 223 47% 11%;
    --card-foreground: 210 40% 98%;
    --popover: 222 47% 11%;
    --popover-foreground: 210 40% 98%;
    --primary: 251 17% 35%;
    --primary-foreground: 210 40% 98%;
    --secondary: 217 33% 17%;
    --secondary-foreground: 210 40% 98%;
    --accent: 217 33% 17%;
    --accent-foreground: 210 40% 98%;
    --muted: 217 33% 17%;
    --muted-foreground: 215 20% 65%;
    --destructive: 0 63% 31%;
    --destructive-foreground: 210 40% 98%;
    --border: 217 33% 17%;
    --input: 217 33% 17%;
    --ring: 251 17% 35%;
  }
}

@layer base {
  * {
    border-color: hsl(var(--border));
  }

  body {
    @apply bg-background text-foreground;
  }

  html {
    scroll-behavior: smooth;
  }
}

@layer components {
  .scaffold-heading {
    font-size: 1.875rem;
    line-height: 2.375rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: hsl(var(--foreground));
  }

  .scaffold-subheading {
    font-size: 1.25rem;
    line-height: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    color: hsl(var(--foreground));
  }

  .scaffold-description {
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: hsl(var(--muted-foreground));
  }

  .scaffold-badge {
    @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium;
  }

  .el-emerging {
    @apply bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300;
  }

  .el-expanding {
    @apply bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300;
  }

  .el-bridging {
    @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300;
  }
}

/* Scaffold preview always has a light background, so force dark text in dark mode */
.dark .scaffold-preview {
  color: #111827;
}

@layer utilities {
  .bg-background {
    background-color: hsl(var(--background));
  }

  .text-foreground {
    color: hsl(var(--foreground));
  }

  .text-muted-foreground {
    color: hsl(var(--muted-foreground));
  }

  .scrollbar-thin {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--muted)) transparent;
  }

  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: hsl(var(--muted-foreground) / 0.3);
    border-radius: 3px;
  }

  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #e5e7eb transparent;
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #e5e7eb;
    border-radius: 9999px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: #d1d5db;
  }

  .dark .custom-scrollbar {
    scrollbar-color: #374151 transparent;
  }

  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #374151;
  }

  .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: #4b5563;
  }

  .sidebar-transition {
    transition: all 300ms ease-in-out;
  }
}

@media print {

  /* Hide all UI chrome */
  nav,
  aside,
  header,
  footer,
  .export-toolbar,
  .sidebar,
  .mobile-nav,
  button,
  textarea,
  input {
    display: none !important;
  }

  /* Reset body and page */
  body {
    background: white !important;
    color: black !important;
    font-size: 12pt !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Main content area fills page */
  main,
  .scaffolded-column {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Cards: remove borders and shadows */
  [class*="card"] {
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
  }

  /* Scaffold preview: full width, clean */
  .scaffold-preview {
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    background: white !important;
    width: 100% !important;
    max-width: 100% !important;
    font-size: 12pt !important;
    line-height: 1.6 !important;
    color: black !important;
  }

  /* Ensure colored highlights print */
  .scaffold-preview span[style],
  .scaffold-preview div[style] {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Page breaks */
  .scaffold-preview .chunk-header {
    page-break-before: auto;
    page-break-after: avoid;
  }

  .scaffold-preview .word-bank {
    page-break-inside: avoid;
  }
}
import type { Metadata } from "next";
import { Outfit } from "next/font/google";
import { Providers } from "./providers";
import "./globals.css";

const outfit = Outfit({
  subsets: ["latin"],
  variable: "--font-outfit",
});

export const metadata: Metadata = {
  metadataBase: new URL("https://vamseld.com"),
  title: "VAMS ELD - Scaffolding Platform",
  description:
    "AI-powered scaffolding tools for English Language Development teachers at Valor Academy Middle School",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${outfit.variable} font-sans antialiased`}>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
import { redirect } from "next/navigation";

export default function Home() {
  redirect("/dashboard");
}
"use client";

import { ThemeProvider } from "next-themes";
import { Toaster } from "sonner";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <ThemeProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange
    >
      {children}
      <Toaster richColors position="bottom-right" />
    </ThemeProvider>
  );
}
"use client";

import { useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import { createClient } from "@/lib/supabase-browser";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { AlertCircle, Eye, EyeOff, Loader2 } from "lucide-react";

export default function SignInPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const supabase = createClient();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const errorParam = searchParams.get("error");
  const [error, setError] = useState(
    errorParam === "unauthorized_domain"
      ? "Only Bright Star Schools email addresses are allowed."
      : errorParam === "confirmation_failed"
        ? "Email confirmation failed. Please try signing up again."
        : ""
  );
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    const { error: authError } = await supabase.auth.signInWithPassword({
      email: email.trim(),
      password,
    });

    if (authError) {
      setError(authError.message);
      setLoading(false);
      return;
    }

    const redirect = searchParams.get("redirect") ?? "/dashboard";
    router.push(redirect);
    router.refresh();
  };

  return (
    <div className="flex min-h-screen items-center justify-center bg-gradient-to-b from-eld-seashell to-white dark:from-gray-900 dark:to-gray-950">
      <div className="w-full max-w-md px-4">
        {/* Logo */}
        <div className="mb-8 text-center">
          <div className="mx-auto mb-4">
            <img 
              src="/eldlogo.png" 
              alt="Valor Academy Middle School Logo"
              className="h-16 w-auto mx-auto"
            />
          </div>
          <h1 className="text-3xl font-bold text-foreground">Valor Academy Middle School</h1>
          <p className="mt-2 text-muted-foreground">
            English Language Development
          </p>
        </div>

        {/* Card */}
        <div className="rounded-2xl border border-eld-almond-silk/40 bg-white p-6 shadow-theme-xs dark:border-gray-800 dark:bg-gray-900">
          <form onSubmit={handleSubmit} className="space-y-4">
            {error && (
              <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
                <AlertCircle className="mt-0.5 h-4 w-4 shrink-0" />
                <span>{error}</span>
              </div>
            )}

            <div className="space-y-1.5">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="you@brightstarschools.org"
                required
                autoComplete="email"
              />
            </div>

            <div className="space-y-1.5">
              <Label htmlFor="password">Password</Label>
              <div className="relative">
                <Input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Enter your password"
                  required
                  autoComplete="current-password"
                  className="pr-10"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-eld-lilac-ash hover:text-eld-space-indigo dark:text-gray-400 dark:hover:text-gray-300"
                >
                  {showPassword ? (
                    <EyeOff className="h-4 w-4" />
                  ) : (
                    <Eye className="h-4 w-4" />
                  )}
                </button>
              </div>
            </div>

            <Button type="submit" className="w-full" disabled={loading}>
              {loading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Sign in
            </Button>

            <p className="text-center text-sm text-muted-foreground">
              Don&apos;t have an account?{" "}
              <Link
                href="/sign-up"
                className="font-medium text-eld-space-indigo hover:underline dark:text-eld-almond-silk"
              >
                Sign up
              </Link>
            </p>
          </form>
        </div>

        {/* Footer */}
        <p className="mt-8 text-center text-theme-xs text-eld-lilac-ash dark:text-gray-500">
          &copy; {new Date().getFullYear()} Valor Academy Middle School &mdash; ELD Scaffolding Platform
        </p>
      </div>
    </div>
  );
}
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { createClient } from "@/lib/supabase-browser";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { AlertCircle, CheckCircle2, Eye, EyeOff, Loader2 } from "lucide-react";

// Only @brightstarschools.org emails are allowed
const ALLOWED_DOMAIN = "@brightstarschools.org";

function isAllowedEmail(email: string): boolean {
  return email.toLowerCase().trim().endsWith(ALLOWED_DOMAIN);
}

export default function SignUpPage() {
  const router = useRouter();
  const supabase = createClient();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [fullName, setFullName] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [confirmationSent, setConfirmationSent] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    // Client-side email domain check
    if (!isAllowedEmail(email)) {
      setError("Please use your Bright Star Schools email to register.");
      return;
    }

    // Server-side double-check via API
    const validateRes = await fetch("/api/validate-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: email.trim() }),
    });
    if (!validateRes.ok) {
      const data = await validateRes.json();
      setError(data.message ?? "Email not allowed.");
      return;
    }

    setLoading(true);
    try {
      const siteUrl = window.location.origin;
      const { error: authError } = await supabase.auth.signUp({
        email: email.trim(),
        password,
        options: {
          emailRedirectTo: `${siteUrl}/auth/callback`,
          data: {
            full_name: fullName.trim(),
          },
        },
      });

      if (authError) {
        setError(authError.message);
        return;
      }

      // Supabase sends a confirmation email automatically
      setConfirmationSent(true);
    } catch {
      setError("Something went wrong. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex min-h-screen items-center justify-center bg-gradient-to-b from-eld-seashell to-white dark:from-gray-900 dark:to-gray-950">
      <div className="w-full max-w-md px-4">
        {/* Logo */}
        <div className="mb-8 text-center">
          <div className="mx-auto mb-4">
            <img 
              src="/eldlogo.png" 
              alt="Valor Academy Middle School Logo"
              className="h-16 w-auto mx-auto"
            />
          </div>
          <h1 className="text-3xl font-bold text-foreground">Valor Academy Middle School</h1>
          <p className="mt-2 text-muted-foreground">
            English Language Development
          </p>
        </div>

        {/* Card */}
        <div className="rounded-2xl border border-eld-almond-silk/40 bg-white p-6 shadow-theme-xs dark:border-gray-800 dark:bg-gray-900">
          {!confirmationSent ? (
            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Error message */}
              {error && (
                <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
                  <AlertCircle className="mt-0.5 h-4 w-4 shrink-0" />
                  <span>{error}</span>
                </div>
              )}

              {/* Domain notice */}
              <div className="rounded-lg bg-eld-seashell/50 p-3 text-sm text-muted-foreground dark:bg-gray-800">
                Only <strong>{ALLOWED_DOMAIN}</strong> email addresses can
                register.
              </div>

              {/* Full name */}
              <div className="space-y-1.5">
                <Label htmlFor="fullName">Full name</Label>
                <Input
                  id="fullName"
                  value={fullName}
                  onChange={(e) => setFullName(e.target.value)}
                  placeholder="Jane Doe"
                  required
                  autoComplete="name"
                />
              </div>

              {/* Email */}
              <div className="space-y-1.5">
                <Label htmlFor="email">School email</Label>
                <Input
                  id="email"
                  type="email"
                  value={email}
                  onChange={(e) => {
                    setEmail(e.target.value);
                    if (error) setError("");
                  }}
                  placeholder="you@brightstarschools.org"
                  required
                  autoComplete="email"
                />
              </div>

              {/* Password */}
              <div className="space-y-1.5">
                <Label htmlFor="password">Password</Label>
                <div className="relative">
                  <Input
                    id="password"
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="At least 6 characters"
                    minLength={6}
                    required
                    autoComplete="new-password"
                    className="pr-10"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-eld-lilac-ash hover:text-eld-space-indigo dark:text-gray-400 dark:hover:text-gray-300"
                  >
                    {showPassword ? (
                      <EyeOff className="h-4 w-4" />
                    ) : (
                      <Eye className="h-4 w-4" />
                    )}
                  </button>
                </div>
              </div>

              <Button type="submit" className="w-full" disabled={loading}>
                {loading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Create account
              </Button>

              <p className="text-center text-sm text-muted-foreground">
                Already have an account?{" "}
                <Link
                  href="/sign-in"
                  className="font-medium text-eld-space-indigo hover:underline dark:text-eld-almond-silk"
                >
                  Sign in
                </Link>
              </p>
            </form>
          ) : (
            /* Confirmation sent */
            <div className="space-y-4 text-center">
              <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30">
                <CheckCircle2 className="h-6 w-6 text-green-600 dark:text-green-400" />
              </div>
              <h2 className="text-lg font-semibold text-foreground">
                Check your email
              </h2>
              <p className="text-sm text-muted-foreground">
                We sent a confirmation link to{" "}
                <strong className="text-foreground">{email}</strong>.
                Click the link to activate your account.
              </p>
              <Link href="/sign-in">
                <Button variant="outline" className="mt-2 w-full">
                  Back to sign in
                </Button>
              </Link>
            </div>
          )}
        </div>

        {/* Footer */}
        <p className="mt-8 text-center text-theme-xs text-eld-lilac-ash dark:text-gray-500">
          &copy; {new Date().getFullYear()} Valor Academy Middle School &mdash; ELD Scaffolding Platform
        </p>
      </div>
    </div>
  );
}
import { Sidebar } from "@/components/layout/sidebar";
import { Header } from "@/components/layout/header";
import { Footer } from "@/components/layout/footer";

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-background">
      <Sidebar />
      <div className="flex min-h-screen flex-col lg:ml-[290px]">
        <Header />
        <main className="flex-1 p-4 md:p-6 lg:border-l lg:border-white/10">
          <div className="mx-auto max-w-screen-2xl">
            {children}
          </div>
        </main>
        <div className="hidden lg:block">
          <Footer />
        </div>
      </div>
    </div>
  );
}
"use client";

import { useState } from "react";
import { toast } from "sonner";
import {
  Bug,
  Loader2,
  CheckCircle2,
  ChevronDown,
  AlertTriangle,
  Monitor,
  FileText,
  RotateCcw,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

const CATEGORIES = [
  "UI / Display Issue",
  "Feature Not Working",
  "Data Error",
  "Performance Issue",
  "Login / Access Issue",
  "Assignment / Scaffold Error",
  "Student Management Issue",
  "PDF / Export Issue",
  "Other",
];

const SEVERITIES = [
  { value: "Low", description: "Minor annoyance, workaround exists" },
  { value: "Medium", description: "Disrupts workflow but site still usable" },
  { value: "High", description: "Key feature broken, no workaround" },
  { value: "Critical", description: "Site unusable or data loss" },
];

const SEVERITY_STYLES: Record<string, string> = {
  Low: "border-green-500 bg-green-50 text-green-800 dark:bg-green-950/30 dark:text-green-300",
  Medium: "border-yellow-500 bg-yellow-50 text-yellow-800 dark:bg-yellow-950/30 dark:text-yellow-300",
  High: "border-orange-500 bg-orange-50 text-orange-800 dark:bg-orange-950/30 dark:text-orange-300",
  Critical: "border-red-500 bg-red-50 text-red-800 dark:bg-red-950/30 dark:text-red-300",
};

function NativeSelect({
  id,
  value,
  onChange,
  placeholder,
  options,
  disabled,
}: {
  id: string;
  value: string;
  onChange: (v: string) => void;
  placeholder: string;
  options: string[];
  disabled?: boolean;
}) {
  return (
    <div className="relative">
      <select
        id={id}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        disabled={disabled}
        className="w-full appearance-none rounded-md border border-input bg-background px-3 py-2 pr-8 text-sm text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
      >
        <option value="">{placeholder}</option>
        {options.map((opt) => (
          <option key={opt} value={opt}>
            {opt}
          </option>
        ))}
      </select>
      <ChevronDown className="pointer-events-none absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
    </div>
  );
}

function SectionHeading({
  icon: Icon,
  title,
  subtitle,
}: {
  icon: React.ElementType;
  title: string;
  subtitle?: string;
}) {
  return (
    <div className="flex items-start gap-2 border-b border-border pb-2">
      <Icon className="mt-0.5 h-4 w-4 shrink-0 text-muted-foreground" />
      <div>
        <p className="text-sm font-semibold text-foreground">{title}</p>
        {subtitle && <p className="text-xs text-muted-foreground">{subtitle}</p>}
      </div>
    </div>
  );
}

function Field({
  label,
  htmlFor,
  optional,
  children,
}: {
  label: string;
  htmlFor: string;
  optional?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div className="space-y-1.5">
      <label htmlFor={htmlFor} className="flex items-center gap-1.5 text-sm font-medium">
        {label}
        {optional && (
          <span className="text-xs font-normal text-muted-foreground">(optional)</span>
        )}
      </label>
      {children}
    </div>
  );
}

const emptyForm = {
  reporterName: "",
  reporterEmail: "",
  category: "",
  severity: "",
  affectedPage: "",
  description: "",
  stepsToReproduce: "",
  expectedBehavior: "",
  actualBehavior: "",
  browserDevice: "",
  additionalNotes: "",
};

export default function BugReportPage() {
  const [form, setForm] = useState(emptyForm);
  const [isSending, setIsSending] = useState(false);
  const [sent, setSent] = useState(false);

  function set(field: keyof typeof emptyForm) {
    return (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) =>
      setForm((prev) => ({ ...prev, [field]: e.target.value }));
  }

  function setVal(field: keyof typeof emptyForm) {
    return (value: string) => setForm((prev) => ({ ...prev, [field]: value }));
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setIsSending(true);
    try {
      const res = await fetch("/api/bug-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error ?? "Failed to submit report.");
      setSent(true);
      toast.success("Bug report submitted!");
    } catch (err: unknown) {
      toast.error(err instanceof Error ? err.message : "Something went wrong. Please try again.");
    } finally {
      setIsSending(false);
    }
  }

  function handleReset() {
    setForm(emptyForm);
    setSent(false);
  }

  if (sent) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="scaffold-heading">Report a Bug</h1>
          <p className="scaffold-description mt-1">Help us improve the platform.</p>
        </div>
        <div className="mx-auto max-w-xl">
          <Card>
            <CardContent className="flex flex-col items-center gap-4 py-12 text-center">
              <div className="flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-950/40">
                <CheckCircle2 className="h-8 w-8 text-green-600 dark:text-green-400" />
              </div>
              <div>
                <p className="text-base font-semibold text-foreground">Report Submitted!</p>
                <p className="mt-1 text-sm text-muted-foreground">
                  Thank you. Your report has been sent to the platform administrator.
                </p>
              </div>
              <Button variant="outline" size="sm" onClick={handleReset} className="gap-2">
                <RotateCcw className="h-3.5 w-3.5" />
                Submit Another Report
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="scaffold-heading">Report a Bug</h1>
        <p className="scaffold-description mt-1">
          Found a problem? All fields are optional â€” share as much or as little as you like.
        </p>
      </div>

      <div className="mx-auto max-w-2xl">
        <form onSubmit={handleSubmit} className="space-y-5">

          {/* â”€â”€ Reporter Info â”€â”€ */}
          <Card>
            <CardHeader className="pb-3 pt-4">
              <CardTitle className="flex items-center gap-2 text-sm font-semibold">
                <FileText className="h-4 w-4" />
                Your Information
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                <Field label="Name" htmlFor="reporterName" optional>
                  <Input
                    id="reporterName"
                    placeholder="e.g. Maria Garcia"
                    value={form.reporterName}
                    onChange={set("reporterName")}
                    disabled={isSending}
                  />
                </Field>
                <Field label="Email" htmlFor="reporterEmail" optional>
                  <Input
                    id="reporterEmail"
                    type="email"
                    placeholder="e.g. mgarcia@brightstarschools.org"
                    value={form.reporterEmail}
                    onChange={set("reporterEmail")}
                    disabled={isSending}
                  />
                </Field>
              </div>
              <p className="text-xs text-muted-foreground">
                Provide your email if you&apos;d like a follow-up from the administrator.
              </p>
            </CardContent>
          </Card>

          {/* â”€â”€ Bug Classification â”€â”€ */}
          <Card>
            <CardHeader className="pb-3 pt-4">
              <CardTitle className="flex items-center gap-2 text-sm font-semibold">
                <AlertTriangle className="h-4 w-4" />
                Bug Classification
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                <Field label="Category" htmlFor="category" optional>
                  <NativeSelect
                    id="category"
                    value={form.category}
                    onChange={setVal("category")}
                    placeholder="Select a categoryâ€¦"
                    options={CATEGORIES}
                    disabled={isSending}
                  />
                </Field>
                <Field label="Affected Page / Section" htmlFor="affectedPage" optional>
                  <Input
                    id="affectedPage"
                    placeholder="e.g. Create Assignment, Students"
                    value={form.affectedPage}
                    onChange={set("affectedPage")}
                    disabled={isSending}
                  />
                </Field>
              </div>

              {/* Severity picker */}
              <div className="space-y-1.5">
                <label className="flex items-center gap-1.5 text-sm font-medium">
                  Severity
                  <span className="text-xs font-normal text-muted-foreground">(optional)</span>
                </label>
                <div className="grid grid-cols-2 gap-2 sm:grid-cols-4">
                  {SEVERITIES.map(({ value, description }) => (
                    <button
                      key={value}
                      type="button"
                      disabled={isSending}
                      onClick={() => setForm((prev) => ({ ...prev, severity: prev.severity === value ? "" : value }))}
                      className={[
                        "rounded-md border-2 px-3 py-2 text-left transition-all focus:outline-none focus:ring-2 focus:ring-ring disabled:opacity-50",
                        form.severity === value
                          ? SEVERITY_STYLES[value]
                          : "border-border bg-background text-muted-foreground hover:border-muted-foreground",
                      ].join(" ")}
                    >
                      <p className="text-xs font-semibold">{value}</p>
                      <p className="mt-0.5 text-[11px] leading-tight opacity-80">{description}</p>
                    </button>
                  ))}
                </div>
              </div>
            </CardContent>
          </Card>

          {/* â”€â”€ Bug Details â”€â”€ */}
          <Card>
            <CardHeader className="pb-3 pt-4">
              <CardTitle className="flex items-center gap-2 text-sm font-semibold">
                <Bug className="h-4 w-4" />
                Bug Details
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <Field label="Description" htmlFor="description" optional>
                <Textarea
                  id="description"
                  placeholder="Briefly describe the issue you encounteredâ€¦"
                  value={form.description}
                  onChange={set("description")}
                  disabled={isSending}
                  rows={4}
                />
              </Field>

              <Field label="Steps to Reproduce" htmlFor="stepsToReproduce" optional>
                <Textarea
                  id="stepsToReproduce"
                  placeholder={"1. Go to...\n2. Click on...\n3. See error"}
                  value={form.stepsToReproduce}
                  onChange={set("stepsToReproduce")}
                  disabled={isSending}
                  rows={3}
                />
              </Field>

              <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                <Field label="Expected Behavior" htmlFor="expectedBehavior" optional>
                  <Textarea
                    id="expectedBehavior"
                    placeholder="What should have happened?"
                    value={form.expectedBehavior}
                    onChange={set("expectedBehavior")}
                    disabled={isSending}
                    rows={3}
                  />
                </Field>
                <Field label="Actual Behavior" htmlFor="actualBehavior" optional>
                  <Textarea
                    id="actualBehavior"
                    placeholder="What actually happened?"
                    value={form.actualBehavior}
                    onChange={set("actualBehavior")}
                    disabled={isSending}
                    rows={3}
                  />
                </Field>
              </div>
            </CardContent>
          </Card>

          {/* â”€â”€ Environment & Notes â”€â”€ */}
          <Card>
            <CardHeader className="pb-3 pt-4">
              <CardTitle className="flex items-center gap-2 text-sm font-semibold">
                <Monitor className="h-4 w-4" />
                Environment &amp; Notes
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <Field label="Browser / Device" htmlFor="browserDevice" optional>
                <Input
                  id="browserDevice"
                  placeholder="e.g. Chrome 123 on Windows 11, iPhone 15 Safari"
                  value={form.browserDevice}
                  onChange={set("browserDevice")}
                  disabled={isSending}
                />
              </Field>
              <Field label="Additional Notes" htmlFor="additionalNotes" optional>
                <Textarea
                  id="additionalNotes"
                  placeholder="Anything else that might help us fix thisâ€¦"
                  value={form.additionalNotes}
                  onChange={set("additionalNotes")}
                  disabled={isSending}
                  rows={3}
                />
              </Field>
            </CardContent>
          </Card>

          {/* â”€â”€ Submit â”€â”€ */}
          <div className="flex items-center justify-between">
            <p className="text-xs text-muted-foreground">
              Reports are sent to{" "}
              <span className="font-medium">dvandiest@brightstarschools.org</span>
            </p>
            <Button type="submit" disabled={isSending} className="gap-2">
              {isSending ? (
                <>
                  <Loader2 className="h-4 w-4 animate-spin" />
                  Submittingâ€¦
                </>
              ) : (
                <>
                  <Bug className="h-4 w-4" />
                  Submit Report
                </>
              )}
            </Button>
          </div>

        </form>
      </div>
    </div>
  );
}
"use client";

import { useState } from "react";
import { toast } from "sonner";
import { Send, Loader2, Mail, CheckCircle2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

export default function ContactPage() {
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [message, setMessage] = useState("");
  const [isSending, setIsSending] = useState(false);
  const [sent, setSent] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!firstName.trim() || !lastName.trim() || !message.trim()) {
      toast.error("Please fill in all fields before sending.");
      return;
    }

    setIsSending(true);
    try {
      const res = await fetch("/api/contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firstName, lastName, message }),
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error ?? "Failed to send message.");
      }

      setSent(true);
      toast.success("Message sent successfully!");
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : "Something went wrong. Please try again.";
      toast.error(errorMessage);
    } finally {
      setIsSending(false);
    }
  }

  function handleReset() {
    setFirstName("");
    setLastName("");
    setMessage("");
    setSent(false);
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="scaffold-heading">Message the ELD Teacher</h1>
        <p className="scaffold-description mt-1">
          Send a message directly to your ELD teacher.
        </p>
      </div>

      <div className="mx-auto max-w-xl">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <Mail className="h-4 w-4" />
              Send a Message
            </CardTitle>
          </CardHeader>
          <CardContent>
            {sent ? (
              <div className="flex flex-col items-center gap-4 py-8 text-center">
                <div className="flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-950/40">
                  <CheckCircle2 className="h-8 w-8 text-green-600 dark:text-green-400" />
                </div>
                <div>
                  <p className="text-base font-semibold text-foreground">
                    Message Sent!
                  </p>
                  <p className="mt-1 text-sm text-muted-foreground">
                    Your message has been delivered to the ELD teacher.
                  </p>
                </div>
                <Button variant="outline" size="sm" onClick={handleReset}>
                  Send Another Message
                </Button>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                  <div className="space-y-1.5">
                    <label htmlFor="firstName" className="text-sm font-medium">
                      First Name
                    </label>
                    <Input
                      id="firstName"
                      placeholder="e.g. Maria"
                      value={firstName}
                      onChange={(e) => setFirstName(e.target.value)}
                      disabled={isSending}
                      required
                    />
                  </div>
                  <div className="space-y-1.5">
                    <label htmlFor="lastName" className="text-sm font-medium">
                      Last Name
                    </label>
                    <Input
                      id="lastName"
                      placeholder="e.g. Garcia"
                      value={lastName}
                      onChange={(e) => setLastName(e.target.value)}
                      disabled={isSending}
                      required
                    />
                  </div>
                </div>

                <div className="space-y-1.5">
                  <label htmlFor="message" className="text-sm font-medium">
                    Message
                  </label>
                  <Textarea
                    id="message"
                    placeholder="Type your message here..."
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    disabled={isSending}
                    rows={6}
                    required
                  />
                </div>

                <div className="flex items-center justify-between pt-1">
                  <p className="text-xs text-muted-foreground">
                    Your message will be sent to{" "}
                    <span className="font-medium">dvandiest@brightstarschools.org</span>
                  </p>
                  <Button type="submit" disabled={isSending} className="gap-2">
                    {isSending ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Sendingâ€¦
                      </>
                    ) : (
                      <>
                        <Send className="h-4 w-4" />
                        Send Message
                      </>
                    )}
                  </Button>
                </div>
              </form>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
"use client";

import { useCallback } from "react";
import { toast } from "sonner";
import { ArrowRight, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { AssignmentInputTabs } from "@/components/assignments/assignment-input-tabs";
import { AssignmentDetailsForm } from "@/components/assignments/assignment-details-form";
import { StudentScaffoldSelection } from "@/components/assignments/student-scaffold-selection";
import { useAssignmentForm } from "@/lib/hooks/use-assignment-form";
import { cn } from "@/lib/utils";
import type { AssignmentDetailsFormValues } from "@/lib/validations";

const steps = [
  { number: 1, label: "Input Assignment" },
  { number: 2, label: "Assignment Details" },
  { number: 3, label: "Select & Generate" },
];

export default function CreateAssignmentPage() {
  const form = useAssignmentForm();

  const handleContentChange = useCallback(
    (content: string, sourceType: "text" | "upload" | "google_doc", fileName?: string) => {
      form.updateContent(content, sourceType, fileName);
    },
    [form]
  );

  function handleStep1Continue() {
    if (!form.canProceedToStep2) {
      toast.error("Assignment must be at least 50 characters.");
      return;
    }
    form.nextStep();
  }

  function handleStep2Submit(data: AssignmentDetailsFormValues) {
    form.updateDetails({
      title: data.title,
      subject: data.subject ?? "",
      gradeLevel: data.grade_level,
    });
    form.nextStep();
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="scaffold-heading">Create Assignment</h1>
        <p className="scaffold-description mt-1">
          Input your assignment, add details, then select scaffolds to apply.
        </p>
      </div>

      {/* Progress Steps */}
      <div className="flex items-center gap-2">
        {steps.map((step, idx) => (
          <div key={step.number} className="flex items-center gap-2">
            <button
              onClick={() => {
                if (step.number < form.currentStep) {
                  form.goToStep(step.number as 1 | 2 | 3);
                }
              }}
              disabled={step.number > form.currentStep}
              className={cn(
                "flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-medium transition-colors",
                step.number === form.currentStep
                  ? "bg-eld-space-indigo/15 text-eld-space-indigo shadow-theme-xs font-bold dark:bg-eld-dusty-grape dark:text-white"
                  : step.number < form.currentStep
                  ? "bg-eld-space-indigo/10 text-eld-space-indigo cursor-pointer hover:bg-eld-space-indigo/20 dark:bg-eld-dusty-grape/20 dark:text-eld-seashell"
                  : "bg-eld-almond-silk/20 text-eld-space-indigo/50 dark:bg-gray-800 dark:text-gray-500"
              )}
            >
              {step.number < form.currentStep ? (
                <Check className="h-3 w-3" />
              ) : (
                <span>{step.number}</span>
              )}
              <span className="hidden sm:inline">{step.label}</span>
            </button>
            {idx < steps.length - 1 && (
              <div
                className={cn(
                  "h-0.5 w-8 sm:w-12",
                  step.number < form.currentStep ? "bg-eld-space-indigo dark:bg-eld-dusty-grape" : "bg-eld-almond-silk/40 dark:bg-gray-700"
                )}
              />
            )}
          </div>
        ))}
      </div>

      {/* Step 1: Input */}
      {form.currentStep === 1 && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Step 1: Input Your Assignment</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <AssignmentInputTabs
              content={form.content}
              sourceType={form.sourceType}
              onContentChange={handleContentChange}
            />
            <div className="flex justify-end pt-2">
              <Button
                onClick={handleStep1Continue}
                disabled={!form.canProceedToStep2}
                className="gap-2"
              >
                Continue to Details
                <ArrowRight className="h-4 w-4" />
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Step 2: Details */}
      {form.currentStep === 2 && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Step 2: Assignment Details</CardTitle>
          </CardHeader>
          <CardContent>
            <AssignmentDetailsForm
              defaultValues={{
                title: form.title,
                subject: form.subject,
                gradeLevel: form.gradeLevel,
              }}
              onSubmit={handleStep2Submit}
              onBack={form.prevStep}
            />
          </CardContent>
        </Card>
      )}

      {/* Step 3: Select Student & Scaffolds */}
      {form.currentStep === 3 && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Step 3: Select Student & Scaffolds
            </CardTitle>
          </CardHeader>
          <CardContent>
            <StudentScaffoldSelection
              assignmentTitle={form.title}
              content={form.content}
              subject={form.subject}
              sourceType={form.sourceType}
              gradeLevel={form.gradeLevel}
              contentLength={form.content.length}
              onBack={form.prevStep}
            />
          </CardContent>
        </Card>
      )}
    </div>
  );
}
"use client";

import { Suspense, useCallback, useEffect, useRef, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { toast } from "sonner";
import {
  ArrowLeft,
  PenSquare,
  FileText,
  ExternalLink,
  Printer,
  Download,
  ChevronDown,
  ChevronUp,
  BookOpen,
  GraduationCap,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ELBadge } from "@/components/students/el-badge";
import { useGoogleDocsExport } from "@/lib/hooks/use-google-docs-export";
import type { ELLevel } from "@/types";

interface ScaffoldResult {
  outputHtml: string;
  isDemo: boolean;
  scaffoldsApplied: string[];
  assignmentTitle: string;
  elLevel: ELLevel;
  studentName: string;
  originalContent?: string;
  teacherNotes?: string;
  generatedAt: string;
  // Structured output fields
  wordBank?: { term: string; definition: string }[];
  scaffoldsUsed?: string[];
  teacherInstructions?: string;
  // Batch mode
  isBatch?: boolean;
  levels?: BatchLevel[];
}

interface BatchLevel {
  level: ELLevel;
  studentCount: number;
  studentNames: string[];
  outputHtml: string;
  wordBank?: { term: string; definition: string }[];
  scaffoldsUsed?: string[];
  teacherInstructions?: string;
  scaffoldsApplied: string[];
  isDemo: boolean;
}

function TeacherInstructionsCard({ instructions }: { instructions: string }) {
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center gap-2">
          <GraduationCap className="h-4 w-4 text-eld-lilac-ash" />
          <CardTitle className="text-sm">Teacher Instructions</CardTitle>
        </div>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-muted-foreground leading-relaxed">
          {instructions}
        </p>
      </CardContent>
    </Card>
  );
}

function ScaffoldResultContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [result, setResult] = useState<ScaffoldResult | null>(null);
  const [notFound, setNotFound] = useState(false);
  const [showOriginal, setShowOriginal] = useState(false);
  const [notes, setNotes] = useState("");
  const [isExporting, setIsExporting] = useState(false);
  const [activeTab, setActiveTab] = useState("");
  const resultIdRef = useRef<string | null>(null);
  const debounceRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const {
    isGoogleConnected,
    isExporting: isGDocsExporting,
    exportToGoogleDocs,
  } = useGoogleDocsExport();

  useEffect(() => {
    const id = searchParams.get("id");
    if (!id) {
      setNotFound(true);
      return;
    }
    resultIdRef.current = id;

    // 1. Try sessionStorage first (immediate display after generation)
    const stored = sessionStorage.getItem(`scaffold-result-${id}`);
    if (stored) {
      try {
        const parsed = JSON.parse(stored) as ScaffoldResult;
        setResult(parsed);
        setNotes(parsed.teacherNotes ?? "");
        if (parsed.isBatch && parsed.levels?.length) {
          setActiveTab(parsed.levels[0].level);
        }
        return;
      } catch {
        // Fall through to DB fetch
      }
    }

    // 2. Fetch from database (handles page refresh, different browser, shared link)
    async function loadFromDb() {
      try {
        const res = await fetch(`/api/library/${id}`);
        if (!res.ok) {
          setNotFound(true);
          return;
        }
        const data = await res.json();
        setResult({
          outputHtml: data.output_html,
          isDemo: data.is_demo,
          scaffoldsApplied: data.scaffolds_applied,
          assignmentTitle: data.assignment_title,
          elLevel: data.el_level,
          studentName: data.student_name ?? "Unknown",
          originalContent: data.original_content,
          teacherNotes: data.teacher_notes,
          generatedAt: data.created_at,
          wordBank: data.word_bank,
          teacherInstructions: data.teacher_instructions,
        });
        setNotes(data.teacher_notes ?? "");
      } catch {
        setNotFound(true);
      }
    }
    loadFromDb();
  }, [searchParams]);

  const handleNotesChange = useCallback((value: string) => {
    setNotes(value);
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(async () => {
      if (resultIdRef.current) {
        try {
          await fetch(`/api/library/${resultIdRef.current}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ teacher_notes: value }),
          });
        } catch {
          // Silent fail on note save
        }
      }
    }, 500);
  }, []);

  async function handleDownloadPdf() {
    if (!result) return;
    setIsExporting(true);
    try {
      const { downloadScaffoldPdf } = await import("@/lib/export-pdf");
      await downloadScaffoldPdf({
        html: result.outputHtml,
        title: result.assignmentTitle,
        elLevel: result.elLevel,
        teacherInstructions: result.teacherInstructions,
        filename: `${result.assignmentTitle}-${result.elLevel ?? "batch"}-scaffolded.pdf`,
      });
      toast.success("PDF downloaded successfully!");
    } catch {
      toast.error("Failed to generate PDF. Please try again.");
    } finally {
      setIsExporting(false);
    }
  }

  if (notFound) {
    return (
      <div className="flex flex-col items-center justify-center py-20 text-center">
        <FileText className="h-12 w-12 text-muted-foreground mb-4" />
        <h2 className="text-lg font-semibold">Result Not Found</h2>
        <p className="text-sm text-muted-foreground mt-1 mb-4">
          This result may have expired or the session was cleared.
        </p>
        <Button onClick={() => router.push("/create")}>
          <PenSquare className="h-4 w-4 mr-2" />
          Create New Assignment
        </Button>
      </div>
    );
  }

  if (!result) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="h-6 w-6 animate-spin rounded-full border-2 border-eld-space-indigo border-t-transparent dark:border-eld-dusty-grape dark:border-t-transparent" />
      </div>
    );
  }

  // Batch mode â€” tabbed by EL level
  if (result.isBatch && result.levels) {
    return (
      <div className="space-y-6">
        <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h1 className="scaffold-heading">Scaffolded Assignment (Batch)</h1>
            <p className="scaffold-description mt-1">
              Generated {result.levels.length} version(s) for{" "}
              {result.levels.reduce((sum, l) => sum + l.studentCount, 0)}{" "}
              students across {result.levels.length} EL level(s).
            </p>
          </div>
          <Button
            variant="outline"
            onClick={() => router.push("/create")}
            className="gap-2 shrink-0"
          >
            <PenSquare className="h-4 w-4" />
            Create Another
          </Button>
        </div>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList>
            {result.levels.map((lvl) => (
              <TabsTrigger key={lvl.level} value={lvl.level} className="gap-1.5">
                <ELBadge level={lvl.level} />
                <span className="text-xs text-muted-foreground">
                  ({lvl.studentCount})
                </span>
              </TabsTrigger>
            ))}
          </TabsList>

          {result.levels.map((lvl) => (
            <TabsContent key={lvl.level} value={lvl.level} className="space-y-4 mt-4">
              {/* Students in this level */}
              <Card>
                <CardContent className="pt-4">
                  <p className="text-xs font-medium text-muted-foreground mb-2">
                    Students ({lvl.studentCount})
                  </p>
                  <div className="flex flex-wrap gap-1.5">
                    {lvl.studentNames.map((name) => (
                      <span
                        key={name}
                        className="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-300"
                      >
                        {name}
                      </span>
                    ))}
                  </div>
                </CardContent>
              </Card>

              {/* Scaffolded preview */}
              <Card>
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle className="text-lg">
                    {lvl.level} Preview
                  </CardTitle>
                  <div className="flex gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => window.print()}
                      className="gap-1.5"
                    >
                      <Printer className="h-3.5 w-3.5" />
                      Print
                    </Button>
                  </div>
                </CardHeader>
                <CardContent>
                  <div
                    className="scaffold-preview rounded-lg border bg-white p-6 dark:bg-gray-50"
                    dangerouslySetInnerHTML={{ __html: lvl.outputHtml }}
                  />
                </CardContent>
              </Card>

              {/* Teacher instructions */}
              {lvl.teacherInstructions && (
                <TeacherInstructionsCard
                  instructions={lvl.teacherInstructions}
                />
              )}


            </TabsContent>
          ))}
        </Tabs>

        {/* Bottom Actions */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={() => router.back()}
            className="gap-2"
          >
            <ArrowLeft className="h-4 w-4" />
            Back
          </Button>
          <Button onClick={() => router.push("/create")} className="gap-2">
            <PenSquare className="h-4 w-4" />
            Create Another Assignment
          </Button>
        </div>
      </div>
    );
  }

  // Single-result mode
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 className="scaffold-heading">Scaffolded Assignment</h1>
          <p className="scaffold-description mt-1">
            Review the generated scaffolded assignment below.
          </p>
        </div>
        <Button
          variant="outline"
          onClick={() => router.push("/create")}
          className="gap-2 shrink-0"
        >
          <PenSquare className="h-4 w-4" />
          Create Another
        </Button>
      </div>

      {/* Metadata Card */}
      <Card>
        <CardContent className="pt-6">
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <div>
              <p className="text-xs font-medium text-muted-foreground">
                Assignment
              </p>
              <p className="text-sm font-medium mt-0.5">
                {result.assignmentTitle}
              </p>
            </div>
            <div>
              <p className="text-xs font-medium text-muted-foreground">
                Student
              </p>
              <p className="text-sm font-medium mt-0.5">
                {result.studentName}
              </p>
            </div>
            <div>
              <p className="text-xs font-medium text-muted-foreground">
                EL Level
              </p>
              <div className="mt-1">
                <ELBadge level={result.elLevel} />
              </div>
            </div>
            <div>
              <p className="text-xs font-medium text-muted-foreground">
                Status
              </p>
              <div className="mt-1 flex items-center gap-1.5">
                <BookOpen className="h-3.5 w-3.5 text-green-600" />
                <span className="text-xs font-medium text-green-600">
                  Saved to Library
                </span>
              </div>
            </div>
          </div>

          {/* Scaffold tags */}
          <div className="mt-4 flex flex-wrap gap-1.5">
            {result.scaffoldsApplied.map((name) => (
              <span
                key={name}
                className="inline-flex items-center rounded-full bg-eld-almond-silk/20 px-2.5 py-0.5 text-xs font-medium text-eld-space-indigo"
              >
                {name}
              </span>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Teacher Instructions (from structured Gemini output) */}
      {result.teacherInstructions && (
        <TeacherInstructionsCard instructions={result.teacherInstructions} />
      )}

      {/* Original Content Toggle */}
      {result.originalContent && (
        <Card>
          <CardHeader className="pb-0">
            <button
              onClick={() => setShowOriginal(!showOriginal)}
              className="flex items-center gap-2 text-left"
            >
              <CardTitle className="text-sm">Original Assignment</CardTitle>
              {showOriginal ? (
                <ChevronUp className="h-4 w-4 text-muted-foreground" />
              ) : (
                <ChevronDown className="h-4 w-4 text-muted-foreground" />
              )}
            </button>
          </CardHeader>
          {showOriginal && (
            <CardContent className="pt-3">
              <div className="rounded-xl border border-eld-almond-silk/40 bg-eld-seashell/50 p-4 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto scrollbar-thin dark:border-gray-700 dark:bg-gray-800/30">
                {result.originalContent}
              </div>
            </CardContent>
          )}
        </Card>
      )}

      {/* Generated HTML Preview */}
      <Card>
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle className="text-lg">Preview</CardTitle>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={handleDownloadPdf}
              disabled={isExporting}
              className="gap-1.5"
            >
              <Download className="h-3.5 w-3.5" />
              {isExporting ? "Exporting..." : "Download PDF"}
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => window.print()}
              className="gap-1.5"
            >
              <Printer className="h-3.5 w-3.5" />
              Print
            </Button>
            <Button
              variant="outline"
              size="sm"
              disabled={!isGoogleConnected || isGDocsExporting}
              onClick={() =>
                result &&
                exportToGoogleDocs({
                  title: result.assignmentTitle,
                  outputHtml: result.outputHtml,
                  elLevel: result.elLevel,
                  scaffoldsApplied: result.scaffoldsApplied,
                  wordBank: result.wordBank,
                  teacherInstructions: result.teacherInstructions,
                })
              }
              className="gap-1.5"
              title={
                isGoogleConnected
                  ? "Export to Google Docs"
                  : "Connect Google account in Settings"
              }
            >
              <ExternalLink className="h-3.5 w-3.5" />
              <span className="hidden sm:inline">
                {isGDocsExporting ? "Exporting..." : "Google Docs"}
              </span>
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <div
            id="scaffold-preview-content"
            className="scaffold-preview rounded-lg border bg-white p-6 dark:bg-gray-50"
            dangerouslySetInnerHTML={{ __html: result.outputHtml }}
          />
        </CardContent>
      </Card>


      {/* Teacher Notes */}
      <Card>
        <CardHeader>
          <CardTitle className="text-sm">Teacher Notes</CardTitle>
        </CardHeader>
        <CardContent>
          <textarea
            value={notes}
            onChange={(e) => handleNotesChange(e.target.value)}
            placeholder="Add notes about this scaffolded assignment..."
            className="w-full rounded-lg border border-eld-almond-silk/60 bg-white px-4 py-2.5 text-sm text-gray-900 shadow-theme-xs placeholder:text-gray-400 focus:border-eld-space-indigo focus:outline-none focus:ring-3 focus:ring-eld-space-indigo/10 min-h-[80px] resize-y dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"
          />
          <p className="mt-1.5 text-xs text-muted-foreground">
            Notes are auto-saved.
          </p>
        </CardContent>
      </Card>

      {/* Bottom Actions */}
      <div className="flex justify-between">
        <Button
          variant="outline"
          onClick={() => router.back()}
          className="gap-2"
        >
          <ArrowLeft className="h-4 w-4" />
          Back
        </Button>
        <Button onClick={() => router.push("/create")} className="gap-2">
          <PenSquare className="h-4 w-4" />
          Create Another Assignment
        </Button>
      </div>
    </div>
  );
}

export default function ScaffoldResultPage() {
  return (
    <Suspense
      fallback={
        <div className="flex items-center justify-center py-20">
          <div className="h-6 w-6 animate-spin rounded-full border-2 border-eld-space-indigo border-t-transparent dark:border-eld-dusty-grape dark:border-t-transparent" />
        </div>
      }
    >
      <ScaffoldResultContent />
    </Suspense>
  );
}
"use client";

import { useEffect } from "react";
import { ErrorMessage } from "@/components/shared/error-message";

export default function DashboardError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error("Dashboard error:", error);
  }, [error]);

  return (
    <div className="flex min-h-[50vh] items-center justify-center">
      <ErrorMessage
        title="Dashboard Error"
        message="Failed to load the dashboard. This might be due to a connection issue."
        retry={reset}
      />
    </div>
  );
}
import { Skeleton } from "@/components/ui/skeleton";
import { Card, CardContent, CardHeader } from "@/components/ui/card";

export default function DashboardLoading() {
  return (
    <div className="space-y-8">
      <div>
        <Skeleton className="h-8 w-72" />
        <Skeleton className="mt-2 h-4 w-96" />
      </div>

      <div className="grid grid-cols-1 gap-4 md:gap-6 sm:grid-cols-2 xl:grid-cols-3">
        {Array.from({ length: 3 }).map((_, i) => (
          <Card key={i}>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <Skeleton className="h-4 w-32" />
              <Skeleton className="h-4 w-4 rounded" />
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                <Skeleton className="h-8 w-16" />
                <Skeleton className="h-3 w-24" />
                <Skeleton className="h-2 w-full rounded-full" />
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      <div className="flex justify-center">
        <Skeleton className="h-11 w-64" />
      </div>
    </div>
  );
}
import Link from "next/link";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Users, FileText, PenSquare, GraduationCap } from "lucide-react";
import { createClient } from "@/lib/supabase-server";
import type { ELLevel } from "@/types";
import { DashboardGreeting } from "@/components/dashboard/greeting";
import { AIUsageCard } from "@/components/dashboard/ai-usage-card";

const levelStyles: Record<ELLevel, string> = {
  Emerging: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
  Expanding: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
  Bridging: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
};

const levelBarColors: Record<ELLevel, string> = {
  Emerging: "bg-red-400 dark:bg-red-500",
  Expanding: "bg-orange-400 dark:bg-orange-500",
  Bridging: "bg-green-400 dark:bg-green-500",
};

async function getStudentStats() {
  const supabase = createClient();
  const { data: students } = await supabase
    .from("students")
    .select("grade, el_level, homeroom");

  if (!students || students.length === 0) {
    return {
      total: 0,
      byLevel: { Emerging: 0, Expanding: 0, Bridging: 0 } as Record<ELLevel, number>,
      byGrade: {} as Record<number, number>,
      byHomeroom: {} as Record<string, number>,
    };
  }

  const byLevel: Record<ELLevel, number> = { Emerging: 0, Expanding: 0, Bridging: 0 };
  const byGrade: Record<number, number> = {};
  const byHomeroom: Record<string, number> = {};

  for (const s of students) {
    if (s.el_level in byLevel) {
      byLevel[s.el_level as ELLevel]++;
    }
    byGrade[s.grade] = (byGrade[s.grade] || 0) + 1;
    if (s.homeroom) {
      byHomeroom[s.homeroom] = (byHomeroom[s.homeroom] || 0) + 1;
    }
  }

  return {
    total: students.length,
    byLevel,
    byGrade,
    byHomeroom,
  };
}

export default async function DashboardPage() {
  const stats = await getStudentStats();

  return (
    <div className="space-y-8">
      <div>
        <h1 className="scaffold-heading"><DashboardGreeting /></h1>
        <p className="scaffold-description mt-1">
          Here&apos;s an overview of your ELD scaffolding workspace.
        </p>
      </div>

      {/* Total students banner */}
      <div className="flex items-center gap-3 rounded-2xl border border-eld-almond-silk/40 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
          <Users className="h-6 w-6 text-eld-space-indigo dark:text-eld-almond-silk" />
        </div>
        <div>
          <p className="text-2xl font-bold text-foreground">{stats.total}</p>
          <p className="text-sm text-muted-foreground">Total ELD Students</p>
        </div>
      </div>

      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6 xl:grid-cols-3">
        {/* Students by EL Level */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Students by EL Level
            </CardTitle>
            <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
              <Users className="h-6 w-6 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {(["Emerging", "Expanding", "Bridging"] as ELLevel[]).map((level) => {
                const count = stats.byLevel[level];
                const pct = stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;
                return (
                  <div key={level} className="space-y-1">
                    <div className="flex items-center justify-between text-sm">
                      <span
                        className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${levelStyles[level]}`}
                      >
                        {level}
                      </span>
                      <span className="font-medium">{count}</span>
                    </div>
                    <div className="h-2 rounded-full bg-eld-almond-silk/30 dark:bg-gray-700">
                      <div
                        className={`h-2 rounded-full transition-all ${levelBarColors[level]}`}
                        style={{ width: `${pct}%` }}
                      />
                    </div>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>

        {/* Students by Grade */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Students by Grade
            </CardTitle>
            <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
              <GraduationCap className="h-6 w-6 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {[5, 6, 7, 8].map((grade) => {
                const count = stats.byGrade[grade] || 0;
                return (
                  <div
                    key={grade}
                    className="flex items-center justify-between text-sm"
                  >
                    <span className="text-muted-foreground">Grade {grade}</span>
                    <span className="font-medium">{count}</span>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>

        {/* Students by Homeroom */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Students by Homeroom
            </CardTitle>
            <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
              <FileText className="h-6 w-6 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {Object.entries(stats.byHomeroom)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([homeroom, count]) => (
                  <div
                    key={homeroom}
                    className="flex items-center justify-between text-sm"
                  >
                    <span className="text-muted-foreground">{homeroom}</span>
                    <span className="font-medium">{count}</span>
                  </div>
                ))}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* AI Usage + Quick Action */}
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6">
        <AIUsageCard />

        <Card className="flex flex-col items-center justify-center p-6 text-center">
          <PenSquare className="h-8 w-8 text-muted-foreground mb-3" />
          <p className="text-sm font-medium text-foreground mb-1">Ready to scaffold?</p>
          <p className="text-xs text-muted-foreground mb-4">
            Create differentiated assignments for your {stats.total} students
          </p>
          <Button asChild size="lg" variant="secondary" className="gap-2">
            <Link href="/create">
              <PenSquare className="h-4 w-4" />
              Create Assignment
            </Link>
          </Button>
        </Card>
      </div>
    </div>
  );
}
"use client";

import { useState } from "react";
import Link from "next/link";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  Scale,
  BookOpen,
  GraduationCap,
  ClipboardCheck,
  FileText,
  AlertCircle,
  CheckCircle2,
  ChevronDown,
  ChevronUp,
  ScrollText,
  Users,
  Clock,
  Target,
  Info,
  Shield,
  Landmark,
  ArrowRight,
} from "lucide-react";

/* ------------------------------------------------------------------ */
/*  Collapsible Section Component                                      */
/* ------------------------------------------------------------------ */

function Collapsible({
  title,
  children,
  defaultOpen = false,
  icon: Icon,
}: {
  title: string;
  children: React.ReactNode;
  defaultOpen?: boolean;
  icon?: React.ComponentType<{ className?: string }>;
}) {
  const [open, setOpen] = useState(defaultOpen);

  return (
    <div className="rounded-xl border border-eld-almond-silk/40 dark:border-gray-700/60 overflow-hidden">
      <button
        type="button"
        onClick={() => setOpen(!open)}
        className="flex w-full items-center justify-between gap-3 px-4 py-3.5 md:px-5 md:py-4 text-left font-semibold text-foreground hover:bg-eld-almond-silk/10 dark:hover:bg-white/[0.03] transition-colors"
      >
        <div className="flex items-center gap-3">
          {Icon && (
            <div className="flex h-8 w-8 shrink-0 items-center justify-center rounded-lg bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
              <Icon className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          )}
          <span className="text-sm md:text-base">{title}</span>
        </div>
        {open ? (
          <ChevronUp className="h-4 w-4 shrink-0 text-muted-foreground" />
        ) : (
          <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground" />
        )}
      </button>
      {open && (
        <div className="border-t border-eld-almond-silk/30 dark:border-gray-700/40 px-4 py-4 md:px-5 md:py-5 text-sm leading-relaxed text-muted-foreground">
          {children}
        </div>
      )}
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Info Banner                                                        */
/* ------------------------------------------------------------------ */

function InfoBanner({
  children,
  variant = "info",
}: {
  children: React.ReactNode;
  variant?: "info" | "warning" | "success";
}) {
  const styles = {
    info: "border-blue-200 bg-blue-50 text-blue-800 dark:border-blue-800/40 dark:bg-blue-900/20 dark:text-blue-300",
    warning:
      "border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-800/40 dark:bg-amber-900/20 dark:text-amber-300",
    success:
      "border-green-200 bg-green-50 text-green-800 dark:border-green-800/40 dark:bg-green-900/20 dark:text-green-300",
  };

  const icons = {
    info: Info,
    warning: AlertCircle,
    success: CheckCircle2,
  };

  const IconComponent = icons[variant];

  return (
    <div
      className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${styles[variant]}`}
    >
      <IconComponent className="mt-0.5 h-4 w-4 shrink-0" />
      <div>{children}</div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Stat Card                                                          */
/* ------------------------------------------------------------------ */

function StatCard({
  icon: Icon,
  label,
  value,
}: {
  icon: React.ComponentType<{ className?: string }>;
  label: string;
  value: string;
}) {
  return (
    <div className="flex items-center gap-3 rounded-xl border border-eld-almond-silk/40 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]">
      <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
        <Icon className="h-5 w-5 text-eld-space-indigo dark:text-eld-almond-silk" />
      </div>
      <div>
        <p className="text-lg font-bold text-foreground">{value}</p>
        <p className="text-xs text-muted-foreground">{label}</p>
      </div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Section Heading                                                    */
/* ------------------------------------------------------------------ */

function SectionHeading({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <h2
      className={`text-lg md:text-xl font-bold text-foreground ${className}`}
    >
      {children}
    </h2>
  );
}

/* ------------------------------------------------------------------ */
/*  Overview Tab                                                       */
/* ------------------------------------------------------------------ */

function OverviewTab() {
  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            What is English Language Development (ELD)?
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm leading-relaxed text-muted-foreground">
          <p>
            English Language Development (ELD) is specialized instruction
            designed to help English Learners (ELs) acquire English language
            proficiency in listening, speaking, reading, and writing. In
            California, ELD instruction is a legal requirement for all
            identified English Learners and is governed by the California
            Department of Education (CDE).
          </p>
          <p>
            California adopted the{" "}
            <strong className="text-foreground">
              California English Language Development Standards
            </strong>{" "}
            in 2012 (updated in 2014), which are designed to be used alongside
            the California Common Core State Standards for English Language Arts
            (CA CCSS for ELA/Literacy). These standards define three
            proficiency levels:{" "}
            <span className="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-300">
              Emerging
            </span>
            ,{" "}
            <span className="inline-flex items-center rounded-full bg-orange-100 px-2 py-0.5 text-xs font-medium text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
              Expanding
            </span>
            , and{" "}
            <span className="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-300">
              Bridging
            </span>
            .
          </p>
        </CardContent>
      </Card>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-4">
        <StatCard
          icon={Users}
          label="ELs in California (approx.)"
          value="1.1M+"
        />
        <StatCard
          icon={ScrollText}
          label="Languages Represented"
          value="60+"
        />
        <StatCard
          icon={GraduationCap}
          label="CA ELD Proficiency Levels"
          value="3"
        />
        <StatCard
          icon={ClipboardCheck}
          label="ELPAC Test Domains"
          value="4"
        />
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            Two Types of ELD Instruction
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-5">
          <div className="rounded-xl border border-eld-almond-silk/40 p-4 dark:border-gray-700/60">
            <h3 className="font-semibold text-foreground">
              Designated ELD (dELD)
            </h3>
            <p className="mt-1.5 text-sm leading-relaxed text-muted-foreground">
              A protected time during the regular school day when teachers
              provide lessons focused specifically on the CA ELD Standards.
              During Designated ELD, ELs are grouped by English proficiency
              level and receive targeted instruction to advance their English
              language skills. This is a <strong>legal requirement</strong> for
              all English Learners in California.
            </p>
            <ul className="mt-3 space-y-1.5 text-sm text-muted-foreground">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Minimum 30 minutes daily for elementary, recommended 45+ minutes
                for secondary
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Students grouped by proficiency level (Emerging, Expanding,
                Bridging)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Instruction focuses on language forms, functions, and fluency
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Must be aligned to the CA ELD Standards
              </li>
            </ul>
          </div>

          <div className="rounded-xl border border-eld-almond-silk/40 p-4 dark:border-gray-700/60">
            <h3 className="font-semibold text-foreground">
              Integrated ELD (iELD)
            </h3>
            <p className="mt-1.5 text-sm leading-relaxed text-muted-foreground">
              ELD instruction that occurs throughout the school day across all
              content areas. All teachers of English Learners are responsible
              for incorporating ELD standards into their content-area
              instruction. This ensures ELs can access grade-level content while
              continuing to develop English proficiency.
            </p>
            <ul className="mt-3 space-y-1.5 text-sm text-muted-foreground">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Occurs in all content areas (Math, Science, Social Studies, etc.)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Teachers use scaffolding strategies to make content accessible
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                ELs participate in mainstream instruction with support
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Uses CA ELD Standards Part I in tandem with content standards
              </li>
            </ul>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            California ELD Standards Structure
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm leading-relaxed text-muted-foreground">
          <p>
            The CA ELD Standards are organized into two parts:
          </p>

          <div className="space-y-3">
            <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
              <h4 className="font-semibold text-foreground">
                Part I: Interacting in Meaningful Ways
              </h4>
              <ul className="mt-2 space-y-1 text-sm">
                <li>
                  <strong>A. Collaborative</strong> &mdash; Exchanging
                  information and ideas, interacting via written English,
                  offering opinions and negotiating
                </li>
                <li>
                  <strong>B. Interpretive</strong> &mdash; Listening actively,
                  reading closely, evaluating language choices, analyzing how
                  writers use language
                </li>
                <li>
                  <strong>C. Productive</strong> &mdash; Supporting opinions,
                  writing literary and informational texts, presenting
                </li>
              </ul>
            </div>

            <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
              <h4 className="font-semibold text-foreground">
                Part II: Learning About How English Works
              </h4>
              <ul className="mt-2 space-y-1 text-sm">
                <li>
                  <strong>A. Structuring Cohesive Texts</strong> &mdash;
                  Understanding text structure, cohesion
                </li>
                <li>
                  <strong>B. Expanding &amp; Enriching Ideas</strong> &mdash;
                  Using verbs, nouns, modifying to add details
                </li>
                <li>
                  <strong>C. Connecting &amp; Condensing Ideas</strong> &mdash;
                  Connecting and condensing ideas using a variety of linguistic
                  resources
                </li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            ELD Proficiency Levels
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="rounded-xl border-l-4 border-red-400 bg-red-50/50 p-4 dark:border-red-500 dark:bg-red-900/10">
            <h4 className="font-semibold text-red-800 dark:text-red-300">
              Emerging
            </h4>
            <p className="mt-1 text-sm text-red-700/80 dark:text-red-300/70">
              Students at this level typically progress very quickly,
              learning to use English for immediate communicative needs and
              beginning to understand and use academic vocabulary and other
              features of academic language. They may demonstrate understanding
              of content topics with substantial linguistic support. They often
              use short phrases, simple sentences, and formulaic expressions.
            </p>
          </div>

          <div className="rounded-xl border-l-4 border-orange-400 bg-orange-50/50 p-4 dark:border-orange-500 dark:bg-orange-900/10">
            <h4 className="font-semibold text-orange-800 dark:text-orange-300">
              Expanding
            </h4>
            <p className="mt-1 text-sm text-orange-700/80 dark:text-orange-300/70">
              Students at this level are challenged to increase their
              English language skills in more contexts and apply a greater
              variety of linguistic features. They can use a growing number of
              general academic and domain-specific words, varied sentence
              structures, and more complex grammar. They demonstrate increased
              ability to participate in classroom discussions on a wider range of
              topics.
            </p>
          </div>

          <div className="rounded-xl border-l-4 border-green-400 bg-green-50/50 p-4 dark:border-green-500 dark:bg-green-900/10">
            <h4 className="font-semibold text-green-800 dark:text-green-300">
              Bridging
            </h4>
            <p className="mt-1 text-sm text-green-700/80 dark:text-green-300/70">
              Students at this level continue to learn and apply a range of
              high-level English language skills in a wide variety of contexts,
              including comprehension and production of highly technical texts.
              They can participate fully in grade-level academic tasks and
              demonstrate academic English proficiency comparable to that of
              native English speakers, although they may still benefit from some
              linguistic support.
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Legal Requirements Tab                                             */
/* ------------------------------------------------------------------ */

function LegalTab() {
  return (
    <div className="space-y-6">
      <InfoBanner variant="warning">
        <strong>Disclaimer:</strong> This page is for informational purposes
        only and should not be considered legal advice. Always consult the
        official CDE resources and your district&apos;s legal counsel for
        authoritative guidance.
      </InfoBanner>

      <SectionHeading>Federal Legislation</SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="Title III of the Every Student Succeeds Act (ESSA)"
          icon={Landmark}
          defaultOpen
        >
          <div className="space-y-3">
            <p>
              Title III of ESSA (2015) is the primary federal law governing the
              education of English Learners. It requires states and districts to:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Identify and assess all potential English Learners within 30
                days of enrollment
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Provide language instruction educational programs (LIEPs) for
                all identified ELs
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Notify parents of EL identification within 30 days of the start
                of the school year (or within two weeks for students identified
                during the year)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Annually assess English proficiency using state-approved
                assessments (ELPAC in California)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Establish standardized reclassification criteria
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Monitor reclassified students (RFEPs) for four years after
                reclassification
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Lau v. Nichols (1974) â€” Supreme Court Decision"
          icon={Scale}
        >
          <div className="space-y-3">
            <p>
              This landmark U.S. Supreme Court case established that school
              districts must take affirmative steps to address the language
              barriers of English Learners. The Court held that simply providing
              the same facilities, textbooks, teachers, and curriculum to
              students who do not understand English effectively denies them a
              meaningful education.
            </p>
            <p>
              <strong className="text-foreground">Key ruling:</strong>{" "}
              &quot;There is no equality of treatment merely by providing
              students with the same facilities, textbooks, teachers, and
              curriculum; for students who do not understand English are
              effectively foreclosed from any meaningful education.&quot;
            </p>
            <p>
              This decision forms the legal foundation for all ELD programs
              nationwide and is the basis upon which California&apos;s ELD
              requirements are built.
            </p>
          </div>
        </Collapsible>

        <Collapsible
          title="CastaÃ±eda v. Pickard (1981) â€” Three-Part Test"
          icon={Scale}
        >
          <div className="space-y-3">
            <p>
              The Fifth Circuit Court of Appeals established a three-part test
              that EL programs must meet:
            </p>
            <ol className="list-decimal ml-5 space-y-2">
              <li>
                <strong className="text-foreground">
                  Theory-based program:
                </strong>{" "}
                The program must be based on a sound educational theory or
                recognized as a legitimate experimental strategy.
              </li>
              <li>
                <strong className="text-foreground">
                  Adequate implementation:
                </strong>{" "}
                The program must be reasonably calculated to implement
                effectively the educational theory adopted, including adequate
                resources, materials, and qualified staff.
              </li>
              <li>
                <strong className="text-foreground">
                  Program effectiveness:
                </strong>{" "}
                After a trial period, the program must produce results
                indicating that language barriers are being overcome. If not,
                the program must be modified.
              </li>
            </ol>
          </div>
        </Collapsible>

        <Collapsible title="Equal Educational Opportunities Act (EEOA) of 1974" icon={Shield}>
          <div className="space-y-3">
            <p>
              The EEOA prohibits states from denying equal educational
              opportunities to individuals based on race, color, sex, or
              national origin. Section 1703(f) specifically requires educational
              agencies to take &quot;appropriate action to overcome language
              barriers that impede equal participation by its students in its
              instructional programs.&quot;
            </p>
          </div>
        </Collapsible>
      </div>

      <SectionHeading className="pt-2">
        California State Legislation
      </SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="Proposition 58 â€” California Education for a Global Economy Initiative (2016)"
          icon={ScrollText}
          defaultOpen
        >
          <div className="space-y-3">
            <p>
              Proposition 58, also known as the{" "}
              <strong className="text-foreground">
                California Ed.G.E. (Education for a Global Economy) Initiative
              </strong>
              , was approved by voters in November 2016 and replaced the
              restrictive English-only provisions of Proposition 227 (1998).
            </p>
            <p>Key provisions include:</p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Schools may establish dual-language immersion programs,
                transitional/developmental bilingual programs, or other language
                acquisition programs
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Parents may request specific language programs for their children
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                If 20+ parents at a school (or 30+ parents in a district)
                request a language acquisition program, the school/district must
                respond
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                EL students must be provided Designated and Integrated ELD
                regardless of program type
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="California Education Code Â§ 300â€“340 â€” English Language Education"
          icon={FileText}
        >
          <div className="space-y-3">
            <p>
              These sections of the California Education Code establish the
              framework for educating English Learners:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <span className="mt-0.5 h-4 w-4 shrink-0 text-center font-bold text-eld-space-indigo dark:text-eld-almond-silk">Â§</span>
                <strong className="text-foreground">EC Â§ 305:</strong> Defines
                language acquisition programs, including Structured English
                Immersion (SEI), dual-language immersion, and transitional
                bilingual programs
              </li>
              <li className="flex items-start gap-2">
                <span className="mt-0.5 h-4 w-4 shrink-0 text-center font-bold text-eld-space-indigo dark:text-eld-almond-silk">Â§</span>
                <strong className="text-foreground">EC Â§ 306:</strong>{" "}
                Establishes requirements for EL programs, including that they
                must be designed using evidence-based approaches and must lead to
                grade-level proficiency
              </li>
              <li className="flex items-start gap-2">
                <span className="mt-0.5 h-4 w-4 shrink-0 text-center font-bold text-eld-space-indigo dark:text-eld-almond-silk">Â§</span>
                <strong className="text-foreground">EC Â§ 310:</strong> Defines
                parent and community engagement requirements, including the
                parent notification and language program request process
              </li>
              <li className="flex items-start gap-2">
                <span className="mt-0.5 h-4 w-4 shrink-0 text-center font-bold text-eld-space-indigo dark:text-eld-almond-silk">Â§</span>
                <strong className="text-foreground">EC Â§ 313:</strong>{" "}
                Establishes the English Language Proficiency Assessment for
                California (ELPAC) as the state assessment for ELs
              </li>
              <li className="flex items-start gap-2">
                <span className="mt-0.5 h-4 w-4 shrink-0 text-center font-bold text-eld-space-indigo dark:text-eld-almond-silk">Â§</span>
                <strong className="text-foreground">EC Â§ 313.3:</strong>{" "}
                Defines the reclassification criteria that must be met before an
                EL can be reclassified as Fluent English Proficient (RFEP)
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="AB 2735 â€” English Learner Roadmap Implementation (2018)"
          icon={ScrollText}
        >
          <div className="space-y-3">
            <p>
              Assembly Bill 2735 aligned the California Education Code with the
              English Learner Roadmap Policy adopted by the State Board of
              Education in 2017. Key provisions:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Requires districts to provide effective EL programs based on the
                EL Roadmap principles
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Emphasizes asset-based pedagogy that values students&apos; home
                languages and cultures
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Supports the development of programs that lead to bilingualism
                and biliteracy
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="SB 463 â€” English Learner Reclassification (2019)"
          icon={ScrollText}
        >
          <div className="space-y-3">
            <p>
              Senate Bill 463 updated reclassification criteria and process
              requirements:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Established standardized statewide criteria for reclassification
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Requires comparison of EL performance to that of English-only
                peers on academic assessments
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Mandates teacher evaluation of student&apos;s English
                proficiency for reclassification
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Requires parent consultation during the reclassification process
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="California English Learner Roadmap Policy (2017)"
          icon={Target}
        >
          <div className="space-y-3">
            <p>
              The EL Roadmap, adopted by the State Board of Education, serves as
              the guiding policy document for all California districts. It is
              built on four interrelated principles:
            </p>
            <ol className="list-decimal ml-5 space-y-3">
              <li>
                <strong className="text-foreground">
                  Assets-Oriented and Needs-Responsive
                </strong>
                <p className="mt-0.5">
                  ELs&apos; home languages and cultures are valuable assets.
                  Programs should value and build on these resources while
                  addressing students&apos; linguistic and academic needs.
                </p>
              </li>
              <li>
                <strong className="text-foreground">
                  Intellectual Quality of Instruction and Meaningful Access
                </strong>
                <p className="mt-0.5">
                  ELs should engage in intellectually rich, standards-based
                  instruction with appropriate scaffolds and supports across all
                  content areas.
                </p>
              </li>
              <li>
                <strong className="text-foreground">
                  System Conditions That Support Effectiveness
                </strong>
                <p className="mt-0.5">
                  Leadership, adequate resources, professional development,
                  appropriate assessments, and family engagement create
                  conditions for effective EL programs.
                </p>
              </li>
              <li>
                <strong className="text-foreground">
                  Alignment and Articulation Within and Across Systems
                </strong>
                <p className="mt-0.5">
                  EL services should be aligned and articulated across grade
                  levels, programs, and educational systems from preschool
                  through higher education.
                </p>
              </li>
            </ol>
          </div>
        </Collapsible>
      </div>

      <SectionHeading className="pt-2">
        Key Legal Requirements for Schools
      </SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6">
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-eld-almond-silk/40 dark:border-gray-700">
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Requirement
                  </th>
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Timeline
                  </th>
                  <th className="pb-3 text-left font-semibold text-foreground">
                    Authority
                  </th>
                </tr>
              </thead>
              <tbody className="text-muted-foreground">
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Administer Home Language Survey (HLS)
                  </td>
                  <td className="py-3 pr-4">At enrollment</td>
                  <td className="py-3">EC Â§ 52164.1</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Assess potential ELs with Initial ELPAC
                  </td>
                  <td className="py-3 pr-4">Within 30 days of enrollment</td>
                  <td className="py-3">EC Â§ 313, 5 CCR Â§ 11511</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Notify parents of EL identification
                  </td>
                  <td className="py-3 pr-4">
                    Within 30 days of school year start
                  </td>
                  <td className="py-3">ESSA Title III, EC Â§ 313.2</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Provide Designated ELD instruction daily
                  </td>
                  <td className="py-3 pr-4">Daily / ongoing</td>
                  <td className="py-3">EC Â§ 305â€“306</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Provide Integrated ELD in all content
                  </td>
                  <td className="py-3 pr-4">Daily / ongoing</td>
                  <td className="py-3">EC Â§ 305â€“306</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Administer Summative ELPAC annually
                  </td>
                  <td className="py-3 pr-4">Feb 1 â€“ May 31</td>
                  <td className="py-3">EC Â§ 313</td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    Evaluate ELs for reclassification annually
                  </td>
                  <td className="py-3 pr-4">Annually</td>
                  <td className="py-3">EC Â§ 313.3</td>
                </tr>
                <tr>
                  <td className="py-3 pr-4">
                    Monitor RFEPs for academic progress
                  </td>
                  <td className="py-3 pr-4">4 years post-reclassification</td>
                  <td className="py-3">ESSA Title III</td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Rules & Compliance Tab                                             */
/* ------------------------------------------------------------------ */

function RulesTab() {
  return (
    <div className="space-y-6">
      <SectionHeading>ELD Program Compliance Requirements</SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="EL Identification & Assessment Process"
          icon={ClipboardCheck}
          defaultOpen
        >
          <div className="space-y-3">
            <p>California follows a specific process for identifying English Learners:</p>
            <ol className="list-decimal ml-5 space-y-3">
              <li>
                <strong className="text-foreground">
                  Home Language Survey (HLS):
                </strong>{" "}
                Upon enrollment, parents/guardians complete the HLS. If any of
                the first three questions indicate a language other than English,
                the student must be assessed.
              </li>
              <li>
                <strong className="text-foreground">
                  Initial ELPAC Administration:
                </strong>{" "}
                Students flagged by the HLS must take the Initial ELPAC within
                30 calendar days of enrollment. The Initial ELPAC determines if
                the student is an English Learner (EL) or an Initially Fluent
                English Proficient (IFEP) student.
              </li>
              <li>
                <strong className="text-foreground">
                  Classification:
                </strong>{" "}
                Based on the Initial ELPAC results, students are classified as
                EL or IFEP. EL students are placed in an appropriate language
                acquisition program.
              </li>
              <li>
                <strong className="text-foreground">
                  Annual Assessment:
                </strong>{" "}
                EL students take the Summative ELPAC each year until they meet
                reclassification criteria.
              </li>
            </ol>
          </div>
        </Collapsible>

        <Collapsible
          title="Reclassification Criteria (RFEP)"
          icon={GraduationCap}
        >
          <div className="space-y-3">
            <p>
              For an English Learner to be reclassified as Fluent English
              Proficient (RFEP), California requires all four of these criteria
              to be met:
            </p>
            <div className="space-y-3">
              <div className="flex items-start gap-3 rounded-lg border border-green-200 bg-green-50/50 p-3 dark:border-green-800/40 dark:bg-green-900/10">
                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-green-200 text-xs font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                  1
                </span>
                <div>
                  <strong className="text-green-800 dark:text-green-300">
                    ELPAC Overall Score:
                  </strong>
                  <p className="text-green-700/80 dark:text-green-300/70">
                    Overall performance level of 4 on the Summative ELPAC
                  </p>
                </div>
              </div>
              <div className="flex items-start gap-3 rounded-lg border border-green-200 bg-green-50/50 p-3 dark:border-green-800/40 dark:bg-green-900/10">
                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-green-200 text-xs font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                  2
                </span>
                <div>
                  <strong className="text-green-800 dark:text-green-300">
                    Teacher Evaluation:
                  </strong>
                  <p className="text-green-700/80 dark:text-green-300/70">
                    Teacher evaluation of the student&apos;s academic
                    performance, including English language arts, using an
                    objective assessment instrument (curriculum-based measures)
                  </p>
                </div>
              </div>
              <div className="flex items-start gap-3 rounded-lg border border-green-200 bg-green-50/50 p-3 dark:border-green-800/40 dark:bg-green-900/10">
                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-green-200 text-xs font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                  3
                </span>
                <div>
                  <strong className="text-green-800 dark:text-green-300">
                    Parent Consultation:
                  </strong>
                  <p className="text-green-700/80 dark:text-green-300/70">
                    Parent/guardian opinion and consultation as part of the
                    reclassification process
                  </p>
                </div>
              </div>
              <div className="flex items-start gap-3 rounded-lg border border-green-200 bg-green-50/50 p-3 dark:border-green-800/40 dark:bg-green-900/10">
                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-green-200 text-xs font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                  4
                </span>
                <div>
                  <strong className="text-green-800 dark:text-green-300">
                    Academic Performance:
                  </strong>
                  <p className="text-green-700/80 dark:text-green-300/70">
                    Comparison of student performance on an objective assessment
                    of basic skills (e.g., CAASPP/SBAC) with that of English
                    proficient students of the same age
                  </p>
                </div>
              </div>
            </div>
          </div>
        </Collapsible>

        <Collapsible
          title="Teacher Qualifications & Authorization"
          icon={Users}
        >
          <div className="space-y-3">
            <p>
              California requires specific authorizations for teachers working
              with English Learners:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    EL Authorization:
                  </strong>{" "}
                  All teachers of ELs must hold a valid EL Authorization (or
                  equivalent, such as CLAD, BCLAD, or SB 2042 credential with
                  embedded EL authorization)
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Bilingual Authorization:
                  </strong>{" "}
                  Teachers in bilingual programs must hold a Bilingual
                  Authorization in the target language
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Professional Development:
                  </strong>{" "}
                  Districts must provide ongoing professional development in
                  ELD instructional strategies for all teachers
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Instructional Time Requirements"
          icon={Clock}
        >
          <div className="space-y-3">
            <p>
              While California does not mandate an exact number of minutes for
              Designated ELD at every grade level, the following are CDE
              recommendations and common district practices:
            </p>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-eld-almond-silk/40 dark:border-gray-700">
                    <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                      Grade Level
                    </th>
                    <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                      Recommended dELD
                    </th>
                    <th className="pb-3 text-left font-semibold text-foreground">
                      Notes
                    </th>
                  </tr>
                </thead>
                <tbody className="text-muted-foreground">
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4">TKâ€“K</td>
                    <td className="py-3 pr-4">20â€“30 min/day</td>
                    <td className="py-3">
                      Focus on oral language development
                    </td>
                  </tr>
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4">Grades 1â€“3</td>
                    <td className="py-3 pr-4">30â€“45 min/day</td>
                    <td className="py-3">
                      Includes literacy-focused ELD
                    </td>
                  </tr>
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4">Grades 4â€“5</td>
                    <td className="py-3 pr-4">30â€“45 min/day</td>
                    <td className="py-3">
                      Increased academic language focus
                    </td>
                  </tr>
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4">Grades 6â€“8</td>
                    <td className="py-3 pr-4">45â€“55 min/day</td>
                    <td className="py-3">
                      Often a full class period; may be a dedicated ELD course
                    </td>
                  </tr>
                  <tr>
                    <td className="py-3 pr-4">Grades 9â€“12</td>
                    <td className="py-3 pr-4">
                      1 full period/day
                    </td>
                    <td className="py-3">
                      ELD course for credit; Newcomers may need additional
                      support
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </Collapsible>

        <Collapsible
          title="Parent Notification & Engagement Requirements"
          icon={FileText}
        >
          <div className="space-y-3">
            <p>
              Schools must comply with specific parent notification and
              engagement requirements:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Initial Notification:
                </strong>{" "}
                Parents must be informed of their child&apos;s EL status,
                proficiency level, program placement, and exit criteria within
                30 days of the start of the school year
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Annual Notification:
                </strong>{" "}
                Parents must receive annual ELPAC results and updated program
                information
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Language Access:
                </strong>{" "}
                All required notices must be provided in the parents&apos;
                primary language (when 15%+ of students speak that language)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">ELAC/DELAC:</strong> Schools
                with 21+ ELs must establish an English Learner Advisory
                Committee (ELAC); districts with 51+ ELs must have a District
                ELAC (DELAC)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Program Waiver Rights:
                </strong>{" "}
                Parents have the right to request specific language acquisition
                programs under Prop 58
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Long-Term English Learners (LTELs)"
          icon={AlertCircle}
        >
          <div className="space-y-3">
            <InfoBanner variant="warning">
              LTELs are one of the most critical equity issues in California&apos;s
              EL programs. Districts must monitor and address the needs of these
              students.
            </InfoBanner>
            <p>
              A Long-Term English Learner (LTEL) is defined as a student who has
              been classified as an EL for{" "}
              <strong className="text-foreground">six or more years</strong> and
              has not made expected progress toward English proficiency. An
              &quot;At-Risk&quot; LTEL is an EL enrolled for{" "}
              <strong className="text-foreground">four to five years</strong>{" "}
              who is not meeting proficiency benchmarks.
            </p>
            <p>California law (AB 2193, EC Â§ 313.1) requires districts to:</p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Identify and track LTELs and At-Risk LTELs
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Notify parents annually of LTEL or At-Risk status
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Provide information about the student&apos;s language
                acquisition program options
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Include LTEL data in the district&apos;s LCAP (Local Control
                Accountability Plan)
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible title="Funding & Resource Allocation" icon={Landmark}>
          <div className="space-y-3">
            <p>
              Schools receive additional funding for EL students through multiple
              channels:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">LCFF Supplemental/Concentration Grants:</strong>{" "}
                  Additional funding based on the number of EL, foster youth,
                  and low-income students in the district
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Title III Federal Funds:</strong>{" "}
                  Federal funds specifically for English Learner programs,
                  professional development, and parent engagement
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Title I Funds:</strong>{" "}
                  May be used to support EL students who are also economically
                  disadvantaged
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>
      </div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  ELPAC Tab                                                          */
/* ------------------------------------------------------------------ */

function ElpacTab() {
  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            What is the ELPAC?
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm leading-relaxed text-muted-foreground">
          <p>
            The <strong className="text-foreground">English Language Proficiency
            Assessments for California (ELPAC)</strong> is California&apos;s
            required state assessment for English language proficiency. It
            replaced the California English Language Development Test (CELDT) in
            2018. The ELPAC is aligned with the 2012 California ELD Standards
            and is administered by the California Department of Education (CDE)
            in partnership with Educational Testing Service (ETS).
          </p>
          <p>
            The ELPAC is composed of two separate assessments:
          </p>
        </CardContent>
      </Card>

      {/* Two ELPAC Types */}
      <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
        <Card>
          <CardHeader>
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30">
                <ClipboardCheck className="h-5 w-5 text-blue-600 dark:text-blue-400" />
              </div>
              <CardTitle className="text-base">Initial ELPAC</CardTitle>
            </div>
          </CardHeader>
          <CardContent className="space-y-3 text-sm text-muted-foreground">
            <p>
              Administered to newly enrolled students whose Home Language Survey
              indicates a language other than English. Determines whether a
              student is an English Learner (EL) or Initially Fluent English
              Proficient (IFEP).
            </p>
            <div className="space-y-2">
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-blue-600 dark:text-blue-400">
                  When:
                </span>
                <span>Within 30 calendar days of enrollment, year-round</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-blue-600 dark:text-blue-400">
                  Who:
                </span>
                <span>
                  New students with a non-English HLS, grades TKâ€“12
                </span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-blue-600 dark:text-blue-400">
                  Format:
                </span>
                <span>
                  Computer-based (grades 3â€“12) or paper-based (TKâ€“2); one-on-one
                  speaking assessment for all grade spans
                </span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-blue-600 dark:text-blue-400">
                  Result:
                </span>
                <span>EL or IFEP classification</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30">
                <Target className="h-5 w-5 text-purple-600 dark:text-purple-400" />
              </div>
              <CardTitle className="text-base">Summative ELPAC</CardTitle>
            </div>
          </CardHeader>
          <CardContent className="space-y-3 text-sm text-muted-foreground">
            <p>
              Administered annually to all identified English Learners.
              Measures progress toward English proficiency and provides
              data for accountability, reclassification decisions, and program
              evaluation.
            </p>
            <div className="space-y-2">
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-purple-600 dark:text-purple-400">
                  When:
                </span>
                <span>February 1 â€“ May 31, annually</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-purple-600 dark:text-purple-400">
                  Who:
                </span>
                <span>
                  All identified English Learners, grades TKâ€“12
                </span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-purple-600 dark:text-purple-400">
                  Format:
                </span>
                <span>
                  Computer-based (grades 3â€“12) or paper-based (TKâ€“2); includes
                  both group-administered and one-on-one components
                </span>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-0.5 text-xs font-bold text-purple-600 dark:text-purple-400">
                  Result:
                </span>
                <span>Performance levels 1â€“4; used for reclassification</span>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <SectionHeading>ELPAC Test Domains</SectionHeading>

      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
        {[
          {
            domain: "Listening",
            description:
              "Comprehending spoken English in academic and social contexts. Includes understanding main ideas, details, and inferences from oral presentations, conversations, and lectures.",
            examples:
              "Listen to a short lecture and answer comprehension questions; identify the main idea of a conversation between students",
            color: "blue",
          },
          {
            domain: "Speaking",
            description:
              "Producing spoken English in academic and social contexts. Assessed one-on-one with a trained examiner. Evaluates pronunciation, grammar, vocabulary, and fluency.",
            examples:
              "Describe a picture or sequence of events; summarize a short passage; present an argument or opinion on a topic",
            color: "green",
          },
          {
            domain: "Reading",
            description:
              "Comprehending written English texts, including literary and informational passages. Assesses vocabulary knowledge, text analysis, and reading comprehension.",
            examples:
              "Read a passage and answer multiple-choice questions; identify vocabulary in context; analyze text structure",
            color: "amber",
          },
          {
            domain: "Writing",
            description:
              "Producing written English for various academic purposes. Assesses organization, grammar, vocabulary usage, and the ability to convey ideas clearly in writing.",
            examples:
              "Write a short opinion essay; describe a process or event; summarize information from a passage or chart",
            color: "purple",
          },
        ].map((item) => {
          const colorMap: Record<string, string> = {
            blue: "border-blue-200 bg-blue-50/50 dark:border-blue-800/40 dark:bg-blue-900/10",
            green:
              "border-green-200 bg-green-50/50 dark:border-green-800/40 dark:bg-green-900/10",
            amber:
              "border-amber-200 bg-amber-50/50 dark:border-amber-800/40 dark:bg-amber-900/10",
            purple:
              "border-purple-200 bg-purple-50/50 dark:border-purple-800/40 dark:bg-purple-900/10",
          };
          const textMap: Record<string, string> = {
            blue: "text-blue-800 dark:text-blue-300",
            green: "text-green-800 dark:text-green-300",
            amber: "text-amber-800 dark:text-amber-300",
            purple: "text-purple-800 dark:text-purple-300",
          };
          return (
            <div
              key={item.domain}
              className={`rounded-xl border p-4 ${colorMap[item.color]}`}
            >
              <h3 className={`font-semibold ${textMap[item.color]}`}>
                {item.domain}
              </h3>
              <p className="mt-1.5 text-sm text-muted-foreground">
                {item.description}
              </p>
              <p className="mt-2 text-xs text-muted-foreground/80">
                <strong className="text-muted-foreground">
                  Sample tasks:
                </strong>{" "}
                {item.examples}
              </p>
            </div>
          );
        })}
      </div>

      <SectionHeading>ELPAC Performance Levels</SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4">
          <p className="text-sm text-muted-foreground">
            The Summative ELPAC reports results using four overall performance
            levels. Each domain (Listening, Speaking, Reading, Writing) also
            receives a score of 1â€“3 (Beginning, Somewhat/Moderately Developed,
            Well Developed).
          </p>

          <div className="space-y-3">
            <div className="flex items-start gap-3 rounded-lg border border-red-200 bg-red-50/50 p-3 dark:border-red-800/40 dark:bg-red-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-red-200 text-sm font-bold text-red-800 dark:bg-red-800 dark:text-red-200">
                1
              </span>
              <div>
                <strong className="text-red-800 dark:text-red-300">
                  Level 1 â€” Minimally Developed
                </strong>
                <p className="mt-0.5 text-sm text-red-700/80 dark:text-red-300/70">
                  English proficiency is at the early stages. Student
                  demonstrates minimal understanding and use of English in
                  listening, speaking, reading, and writing. Corresponds roughly
                  to the lower range of the Emerging proficiency level.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-lg border border-orange-200 bg-orange-50/50 p-3 dark:border-orange-800/40 dark:bg-orange-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-orange-200 text-sm font-bold text-orange-800 dark:bg-orange-800 dark:text-orange-200">
                2
              </span>
              <div>
                <strong className="text-orange-800 dark:text-orange-300">
                  Level 2 â€” Somewhat Developed
                </strong>
                <p className="mt-0.5 text-sm text-orange-700/80 dark:text-orange-300/70">
                  Student demonstrates some understanding and use of English.
                  Can communicate basic ideas but struggles with more complex
                  academic language. Corresponds roughly to the upper Emerging /
                  lower Expanding range.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-lg border border-yellow-200 bg-yellow-50/50 p-3 dark:border-yellow-800/40 dark:bg-yellow-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-yellow-200 text-sm font-bold text-yellow-800 dark:bg-yellow-800 dark:text-yellow-200">
                3
              </span>
              <div>
                <strong className="text-yellow-800 dark:text-yellow-300">
                  Level 3 â€” Moderately Developed
                </strong>
                <p className="mt-0.5 text-sm text-yellow-700/80 dark:text-yellow-300/70">
                  Student demonstrates increasing understanding and use of
                  English in academic contexts. Can communicate ideas with some
                  detail and use a growing range of academic vocabulary.
                  Corresponds roughly to the Expanding / lower Bridging range.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-lg border border-green-200 bg-green-50/50 p-3 dark:border-green-800/40 dark:bg-green-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-green-200 text-sm font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                4
              </span>
              <div>
                <strong className="text-green-800 dark:text-green-300">
                  Level 4 â€” Well Developed
                </strong>
                <p className="mt-0.5 text-sm text-green-700/80 dark:text-green-300/70">
                  Student demonstrates strong understanding and use of English
                  in academic contexts. Proficiency is comparable to that of
                  native English speakers for the grade level. This is the level
                  required for reclassification consideration.
                </p>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <SectionHeading>ELPAC Grade Spans</SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6">
          <p className="mb-4 text-sm text-muted-foreground">
            The ELPAC is organized into grade-span groupings. Each grade span
            has test items calibrated to the developmental and linguistic
            expectations for that age group:
          </p>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-eld-almond-silk/40 dark:border-gray-700">
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Grade Span
                  </th>
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Grades
                  </th>
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Test Format
                  </th>
                  <th className="pb-3 text-left font-semibold text-foreground">
                    Key Features
                  </th>
                </tr>
              </thead>
              <tbody className="text-muted-foreground">
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 1
                  </td>
                  <td className="py-3 pr-4">TKâ€“K</td>
                  <td className="py-3 pr-4">Paper-based, 1-on-1</td>
                  <td className="py-3">
                    Entirely one-on-one administration; focuses on oral language
                  </td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 2
                  </td>
                  <td className="py-3 pr-4">Grade 1</td>
                  <td className="py-3 pr-4">Paper-based, mixed</td>
                  <td className="py-3">
                    Mix of one-on-one and group tasks; beginning literacy
                    assessed
                  </td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 3
                  </td>
                  <td className="py-3 pr-4">Grade 2</td>
                  <td className="py-3 pr-4">Paper-based, mixed</td>
                  <td className="py-3">
                    Increased reading/writing demands; one-on-one speaking
                  </td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 4
                  </td>
                  <td className="py-3 pr-4">Grades 3â€“5</td>
                  <td className="py-3 pr-4">Computer-based + 1-on-1</td>
                  <td className="py-3">
                    Computer-based for Listening, Reading, Writing; one-on-one
                    Speaking
                  </td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 5
                  </td>
                  <td className="py-3 pr-4">Grades 6â€“8</td>
                  <td className="py-3 pr-4">Computer-based + 1-on-1</td>
                  <td className="py-3">
                    More complex academic texts and tasks; grade-appropriate
                    content
                  </td>
                </tr>
                <tr>
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Span 6
                  </td>
                  <td className="py-3 pr-4">Grades 9â€“12</td>
                  <td className="py-3 pr-4">Computer-based + 1-on-1</td>
                  <td className="py-3">
                    Advanced academic language; college and career readiness
                    focus
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      <SectionHeading>ELPAC Scoring & Reporting</SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="How ELPAC Scores Are Calculated"
          icon={Target}
          defaultOpen
        >
          <div className="space-y-3">
            <p>The ELPAC produces several types of scores:</p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Scale Scores:</strong>{" "}
                  Numeric scores for each domain and overall. Scale scores allow
                  comparison across administrations and grade spans.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Overall Performance Level (1â€“4):
                  </strong>{" "}
                  Based on the combined scale scores across all four domains.
                  Level 4 is required for reclassification.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Domain Performance Levels (1â€“3):
                  </strong>{" "}
                  Each domain receives a level of Beginning (1),
                  Somewhat/Moderately Developed (2), or Well Developed (3).
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Score Reports & Data Access"
          icon={FileText}
        >
          <div className="space-y-3">
            <p>
              ELPAC results are communicated through several channels:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Student Score Reports (SSRs):
                  </strong>{" "}
                  Individual reports sent to parents/guardians showing overall
                  and domain scores, performance levels, and descriptors. Must
                  be provided in the parent&apos;s primary language when
                  available.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    TOMS (Test Operations Management System):
                  </strong>{" "}
                  Districts access detailed student-level data through the CDE&apos;s
                  TOMS platform for program evaluation and reclassification
                  decisions.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    DataQuest:
                  </strong>{" "}
                  Aggregate ELPAC data is available publicly through the CDE&apos;s
                  DataQuest tool for research and accountability purposes.
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="ELPAC Testing Accommodations & Accessibility"
          icon={Shield}
        >
          <div className="space-y-3">
            <p>
              The ELPAC provides accommodations and accessibility resources
              for students with disabilities and other special needs:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Universal Tools:
                </strong>{" "}
                Available to all students (e.g., scratch paper, highlighter
                tool, zoom/magnification)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Designated Supports:
                </strong>{" "}
                Available for students with documented needs (e.g., separate
                testing room, extended time, specialized lighting)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Accommodations:
                </strong>{" "}
                For students with IEPs or 504 plans (e.g., braille, speech-to-text,
                scribe, American Sign Language for non-listening items)
              </li>
            </ul>
            <InfoBanner variant="info">
              Accommodations must be documented in the student&apos;s IEP or 504
              plan and entered into TOMS prior to testing. Not all
              accommodations apply to all domains.
            </InfoBanner>
          </div>
        </Collapsible>

        <Collapsible title="ELPAC Test Preparation Tips for Educators" icon={BookOpen}>
          <div className="space-y-3">
            <p>
              While the ELPAC is designed to measure English proficiency rather
              than content knowledge, educators can support students by:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Familiarizing students with the test format using CDE-provided
                practice tests and training tests
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Building academic vocabulary across all content areas throughout
                the year
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Providing regular opportunities for academic speaking and
                discussion (Socratic seminars, partner talk, presentations)
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Teaching text analysis and close reading strategies aligned with
                ELD standards
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Incorporating regular writing practice with focus on organization,
                grammar, and vocabulary
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                Using scaffolding strategies that gradually release support as
                students gain proficiency
              </li>
            </ul>
          </div>
        </Collapsible>
      </div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Guides & Resources Tab                                             */
/* ------------------------------------------------------------------ */

function GuidesTab() {
  return (
    <div className="space-y-6">
      <SectionHeading>Scaffolding Strategies for ELD</SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="Sentence Frames & Sentence Starters"
          icon={FileText}
          defaultOpen
        >
          <div className="space-y-3">
            <p>
              Sentence frames and starters are one of the most widely used ELD
              scaffolding strategies. They provide linguistic structures that
              support students in producing academic language.
            </p>
            <div className="space-y-3">
              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">For Emerging Students</h4>
                <ul className="mt-2 space-y-1 text-sm">
                  <li>&bull; &quot;The main idea is ___.&quot;</li>
                  <li>&bull; &quot;I see/hear/notice ___.&quot;</li>
                  <li>&bull; &quot;This is about ___.&quot;</li>
                  <li>&bull; &quot;I agree/disagree because ___.&quot;</li>
                </ul>
              </div>
              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">For Expanding Students</h4>
                <ul className="mt-2 space-y-1 text-sm">
                  <li>&bull; &quot;According to the text, ___ because ___.&quot;</li>
                  <li>&bull; &quot;One important detail is ___, which shows ___.&quot;</li>
                  <li>&bull; &quot;I would argue that ___ because ___.&quot;</li>
                  <li>&bull; &quot;The author&apos;s purpose is to ___ by ___.&quot;</li>
                </ul>
              </div>
              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">For Bridging Students</h4>
                <ul className="mt-2 space-y-1 text-sm">
                  <li>&bull; &quot;While some may argue ___, the evidence suggests ___.&quot;</li>
                  <li>&bull; &quot;The significance of ___ can be understood through ___.&quot;</li>
                  <li>&bull; &quot;This connects to the broader theme of ___ in that ___.&quot;</li>
                </ul>
              </div>
            </div>
          </div>
        </Collapsible>

        <Collapsible
          title="Graphic Organizers"
          icon={BookOpen}
        >
          <div className="space-y-3">
            <p>
              Graphic organizers help ELs visually organize information and
              understand relationships between concepts. Effective types include:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Venn Diagrams:</strong>{" "}
                  Compare and contrast concepts, characters, or events
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">T-Charts:</strong>{" "}
                  Organize pros/cons, cause/effect, or fact/opinion
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Flow Charts:</strong>{" "}
                  Sequence events, processes, or steps in a procedure
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Concept Maps:</strong>{" "}
                  Show relationships between key concepts and vocabulary
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Frayer Models:
                  </strong>{" "}
                  Deep vocabulary development (definition, characteristics,
                  examples, non-examples)
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Vocabulary Development Strategies"
          icon={BookOpen}
        >
          <div className="space-y-3">
            <p>
              Building academic vocabulary is central to ELD. Research-based
              strategies include:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Tiered Vocabulary Instruction:
                  </strong>{" "}
                  Focus on Tier 2 (general academic) and Tier 3 (domain-specific)
                  vocabulary with explicit instruction and multiple exposures
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Word Walls:
                  </strong>{" "}
                  Display high-frequency academic words with student-friendly
                  definitions, visuals, and home-language translations
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Cognate Charts:
                  </strong>{" "}
                  Leverage Spanish-English cognates (and other languages) to
                  build vocabulary connections
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Total Physical Response (TPR):
                  </strong>{" "}
                  Connect vocabulary to physical movements for kinesthetic
                  learning, especially effective for Emerging-level students
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Personal Dictionaries/Word Journals:
                  </strong>{" "}
                  Students maintain personal vocabulary logs with definitions,
                  drawings, sentences, and translations
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Collaborative Learning Structures"
          icon={Users}
        >
          <div className="space-y-3">
            <p>
              Collaborative structures provide ELs with opportunities for
              meaningful interaction and language practice:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Think-Pair-Share:</strong>{" "}
                  Students think individually, discuss with a partner, then
                  share with the group. Provides processing time and a low-stakes
                  speaking opportunity.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Numbered Heads Together:</strong>{" "}
                  Small groups discuss and prepare answers, then one member is
                  randomly selected to share, ensuring accountability.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Literature Circles:</strong>{" "}
                  Students take assigned roles (discussion director, vocabulary
                  enricher, summarizer) to discuss a shared text.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Gallery Walks:</strong>{" "}
                  Students circulate to view and discuss posted work, providing
                  opportunities for reading, writing, and speaking.
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">Reciprocal Teaching:</strong>{" "}
                  Students take turns leading discussions using four strategies:
                  predicting, questioning, clarifying, and summarizing.
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Differentiation by Proficiency Level"
          icon={Target}
        >
          <div className="space-y-3">
            <p>
              Effective ELD instruction differentiates based on student
              proficiency levels. Here is a guide for differentiating common
              classroom tasks:
            </p>

            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-eld-almond-silk/40 dark:border-gray-700">
                    <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                      Strategy
                    </th>
                    <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                      <span className="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-300">
                        Emerging
                      </span>
                    </th>
                    <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                      <span className="inline-flex items-center rounded-full bg-orange-100 px-2 py-0.5 text-xs font-medium text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
                        Expanding
                      </span>
                    </th>
                    <th className="pb-3 text-left font-semibold text-foreground">
                      <span className="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-300">
                        Bridging
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody className="text-muted-foreground">
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4 font-medium text-foreground">
                      Reading
                    </td>
                    <td className="py-3 pr-4">
                      Adapted text with visuals; teacher read-aloud; partner
                      reading
                    </td>
                    <td className="py-3 pr-4">
                      Grade-level text with glossary; guided reading groups
                    </td>
                    <td className="py-3">
                      Grade-level text with minimal support; independent close
                      reading
                    </td>
                  </tr>
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4 font-medium text-foreground">
                      Writing
                    </td>
                    <td className="py-3 pr-4">
                      Sentence frames; word banks; labeled drawings; cloze
                      paragraphs
                    </td>
                    <td className="py-3 pr-4">
                      Paragraph frames; sentence starters; model texts; graphic
                      organizers
                    </td>
                    <td className="py-3">
                      Essay prompts with rubric; peer revision; mentor texts
                    </td>
                  </tr>
                  <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                    <td className="py-3 pr-4 font-medium text-foreground">
                      Speaking
                    </td>
                    <td className="py-3 pr-4">
                      Repetition; choral response; simple partner talk with
                      frames
                    </td>
                    <td className="py-3 pr-4">
                      Small group discussions; structured academic conversations
                    </td>
                    <td className="py-3">
                      Socratic seminars; formal presentations; debates
                    </td>
                  </tr>
                  <tr>
                    <td className="py-3 pr-4 font-medium text-foreground">
                      Assessment
                    </td>
                    <td className="py-3 pr-4">
                      Picture-based; oral responses; matching; drawing
                    </td>
                    <td className="py-3 pr-4">
                      Short constructed response; modified rubrics; graphic
                      organizer-based
                    </td>
                    <td className="py-3">
                      Grade-level assessments with minor accommodations
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </Collapsible>
      </div>

      <SectionHeading className="pt-2">
        Newcomer Student Support
      </SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4 text-sm leading-relaxed text-muted-foreground">
          <p>
            Newcomer students (those who have been in U.S. schools for fewer
            than 12 months) require additional support beyond standard ELD
            instruction:
          </p>
          <ul className="space-y-2 ml-1">
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Newcomer Programs:
                </strong>{" "}
                Some districts offer dedicated newcomer programs or academies
                that provide intensive English instruction and acculturation
                support for the first 1â€“2 years
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Primary Language Support:
                </strong>{" "}
                Use of the student&apos;s home language (through bilingual aides,
                translated materials, or bilingual instruction) to support
                content understanding while English develops
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Survival English:
                </strong>{" "}
                Immediate focus on essential vocabulary and phrases for navigating
                school and daily life
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Social-Emotional Support:
                </strong>{" "}
                Addressing the cultural adjustment, potential trauma, and
                social isolation that newcomer students may experience
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  SLIFE Considerations:
                </strong>{" "}
                Students with Limited or Interrupted Formal Education (SLIFE)
                may need additional academic foundations alongside English
                language instruction
              </div>
            </li>
          </ul>
        </CardContent>
      </Card>

      <SectionHeading className="pt-2">
        Official California ELD Resources
      </SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6">
          <div className="space-y-3">
            {[
              {
                title: "CA ELD Standards",
                description:
                  "The full California ELD Standards document, including proficiency level descriptors and standard progressions.",
                source: "California Department of Education",
              },
              {
                title: "ELA/ELD Framework",
                description:
                  "The comprehensive California ELA/ELD Framework with guidance on curriculum, instruction, and assessment for both ELA and ELD.",
                source: "California Department of Education",
              },
              {
                title: "English Learner Roadmap Policy",
                description:
                  "The State Board of Education policy document guiding EL programs with four key principles for serving English Learners.",
                source: "California State Board of Education",
              },
              {
                title: "ELPAC Practice & Training Tests",
                description:
                  "Free practice and training tests from CDE/ETS for all grade spans. Helps students become familiar with the test format.",
                source: "CDE / Educational Testing Service",
              },
              {
                title: "EL Roadmap Toolkits",
                description:
                  "Implementation toolkits for districts and schools to put the EL Roadmap principles into practice across all content areas.",
                source: "Californians Together / SEAL",
              },
              {
                title: "Improving Education for Multilingual and English Learner Students: Research to Practice",
                description:
                  "CDE research publication providing evidence-based guidance on effective instructional practices for English Learners.",
                source: "California Department of Education",
              },
            ].map((resource) => (
              <div
                key={resource.title}
                className="flex items-start gap-3 rounded-lg border border-eld-almond-silk/30 p-3 dark:border-gray-700/50"
              >
                <div className="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-eld-almond-silk/20 dark:bg-eld-dusty-grape/20">
                  <FileText className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
                </div>
                <div>
                  <h4 className="font-semibold text-foreground text-sm">
                    {resource.title}
                  </h4>
                  <p className="mt-0.5 text-xs text-muted-foreground">
                    {resource.description}
                  </p>
                  <p className="mt-1 text-xs text-muted-foreground/70">
                    Source: {resource.source}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Main Page Component                                                */
/* ------------------------------------------------------------------ */

export default function ELDGuidePage() {
  const [activeTab, setActiveTab] = useState("overview");

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div>
        <h1 className="scaffold-heading">California ELD Guide</h1>
        <p className="scaffold-description mt-1">
          Comprehensive resource for English Language Development standards,
          legal requirements, ELPAC assessment, and instructional strategies
          in California.
        </p>
      </div>

      {/* Hero Banner */}
      <div className="flex flex-col gap-4 rounded-2xl border border-eld-almond-silk/40 bg-white p-5 md:flex-row md:items-center md:gap-6 md:p-6 dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="flex h-14 w-14 shrink-0 items-center justify-center rounded-xl bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
          <BookOpen className="h-7 w-7 text-eld-space-indigo dark:text-eld-almond-silk" />
        </div>
        <div>
          <h2 className="text-lg font-bold text-foreground">
            Everything You Need to Know About ELD in California
          </h2>
          <p className="mt-1 text-sm text-muted-foreground">
            This guide covers California ELD Standards, federal and state
            legal requirements, ELPAC assessment details, reclassification
            criteria, instructional strategies, and resources for educators
            working with English Learners.
          </p>
        </div>
      </div>

      {/* ELPAC Dedicated Page Link */}
      <Link
        href="/eld-guide/elpac"
        className="group flex items-center justify-between gap-4 rounded-2xl border border-purple-200/60 bg-purple-50/50 p-4 md:p-5 transition-colors hover:bg-purple-100/50 dark:border-purple-800/30 dark:bg-purple-900/10 dark:hover:bg-purple-900/20"
      >
        <div className="flex items-center gap-4">
          <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30">
            <ClipboardCheck className="h-5 w-5 text-purple-600 dark:text-purple-400" />
          </div>
          <div>
            <h3 className="text-sm font-bold text-purple-900 dark:text-purple-200">
              ELPAC Assessment Guide
            </h3>
            <p className="text-xs text-purple-700/80 dark:text-purple-300/70">
              In-depth guide to the Initial &amp; Summative ELPAC â€” test
              domains, scoring, performance levels, administration, and
              reclassification.
            </p>
          </div>
        </div>
        <ArrowRight className="h-5 w-5 shrink-0 text-purple-400 transition-transform group-hover:translate-x-1 dark:text-purple-500" />
      </Link>

      {/* Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
          <TabsList className="min-w-max">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="legal">Legal &amp; Legislation</TabsTrigger>
            <TabsTrigger value="rules">Rules &amp; Compliance</TabsTrigger>
            <TabsTrigger value="elpac">ELPAC</TabsTrigger>
            <TabsTrigger value="guides">Guides &amp; Resources</TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="overview">
          <OverviewTab />
        </TabsContent>
        <TabsContent value="legal">
          <LegalTab />
        </TabsContent>
        <TabsContent value="rules">
          <RulesTab />
        </TabsContent>
        <TabsContent value="elpac">
          <ElpacTab />
        </TabsContent>
        <TabsContent value="guides">
          <GuidesTab />
        </TabsContent>
      </Tabs>
    </div>
  );
}
"use client";

import { useState } from "react";
import Link from "next/link";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  ArrowLeft,
  ClipboardCheck,
  Target,
  FileText,
  Shield,
  BookOpen,
  CheckCircle2,
  ChevronDown,
  ChevronUp,
  Info,
  AlertCircle,
  Clock,
  Users,
  GraduationCap,
  BarChart3,
  Calendar,
  HelpCircle,
  Lightbulb,
  ListChecks,
  MessageSquare,
  Pencil,
  Headphones,
  Mic,
} from "lucide-react";

/* ------------------------------------------------------------------ */
/*  Shared Components                                                  */
/* ------------------------------------------------------------------ */

function Collapsible({
  title,
  children,
  defaultOpen = false,
  icon: Icon,
}: {
  title: string;
  children: React.ReactNode;
  defaultOpen?: boolean;
  icon?: React.ComponentType<{ className?: string }>;
}) {
  const [open, setOpen] = useState(defaultOpen);

  return (
    <div className="rounded-xl border border-eld-almond-silk/40 dark:border-gray-700/60 overflow-hidden">
      <button
        type="button"
        onClick={() => setOpen(!open)}
        className="flex w-full items-center justify-between gap-3 px-4 py-3.5 md:px-5 md:py-4 text-left font-semibold text-foreground hover:bg-eld-almond-silk/10 dark:hover:bg-white/[0.03] transition-colors"
      >
        <div className="flex items-center gap-3">
          {Icon && (
            <div className="flex h-8 w-8 shrink-0 items-center justify-center rounded-lg bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
              <Icon className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          )}
          <span className="text-sm md:text-base">{title}</span>
        </div>
        {open ? (
          <ChevronUp className="h-4 w-4 shrink-0 text-muted-foreground" />
        ) : (
          <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground" />
        )}
      </button>
      {open && (
        <div className="border-t border-eld-almond-silk/30 dark:border-gray-700/40 px-4 py-4 md:px-5 md:py-5 text-sm leading-relaxed text-muted-foreground">
          {children}
        </div>
      )}
    </div>
  );
}

function InfoBanner({
  children,
  variant = "info",
}: {
  children: React.ReactNode;
  variant?: "info" | "warning" | "success";
}) {
  const styles = {
    info: "border-blue-200 bg-blue-50 text-blue-800 dark:border-blue-800/40 dark:bg-blue-900/20 dark:text-blue-300",
    warning:
      "border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-800/40 dark:bg-amber-900/20 dark:text-amber-300",
    success:
      "border-green-200 bg-green-50 text-green-800 dark:border-green-800/40 dark:bg-green-900/20 dark:text-green-300",
  };

  const icons = {
    info: Info,
    warning: AlertCircle,
    success: CheckCircle2,
  };

  const IconComponent = icons[variant];

  return (
    <div
      className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${styles[variant]}`}
    >
      <IconComponent className="mt-0.5 h-4 w-4 shrink-0" />
      <div>{children}</div>
    </div>
  );
}

function SectionHeading({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <h2
      className={`text-lg md:text-xl font-bold text-foreground ${className}`}
    >
      {children}
    </h2>
  );
}

/* ------------------------------------------------------------------ */
/*  Assessment Overview Tab                                            */
/* ------------------------------------------------------------------ */

function AssessmentOverviewTab() {
  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">
            About the ELPAC
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm leading-relaxed text-muted-foreground">
          <p>
            The <strong className="text-foreground">English Language Proficiency
            Assessments for California (ELPAC)</strong> is the required state
            test for English language proficiency (ELP) that must be given to
            students whose primary language is a language other than English.
            State and federal law require that local educational agencies (LEAs)
            administer a state test of ELP to eligible students in kindergarten
            (or year one of a two-year kindergarten program, sometimes referred
            to as &quot;transitional kindergarten&quot;) through grade twelve.
          </p>
          <p>
            The ELPAC is aligned with the 2012 California English Language
            Development Standards. It was developed by the California Department
            of Education (CDE) in partnership with Educational Testing Service
            (ETS) and replaced the California English Language Development Test
            (CELDT) beginning in 2017â€“18.
          </p>
          <p>
            The ELPAC has two components:
          </p>
          <ul className="space-y-2 ml-1">
            <li className="flex items-start gap-2">
              <span className="mt-0.5 h-4 w-4 shrink-0 flex items-center justify-center rounded-full bg-blue-200 dark:bg-blue-800 text-[10px] font-bold text-blue-800 dark:text-blue-200">1</span>
              <strong className="text-foreground">Initial ELPAC</strong> â€” Used to identify students as English Learners (ELs) or as Initially Fluent English Proficient (IFEP)
            </li>
            <li className="flex items-start gap-2">
              <span className="mt-0.5 h-4 w-4 shrink-0 flex items-center justify-center rounded-full bg-purple-200 dark:bg-purple-800 text-[10px] font-bold text-purple-800 dark:text-purple-200">2</span>
              <strong className="text-foreground">Summative ELPAC</strong> â€” Administered annually to measure an EL student&apos;s progress in learning English and to identify the student&apos;s ELP level
            </li>
          </ul>
        </CardContent>
      </Card>

      {/* Initial vs Summative Comparison */}
      <SectionHeading>Initial ELPAC vs. Summative ELPAC</SectionHeading>

      <div className="grid grid-cols-1 gap-4 lg:grid-cols-2">
        <Card className="border-blue-200/50 dark:border-blue-800/30">
          <CardHeader className="pb-3">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30">
                <ClipboardCheck className="h-5 w-5 text-blue-600 dark:text-blue-400" />
              </div>
              <CardTitle className="text-base">Initial ELPAC</CardTitle>
            </div>
          </CardHeader>
          <CardContent className="space-y-4 text-sm text-muted-foreground">
            <div className="space-y-3">
              <div className="flex items-start gap-2">
                <Target className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">Purpose:</strong>{" "}
                  Determine whether a student is an English Learner or Initially
                  Fluent English Proficient (IFEP)
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Users className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">Who Takes It:</strong>{" "}
                  Students new to California public schools whose Home Language
                  Survey (HLS) indicates a language other than English
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Calendar className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">When:</strong>{" "}
                  Within 30 calendar days of initial enrollment; administered
                  year-round
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Clock className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">Duration:</strong>{" "}
                  Approximately 30â€“45 minutes for TKâ€“2; 45â€“75 minutes for
                  grades 3â€“12 (untimed)
                </div>
              </div>
              <div className="flex items-start gap-2">
                <FileText className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">Format:</strong>{" "}
                  Paper-based for TKâ€“2; computer-based for 3â€“12; one-on-one
                  Speaking component for all grades
                </div>
              </div>
              <div className="flex items-start gap-2">
                <BarChart3 className="mt-0.5 h-4 w-4 shrink-0 text-blue-500" />
                <div>
                  <strong className="text-foreground">Results:</strong>{" "}
                  Binary classification: EL or IFEP. Score reports available
                  within 3 weeks of testing.
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-purple-200/50 dark:border-purple-800/30">
          <CardHeader className="pb-3">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30">
                <Target className="h-5 w-5 text-purple-600 dark:text-purple-400" />
              </div>
              <CardTitle className="text-base">Summative ELPAC</CardTitle>
            </div>
          </CardHeader>
          <CardContent className="space-y-4 text-sm text-muted-foreground">
            <div className="space-y-3">
              <div className="flex items-start gap-2">
                <Target className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">Purpose:</strong>{" "}
                  Measure annual progress toward English proficiency; provide
                  data for reclassification, accountability, and program
                  evaluation
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Users className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">Who Takes It:</strong>{" "}
                  All currently identified English Learners in California
                  public schools, grades TKâ€“12
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Calendar className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">When:</strong>{" "}
                  Annually during a fixed testing window, February 1 through
                  May 31
                </div>
              </div>
              <div className="flex items-start gap-2">
                <Clock className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">Duration:</strong>{" "}
                  Varies by grade span; approximately 1.5â€“3.5 hours across
                  multiple sessions (untimed)
                </div>
              </div>
              <div className="flex items-start gap-2">
                <FileText className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">Format:</strong>{" "}
                  Paper-based for TKâ€“2; computer-based for 3â€“12; includes both
                  group-administered and one-on-one components
                </div>
              </div>
              <div className="flex items-start gap-2">
                <BarChart3 className="mt-0.5 h-4 w-4 shrink-0 text-purple-500" />
                <div>
                  <strong className="text-foreground">Results:</strong>{" "}
                  Overall performance level 1â€“4; domain levels 1â€“3; scale
                  scores. Level 4 required for reclassification consideration.
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Key Dates */}
      <SectionHeading>ELPAC Key Dates &amp; Timeline</SectionHeading>
      <Card>
        <CardContent className="pt-5 md:pt-6">
          <div className="relative space-y-0">
            {[
              {
                period: "Year-round",
                event: "Initial ELPAC Administration",
                detail:
                  "Administer within 30 calendar days of a student's first enrollment in a California public school.",
              },
              {
                period: "July â€“ January",
                event: "Summative ELPAC Preparation",
                detail:
                  "LEAs prepare test settings in TOMS, assign test examiners, coordinate logistics, and train staff.",
              },
              {
                period: "February 1 â€“ May 31",
                event: "Summative ELPAC Testing Window",
                detail:
                  "All identified ELs take the Summative ELPAC. Both group and one-on-one components must be completed within the window.",
              },
              {
                period: "June â€“ August",
                event: "Score Reporting & Data Analysis",
                detail:
                  "Score reports are released to districts. Student Score Reports (SSRs) are generated for parents. Districts analyze data for program evaluation.",
              },
              {
                period: "Ongoing (post-results)",
                event: "Reclassification Review",
                detail:
                  "Districts evaluate ELs who scored Level 4 against all reclassification criteria. Parent consultation occurs. Eligible students are reclassified as RFEP.",
              },
              {
                period: "4 years post-RFEP",
                event: "RFEP Monitoring Period",
                detail:
                  "Reclassified students are monitored for academic progress for four years. If they struggle, additional support is provided.",
              },
            ].map((item, index) => (
              <div key={index} className="flex gap-4 pb-6 last:pb-0">
                <div className="flex flex-col items-center">
                  <div className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-eld-almond-silk/40 dark:bg-eld-dusty-grape/40">
                    <span className="text-xs font-bold text-eld-space-indigo dark:text-eld-almond-silk">
                      {index + 1}
                    </span>
                  </div>
                  {index < 5 && (
                    <div className="mt-1 h-full w-px bg-eld-almond-silk/30 dark:bg-gray-700" />
                  )}
                </div>
                <div className="pb-2">
                  <span className="text-xs font-semibold uppercase tracking-wider text-muted-foreground/70">
                    {item.period}
                  </span>
                  <h4 className="mt-0.5 font-semibold text-foreground">
                    {item.event}
                  </h4>
                  <p className="mt-1 text-sm text-muted-foreground">
                    {item.detail}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Test Domains Tab                                                   */
/* ------------------------------------------------------------------ */

function DomainsTab() {
  return (
    <div className="space-y-6">
      <SectionHeading>The Four ELPAC Domains</SectionHeading>

      <p className="text-sm text-muted-foreground">
        The ELPAC assesses English language proficiency across four domains.
        Each domain is assessed separately and receives its own score. The
        four domain scores combine to produce an overall performance level.
      </p>

      {/* Listening */}
      <Card className="border-blue-200/40 dark:border-blue-800/20">
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30">
              <Headphones className="h-6 w-6 text-blue-600 dark:text-blue-400" />
            </div>
            <div>
              <CardTitle className="text-lg">Listening</CardTitle>
              <p className="text-sm text-muted-foreground">
                Comprehension of spoken English
              </p>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-muted-foreground">
          <p>
            The Listening domain assesses students&apos; ability to understand
            spoken English in both academic and social contexts. Students listen
            to a variety of audio stimuli and respond to questions.
          </p>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="rounded-lg bg-blue-50/50 p-3 dark:bg-blue-900/10">
              <h4 className="font-semibold text-blue-800 dark:text-blue-300">
                Task Types
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-blue-700/80 dark:text-blue-300/70">
                <li>&bull; Listen to a short conversation</li>
                <li>&bull; Listen to a classroom presentation</li>
                <li>&bull; Listen to an academic lecture</li>
                <li>&bull; Listen to a read-aloud story</li>
                <li>&bull; Listen and identify main idea/details</li>
              </ul>
            </div>
            <div className="rounded-lg bg-blue-50/50 p-3 dark:bg-blue-900/10">
              <h4 className="font-semibold text-blue-800 dark:text-blue-300">
                Skills Assessed
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-blue-700/80 dark:text-blue-300/70">
                <li>&bull; Identifying main ideas and key details</li>
                <li>&bull; Making inferences from spoken text</li>
                <li>&bull; Understanding academic vocabulary in context</li>
                <li>&bull; Following multi-step oral directions</li>
                <li>&bull; Recognizing language used for different purposes</li>
              </ul>
            </div>
          </div>
          <div className="rounded-lg border border-blue-200 bg-blue-50/30 p-3 dark:border-blue-800/40 dark:bg-blue-900/5">
            <h4 className="font-semibold text-blue-800 dark:text-blue-300 text-xs uppercase tracking-wider">
              Administration Notes
            </h4>
            <p className="mt-1 text-sm text-blue-700/80 dark:text-blue-300/70">
              The Listening domain is group-administered for grades 3â€“12
              (computer-based) and individually administered for TKâ€“2 (paper-based).
              Audio is played through headphones (computer) or read aloud by the
              examiner (paper). Students may listen to each audio clip up to
              three times (grades TKâ€“2) or twice (grades 3â€“12).
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Speaking */}
      <Card className="border-green-200/40 dark:border-green-800/20">
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-green-100 dark:bg-green-900/30">
              <Mic className="h-6 w-6 text-green-600 dark:text-green-400" />
            </div>
            <div>
              <CardTitle className="text-lg">Speaking</CardTitle>
              <p className="text-sm text-muted-foreground">
                Production of spoken English
              </p>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-muted-foreground">
          <p>
            The Speaking domain is always administered one-on-one with a
            trained test examiner. This allows for authentic assessment of oral
            language skills including pronunciation, grammar, vocabulary,
            fluency, and discourse.
          </p>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="rounded-lg bg-green-50/50 p-3 dark:bg-green-900/10">
              <h4 className="font-semibold text-green-800 dark:text-green-300">
                Task Types
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-green-700/80 dark:text-green-300/70">
                <li>&bull; Describe a picture or scene</li>
                <li>&bull; Retell a story or sequence events</li>
                <li>&bull; Summarize a passage read aloud</li>
                <li>&bull; Present an opinion with supporting reasons</li>
                <li>&bull; Respond to academic prompts orally</li>
                <li>&bull; Engage in a brief conversation with the examiner</li>
              </ul>
            </div>
            <div className="rounded-lg bg-green-50/50 p-3 dark:bg-green-900/10">
              <h4 className="font-semibold text-green-800 dark:text-green-300">
                Skills Assessed
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-green-700/80 dark:text-green-300/70">
                <li>&bull; Oral fluency and coherence</li>
                <li>&bull; Vocabulary usage and precision</li>
                <li>&bull; Grammatical accuracy and complexity</li>
                <li>&bull; Pronunciation and intelligibility</li>
                <li>&bull; Discourse organization</li>
                <li>&bull; Use of academic language registers</li>
              </ul>
            </div>
          </div>
          <InfoBanner variant="info">
            The Speaking domain is the most resource-intensive component of the
            ELPAC, requiring trained examiners and private testing spaces. Each
            student&apos;s speaking assessment takes approximately 10â€“20 minutes
            depending on grade level.
          </InfoBanner>
        </CardContent>
      </Card>

      {/* Reading */}
      <Card className="border-amber-200/40 dark:border-amber-800/20">
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-amber-100 dark:bg-amber-900/30">
              <BookOpen className="h-6 w-6 text-amber-600 dark:text-amber-400" />
            </div>
            <div>
              <CardTitle className="text-lg">Reading</CardTitle>
              <p className="text-sm text-muted-foreground">
                Comprehension of written English
              </p>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-muted-foreground">
          <p>
            The Reading domain assesses students&apos; ability to read and
            comprehend written English texts, including both literary and
            informational passages appropriate for their grade span.
          </p>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="rounded-lg bg-amber-50/50 p-3 dark:bg-amber-900/10">
              <h4 className="font-semibold text-amber-800 dark:text-amber-300">
                Task Types
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-amber-700/80 dark:text-amber-300/70">
                <li>&bull; Read a passage and answer comprehension questions</li>
                <li>&bull; Identify vocabulary meaning in context</li>
                <li>&bull; Analyze text structure and organization</li>
                <li>&bull; Make inferences and draw conclusions</li>
                <li>&bull; Compare/contrast information across texts</li>
              </ul>
            </div>
            <div className="rounded-lg bg-amber-50/50 p-3 dark:bg-amber-900/10">
              <h4 className="font-semibold text-amber-800 dark:text-amber-300">
                Skills Assessed
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-amber-700/80 dark:text-amber-300/70">
                <li>&bull; Literal comprehension</li>
                <li>&bull; Inferential comprehension</li>
                <li>&bull; Vocabulary knowledge (academic and domain-specific)</li>
                <li>&bull; Text analysis and evaluation</li>
                <li>&bull; Understanding text features and structures</li>
              </ul>
            </div>
          </div>
          <div className="rounded-lg border border-amber-200 bg-amber-50/30 p-3 dark:border-amber-800/40 dark:bg-amber-900/5">
            <h4 className="font-semibold text-amber-800 dark:text-amber-300 text-xs uppercase tracking-wider">
              Grade-Span Considerations
            </h4>
            <p className="mt-1 text-sm text-amber-700/80 dark:text-amber-300/70">
              For TKâ€“2 students, the Reading domain is administered one-on-one
              and focuses on foundational literacy skills (letter recognition,
              sight words, simple sentences). For grades 3â€“12, Reading is
              computer-based and includes increasingly complex literary and
              informational texts with multi-paragraph passages.
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Writing */}
      <Card className="border-purple-200/40 dark:border-purple-800/20">
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30">
              <Pencil className="h-6 w-6 text-purple-600 dark:text-purple-400" />
            </div>
            <div>
              <CardTitle className="text-lg">Writing</CardTitle>
              <p className="text-sm text-muted-foreground">
                Production of written English
              </p>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-muted-foreground">
          <p>
            The Writing domain assesses students&apos; ability to produce
            written English for various academic purposes, including opinion,
            informational, and narrative writing tasks.
          </p>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="rounded-lg bg-purple-50/50 p-3 dark:bg-purple-900/10">
              <h4 className="font-semibold text-purple-800 dark:text-purple-300">
                Task Types
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-purple-700/80 dark:text-purple-300/70">
                <li>&bull; Write a short opinion/argument essay</li>
                <li>&bull; Write an informational paragraph or essay</li>
                <li>&bull; Describe a process or event in writing</li>
                <li>&bull; Summarize information from a passage</li>
                <li>&bull; Label or complete sentences (TKâ€“2)</li>
                <li>&bull; Write a narrative or personal experience</li>
              </ul>
            </div>
            <div className="rounded-lg bg-purple-50/50 p-3 dark:bg-purple-900/10">
              <h4 className="font-semibold text-purple-800 dark:text-purple-300">
                Skills Assessed
              </h4>
              <ul className="mt-2 space-y-1 text-sm text-purple-700/80 dark:text-purple-300/70">
                <li>&bull; Organization and coherence</li>
                <li>&bull; Development of ideas with details/evidence</li>
                <li>&bull; Grammar and sentence structure variety</li>
                <li>&bull; Academic vocabulary usage</li>
                <li>&bull; Conventions (spelling, punctuation, capitalization)</li>
                <li>&bull; Audience and purpose awareness</li>
              </ul>
            </div>
          </div>
          <div className="rounded-lg border border-purple-200 bg-purple-50/30 p-3 dark:border-purple-800/40 dark:bg-purple-900/5">
            <h4 className="font-semibold text-purple-800 dark:text-purple-300 text-xs uppercase tracking-wider">
              Scoring Notes
            </h4>
            <p className="mt-1 text-sm text-purple-700/80 dark:text-purple-300/70">
              Writing responses are scored by trained human raters using
              rubrics that evaluate the response holistically. For the
              Summative ELPAC, each writing task receives a score that
              contributes to the overall Writing domain score. Rubrics assess
              both language proficiency and communicative effectiveness.
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Domain Weighting */}
      <SectionHeading>Domain Score Weighting</SectionHeading>
      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4 text-sm text-muted-foreground">
          <p>
            The four domain scores are combined to calculate the overall ELPAC
            performance level. The weighting varies slightly by grade span but
            generally follows this distribution:
          </p>
          <div className="grid grid-cols-2 gap-3 sm:grid-cols-4">
            {[
              { domain: "Listening", pct: "~25%", color: "blue" },
              { domain: "Speaking", pct: "~25%", color: "green" },
              { domain: "Reading", pct: "~25%", color: "amber" },
              { domain: "Writing", pct: "~25%", color: "purple" },
            ].map((item) => {
              const bgMap: Record<string, string> = {
                blue: "bg-blue-100 dark:bg-blue-900/30",
                green: "bg-green-100 dark:bg-green-900/30",
                amber: "bg-amber-100 dark:bg-amber-900/30",
                purple: "bg-purple-100 dark:bg-purple-900/30",
              };
              const textMap: Record<string, string> = {
                blue: "text-blue-800 dark:text-blue-300",
                green: "text-green-800 dark:text-green-300",
                amber: "text-amber-800 dark:text-amber-300",
                purple: "text-purple-800 dark:text-purple-300",
              };
              return (
                <div
                  key={item.domain}
                  className={`rounded-xl p-4 text-center ${bgMap[item.color]}`}
                >
                  <p className={`text-2xl font-bold ${textMap[item.color]}`}>
                    {item.pct}
                  </p>
                  <p className={`text-xs font-medium mt-1 ${textMap[item.color]}`}>
                    {item.domain}
                  </p>
                </div>
              );
            })}
          </div>
          <InfoBanner variant="info">
            For TKâ€“K students, the oral domains (Listening and Speaking) carry
            a greater weight since these students are still developing
            foundational literacy. Exact weighting formulas are available in the
            ELPAC Technical Report published by CDE.
          </InfoBanner>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Scoring & Levels Tab                                               */
/* ------------------------------------------------------------------ */

function ScoringTab() {
  return (
    <div className="space-y-6">
      <SectionHeading>Summative ELPAC Performance Levels</SectionHeading>

      <p className="text-sm text-muted-foreground">
        The Summative ELPAC reports an overall performance level from 1 to 4.
        Each level describes the student&apos;s overall English language
        proficiency and maps to the CA ELD Standards proficiency continuum.
      </p>

      <div className="space-y-4">
        <Card className="border-l-4 border-l-red-400 dark:border-l-red-500">
          <CardContent className="pt-5 md:pt-6">
            <div className="flex items-start gap-4">
              <span className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-red-100 text-lg font-bold text-red-800 dark:bg-red-900/30 dark:text-red-300">
                1
              </span>
              <div>
                <h3 className="font-bold text-foreground">
                  Level 1 â€” Minimally Developed
                </h3>
                <p className="mt-1 text-sm text-muted-foreground">
                  Students at this level have minimally developed oral (listening
                  and speaking) and written (reading and writing) English skills.
                  They tend to understand and use only very familiar English
                  words, short phrases, and formulaic expressions.
                </p>
                <div className="mt-3 rounded-lg bg-red-50 p-3 dark:bg-red-900/10">
                  <p className="text-xs font-semibold text-red-800 dark:text-red-300">
                    ELD Standards Alignment: Lower Emerging
                  </p>
                  <p className="mt-1 text-xs text-red-700/80 dark:text-red-300/70">
                    These students require substantial linguistic support and
                    scaffolding in all content areas. Focus on developing
                    receptive language skills and basic communicative competence.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-orange-400 dark:border-l-orange-500">
          <CardContent className="pt-5 md:pt-6">
            <div className="flex items-start gap-4">
              <span className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-orange-100 text-lg font-bold text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
                2
              </span>
              <div>
                <h3 className="font-bold text-foreground">
                  Level 2 â€” Somewhat Developed
                </h3>
                <p className="mt-1 text-sm text-muted-foreground">
                  Students at this level demonstrate somewhat developed oral and
                  written English skills. They can use English to meet some
                  immediate communication needs but often struggle with more
                  abstract, complex academic language.
                </p>
                <div className="mt-3 rounded-lg bg-orange-50 p-3 dark:bg-orange-900/10">
                  <p className="text-xs font-semibold text-orange-800 dark:text-orange-300">
                    ELD Standards Alignment: Upper Emerging / Lower Expanding
                  </p>
                  <p className="mt-1 text-xs text-orange-700/80 dark:text-orange-300/70">
                    These students benefit from moderate scaffolding, including
                    sentence frames, graphic organizers, and pre-taught
                    vocabulary. They are building foundational academic language.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-yellow-400 dark:border-l-yellow-500">
          <CardContent className="pt-5 md:pt-6">
            <div className="flex items-start gap-4">
              <span className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-yellow-100 text-lg font-bold text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
                3
              </span>
              <div>
                <h3 className="font-bold text-foreground">
                  Level 3 â€” Moderately Developed
                </h3>
                <p className="mt-1 text-sm text-muted-foreground">
                  Students at this level demonstrate moderately developed oral
                  and written English skills. They can use English to learn
                  academic content in most areas with some linguistic support.
                  They show increasing independence with academic language.
                </p>
                <div className="mt-3 rounded-lg bg-yellow-50 p-3 dark:bg-yellow-900/10">
                  <p className="text-xs font-semibold text-yellow-800 dark:text-yellow-300">
                    ELD Standards Alignment: Upper Expanding / Lower Bridging
                  </p>
                  <p className="mt-1 text-xs text-yellow-700/80 dark:text-yellow-300/70">
                    These students are approaching reclassification readiness.
                    They benefit from light scaffolding and continued academic
                    vocabulary development. Focus on complex sentence structures
                    and extended discourse.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-green-400 dark:border-l-green-500">
          <CardContent className="pt-5 md:pt-6">
            <div className="flex items-start gap-4">
              <span className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100 text-lg font-bold text-green-800 dark:bg-green-900/30 dark:text-green-300">
                4
              </span>
              <div>
                <h3 className="font-bold text-foreground">
                  Level 4 â€” Well Developed
                </h3>
                <p className="mt-1 text-sm text-muted-foreground">
                  Students at this level demonstrate well-developed oral and
                  written English skills. They can use English to learn and
                  communicate in meaningful ways that are comparable to those
                  of native English speakers. They show strong command of
                  academic language.
                </p>
                <div className="mt-3 rounded-lg bg-green-50 p-3 dark:bg-green-900/10">
                  <p className="text-xs font-semibold text-green-800 dark:text-green-300">
                    ELD Standards Alignment: Upper Bridging
                  </p>
                  <p className="mt-1 text-xs text-green-700/80 dark:text-green-300/70">
                    Students scoring at Level 4 meet one of the four required
                    criteria for reclassification as RFEP. They may still
                    benefit from some linguistic support for highly technical
                    or specialized academic content.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <SectionHeading className="pt-2">Domain Performance Levels</SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4 text-sm text-muted-foreground">
          <p>
            In addition to the overall performance level (1â€“4), each domain
            receives a performance level of 1â€“3:
          </p>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-eld-almond-silk/40 dark:border-gray-700">
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Level
                  </th>
                  <th className="pb-3 pr-4 text-left font-semibold text-foreground">
                    Label
                  </th>
                  <th className="pb-3 text-left font-semibold text-foreground">
                    Description
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    <span className="inline-flex h-6 w-6 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-800 dark:bg-red-900/30 dark:text-red-300">
                      1
                    </span>
                  </td>
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Beginning
                  </td>
                  <td className="py-3">
                    English skills in this domain are beginning to develop.
                    Student shows limited ability to understand or produce
                    language in this area.
                  </td>
                </tr>
                <tr className="border-b border-eld-almond-silk/20 dark:border-gray-800">
                  <td className="py-3 pr-4">
                    <span className="inline-flex h-6 w-6 items-center justify-center rounded-full bg-orange-100 text-xs font-bold text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
                      2
                    </span>
                  </td>
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Somewhat/Moderately Developed
                  </td>
                  <td className="py-3">
                    English skills in this domain are developing. Student can
                    understand and produce some academic language but
                    inconsistently.
                  </td>
                </tr>
                <tr>
                  <td className="py-3 pr-4">
                    <span className="inline-flex h-6 w-6 items-center justify-center rounded-full bg-green-100 text-xs font-bold text-green-800 dark:bg-green-900/30 dark:text-green-300">
                      3
                    </span>
                  </td>
                  <td className="py-3 pr-4 font-medium text-foreground">
                    Well Developed
                  </td>
                  <td className="py-3">
                    English skills in this domain are well developed. Student
                    demonstrates strong ability to understand and produce
                    academic language consistently.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <InfoBanner variant="info">
            Domain-level scores help teachers identify specific areas of
            strength and need for each student. A student might be &quot;Well
            Developed&quot; in Speaking but &quot;Beginning&quot; in Writing,
            indicating a need for targeted writing instruction.
          </InfoBanner>
        </CardContent>
      </Card>

      <SectionHeading className="pt-2">
        Understanding Scale Scores
      </SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4 text-sm text-muted-foreground">
          <p>
            Scale scores are the numeric scores that underlie the performance
            levels. They provide a more precise measure of a student&apos;s
            English proficiency and enable year-over-year comparisons:
          </p>
          <ul className="space-y-2 ml-1">
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Overall Scale Score:
                </strong>{" "}
                Ranges from approximately 1150 to 1900+ depending on the grade
                span. Each performance level has a defined scale score range.
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">
                  Domain Scale Scores:
                </strong>{" "}
                Each domain also has a scale score that maps to the 1â€“3 domain
                performance levels. Domain scores help identify specific
                instructional needs.
              </div>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
              <div>
                <strong className="text-foreground">Year-over-Year Growth:</strong>{" "}
                Because scale scores are on a continuous scale, they can be used
                to measure growth from one year to the next, even if the
                performance level remains the same.
              </div>
            </li>
          </ul>
        </CardContent>
      </Card>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Administration & Logistics Tab                                     */
/* ------------------------------------------------------------------ */

function AdminTab() {
  return (
    <div className="space-y-6">
      <SectionHeading>Test Administration Requirements</SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="Test Examiner Qualifications"
          icon={Users}
          defaultOpen
        >
          <div className="space-y-3">
            <p>
              ELPAC test examiners must meet specific requirements:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Credentialed Staff:
                  </strong>{" "}
                  Must hold a valid California teaching credential, pupil
                  personnel services credential, or administrative credential
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Annual Training:
                  </strong>{" "}
                  Must complete the ELPAC examiner training annually, which
                  includes calibration scoring and administration procedures
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Speaking Domain Training:
                  </strong>{" "}
                  Examiners administering the one-on-one Speaking domain must
                  complete additional calibration scoring training to ensure
                  reliable scoring
                </div>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <div>
                  <strong className="text-foreground">
                    Paraprofessionals:
                  </strong>{" "}
                  Classified staff (paraprofessionals) may administer the ELPAC
                  under the direct supervision of a certificated employee, per
                  Education Code Section 313
                </div>
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Testing Environment & Setup"
          icon={Shield}
        >
          <div className="space-y-3">
            <p>
              The testing environment must meet specific standards:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Group Testing:</strong>{" "}
                Quiet, well-lit room with adequate spacing between students;
                working computers with headphones for grades 3â€“12
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  One-on-One Testing:
                </strong>{" "}
                Private or semi-private space free from distractions; audio
                recording capability if required by district
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Technology:</strong>{" "}
                Computers must meet minimum system requirements; the Secure
                Browser must be installed for computer-based testing
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Test Security:
                </strong>{" "}
                All test materials must be kept secure; test content must not
                be reproduced, discussed, or shared
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="Accommodations & Accessibility Resources"
          icon={Shield}
        >
          <div className="space-y-3">
            <p>
              The ELPAC provides a tiered system of accessibility resources:
            </p>

            <div className="space-y-4">
              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">
                  Universal Tools (Available to All Students)
                </h4>
                <div className="mt-2 grid grid-cols-1 gap-1 sm:grid-cols-2 text-sm">
                  <span>&bull; Breaks</span>
                  <span>&bull; Scratch paper</span>
                  <span>&bull; Highlighter (computer)</span>
                  <span>&bull; Zoom/magnification (computer)</span>
                  <span>&bull; Mark for review (computer)</span>
                  <span>&bull; Strikethrough (computer)</span>
                  <span>&bull; Line reader (computer)</span>
                </div>
              </div>

              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">
                  Designated Supports (For Students with Documented Need)
                </h4>
                <div className="mt-2 grid grid-cols-1 gap-1 sm:grid-cols-2 text-sm">
                  <span>&bull; Extended testing time</span>
                  <span>&bull; Separate testing room</span>
                  <span>&bull; Specialized lighting/acoustics</span>
                  <span>&bull; Simplified test directions</span>
                  <span>&bull; Supervised breaks</span>
                  <span>&bull; Adaptive/assistive technology</span>
                </div>
              </div>

              <div className="rounded-lg bg-eld-almond-silk/15 p-4 dark:bg-white/[0.03]">
                <h4 className="font-semibold text-foreground">
                  Accommodations (For Students with IEP/504 Plans)
                </h4>
                <div className="mt-2 grid grid-cols-1 gap-1 sm:grid-cols-2 text-sm">
                  <span>&bull; Braille</span>
                  <span>&bull; Large print</span>
                  <span>&bull; Speech-to-text</span>
                  <span>&bull; Scribe</span>
                  <span>&bull; ASL (non-Listening items)</span>
                  <span>&bull; Closed captioning (non-Listening)</span>
                  <span>&bull; Alternate response options</span>
                  <span>&bull; Noise buffers</span>
                </div>
              </div>
            </div>

            <InfoBanner variant="warning">
              Accommodations must be documented in the student&apos;s IEP or
              504 plan AND entered into TOMS before testing begins. Test
              coordinators should verify that all accommodations are properly
              recorded.
            </InfoBanner>
          </div>
        </Collapsible>

        <Collapsible title="TOMS (Test Operations Management System)" icon={ListChecks}>
          <div className="space-y-3">
            <p>
              TOMS is the online system used by LEAs to manage ELPAC
              administration. Key functions include:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Student Registration:</strong>{" "}
                Enrolling students for testing and assigning them to test
                sessions
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Accessibility Resources:
                </strong>{" "}
                Recording designated supports and accommodations for each student
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Test Management:</strong>{" "}
                Tracking test completion status, managing make-up testing, and
                handling appeals
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Score Retrieval:</strong>{" "}
                Accessing student-level score data after scoring is complete
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Reporting:</strong>{" "}
                Generating aggregate reports for schools, districts, and
                demographic groups
              </li>
            </ul>
          </div>
        </Collapsible>
      </div>

      <SectionHeading className="pt-2">
        Reclassification Using ELPAC Data
      </SectionHeading>

      <Card>
        <CardContent className="pt-5 md:pt-6 space-y-4 text-sm text-muted-foreground">
          <p>
            The Summative ELPAC is the primary data source for reclassification
            decisions. The complete reclassification process requires four
            criteria to be met:
          </p>

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="flex items-start gap-3 rounded-xl border border-green-200 bg-green-50/30 p-4 dark:border-green-800/40 dark:bg-green-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-green-200 text-sm font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                1
              </span>
              <div>
                <strong className="text-green-800 dark:text-green-300">
                  ELPAC Score
                </strong>
                <p className="mt-0.5 text-xs text-green-700/80 dark:text-green-300/70">
                  Overall performance level of 4 (Well Developed) on the
                  Summative ELPAC
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-xl border border-green-200 bg-green-50/30 p-4 dark:border-green-800/40 dark:bg-green-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-green-200 text-sm font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                2
              </span>
              <div>
                <strong className="text-green-800 dark:text-green-300">
                  Teacher Evaluation
                </strong>
                <p className="mt-0.5 text-xs text-green-700/80 dark:text-green-300/70">
                  Teacher assessment of academic performance, including
                  English language arts, using objective measures
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-xl border border-green-200 bg-green-50/30 p-4 dark:border-green-800/40 dark:bg-green-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-green-200 text-sm font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                3
              </span>
              <div>
                <strong className="text-green-800 dark:text-green-300">
                  Parent Consultation
                </strong>
                <p className="mt-0.5 text-xs text-green-700/80 dark:text-green-300/70">
                  Parent/guardian opinion and consultation (parents must be
                  notified and given opportunity to participate)
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 rounded-xl border border-green-200 bg-green-50/30 p-4 dark:border-green-800/40 dark:bg-green-900/10">
              <span className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-green-200 text-sm font-bold text-green-800 dark:bg-green-800 dark:text-green-200">
                4
              </span>
              <div>
                <strong className="text-green-800 dark:text-green-300">
                  Academic Comparison
                </strong>
                <p className="mt-0.5 text-xs text-green-700/80 dark:text-green-300/70">
                  Performance on CAASPP/SBAC or equivalent assessment compared
                  with English proficient peers
                </p>
              </div>
            </div>
          </div>

          <InfoBanner variant="success">
            When all four criteria are met, the student is reclassified as
            Reclassified Fluent English Proficient (RFEP). The district then
            monitors the student&apos;s academic progress for four years to
            ensure they continue to succeed without ELD support.
          </InfoBanner>
        </CardContent>
      </Card>

      <SectionHeading className="pt-2">
        Frequently Asked Questions
      </SectionHeading>

      <div className="space-y-3">
        <Collapsible
          title="Can a parent refuse ELPAC testing?"
          icon={HelpCircle}
          defaultOpen
        >
          <p>
            No. Under state law (Education Code Section 313), the ELPAC is a
            required state assessment. Parents cannot opt their children out of
            the ELPAC. If a student&apos;s Home Language Survey indicates a
            language other than English, the student must take the Initial ELPAC.
            Once classified as an EL, the student must take the Summative ELPAC
            annually until reclassified.
          </p>
        </Collapsible>

        <Collapsible
          title="What happens if a student misses the testing window?"
          icon={HelpCircle}
        >
          <p>
            Districts should make every reasonable effort to test all ELs during
            the February 1 â€“ May 31 window. If a student is absent, the
            district must provide make-up testing opportunities. If a student
            does not complete the ELPAC within the testing window, the student
            retains their current EL classification and cannot be considered for
            reclassification that year. The student&apos;s participation status
            is reported to CDE and factors into the school&apos;s and
            district&apos;s accountability data.
          </p>
        </Collapsible>

        <Collapsible
          title="How do ELPAC scores relate to the CA Dashboard?"
          icon={HelpCircle}
        >
          <p>
            ELPAC results feed into the California School Dashboard&apos;s
            English Learner Progress Indicator (ELPI). The ELPI measures the
            percentage of ELs making progress toward English proficiency,
            as well as the reclassification rate. Schools and districts are
            evaluated on this indicator as part of California&apos;s
            accountability system. Low performance on the ELPI may trigger
            differentiated assistance from the county office of education.
          </p>
        </Collapsible>

        <Collapsible
          title="Can ELPAC scores be used for grading?"
          icon={HelpCircle}
        >
          <p>
            ELPAC scores should not be used as a direct factor in determining
            a student&apos;s course grade. The ELPAC measures English language
            proficiency, not content knowledge or academic performance. However,
            ELPAC data can and should inform instructional decisions, including
            how to differentiate instruction and scaffold assignments for
            English Learners at different proficiency levels.
          </p>
        </Collapsible>

        <Collapsible
          title="What resources are available for ELPAC preparation?"
          icon={HelpCircle}
        >
          <div className="space-y-3">
            <p>
              The CDE and ETS provide several free resources:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Practice Tests:</strong>{" "}
                Full-length practice tests for all grade spans, available on the
                ELPAC website
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Training Tests:</strong>{" "}
                Interactive training tests that familiarize students with the
                computer-based format and question types
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Examiner Training Materials:
                </strong>{" "}
                Manuals, scoring guides, calibration videos, and
                administration guides
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Parent Guides:
                </strong>{" "}
                Multilingual parent information guides explaining the ELPAC,
                score reports, and how to support ELs at home
              </li>
            </ul>
          </div>
        </Collapsible>

        <Collapsible
          title="What is the difference between ELPAC and CELDT?"
          icon={HelpCircle}
        >
          <div className="space-y-3">
            <p>
              The ELPAC replaced the California English Language Development
              Test (CELDT) beginning in 2017â€“18. Key differences include:
            </p>
            <ul className="space-y-2 ml-1">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Standards Alignment:</strong>{" "}
                ELPAC is aligned with the 2012 CA ELD Standards; CELDT was
                aligned with the older 1999 standards
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Two Assessments:</strong>{" "}
                ELPAC separates the initial identification (Initial ELPAC) and
                annual progress monitoring (Summative ELPAC) into distinct
                assessments; CELDT served both purposes with one test
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">Computer-Based:</strong>{" "}
                ELPAC is primarily computer-based for grades 3â€“12; CELDT was
                entirely paper-based
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0 text-green-500" />
                <strong className="text-foreground">
                  Academic Focus:
                </strong>{" "}
                ELPAC places greater emphasis on academic language across
                content areas, reflecting the demands of the CA ELD Standards
              </li>
            </ul>
          </div>
        </Collapsible>
      </div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Main ELPAC Page Component                                          */
/* ------------------------------------------------------------------ */

export default function ElpacPage() {
  const [activeTab, setActiveTab] = useState("overview");

  return (
    <div className="space-y-6">
      {/* Back Navigation */}
      <Link
        href="/eld-guide"
        className="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
      >
        <ArrowLeft className="h-4 w-4" />
        Back to ELD Guide
      </Link>

      {/* Page Header */}
      <div>
        <h1 className="scaffold-heading">ELPAC Assessment Guide</h1>
        <p className="scaffold-description mt-1">
          Complete guide to the English Language Proficiency Assessments for
          California â€” test structure, domains, scoring, administration, and
          reclassification.
        </p>
      </div>

      {/* Hero Banner */}
      <div className="flex flex-col gap-4 rounded-2xl border border-eld-almond-silk/40 bg-white p-5 md:flex-row md:items-center md:gap-6 md:p-6 dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="flex h-14 w-14 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30">
          <ClipboardCheck className="h-7 w-7 text-purple-600 dark:text-purple-400" />
        </div>
        <div>
          <h2 className="text-lg font-bold text-foreground">
            English Language Proficiency Assessments for California
          </h2>
          <p className="mt-1 text-sm text-muted-foreground">
            The ELPAC is California&apos;s required state assessment for
            measuring English language proficiency of students whose primary
            language is not English. It consists of the Initial ELPAC (for
            identification) and the Summative ELPAC (for annual progress
            monitoring).
          </p>
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-2 gap-3 sm:grid-cols-4">
        <div className="flex flex-col items-center rounded-xl border border-eld-almond-silk/40 bg-white p-4 text-center dark:border-gray-800 dark:bg-white/[0.03]">
          <p className="text-2xl font-bold text-foreground">4</p>
          <p className="text-xs text-muted-foreground">Test Domains</p>
        </div>
        <div className="flex flex-col items-center rounded-xl border border-eld-almond-silk/40 bg-white p-4 text-center dark:border-gray-800 dark:bg-white/[0.03]">
          <p className="text-2xl font-bold text-foreground">6</p>
          <p className="text-xs text-muted-foreground">Grade Spans</p>
        </div>
        <div className="flex flex-col items-center rounded-xl border border-eld-almond-silk/40 bg-white p-4 text-center dark:border-gray-800 dark:bg-white/[0.03]">
          <p className="text-2xl font-bold text-foreground">4</p>
          <p className="text-xs text-muted-foreground">Performance Levels</p>
        </div>
        <div className="flex flex-col items-center rounded-xl border border-eld-almond-silk/40 bg-white p-4 text-center dark:border-gray-800 dark:bg-white/[0.03]">
          <p className="text-2xl font-bold text-foreground">Febâ€“May</p>
          <p className="text-xs text-muted-foreground">Testing Window</p>
        </div>
      </div>

      {/* Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
          <TabsList className="min-w-max">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="domains">Test Domains</TabsTrigger>
            <TabsTrigger value="scoring">Scoring &amp; Levels</TabsTrigger>
            <TabsTrigger value="admin">Administration</TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="overview">
          <AssessmentOverviewTab />
        </TabsContent>
        <TabsContent value="domains">
          <DomainsTab />
        </TabsContent>
        <TabsContent value="scoring">
          <ScoringTab />
        </TabsContent>
        <TabsContent value="admin">
          <AdminTab />
        </TabsContent>
      </Tabs>
    </div>
  );
}
"use client";

import { useState } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  Layers,
  Palette,
  LayoutList,
  MessageSquareText,
  BookA,
  Network,
  ChevronDown,
  ChevronUp,
  Info,
  AlertCircle,
  CheckCircle2,
  Target,
  Lightbulb,
  Copy,
  Check,
} from "lucide-react";

/* ------------------------------------------------------------------ */
/*  Reusable Components                                                */
/* ------------------------------------------------------------------ */

function Collapsible({
  title,
  children,
  defaultOpen = false,
  icon: Icon,
}: {
  title: string;
  children: React.ReactNode;
  defaultOpen?: boolean;
  icon?: React.ComponentType<{ className?: string }>;
}) {
  const [open, setOpen] = useState(defaultOpen);

  return (
    <div className="rounded-xl border border-eld-almond-silk/40 dark:border-gray-700/60 overflow-hidden">
      <button
        type="button"
        onClick={() => setOpen(!open)}
        className="flex w-full items-center justify-between gap-3 px-4 py-3.5 md:px-5 md:py-4 text-left font-semibold text-foreground hover:bg-eld-almond-silk/10 dark:hover:bg-white/[0.03] transition-colors"
      >
        <div className="flex items-center gap-3">
          {Icon && (
            <div className="flex h-8 w-8 shrink-0 items-center justify-center rounded-lg bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
              <Icon className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            </div>
          )}
          <span className="text-sm md:text-base">{title}</span>
        </div>
        {open ? (
          <ChevronUp className="h-4 w-4 shrink-0 text-muted-foreground" />
        ) : (
          <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground" />
        )}
      </button>
      {open && (
        <div className="border-t border-eld-almond-silk/30 dark:border-gray-700/40 px-4 py-4 md:px-5 md:py-5 text-sm leading-relaxed text-muted-foreground">
          {children}
        </div>
      )}
    </div>
  );
}

function InfoBanner({
  children,
  variant = "info",
}: {
  children: React.ReactNode;
  variant?: "info" | "warning" | "success";
}) {
  const styles = {
    info: "border-blue-200 bg-blue-50 text-blue-800 dark:border-blue-800/40 dark:bg-blue-900/20 dark:text-blue-300",
    warning:
      "border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-800/40 dark:bg-amber-900/20 dark:text-amber-300",
    success:
      "border-green-200 bg-green-50 text-green-800 dark:border-green-800/40 dark:bg-green-900/20 dark:text-green-300",
  };

  const icons = {
    info: Info,
    warning: AlertCircle,
    success: CheckCircle2,
  };

  const IconComponent = icons[variant];

  return (
    <div
      className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${styles[variant]}`}
    >
      <IconComponent className="mt-0.5 h-4 w-4 shrink-0" />
      <div>{children}</div>
    </div>
  );
}

function SectionHeading({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <h2
      className={`text-lg md:text-xl font-bold text-foreground ${className}`}
    >
      {children}
    </h2>
  );
}

function CopyableTemplate({ content }: { content: string }) {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(content);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="relative">
      <button
        type="button"
        onClick={handleCopy}
        className="absolute top-3 right-3 flex items-center gap-1.5 rounded-lg border border-eld-almond-silk/40 bg-white/80 px-2.5 py-1.5 text-xs font-medium text-muted-foreground transition-colors hover:bg-eld-almond-silk/20 hover:text-foreground dark:border-gray-600 dark:bg-gray-800/80 dark:hover:bg-gray-700"
      >
        {copied ? (
          <>
            <Check className="h-3.5 w-3.5 text-green-500" />
            Copied
          </>
        ) : (
          <>
            <Copy className="h-3.5 w-3.5" />
            Copy
          </>
        )}
      </button>
      <pre className="whitespace-pre-wrap rounded-xl border border-eld-almond-silk/30 bg-eld-almond-silk/10 p-4 pr-24 text-xs leading-relaxed text-muted-foreground dark:border-gray-700/40 dark:bg-white/[0.02]">
        {content}
      </pre>
    </div>
  );
}

function LevelBadge({ level }: { level: "Emerging" | "Expanding" | "Bridging" }) {
  const styles = {
    Emerging:
      "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
    Expanding:
      "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
    Bridging:
      "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
  };

  return (
    <span
      className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${styles[level]}`}
    >
      {level}
    </span>
  );
}

/* ------------------------------------------------------------------ */
/*  Scaffold Example Preview                                           */
/* ------------------------------------------------------------------ */

function ExamplePreview({
  title,
  html,
}: {
  title: string;
  html: string;
}) {
  return (
    <div className="space-y-2">
      <p className="text-xs font-semibold uppercase tracking-wider text-muted-foreground/70">
        {title}
      </p>
      {/* Force light background so inline-styled HTML always renders correctly */}
      <div
        className="rounded-xl border border-eld-almond-silk/30 bg-white p-4 text-sm leading-relaxed text-gray-900 dark:border-gray-600"
        style={{ colorScheme: "light" }}
        dangerouslySetInnerHTML={{ __html: html }}
      />
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Scaffold Section Component                                         */
/* ------------------------------------------------------------------ */

function ScaffoldSection({
  icon: Icon,
  title,
  description,
  whenToUse,
  exampleBefore,
  exampleAfter,
  template,
  tips,
}: {
  icon: React.ComponentType<{ className?: string }>;
  title: string;
  description: string;
  whenToUse: string[];
  exampleBefore: string;
  exampleAfter: string;
  template: string;
  tips: string[];
}) {
  return (
    <Collapsible title={title} icon={Icon} defaultOpen={false}>
      <div className="space-y-5">
        {/* Description */}
        <div>
          <p className="text-sm leading-relaxed">{description}</p>
        </div>

        {/* When to Use */}
        <div>
          <h4 className="mb-2 flex items-center gap-2 text-sm font-semibold text-foreground">
            <Target className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            When to Use
          </h4>
          <ul className="space-y-1.5">
            {whenToUse.map((item, i) => (
              <li key={i} className="flex items-start gap-2 text-sm">
                <CheckCircle2 className="mt-0.5 h-3.5 w-3.5 shrink-0 text-green-500" />
                {item}
              </li>
            ))}
          </ul>
        </div>

        {/* Example */}
        <div>
          <h4 className="mb-3 flex items-center gap-2 text-sm font-semibold text-foreground">
            <Lightbulb className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            Example
          </h4>
          <div className="grid gap-4 md:grid-cols-2">
            <ExamplePreview title="Before (Original)" html={exampleBefore} />
            <ExamplePreview title="After (Scaffolded)" html={exampleAfter} />
          </div>
        </div>

        {/* Teacher Template */}
        <div>
          <h4 className="mb-2 flex items-center gap-2 text-sm font-semibold text-foreground">
            <Copy className="h-4 w-4 text-eld-space-indigo dark:text-eld-almond-silk" />
            Teacher Template (Copy &amp; Use)
          </h4>
          <p className="mb-3 text-xs text-muted-foreground/70">
            Copy this template to create your own scaffolded materials without the AI tool.
          </p>
          <CopyableTemplate content={template} />
        </div>

        {/* Tips */}
        {tips.length > 0 && (
          <InfoBanner variant="info">
            <strong>Tips:</strong>
            <ul className="mt-1 space-y-1">
              {tips.map((tip, i) => (
                <li key={i}>- {tip}</li>
              ))}
            </ul>
          </InfoBanner>
        )}
      </div>
    </Collapsible>
  );
}

/* ================================================================== */
/*  EMERGING TAB                                                       */
/* ================================================================== */

function EmergingTab() {
  return (
    <div className="space-y-6">
      <div className="rounded-xl border-l-4 border-red-400 bg-red-50/50 p-4 dark:border-red-500 dark:bg-red-900/10">
        <div className="flex items-center gap-2 mb-1">
          <h3 className="font-semibold text-red-800 dark:text-red-300">
            Emerging Level â€” Substantial Support
          </h3>
          <LevelBadge level="Emerging" />
        </div>
        <p className="text-sm text-red-700/80 dark:text-red-300/70">
          Students at this level need the most scaffolding. All five scaffold
          categories should be used extensively. Focus on making input
          comprehensible through visuals, simplified language, and structured
          supports. Use shorter sentences, bilingual glossaries, and heavy
          graphic organizer support.
        </p>
      </div>

      <SectionHeading>All Scaffolds for Emerging Students</SectionHeading>

      <div className="space-y-4">
        {/* Color Coding */}
        <ScaffoldSection
          icon={Palette}
          title="Color Coding: Main Ideas & Evidence"
          description="Color coding helps Emerging students visually distinguish between different parts of a text â€” topic sentences, supporting evidence, and transitions. At this level, use bold, high-contrast highlighting and limit to 2-3 colors to avoid overwhelming students."
          whenToUse={[
            "Reading passages with main ideas and supporting details",
            "Informational texts where students need to identify text structure",
            "Before asking students to write their own paragraphs (model the structure)",
            "When students struggle to distinguish between key ideas and supporting details",
          ]}
          exampleBefore={`<p>The water cycle is a continuous process that moves water through the environment. First, the sun heats water in oceans and lakes, causing it to evaporate into the air. Then, the water vapor rises and cools, forming clouds through condensation. Finally, when the clouds become heavy enough, precipitation falls as rain or snow back to Earth.</p>`}
          exampleAfter={`<p><span style="background-color: #FFF176; padding: 2px 4px; border-radius: 2px; color: #000;">The water cycle is a continuous process that moves water through the environment.</span> <span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px; color: #000;">First,</span> the sun heats water in oceans and lakes, causing it to <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">evaporate into the air.</span> <span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px; color: #000;">Then,</span> the water vapor rises and cools, <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">forming clouds through condensation.</span> <span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px; color: #000;">Finally,</span> when the clouds become heavy enough, <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">precipitation falls as rain or snow back to Earth.</span></p><p style="margin-top: 12px; font-size: 0.8rem; color: #555;"><strong>Key:</strong> <span style="background-color: #FFF176; padding: 2px 6px; border-radius: 2px;">Yellow = Main Idea</span>&nbsp; <span style="background-color: #AED581; padding: 2px 6px; border-radius: 2px;">Green = Evidence/Details</span>&nbsp; <span style="background-color: #90CAF9; padding: 2px 6px; border-radius: 2px;">Blue = Transitions</span></p>`}
          template={`COLOR CODING TEMPLATE â€” Emerging Level
==========================================

Instructions: Highlight or underline using these colors:
  - YELLOW = Main Idea (the most important sentence)
  - GREEN  = Evidence / Supporting Details
  - BLUE   = Transition Words (First, Then, Finally, etc.)

Title: _______________________________________

Passage:
[Paste or write your passage here]

Student Task:
1. Read the passage one time all the way through.
2. Find the MAIN IDEA sentence. Highlight it YELLOW.
3. Find EVIDENCE or DETAILS. Highlight them GREEN.
4. Find TRANSITION WORDS. Highlight them BLUE.

Reflection:
- The main idea is: ___________________________
- One detail that supports it is: ______________`}
          tips={[
            "Limit to 2-3 colors maximum for Emerging students",
            "Always include a color key at the bottom of the page",
            "Model the first highlight together as a class before independent work",
            "Consider providing pre-highlighted examples first, then have students try on a new passage",
          ]}
        />

        {/* Chunking: Break Into Sections */}
        <ScaffoldSection
          icon={LayoutList}
          title="Chunking: Break Into Sections"
          description="Chunking divides a long text or assignment into 3-5 smaller, numbered sections with clear headers. For Emerging students, use very short chunks (2-3 sentences each) with visual dividers and pause prompts. This prevents cognitive overload and helps students process text in manageable pieces."
          whenToUse={[
            "Any reading passage longer than one paragraph",
            "Multi-step assignments or directions",
            "Texts with dense academic vocabulary",
            "When students shut down or skip parts of longer assignments",
          ]}
          exampleBefore={`<p>The American Revolution began because the colonists were unhappy with British rule. They had to pay taxes but had no voice in the British government. Groups like the Sons of Liberty organized protests. The Boston Tea Party in 1773 was one of the most famous protests, where colonists dumped tea into Boston Harbor. The British responded with harsh laws called the Intolerable Acts, which made the colonists even angrier. Eventually, fighting broke out at Lexington and Concord in 1775, beginning the war.</p>`}
          exampleAfter={`<div style="font-weight: 600; margin: 0 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af; border-radius: 4px;">Section 1 of 3: Why Were the Colonists Unhappy?</div><p>The American Revolution began because the colonists were unhappy with British rule. They had to pay taxes but had no voice in the British government.</p><div style="margin: 0.75rem 0; padding: 0.5rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.875rem; font-weight: 500; border-radius: 4px;">&#9208; Pause here. Re-read Section 1 before continuing.</div><div style="font-weight: 600; margin: 1.5rem 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af; border-radius: 4px;">Section 2 of 3: Protests and Reactions</div><p>Groups like the Sons of Liberty organized protests. The Boston Tea Party in 1773 was one of the most famous protests, where colonists dumped tea into Boston Harbor. The British responded with harsh laws called the Intolerable Acts.</p><div style="margin: 0.75rem 0; padding: 0.5rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.875rem; font-weight: 500; border-radius: 4px;">&#9208; Pause here. Re-read Section 2 before continuing.</div><div style="font-weight: 600; margin: 1.5rem 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af; border-radius: 4px;">Section 3 of 3: The War Begins</div><p>The colonists became even angrier. Eventually, fighting broke out at Lexington and Concord in 1775, beginning the war.</p>`}
          template={`CHUNKING TEMPLATE â€” Emerging Level
==========================================

Instructions: Break the text into 3-5 short sections.
Add a header and pause prompt after each section.

Title: _______________________________________

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section 1 of ___:  [Section Title]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ [Paste 2-3 sentences here]              â”‚
â”‚                                          â”‚
â”‚ >> PAUSE: Re-read Section 1 before      â”‚
â”‚    continuing.                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section 2 of ___:  [Section Title]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ [Paste 2-3 sentences here]              â”‚
â”‚                                          â”‚
â”‚ >> PAUSE: Re-read Section 2 before      â”‚
â”‚    continuing.                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section 3 of ___:  [Section Title]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ [Paste 2-3 sentences here]              â”‚
â”‚                                          â”‚
â”‚ >> PAUSE: Re-read Section 3 before      â”‚
â”‚    continuing.                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Check-In Questions:
1. What was Section 1 about? _______________
2. What was Section 2 about? _______________
3. What was Section 3 about? _______________`}
          tips={[
            "For Emerging students, keep chunks to 2-3 sentences maximum",
            "Add a short descriptive title to each section header",
            "Include pause/re-read prompts between every section",
            "Consider adding a simple check-in question after each chunk",
          ]}
        />

        {/* Chunking: Paragraph-by-Paragraph */}
        <ScaffoldSection
          icon={LayoutList}
          title="Chunking: Paragraph-by-Paragraph"
          description="This scaffold breaks individual long paragraphs into smaller pieces of 2-3 sentences each. Specifically designed for Emerging students who struggle with paragraphs longer than 4 sentences. Adds visual pause markers between chunks to encourage re-reading."
          whenToUse={[
            "When a passage has paragraphs longer than 4 sentences",
            "Textbook readings with dense paragraphs",
            "Test prep passages that use long, complex paragraphs",
            "When students consistently lose track of meaning in long paragraphs",
          ]}
          exampleBefore={`<p>Photosynthesis is the process by which plants make their own food using sunlight. Plants take in carbon dioxide from the air through tiny holes in their leaves called stomata. They also absorb water from the soil through their roots. The chlorophyll in the leaves captures energy from sunlight. This energy is used to combine the carbon dioxide and water to make glucose, which is a type of sugar the plant uses for food. Oxygen is released as a byproduct, which is what humans and animals breathe.</p>`}
          exampleAfter={`<p>Photosynthesis is the process by which plants make their own food using sunlight. Plants take in carbon dioxide from the air through tiny holes in their leaves called stomata.</p><div style="margin: 0.75rem 0; padding: 0.5rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.875rem; font-weight: 500; border-radius: 4px;">&#9208; Pause here and re-read before continuing.</div><p>They also absorb water from the soil through their roots. The chlorophyll in the leaves captures energy from sunlight.</p><div style="margin: 0.75rem 0; padding: 0.5rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.875rem; font-weight: 500; border-radius: 4px;">&#9208; Pause here and re-read before continuing.</div><p>This energy is used to combine the carbon dioxide and water to make glucose, which is a type of sugar the plant uses for food. Oxygen is released as a byproduct, which is what humans and animals breathe.</p>`}
          template={`PARAGRAPH-BY-PARAGRAPH CHUNKING â€” Emerging Level
=================================================

Instructions: Break any paragraph longer than 4 sentences
into chunks of 2-3 sentences. Add a pause between each.

Original paragraph topic: ________________________

Chunk 1:
_________________________________________________
_________________________________________________
[2-3 sentences]

>> PAUSE and re-read Chunk 1.
   What is this chunk about? ____________________

Chunk 2:
_________________________________________________
_________________________________________________
[2-3 sentences]

>> PAUSE and re-read Chunk 2.
   What is this chunk about? ____________________

Chunk 3:
_________________________________________________
_________________________________________________
[2-3 sentences]

>> PAUSE and re-read Chunk 3.
   What is this chunk about? ____________________

Put it all together:
The whole paragraph is about ____________________`}
          tips={[
            "This is especially effective for Emerging students who need even smaller chunks than the section-based chunking",
            "Pair with a word bank for challenging vocabulary in each chunk",
            "Have students summarize each chunk in their own words (or native language) before moving on",
          ]}
        />

        {/* Sentence Frames: Opinion Writing */}
        <ScaffoldSection
          icon={MessageSquareText}
          title="Sentence Frames: Opinion Writing"
          description="Provides fill-in-the-blank sentence starters that guide Emerging students through structuring an opinion or argument response. At this level, frames should be simple, using common vocabulary and clear structures. Provide multiple options so students can choose the frame that best fits their idea."
          whenToUse={[
            "Any prompt asking students to state an opinion or take a position",
            "Argumentative or persuasive writing assignments",
            "Discussion preparation before Socratic seminars or class debates",
            "When students can verbally express an opinion but struggle to write it",
          ]}
          exampleBefore={`<p><strong>Writing Prompt:</strong> Do you think schools should have a longer summer break? Write a paragraph explaining your opinion and give at least two reasons.</p>`}
          exampleAfter={`<p><strong>Writing Prompt:</strong> Do you think schools should have a longer summer break? Write a paragraph explaining your opinion and give at least two reasons.</p><div style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Sentence Frames to Help You:</strong><br/><br/>&#x2022; I think ____________ because ____________.<br/><br/>&#x2022; In my opinion, ____________.<br/><br/>&#x2022; One reason I believe this is ____________.<br/><br/>&#x2022; Another reason is ____________.<br/><br/>&#x2022; I agree / disagree with ____________ because ____________.</div>`}
          template={`SENTENCE FRAMES: OPINION WRITING â€” Emerging Level
===================================================

Topic / Prompt: __________________________________
_________________________________________________

Sentence Frames (choose the ones that help you):

1. I think _____________ because _____________.

2. In my opinion, _____________.

3. One reason I believe this is _____________.

4. Another reason is _____________.

5. I agree / disagree with _________ because _________.

6. For example, _____________.

7. This is important because _____________.

My Opinion Paragraph:
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________

Checklist:
[ ] I stated my opinion clearly.
[ ] I gave at least two reasons.
[ ] I used at least one sentence frame.`}
          tips={[
            "Read the frames aloud with students before they write",
            "Allow students to draft ideas in their native language first, then use frames to write in English",
            "Model completing one frame together as a class before independent work",
            "Display sentence frames on a poster or anchor chart for ongoing reference",
          ]}
        />

        {/* Sentence Frames: Summary Writing */}
        <ScaffoldSection
          icon={MessageSquareText}
          title="Sentence Frames: Summary Writing"
          description="Provides structured sentence starters specifically for summarizing a text. Emerging students often retell every detail; these frames guide them to identify and state only the main ideas and key details in a logical order."
          whenToUse={[
            "After reading any informational or narrative text",
            "Summarizing a lesson, video, or experiment",
            "When students retell too many details or miss the main idea",
            "Close reading activities that require identifying central ideas",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Summarize the article about the water cycle in 3-4 sentences.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Summarize the article about the water cycle in 3-4 sentences.</p><div style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Sentence Frames to Help You:</strong><br/><br/>&#x2022; The main idea of this text is ____________.<br/><br/>&#x2022; First, ____________. Then, ____________. Finally, ____________.<br/><br/>&#x2022; This text is mostly about ____________.<br/><br/>&#x2022; One important detail is ____________.<br/><br/>&#x2022; In conclusion, ____________.</div>`}
          template={`SENTENCE FRAMES: SUMMARY WRITING â€” Emerging Level
===================================================

Text / Topic being summarized: ___________________
_________________________________________________

Sentence Frames (choose the ones that help you):

1. The main idea of this text is _____________.

2. This text is mostly about _____________.

3. First, _____________. Then, _____________.
   Finally, _____________.

4. One important detail is _____________.

5. Another important detail is _____________.

6. In conclusion, _____________.

My Summary:
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________

Checklist:
[ ] I stated the main idea.
[ ] I included 2-3 key details (not every detail).
[ ] My summary is in my own words.
[ ] My summary makes sense if someone didn't read
    the original text.`}
          tips={[
            "Teach the difference between 'retelling everything' and 'summarizing the main idea' explicitly",
            "Have students underline or highlight the main idea in the original text before summarizing",
            "The 'First, Then, Finally' frame works especially well for sequential/narrative texts",
          ]}
        />

        {/* Word Banks */}
        <ScaffoldSection
          icon={BookA}
          title="Word Bank: Academic Vocabulary"
          description="A word bank provides 8-12 challenging academic or domain-specific vocabulary words with simple, student-friendly definitions. For Emerging students, definitions should use the simplest possible language, and consider including native language translations or picture cues when possible."
          whenToUse={[
            "Any text with academic or domain-specific vocabulary",
            "Before students read a new passage or chapter",
            "Writing assignments where students need to use specific terminology",
            "Science, social studies, and math assignments with technical terms",
          ]}
          exampleBefore={`<p>Read the passage about ecosystems and answer the questions.</p><p>An ecosystem is a community of living organisms interacting with their physical environment. Producers, such as plants, convert sunlight into energy through photosynthesis. Consumers eat producers or other consumers to obtain energy. Decomposers break down dead organisms and recycle nutrients back into the soil.</p>`}
          exampleAfter={`<p>Read the passage about ecosystems and answer the questions.</p><p>An ecosystem is a community of living organisms interacting with their physical environment. Producers, such as plants, convert sunlight into energy through photosynthesis. Consumers eat producers or other consumers to obtain energy. Decomposers break down dead organisms and recycle nutrients back into the soil.</p><div style="border: 2px solid #2563eb; padding: 1.25rem; margin: 1.5rem 0; background: #eff6ff; border-radius: 8px;"><h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">Word Bank</h3><div style="display: grid; gap: 0.75rem;"><div><strong style="color: #1e40af;">Ecosystem:</strong> A place where living things and non-living things work together</div><div><strong style="color: #1e40af;">Organism:</strong> Any living thing (plant, animal, bacteria)</div><div><strong style="color: #1e40af;">Producers:</strong> Living things that make their own food (like plants)</div><div><strong style="color: #1e40af;">Consumers:</strong> Living things that eat other living things for energy</div><div><strong style="color: #1e40af;">Decomposers:</strong> Living things that break down dead plants and animals</div><div><strong style="color: #1e40af;">Photosynthesis:</strong> How plants use sunlight to make food</div><div><strong style="color: #1e40af;">Nutrients:</strong> Good things in food and soil that help living things grow</div><div><strong style="color: #1e40af;">Environment:</strong> Everything around a living thing (air, water, soil)</div></div></div>`}
          template={`WORD BANK â€” Emerging Level
==========================================

Subject: ____________  Topic: _______________

Instructions: Use this word bank while you read.
Look at the words and definitions BEFORE you read.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Word             â”‚ What It Means             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. _____________ â”‚ _________________________ â”‚
â”‚                  â”‚ _________________________ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Practice: Use 3 words from the word bank in your
own sentences.

1. _____________________________________________
2. _____________________________________________
3. _____________________________________________`}
          tips={[
            "Pre-teach the word bank before students encounter the text â€” don't just hand it out",
            "Use the simplest possible definitions (imagine explaining to a younger sibling)",
            "Include pictures or drawings next to words when possible",
            "Consider adding native language translations for newcomer students",
            "Limit to 8-12 words to avoid overwhelming students",
          ]}
        />

        {/* Visual Organizer: Main Idea Map */}
        <ScaffoldSection
          icon={Network}
          title="Visual Organizer: Main Idea & Details Map"
          description="A graphic organizer that helps Emerging students identify the main idea of a text and find 3 supporting details. This is especially useful for informational texts where students need to distinguish central ideas from supporting evidence."
          whenToUse={[
            "After reading informational text passages",
            "Before writing a summary",
            "When students need help identifying what the text is mostly about",
            "Close reading activities focused on central ideas and key details",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Read the article about recycling. What is the main idea? What are three supporting details?</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Read the article about recycling. What is the main idea? What are three supporting details?</p><div style="border: 2px solid #8b5cf6; padding: 1.5rem; margin: 1rem 0; background: #f5f3ff; border-radius: 8px;"><strong style="color: #6d28d9;">Main Idea &amp; Details Map</strong><br/><br/><div style="text-align: center; padding: 0.75rem; background: #ede9fe; border-radius: 6px; border: 1px solid #c4b5fd; font-weight: 600;">Main Idea: What is this text MOSTLY about?<br/>______________________________________</div><br/><div style="display: grid; gap: 0.75rem;"><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #ddd8fe;">Detail 1: ______________________________________</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #ddd8fe;">Detail 2: ______________________________________</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #ddd8fe;">Detail 3: ______________________________________</div></div></div>`}
          template={`MAIN IDEA & DETAILS MAP â€” Emerging Level
==========================================

Text / Article Title: ___________________________

Step 1: Read the text.
Step 2: Answer the questions below.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MAIN IDEA                          â”‚
â”‚                                             â”‚
â”‚ What is this text MOSTLY about?             â”‚
â”‚                                             â”‚
â”‚ ________________________________________    â”‚
â”‚ ________________________________________    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Detail 1â”‚ â”‚Detail 2â”‚ â”‚Detail 3â”‚
â”‚        â”‚ â”‚        â”‚ â”‚        â”‚
â”‚________â”‚ â”‚________â”‚ â”‚________â”‚
â”‚________â”‚ â”‚________â”‚ â”‚________â”‚
â”‚________â”‚ â”‚________â”‚ â”‚________â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Now write a summary using this frame:
"This text is mostly about _____________.
 One detail is _________________________.
 Another detail is ____________________.
 Finally, _____________________________."

_________________________________________________
_________________________________________________
_________________________________________________`}
          tips={[
            "Have students state the main idea verbally before writing it down",
            "Remind students: the main idea is NOT a detail â€” it is what ALL the details are about",
            "This pairs well with the summary sentence frames scaffold",
            "For extra support, give students 5 details to choose from (2 correct, 3 distractors)",
          ]}
        />
      </div>
    </div>
  );
}

/* ================================================================== */
/*  EXPANDING TAB                                                      */
/* ================================================================== */

function ExpandingTab() {
  return (
    <div className="space-y-6">
      <div className="rounded-xl border-l-4 border-orange-400 bg-orange-50/50 p-4 dark:border-orange-500 dark:bg-orange-900/10">
        <div className="flex items-center gap-2 mb-1">
          <h3 className="font-semibold text-orange-800 dark:text-orange-300">
            Expanding Level â€” Moderate Support
          </h3>
          <LevelBadge level="Expanding" />
        </div>
        <p className="text-sm text-orange-700/80 dark:text-orange-300/70">
          Students at this level can engage with age-appropriate content with moderate
          scaffolding. Focus on building academic language, unpacking complex sentences,
          and gradually increasing independence. Scaffolds should challenge students to
          use more sophisticated language while still providing structured support.
        </p>
      </div>

      <SectionHeading>All Scaffolds for Expanding Students</SectionHeading>

      <div className="space-y-4">
        {/* Color Coding */}
        <ScaffoldSection
          icon={Palette}
          title="Color Coding: Claims, Evidence & Reasoning"
          description="At the Expanding level, color coding shifts from basic main idea identification to analyzing argument structure. Students highlight claims, evidence, and reasoning (CER) to understand how authors build arguments. This supports analytical reading and prepares students for argumentative writing."
          whenToUse={[
            "Argumentative or persuasive texts",
            "Science lab reports or explanations using CER format",
            "Before students write their own argument paragraphs",
            "When analyzing author's purpose and rhetorical strategies",
          ]}
          exampleBefore={`<p>Many scientists believe that climate change is the most serious challenge facing our planet. According to NASA, global temperatures have risen by 1.1Â°C since the late 1800s. This matters because even small temperature changes can cause major shifts in weather patterns, sea levels, and ecosystems. If temperatures continue to rise, we could see more extreme weather events and rising sea levels that threaten coastal cities.</p>`}
          exampleAfter={`<p><span style="background-color: #FFF176; padding: 2px 4px; border-radius: 2px; color: #000;">Many scientists believe that climate change is the most serious challenge facing our planet.</span> <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">According to NASA, global temperatures have risen by 1.1Â°C since the late 1800s.</span> <span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px; color: #000;">This matters because even small temperature changes can cause major shifts in weather patterns, sea levels, and ecosystems.</span> <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">If temperatures continue to rise, we could see more extreme weather events and rising sea levels that threaten coastal cities.</span></p><p style="margin-top: 12px; font-size: 0.8rem; color: #555;"><strong>Key:</strong> <span style="background-color: #FFF176; padding: 2px 6px; border-radius: 2px;">Yellow = Claim</span>&nbsp; <span style="background-color: #AED581; padding: 2px 6px; border-radius: 2px;">Green = Evidence</span>&nbsp; <span style="background-color: #90CAF9; padding: 2px 6px; border-radius: 2px;">Blue = Reasoning</span></p>`}
          template={`COLOR CODING: CLAIMS, EVIDENCE & REASONING â€” Expanding Level
=============================================================

Instructions: Highlight or underline using these colors:
  - YELLOW = Claim (the author's main argument or position)
  - GREEN  = Evidence (facts, data, quotes that support the claim)
  - BLUE   = Reasoning (explains WHY the evidence matters)

Title: _______________________________________
Author: ______________________________________

After highlighting, answer:
1. What is the author's main CLAIM?
   _____________________________________________

2. What EVIDENCE does the author use? (List 2-3)
   a. _________________________________________
   b. _________________________________________
   c. _________________________________________

3. How does the author explain WHY the evidence
   supports the claim? (REASONING)
   _____________________________________________
   _____________________________________________

4. How strong is this argument? Why?
   _____________________________________________
   _____________________________________________`}
          tips={[
            "Teach the CER (Claim, Evidence, Reasoning) framework explicitly before using this scaffold",
            "Some sentences may contain both evidence and reasoning â€” discuss gray areas",
            "Have students compare their highlighting with a partner to discuss differences",
          ]}
        />

        {/* Chunking */}
        <ScaffoldSection
          icon={LayoutList}
          title="Chunking: Sections with Guiding Questions"
          description="At the Expanding level, chunking uses larger sections (a full paragraph or two) with guiding questions rather than simple pause prompts. The questions push students toward deeper analysis and academic language use, building critical thinking alongside reading comprehension."
          whenToUse={[
            "Multi-paragraph informational texts",
            "Primary source documents in social studies",
            "Complex science readings with multiple concepts",
            "Literature with shifting themes or perspectives",
          ]}
          exampleBefore={`<p>The Industrial Revolution transformed society in the 18th and 19th centuries. Factories replaced small workshops, and cities grew rapidly as people moved from rural areas seeking work. New inventions like the steam engine and spinning jenny dramatically increased production capacity.</p><p>However, these changes came at a cost. Factory workers, including children, often worked 14-16 hour days in dangerous conditions. Air and water pollution increased dramatically. The gap between rich factory owners and poor workers widened, leading to social unrest and the eventual rise of labor unions.</p>`}
          exampleAfter={`<div style="font-weight: 600; margin: 0 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af; border-radius: 4px;">Section 1 of 2: The Changes</div><p>The Industrial Revolution transformed society in the 18th and 19th centuries. Factories replaced small workshops, and cities grew rapidly as people moved from rural areas seeking work. New inventions like the steam engine and spinning jenny dramatically increased production capacity.</p><div style="margin: 0.75rem 0; padding: 0.75rem; background: #eff6ff; border-left: 3px solid #3b82f6; font-size: 0.875rem; border-radius: 4px;"><strong>Guiding Questions:</strong><br/>1. What were the main changes during the Industrial Revolution?<br/>2. Why did people move to cities?<br/>3. What is the author's tone â€” positive, negative, or neutral?</div><div style="font-weight: 600; margin: 1.5rem 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af; border-radius: 4px;">Section 2 of 2: The Costs</div><p>However, these changes came at a cost. Factory workers, including children, often worked 14-16 hour days in dangerous conditions. Air and water pollution increased dramatically. The gap between rich factory owners and poor workers widened, leading to social unrest and the eventual rise of labor unions.</p><div style="margin: 0.75rem 0; padding: 0.75rem; background: #eff6ff; border-left: 3px solid #3b82f6; font-size: 0.875rem; border-radius: 4px;"><strong>Guiding Questions:</strong><br/>1. What were the negative effects of industrialization?<br/>2. How does the word "however" signal a shift in the text?<br/>3. What cause-and-effect relationship does the author describe?</div>`}
          template={`CHUNKING WITH GUIDING QUESTIONS â€” Expanding Level
===================================================

Title: _______________________________________

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section 1: [Title] _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ [Paste paragraph(s) for this section]       â”‚
â”‚                                              â”‚
â”‚ Guiding Questions:                           â”‚
â”‚ 1. _________________________________________ â”‚
â”‚ 2. _________________________________________ â”‚
â”‚ 3. What academic vocabulary is important     â”‚
â”‚    in this section? ________________________ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section 2: [Title] _________________________ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ [Paste paragraph(s) for this section]       â”‚
â”‚                                              â”‚
â”‚ Guiding Questions:                           â”‚
â”‚ 1. _________________________________________ â”‚
â”‚ 2. _________________________________________ â”‚
â”‚ 3. How does this section connect to          â”‚
â”‚    Section 1? _____________________________ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Synthesis Question:
How do all the sections connect to one main idea?
_________________________________________________
_________________________________________________`}
          tips={[
            "Use higher-order guiding questions (analyze, evaluate, connect) rather than basic recall",
            "Include at least one question about academic language or text structure per section",
            "Encourage students to annotate the text while answering questions",
          ]}
        />

        {/* Sentence Frames: Analytical Writing */}
        <ScaffoldSection
          icon={MessageSquareText}
          title="Sentence Frames: Analytical & Academic Writing"
          description="At the Expanding level, sentence frames shift from basic opinion starters to academic analysis frames. These help students engage with complex ideas using academic register, including cause-effect, comparison, and evidence-based reasoning structures."
          whenToUse={[
            "Analytical writing across all content areas",
            "Literary analysis essays",
            "Science explanations using CER format",
            "Comparing two texts, ideas, or perspectives",
          ]}
          exampleBefore={`<p><strong>Writing Prompt:</strong> Analyze how the author uses figurative language in the poem "The Road Not Taken" by Robert Frost. Explain how the figurative language contributes to the poem's theme.</p>`}
          exampleAfter={`<p><strong>Writing Prompt:</strong> Analyze how the author uses figurative language in the poem "The Road Not Taken" by Robert Frost. Explain how the figurative language contributes to the poem's theme.</p><div style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Academic Sentence Frames:</strong><br/><br/>&#x2022; The author uses [type of figurative language] when he/she writes, "____________." This suggests that ____________.<br/><br/>&#x2022; One example of [literary device] is "____________," which shows ____________.<br/><br/>&#x2022; This figurative language is important because it helps the reader understand ____________.<br/><br/>&#x2022; The [metaphor/simile/personification] in line ___ contributes to the theme of ____________ by ____________.<br/><br/>&#x2022; Based on this evidence, the author's message is ____________.</div>`}
          template={`SENTENCE FRAMES: ANALYTICAL WRITING â€” Expanding Level
======================================================

Topic / Prompt: __________________________________

ACADEMIC ANALYSIS FRAMES:

For introducing analysis:
â€¢ The author uses _____________ to show _____________.
â€¢ One example of _____________ is "_______________,"
  which suggests _____________.

For explaining evidence:
â€¢ This is significant because _____________.
â€¢ This evidence demonstrates that _____________.
â€¢ This [quote/detail] reveals _____________.

For comparing:
â€¢ While [Text A] _____________, [Text B] _____________.
â€¢ Both texts show _____________, but they differ in _____________.
â€¢ Similarly, _____________, which suggests _____________.

For cause and effect:
â€¢ As a result of _____________, _____________.
â€¢ Because _____________, the [character/outcome] _____________.
â€¢ This led to _____________, which ultimately _____________.

For concluding:
â€¢ Overall, the evidence shows that _____________.
â€¢ Based on this analysis, _____________.
â€¢ In conclusion, the author's use of _____________
  effectively conveys _____________.

My Analysis:
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________`}
          tips={[
            "Encourage students to combine multiple frames in a single paragraph",
            "Model the difference between 'I think' (opinion) and 'The evidence shows' (analysis)",
            "Have students practice orally first using the frames before writing",
            "Gradually remove frames as students internalize academic language patterns",
          ]}
        />

        {/* Word Banks */}
        <ScaffoldSection
          icon={BookA}
          title="Word Bank: Academic Vocabulary with Context"
          description="At the Expanding level, word banks go beyond simple definitions to include example sentences and word connections. Students are expected to use these words in their own writing, not just recognize them. Focus on Tier 2 academic words (analyze, contrast, significant) and domain-specific Tier 3 words."
          whenToUse={[
            "Texts with sophisticated academic vocabulary",
            "Cross-curricular assignments requiring academic register",
            "Before essay or report writing assignments",
            "When students understand content but lack academic language to express ideas",
          ]}
          exampleBefore={`<p>Read the article about the impact of social media on teenagers and write an argumentative essay about whether schools should ban cell phones during school hours.</p>`}
          exampleAfter={`<p>Read the article about the impact of social media on teenagers and write an argumentative essay about whether schools should ban cell phones during school hours.</p><div style="border: 2px solid #2563eb; padding: 1.25rem; margin: 1.5rem 0; background: #eff6ff; border-radius: 8px;"><h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">Academic Word Bank</h3><div style="display: grid; gap: 0.75rem;"><div><strong style="color: #1e40af;">Impact (noun):</strong> A strong effect on something. <em>"Social media has a significant impact on how teens communicate."</em></div><div><strong style="color: #1e40af;">Argue (verb):</strong> To give reasons for or against something. <em>"Some people argue that cell phones are distracting."</em></div><div><strong style="color: #1e40af;">Evidence (noun):</strong> Facts or information that prove something. <em>"The evidence shows that screen time affects sleep."</em></div><div><strong style="color: #1e40af;">Furthermore (adverb):</strong> In addition; also (a transition word). <em>"Furthermore, studies show that social media can affect mental health."</em></div><div><strong style="color: #1e40af;">Perspective (noun):</strong> A point of view or way of looking at something. <em>"From a teacher's perspective, phones are a major distraction."</em></div><div><strong style="color: #1e40af;">Consequently (adverb):</strong> As a result (shows cause and effect). <em>"Students check their phones often; consequently, they miss instruction."</em></div></div></div>`}
          template={`ACADEMIC WORD BANK WITH CONTEXT â€” Expanding Level
===================================================

Subject: ____________  Topic: ___________________

Instructions: Study these words BEFORE reading.
Use at least 4 of these words in your writing.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Word: _________________                       â”‚
â”‚ Part of Speech: ___________                   â”‚
â”‚ Definition: _________________________________ â”‚
â”‚ Example: "___________________________________ â”‚
â”‚ ___________________________________________"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Word Connections: Pick 2 words and explain how
they relate to each other.
_________________________________________________
_________________________________________________`}
          tips={[
            "Include Tier 2 (cross-curricular) academic words, not just Tier 3 (domain-specific) words",
            "Require students to USE the words in their writing, not just define them",
            "Add example sentences using the word in context",
            "Consider adding synonyms and antonyms to deepen vocabulary understanding",
          ]}
        />

        {/* Visual Organizers */}
        <ScaffoldSection
          icon={Network}
          title="Visual Organizer: Cause & Effect Chart"
          description="A graphic organizer that helps Expanding students map out cause-and-effect relationships in informational texts. Unlike simple matching, this organizer asks students to trace chains of causes and effects and explain the connections between them using academic language."
          whenToUse={[
            "History texts describing events and their consequences",
            "Science readings about processes, reactions, or environmental changes",
            "Current events analysis",
            "Narrative texts where characters' actions drive the plot",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Identify three cause-and-effect relationships in the article about the Dust Bowl. Explain how each cause led to its effect.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Identify three cause-and-effect relationships in the article about the Dust Bowl. Explain how each cause led to its effect.</p><div style="border: 2px solid #f59e0b; padding: 1.5rem; margin: 1rem 0; background: #fffbeb; border-radius: 8px;"><strong style="color: #b45309;">Cause &amp; Effect Organizer</strong><br/><br/><div style="display: grid; gap: 1rem;"><div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center;"><div style="padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fcd34d;"><strong>Cause:</strong> ___________</div><div style="font-size: 1.5rem;">&#10132;</div><div style="padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fcd34d;"><strong>Effect:</strong> ___________</div></div><div style="padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.875rem; font-style: italic;">Explain the connection: Because _______, _______ happened, which led to _______.</div></div></div>`}
          template={`CAUSE & EFFECT CHART â€” Expanding Level
==========================================

Topic: ________________________________________

Instructions: Identify cause-and-effect relationships.
Then explain HOW the cause led to the effect.

CAUSE #1                    EFFECT #1
_____________________  -->  _____________________
_____________________       _____________________

Connection: Because _____________________________,
_____________________________________________ happened.

CAUSE #2                    EFFECT #2
_____________________  -->  _____________________
_____________________       _____________________

Connection: As a result of ______________________,
_____________________________________________.

CAUSE #3                    EFFECT #3
_____________________  -->  _____________________
_____________________       _____________________

Connection: This led to _________________________
because ________________________________________.

Chain Reaction: How are these cause-and-effect
relationships connected to each other?
_________________________________________________
_________________________________________________
_________________________________________________`}
          tips={[
            "Teach signal words for cause/effect: because, as a result, consequently, therefore, led to",
            "Encourage students to look for chain reactions (one effect becomes the cause of the next event)",
            "Model the difference between correlation and causation at this level",
          ]}
        />

        {/* Visual Organizer: T-Chart */}
        <ScaffoldSection
          icon={Network}
          title="Visual Organizer: T-Chart for Two Perspectives"
          description="A T-chart organizer for analyzing two sides of an issue or two perspectives on a topic. At the Expanding level, this pushes students beyond simple listing to analyzing which perspective is more supported by evidence and forming their own evidence-based position."
          whenToUse={[
            "Debate preparation or argumentative writing assignments",
            "Analyzing two characters' perspectives in literature",
            "Evaluating pros and cons of a policy or decision",
            "Comparing two historical or scientific viewpoints",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Should students be required to wear school uniforms? Analyze both sides of the argument and take a position supported by evidence.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Should students be required to wear school uniforms? Analyze both sides of the argument and take a position supported by evidence.</p><div style="border: 2px solid #6366f1; padding: 1.5rem; margin: 1rem 0; background: #eef2ff; border-radius: 8px;"><strong style="color: #4338ca;">Two Perspectives Organizer</strong><br/><br/><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #c7d2fe;"><strong style="color: #4338ca;">For Uniforms:</strong><br/>- _____<br/>- _____<br/>- _____<br/><em>Strongest evidence:</em> _____</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #c7d2fe;"><strong style="color: #4338ca;">Against Uniforms:</strong><br/>- _____<br/>- _____<br/>- _____<br/><em>Strongest evidence:</em> _____</div></div><br/><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #c7d2fe;"><strong>My Position:</strong> Based on the evidence, I believe ______ because ______.</div></div>`}
          template={`T-CHART: TWO PERSPECTIVES â€” Expanding Level
=============================================

Issue / Question: _______________________________
_________________________________________________

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERSPECTIVE A:      â”‚ PERSPECTIVE B:          â”‚
â”‚ ________________    â”‚ ________________        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚                         â”‚
â”‚ 1. ________________ â”‚ 1. ________________     â”‚
â”‚ 2. ________________ â”‚ 2. ________________     â”‚
â”‚ 3. ________________ â”‚ 3. ________________     â”‚
â”‚                     â”‚                         â”‚
â”‚ Evidence:           â”‚ Evidence:               â”‚
â”‚ ________________    â”‚ ________________        â”‚
â”‚ ________________    â”‚ ________________        â”‚
â”‚                     â”‚                         â”‚
â”‚ Strongest point:    â”‚ Strongest point:        â”‚
â”‚ ________________    â”‚ ________________        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

My Position:
Based on the evidence, I believe _______________
because ________________________________________
________________________________________________.

One counterargument is ________________________,
but I still believe ___________ because ________
________________________________________________.`}
          tips={[
            "Require students to fill in BOTH sides before writing their position â€” this builds stronger arguments",
            "Teach the concept of counterarguments at this level",
            "Encourage students to evaluate which evidence is STRONGEST, not just list all points",
          ]}
        />
      </div>
    </div>
  );
}

/* ================================================================== */
/*  BRIDGING TAB                                                       */
/* ================================================================== */

function BridgingTab() {
  return (
    <div className="space-y-6">
      <div className="rounded-xl border-l-4 border-green-400 bg-green-50/50 p-4 dark:border-green-500 dark:bg-green-900/10">
        <div className="flex items-center gap-2 mb-1">
          <h3 className="font-semibold text-green-800 dark:text-green-300">
            Bridging Level â€” Light Support
          </h3>
          <LevelBadge level="Bridging" />
        </div>
        <p className="text-sm text-green-700/80 dark:text-green-300/70">
          Students at this level are approaching grade-level independence. Scaffolds
          should focus on nuanced academic language, complex text structures, and
          self-monitoring strategies. The goal is building independence â€” use scaffolds
          as reference tools rather than mandatory supports. Emphasis shifts to
          self-assessment, peer collaboration, and sophisticated analytical language.
        </p>
      </div>

      <SectionHeading>All Scaffolds for Bridging Students</SectionHeading>

      <div className="space-y-4">
        {/* Color Coding */}
        <ScaffoldSection
          icon={Palette}
          title="Color Coding: Rhetorical Analysis"
          description="At the Bridging level, color coding is used for advanced rhetorical analysis â€” identifying ethos, pathos, and logos appeals, or tracking author's use of rhetorical devices across a text. Students at this level should be able to explain WHY the author made specific language choices and evaluate their effectiveness."
          whenToUse={[
            "Argumentative or persuasive texts for rhetorical analysis",
            "Speeches, editorials, and opinion pieces",
            "AP-level or advanced analytical reading tasks",
            "When students need to evaluate the effectiveness of arguments, not just identify them",
          ]}
          exampleBefore={`<p>We must act now to protect our oceans. Every year, over 8 million tons of plastic waste enters our oceans, killing marine wildlife and destroying ecosystems that millions of people depend on for food and livelihood. Dr. Sylvia Earle, one of the world's leading marine biologists, warns that "the ocean is in trouble, and therefore so are we." Can we really afford to wait while our children inherit a dying sea?</p>`}
          exampleAfter={`<p><span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px; color: #000;">We must act now to protect our oceans.</span> <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px; color: #000;">Every year, over 8 million tons of plastic waste enters our oceans, killing marine wildlife and destroying ecosystems that millions of people depend on for food and livelihood.</span> <span style="background-color: #CE93D8; padding: 2px 4px; border-radius: 2px; color: #000;">Dr. Sylvia Earle, one of the world's leading marine biologists, warns that</span> "the ocean is in trouble, and therefore so are we." <span style="background-color: #FFAB91; padding: 2px 4px; border-radius: 2px; color: #000;">Can we really afford to wait while our children inherit a dying sea?</span></p><p style="margin-top: 12px; font-size: 0.8rem; color: #555;"><strong>Key:</strong> <span style="background-color: #90CAF9; padding: 2px 6px; border-radius: 2px;">Blue = Call to Action</span>&nbsp; <span style="background-color: #AED581; padding: 2px 6px; border-radius: 2px;">Green = Logos (Facts/Data)</span>&nbsp; <span style="background-color: #CE93D8; padding: 2px 6px; border-radius: 2px;">Purple = Ethos (Credibility)</span>&nbsp; <span style="background-color: #FFAB91; padding: 2px 6px; border-radius: 2px;">Orange = Pathos (Emotional Appeal)</span></p>`}
          template={`COLOR CODING: RHETORICAL ANALYSIS â€” Bridging Level
===================================================

Instructions: Highlight using these colors:
  - GREEN  = Logos (facts, statistics, logical reasoning)
  - PURPLE = Ethos (expert quotes, credibility appeals)
  - ORANGE = Pathos (emotional language, imagery, questions)
  - BLUE   = Call to Action / Thesis

Title: _______________________________________
Author: ______________________________________

ANALYSIS:

1. Which appeal does the author use MOST? Why?
   _____________________________________________
   _____________________________________________

2. Identify one example of logos and explain why
   it is (or isn't) effective:
   _____________________________________________
   _____________________________________________

3. How does the author use pathos to persuade?
   Is this an effective strategy? Why or why not?
   _____________________________________________
   _____________________________________________

4. Does the author establish credibility (ethos)?
   How? Is it convincing?
   _____________________________________________
   _____________________________________________

5. Overall, how effective is this argument?
   What could the author improve?
   _____________________________________________
   _____________________________________________`}
          tips={[
            "Encourage students to evaluate the EFFECTIVENESS of each appeal, not just identify it",
            "Discuss how authors often combine multiple appeals in a single sentence",
            "This is excellent preparation for AP-level rhetorical analysis",
            "Consider having students compare two texts' use of rhetorical strategies",
          ]}
        />

        {/* Sentence Frames: Complex Analysis */}
        <ScaffoldSection
          icon={MessageSquareText}
          title="Sentence Frames: Complex Academic Discourse"
          description="At the Bridging level, sentence frames provide sophisticated academic language structures for complex analysis â€” cause-effect chains, nuanced comparisons, concession and rebuttal, and synthesis across multiple sources. These frames model the language of academic essays and formal discourse."
          whenToUse={[
            "Multi-paragraph analytical or argumentative essays",
            "Synthesizing multiple sources into a single argument",
            "Literary analysis requiring nuanced interpretation",
            "When students have strong ideas but need academic register to express them",
          ]}
          exampleBefore={`<p><strong>Writing Prompt:</strong> Synthesize the three articles about renewable energy. What is the most compelling argument for transitioning to renewable energy sources, and what are the most significant challenges?</p>`}
          exampleAfter={`<p><strong>Writing Prompt:</strong> Synthesize the three articles about renewable energy. What is the most compelling argument for transitioning to renewable energy sources, and what are the most significant challenges?</p><div style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Complex Academic Frames:</strong><br/><br/><strong>For synthesis:</strong><br/>&#x2022; While [Source A] emphasizes ____________, [Source B] argues ____________, suggesting that ____________.<br/>&#x2022; Taken together, these sources demonstrate that ____________.<br/><br/><strong>For concession &amp; rebuttal:</strong><br/>&#x2022; Although some argue that ____________, the evidence suggests ____________ because ____________.<br/>&#x2022; While it is true that ____________, this does not negate the fact that ____________.<br/><br/><strong>For nuanced analysis:</strong><br/>&#x2022; The relationship between ____________ and ____________ is complex; on one hand ____________, while on the other ____________.<br/>&#x2022; This evidence complicates the assumption that ____________ by revealing ____________.</div>`}
          template={`SENTENCE FRAMES: COMPLEX ACADEMIC DISCOURSE â€” Bridging Level
=============================================================

Topic / Prompt: __________________________________

FOR INTRODUCING A THESIS:
â€¢ This analysis reveals that _____________, as
  evidenced by _____________ and _____________.
â€¢ Although _____________ appears straightforward,
  a closer examination reveals _____________.

FOR SYNTHESIZING MULTIPLE SOURCES:
â€¢ While [Source A] emphasizes _____________,
  [Source B] argues _____________, suggesting
  that _____________.
â€¢ Taken together, these sources demonstrate
  that _____________.

FOR CONCESSION & REBUTTAL:
â€¢ Although some argue that _____________, the
  evidence suggests _____________ because _______.
â€¢ While it is true that _____________, this does
  not negate the fact that _____________.
â€¢ Proponents of _______ contend that _________;
  however, _____________.

FOR NUANCED ANALYSIS:
â€¢ The relationship between ______ and ______ is
  complex; on one hand _______, while on the
  other _____________.
â€¢ This evidence complicates the assumption that
  _____________ by revealing _____________.
â€¢ Rather than a simple [cause/correlation],
  _____________ suggests a more nuanced _______.

FOR CONCLUDING:
â€¢ Ultimately, the evidence compels the conclusion
  that _____________.
â€¢ These findings have significant implications
  for _____________, particularly _____________.

My Writing:
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________
_________________________________________________`}
          tips={[
            "Frame these as reference tools, not requirements â€” Bridging students should select frames that fit their ideas",
            "Encourage students to modify and personalize the frames, not just fill in blanks",
            "Discuss the difference between academic register and informal language explicitly",
            "These frames prepare students for AP, honors, and college-level writing",
          ]}
        />

        {/* Word Banks */}
        <ScaffoldSection
          icon={BookA}
          title="Word Bank: Nuanced & Domain-Specific Vocabulary"
          description="At the Bridging level, word banks focus on nuanced vocabulary distinctions â€” the difference between 'argue' and 'contend,' or 'significant' and 'paramount.' Students learn to select the most precise word for their intended meaning, building the sophisticated vocabulary needed for academic independence."
          whenToUse={[
            "Essay writing requiring precise academic language",
            "When students use basic vocabulary but need more sophisticated alternatives",
            "Advanced content-area texts with discipline-specific terminology",
            "Before peer editing sessions focused on word choice",
          ]}
          exampleBefore={`<p>Write a literary analysis essay about the theme of identity in "The House on Mango Street" by Sandra Cisneros.</p>`}
          exampleAfter={`<p>Write a literary analysis essay about the theme of identity in "The House on Mango Street" by Sandra Cisneros.</p><div style="border: 2px solid #2563eb; padding: 1.25rem; margin: 1.5rem 0; background: #eff6ff; border-radius: 8px;"><h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">Nuanced Vocabulary Bank</h3><div style="display: grid; gap: 0.75rem;"><div><strong style="color: #1e40af;">Convey</strong> (vs. "show"): To communicate a meaning or feeling. <em>Use "convey" when the author communicates something indirectly.</em></div><div><strong style="color: #1e40af;">Embody</strong> (vs. "represent"): To be a perfect example of a quality. <em>"Esperanza embodies the tension between aspiration and circumstance."</em></div><div><strong style="color: #1e40af;">Juxtapose</strong> (vs. "compare"): To place side by side to highlight contrast. <em>"Cisneros juxtaposes poverty and dreams to reveal..."</em></div><div><strong style="color: #1e40af;">Underscore</strong> (vs. "show"): To emphasize the importance of something. <em>"This scene underscores the theme of..."</em></div><div><strong style="color: #1e40af;">Nuanced</strong> (vs. "complicated"): Having subtle differences in meaning. <em>"The author presents a nuanced view of identity."</em></div><div><strong style="color: #1e40af;">Poignant</strong> (vs. "sad"): Evoking a deep sense of sadness or emotion. <em>"The poignant ending reveals..."</em></div></div></div>`}
          template={`NUANCED VOCABULARY BANK â€” Bridging Level
==========================================

Subject: ____________  Assignment: ______________

Instructions: Use these words to make your writing
more precise and academic. Pay attention to how each
word is DIFFERENT from the simpler alternative.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRECISE WORD: _______________                     â”‚
â”‚ Instead of: _______________ (basic word)          â”‚
â”‚ Definition: ________________________________      â”‚
â”‚ When to use it: ____________________________      â”‚
â”‚ Example: "___________________________________     â”‚
â”‚ ___________________________________________"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Self-Check: After writing, review your essay.
Did you replace basic words with precise ones?
Circle 3 places where you upgraded your word choice.`}
          tips={[
            "Focus on the NUANCE between basic and precise words, not just adding harder vocabulary",
            "Encourage students to keep a personal vocabulary journal of precise words they discover",
            "Pair with peer editing â€” have partners suggest more precise word choices",
            "Model how overusing advanced vocabulary can make writing feel forced",
          ]}
        />

        {/* Visual Organizer: Argument Map */}
        <ScaffoldSection
          icon={Network}
          title="Visual Organizer: Argument Map with Counterarguments"
          description="An advanced graphic organizer that maps out a full argument structure including thesis, supporting claims with evidence, counterarguments, and rebuttals. This organizer prepares Bridging students for sophisticated argumentative writing by making the logical structure of their argument visible."
          whenToUse={[
            "Multi-paragraph argumentative or persuasive essays",
            "Debate preparation",
            "Research papers requiring synthesis of multiple sources",
            "When students need to strengthen their argument by addressing opposing views",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Write a 5-paragraph argumentative essay on whether the voting age should be lowered to 16. Use evidence from at least two sources to support your position and address a counterargument.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Write a 5-paragraph argumentative essay on whether the voting age should be lowered to 16. Use evidence from at least two sources to support your position and address a counterargument.</p><div style="border: 2px solid #059669; padding: 1.5rem; margin: 1rem 0; background: #ecfdf5; border-radius: 8px;"><strong style="color: #065f46;">Argument Map</strong><br/><br/><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 2px solid #059669; text-align: center; font-weight: 600;">THESIS: ______________________________________</div><br/><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"><div><div style="padding: 0.75rem; background: #d1fae5; border-radius: 6px; border: 1px solid #6ee7b7; margin-bottom: 0.5rem;"><strong>Claim 1:</strong> _____<br/>Evidence: _____<br/>Source: _____</div><div style="padding: 0.75rem; background: #d1fae5; border-radius: 6px; border: 1px solid #6ee7b7;"><strong>Claim 2:</strong> _____<br/>Evidence: _____<br/>Source: _____</div></div><div><div style="padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fcd34d; margin-bottom: 0.5rem;"><strong>Counterargument:</strong> _____<br/>Their evidence: _____</div><div style="padding: 0.75rem; background: #dbeafe; border-radius: 6px; border: 1px solid #93c5fd;"><strong>My Rebuttal:</strong> _____<br/>Why my position is stronger: _____</div></div></div></div>`}
          template={`ARGUMENT MAP WITH COUNTERARGUMENTS â€” Bridging Level
====================================================

Topic / Prompt: __________________________________

THESIS (your position):
_________________________________________________
_________________________________________________

SUPPORTING CLAIMS:

Claim 1: _______________________________________
  Evidence: _____________________________________
  Source: _______________________________________
  Explanation: __________________________________

Claim 2: _______________________________________
  Evidence: _____________________________________
  Source: _______________________________________
  Explanation: __________________________________

Claim 3 (optional): ____________________________
  Evidence: _____________________________________
  Source: _______________________________________
  Explanation: __________________________________

COUNTERARGUMENT:
What might someone who DISAGREES say?
_________________________________________________
What evidence might they use?
_________________________________________________

MY REBUTTAL:
Why is my argument STILL stronger?
_________________________________________________
_________________________________________________

CONCLUSION:
Restate thesis + why it matters:
_________________________________________________
_________________________________________________

Self-Assessment Checklist:
[ ] My thesis takes a clear position.
[ ] Each claim is supported by specific evidence.
[ ] I cited at least two sources.
[ ] I addressed a counterargument.
[ ] My rebuttal explains why my position is stronger.
[ ] My conclusion connects to a bigger idea.`}
          tips={[
            "Emphasize that strong arguments ACKNOWLEDGE opposing views â€” they don't ignore them",
            "Have students peer-review each other's argument maps before drafting",
            "Use this as a planning tool â€” students fill out the map, then write the essay",
            "Encourage students to evaluate whether their evidence actually supports their claim",
          ]}
        />

        {/* Self-Assessment Checklist */}
        <ScaffoldSection
          icon={MessageSquareText}
          title="Self-Assessment: Academic Language Checklist"
          description="A self-monitoring checklist that Bridging students use to evaluate their own writing for academic language features. This scaffold builds metacognitive awareness and independence â€” instead of the teacher providing the scaffold, the student checks their own work against academic standards."
          whenToUse={[
            "Final draft revision for any writing assignment",
            "Before peer editing sessions",
            "When building student independence in academic writing",
            "As a regular routine for self-reflection on language growth",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Review your essay draft before submitting. Check it for academic language use.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Review your essay draft before submitting. Check it for academic language use.</p><div style="border: 2px solid #8b5cf6; padding: 1.5rem; margin: 1rem 0; background: #f5f3ff; border-radius: 8px;"><strong style="color: #6d28d9;">Academic Language Self-Assessment</strong><br/><br/><div style="display: grid; gap: 0.5rem; font-size: 0.875rem;"><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I used precise academic vocabulary (not just basic words)</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I varied my sentence structure (simple, compound, complex)</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I used transition words to connect ideas between sentences and paragraphs</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I cited evidence from the text using proper formatting</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I explained my reasoning (not just stated facts)</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I maintained an academic tone (no slang or casual language)</div><div style="padding: 0.5rem; background: white; border-radius: 4px;">&#9744; I addressed a counterargument (if argumentative)</div></div></div>`}
          template={`ACADEMIC LANGUAGE SELF-ASSESSMENT â€” Bridging Level
===================================================

Name: ________________  Date: ___________________
Assignment: _____________________________________

Review your writing and check each item honestly.

VOCABULARY & WORD CHOICE:
[ ] I used precise academic vocabulary, not just
    basic words. (Circle 3 examples in your essay)
[ ] I chose words that convey the exact meaning
    I intended (nuanced word choice).
[ ] I avoided repetition by using synonyms
    and varied language.

SENTENCE STRUCTURE:
[ ] I used a variety of sentence types (simple,
    compound, complex).
[ ] I combined short sentences using conjunctions,
    relative clauses, or participial phrases.
[ ] My sentences flow smoothly from one to the next.

ORGANIZATION & TRANSITIONS:
[ ] I used transition words to connect ideas
    (furthermore, however, consequently, etc.)
[ ] Each paragraph has a clear topic sentence.
[ ] My ideas are organized in a logical order.

EVIDENCE & ANALYSIS:
[ ] I cited specific evidence from the text.
[ ] I explained HOW the evidence supports my claim
    (not just dropped in quotes).
[ ] I analyzed the evidence rather than just
    summarizing it.

ACADEMIC TONE:
[ ] I maintained formal/academic tone throughout.
[ ] I avoided slang, contractions, and "I feel."
[ ] I used third person where appropriate.

AREAS TO IMPROVE (pick 1-2):
1. _____________________________________________
2. _____________________________________________

GOAL for next assignment:
_________________________________________________`}
          tips={[
            "Have students complete this BEFORE turning in their final draft, not after",
            "Gradually release responsibility â€” students should begin using this independently",
            "Use the 'Areas to Improve' section to set personal goals for the next assignment",
            "Consider having students highlight or circle the evidence of each checklist item in their essay",
          ]}
        />

        {/* Peer Editing */}
        <ScaffoldSection
          icon={Network}
          title="Peer Editing: Language-Focused Feedback Guide"
          description="A structured peer editing guide that focuses specifically on academic language feedback. Bridging students provide each other with specific, actionable feedback on word choice, sentence structure, and academic register â€” building both the editor's analytical skills and the writer's revision skills."
          whenToUse={[
            "Peer review sessions for essays and research papers",
            "After initial drafts but before final revision",
            "When building a culture of academic feedback in the classroom",
            "Collaborative writing workshops",
          ]}
          exampleBefore={`<p><strong>Prompt:</strong> Exchange essays with a partner and provide feedback on their writing.</p>`}
          exampleAfter={`<p><strong>Prompt:</strong> Exchange essays with a partner and provide feedback on their writing.</p><div style="border: 2px solid #0891b2; padding: 1.5rem; margin: 1rem 0; background: #ecfeff; border-radius: 8px;"><strong style="color: #155e75;">Peer Editing Guide â€” Focus on Academic Language</strong><br/><br/><div style="display: grid; gap: 0.75rem; font-size: 0.875rem;"><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #a5f3fc;"><strong>Word Choice:</strong> Find 2 places where the writer could use a more precise or academic word. Write your suggestion next to the word.</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #a5f3fc;"><strong>Evidence Integration:</strong> Does the writer explain their evidence, or just drop in quotes? Star one place where they could add more analysis.</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #a5f3fc;"><strong>Sentence Variety:</strong> Are the sentences varied in length and structure? Underline a section that feels repetitive.</div><div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #a5f3fc;"><strong>Strengths:</strong> What is the STRONGEST part of this essay's language? Write a specific compliment.</div></div></div>`}
          template={`PEER EDITING: ACADEMIC LANGUAGE FEEDBACK â€” Bridging Level
==========================================================

Writer's Name: _____________  Editor's Name: ____________
Assignment: _____________________________________________

INSTRUCTIONS FOR THE EDITOR:
Read your partner's essay carefully. Focus on their
LANGUAGE, not their ideas. Give specific feedback.

1. WORD CHOICE
   Find 2 places where a MORE PRECISE word could
   replace a basic word.

   a. Change "___________" to "___________"
      (Paragraph ___, Line ___)
   b. Change "___________" to "___________"
      (Paragraph ___, Line ___)

2. EVIDENCE INTEGRATION
   Find 1 place where the writer "drops in" a quote
   without explaining it. How should they fix it?
   _________________________________________________
   _________________________________________________

3. SENTENCE VARIETY
   Underline a section where sentences feel repetitive
   or choppy. Suggest how to combine or vary them:
   _________________________________________________
   _________________________________________________

4. TRANSITIONS
   Is there a place where the ideas jump without a
   transition? Which transition word would help?
   _________________________________________________

5. ACADEMIC TONE
   Is there any informal language (slang, "I feel,"
   contractions)? Circle and suggest alternatives.
   _________________________________________________

6. STRONGEST LANGUAGE MOMENT
   What is the BEST sentence or word choice in
   this essay? Why is it effective?
   _________________________________________________
   _________________________________________________

OVERALL FEEDBACK (2-3 sentences):
_________________________________________________
_________________________________________________
_________________________________________________`}
          tips={[
            "Model giving specific, actionable feedback (not just 'good job' or 'fix this')",
            "Teach the difference between editing for IDEAS and editing for LANGUAGE",
            "Have editors sign their feedback â€” accountability improves quality",
            "Consider a feedback fishbowl: model a peer editing session for the whole class first",
          ]}
        />
      </div>
    </div>
  );
}

/* ================================================================== */
/*  Main Page Component                                                */
/* ================================================================== */

export default function ScaffoldsReferencePage() {
  const [activeTab, setActiveTab] = useState("emerging");

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div>
        <h1 className="scaffold-heading">ELD Scaffolds Reference</h1>
        <p className="scaffold-description mt-1">
          Complete reference for all ELD scaffold types by proficiency level,
          with examples and printable templates for teachers.
        </p>
      </div>

      {/* Hero Banner */}
      <div className="flex flex-col gap-4 rounded-2xl border border-eld-almond-silk/40 bg-white p-5 md:flex-row md:items-center md:gap-6 md:p-6 dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="flex h-14 w-14 shrink-0 items-center justify-center rounded-xl bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
          <Layers className="h-7 w-7 text-eld-space-indigo dark:text-eld-almond-silk" />
        </div>
        <div>
          <h2 className="text-lg font-bold text-foreground">
            Every Scaffold, Every Level â€” In Detail
          </h2>
          <p className="mt-1 text-sm text-muted-foreground">
            This page covers all five scaffold categories (Color Coding, Chunking,
            Sentence Frames, Word Banks, and Visual Organizers) across all three
            ELD proficiency levels. Each scaffold includes a detailed explanation,
            a before-and-after example, and a copyable template you can use
            without the AI tool.
          </p>
        </div>
      </div>

      {/* How to Use */}
      <InfoBanner variant="info">
        <strong>How to use this page:</strong> Select a proficiency level tab
        below to see all scaffolds appropriate for that level. Each scaffold
        includes a concrete example and a teacher template you can copy, print,
        and fill in with your own content. Click the &quot;Copy&quot; button on
        any template to copy it to your clipboard.
      </InfoBanner>

      {/* Quick Reference Card */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Scaffold Categories at a Glance</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-5">
            {[
              {
                icon: Palette,
                name: "Color Coding",
                description: "Highlight text elements with colors to make structure visible",
                levels: "All Levels",
              },
              {
                icon: LayoutList,
                name: "Chunking",
                description: "Break long texts into smaller, manageable sections",
                levels: "Emerging & Expanding",
              },
              {
                icon: MessageSquareText,
                name: "Sentence Frames",
                description: "Provide structured sentence starters for writing",
                levels: "All Levels",
              },
              {
                icon: BookA,
                name: "Word Banks",
                description: "Key vocabulary with definitions and context",
                levels: "All Levels",
              },
              {
                icon: Network,
                name: "Visual Organizers",
                description: "Graphic organizers to structure thinking",
                levels: "All Levels",
              },
            ].map((cat) => (
              <div
                key={cat.name}
                className="flex flex-col items-center gap-2 rounded-xl border border-eld-almond-silk/40 p-4 text-center dark:border-gray-700/60"
              >
                <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-eld-almond-silk/30 dark:bg-eld-dusty-grape/30">
                  <cat.icon className="h-5 w-5 text-eld-space-indigo dark:text-eld-almond-silk" />
                </div>
                <h4 className="text-sm font-semibold text-foreground">{cat.name}</h4>
                <p className="text-xs text-muted-foreground">{cat.description}</p>
                <span className="text-xs font-medium text-eld-dusty-grape dark:text-eld-lilac-ash">
                  {cat.levels}
                </span>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Level Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
          <TabsList className="min-w-max">
            <TabsTrigger value="emerging">
              <span className="flex items-center gap-2">
                Emerging
                <span className="hidden sm:inline-flex items-center rounded-full bg-red-100 px-1.5 py-0.5 text-[10px] font-medium text-red-700 dark:bg-red-900/30 dark:text-red-300">
                  Substantial
                </span>
              </span>
            </TabsTrigger>
            <TabsTrigger value="expanding">
              <span className="flex items-center gap-2">
                Expanding
                <span className="hidden sm:inline-flex items-center rounded-full bg-orange-100 px-1.5 py-0.5 text-[10px] font-medium text-orange-700 dark:bg-orange-900/30 dark:text-orange-300">
                  Moderate
                </span>
              </span>
            </TabsTrigger>
            <TabsTrigger value="bridging">
              <span className="flex items-center gap-2">
                Bridging
                <span className="hidden sm:inline-flex items-center rounded-full bg-green-100 px-1.5 py-0.5 text-[10px] font-medium text-green-700 dark:bg-green-900/30 dark:text-green-300">
                  Light
                </span>
              </span>
            </TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="emerging">
          <EmergingTab />
        </TabsContent>
        <TabsContent value="expanding">
          <ExpandingTab />
        </TabsContent>
        <TabsContent value="bridging">
          <BridgingTab />
        </TabsContent>
      </Tabs>
    </div>
  );
}
"use client";

import { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import {
  BookOpen,
  Search,
  Download,
  Eye,
  Trash2,
  PenSquare,
  Loader2,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { ELBadge } from "@/components/students/el-badge";
import { formatRelativeDate } from "@/lib/utils";
import type { DifferentiatedAssignment, ELLevel } from "@/types";
import { EL_LEVELS } from "@/types";

export default function LibraryPage() {
  const router = useRouter();
  const [entries, setEntries] = useState<DifferentiatedAssignment[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [filterLevel, setFilterLevel] = useState<ELLevel | "all">("all");
  const [deleteTarget, setDeleteTarget] = useState<DifferentiatedAssignment | null>(null);
  const [isExporting, setIsExporting] = useState<string | null>(null);

  useEffect(() => {
    async function load() {
      try {
        const res = await fetch("/api/library");
        if (res.ok) {
          setEntries(await res.json());
        } else {
          toast.error("Failed to load library.");
        }
      } catch {
        toast.error("Failed to load library.");
      } finally {
        setIsLoading(false);
      }
    }
    load();
  }, []);

  const filtered = useMemo(() => {
    let result = entries;
    if (filterLevel !== "all") {
      result = result.filter((e) => e.el_level === filterLevel);
    }
    if (search) {
      const lower = search.toLowerCase();
      result = result.filter(
        (e) =>
          (e.assignment_title ?? "").toLowerCase().includes(lower) ||
          (e.student_name ?? "").toLowerCase().includes(lower)
      );
    }
    return result;
  }, [entries, search, filterLevel]);

  async function handleDelete(entry: DifferentiatedAssignment) {
    try {
      const res = await fetch(`/api/library/${entry.id}`, { method: "DELETE" });
      if (!res.ok) throw new Error();
      setEntries((prev) => prev.filter((e) => e.id !== entry.id));
      setDeleteTarget(null);
      toast.success("Assignment removed from library.");
    } catch {
      toast.error("Failed to delete assignment.");
    }
  }

  async function handleDownloadPdf(entry: DifferentiatedAssignment) {
    setIsExporting(entry.id);
    try {
      const { downloadScaffoldPdf } = await import("@/lib/export-pdf");
      await downloadScaffoldPdf({
        html: entry.output_html,
        title: entry.assignment_title,
        elLevel: entry.el_level as ELLevel,
        filename: `${entry.assignment_title}-${entry.el_level}-scaffolded.pdf`,
      });
      toast.success("PDF downloaded!");
    } catch {
      toast.error("Failed to generate PDF.");
    } finally {
      setIsExporting(null);
    }
  }

  function handleView(entry: DifferentiatedAssignment) {
    router.push(`/library/${entry.id}`);
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-20">
        <Loader2 className="h-6 w-6 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 className="scaffold-heading">Library</h1>
          <p className="scaffold-description mt-1">
            Your saved scaffolded assignments.
          </p>
        </div>
        <Button
          onClick={() => router.push("/create")}
          className="gap-2 shrink-0"
        >
          <PenSquare className="h-4 w-4" />
          Create Assignment
        </Button>
      </div>

      {entries.length > 0 && (
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center">
          {/* Search */}
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Search by title or student..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
          {/* EL Level Filter */}
          <div className="flex gap-1.5">
            <button
              onClick={() => setFilterLevel("all")}
              className={`rounded-full px-3 py-1.5 text-xs font-medium transition-colors ${
                filterLevel === "all"
                  ? "bg-eld-space-indigo/15 text-eld-space-indigo font-bold dark:bg-eld-dusty-grape dark:text-white"
                  : "bg-eld-almond-silk/20 text-eld-dusty-grape hover:bg-eld-almond-silk/40 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
              }`}
            >
              All
            </button>
            {EL_LEVELS.map((level) => (
              <button
                key={level}
                onClick={() => setFilterLevel(level)}
                className={`rounded-full px-3 py-1.5 text-xs font-medium transition-colors ${
                  filterLevel === level
                    ? "bg-eld-space-indigo/15 text-eld-space-indigo font-bold dark:bg-eld-dusty-grape dark:text-white"
                    : "bg-eld-almond-silk/20 text-eld-dusty-grape hover:bg-eld-almond-silk/40 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
                }`}
              >
                {level}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Empty State */}
      {entries.length === 0 ? (
        <div className="flex flex-col items-center justify-center rounded-2xl border-2 border-dashed border-eld-almond-silk/40 dark:border-gray-700 py-16 text-center">
          <BookOpen className="h-10 w-10 text-muted-foreground mb-3" />
          <p className="text-sm font-medium text-foreground">
            No saved assignments yet
          </p>
          <p className="mt-1 text-xs text-muted-foreground">
            Scaffolded assignments will be saved here after generation.
          </p>
          <Button
            onClick={() => router.push("/create")}
            variant="secondary"
            className="mt-4 gap-2"
          >
            <PenSquare className="h-4 w-4" />
            Create Your First Assignment
          </Button>
        </div>
      ) : filtered.length === 0 ? (
        <div className="flex flex-col items-center justify-center rounded-2xl border-2 border-dashed border-eld-almond-silk/40 dark:border-gray-700 py-12 text-center">
          <Search className="h-8 w-8 text-muted-foreground mb-3" />
          <p className="text-sm font-medium text-foreground">
            No matching assignments
          </p>
          <p className="mt-1 text-xs text-muted-foreground">
            Try adjusting your search or filter.
          </p>
        </div>
      ) : (
        <div className="grid gap-4 md:gap-6 sm:grid-cols-2 xl:grid-cols-3">
          {filtered.map((entry) => (
            <Card
              key={entry.id}
              className="group relative hover:shadow-theme-md transition-shadow"
            >
              <CardContent className="pt-5">
                <div className="space-y-3">
                  {/* Title & Demo badge */}
                  <div className="flex items-start justify-between gap-2">
                    <h3 className="text-sm font-semibold line-clamp-2">
                      {entry.assignment_title}
                    </h3>
                    {entry.is_demo && (
                      <span className="shrink-0 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-medium text-amber-700">
                        Demo
                      </span>
                    )}
                  </div>

                  {/* Metadata */}
                  <div className="flex items-center gap-2">
                    <ELBadge level={entry.el_level as ELLevel} />
                    <span className="text-xs text-muted-foreground">
                      {entry.student_name}
                    </span>
                  </div>

                  {/* Scaffold tags */}
                  <div className="flex flex-wrap gap-1">
                    {entry.scaffolds_applied.slice(0, 3).map((name) => (
                      <span
                        key={name}
                        className="rounded-full bg-eld-almond-silk/20 px-2 py-0.5 text-[10px] text-eld-dusty-grape dark:bg-gray-800 dark:text-gray-400"
                      >
                        {name.split(":")[0]}
                      </span>
                    ))}
                    {entry.scaffolds_applied.length > 3 && (
                      <span className="rounded-full bg-eld-almond-silk/20 px-2 py-0.5 text-[10px] text-eld-dusty-grape dark:bg-gray-800 dark:text-gray-400">
                        +{entry.scaffolds_applied.length - 3}
                      </span>
                    )}
                  </div>

                  {/* Date */}
                  <p className="text-xs text-muted-foreground">
                    {formatRelativeDate(entry.created_at)}
                  </p>

                  {/* Actions */}
                  <div className="flex gap-2 pt-1">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleView(entry)}
                      className="gap-1.5 flex-1"
                    >
                      <Eye className="h-3.5 w-3.5" />
                      View
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleDownloadPdf(entry)}
                      disabled={isExporting === entry.id}
                      className="gap-1.5"
                    >
                      <Download className="h-3.5 w-3.5" />
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setDeleteTarget(entry)}
                      className="gap-1.5 text-destructive hover:text-destructive"
                    >
                      <Trash2 className="h-3.5 w-3.5" />
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Delete Confirmation Dialog */}
      <Dialog
        open={!!deleteTarget}
        onOpenChange={(open) => !open && setDeleteTarget(null)}
      >
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Delete Assignment?</DialogTitle>
            <DialogDescription>
              This will permanently remove &quot;{deleteTarget?.assignment_title}
              &quot; from your library. This action cannot be undone.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDeleteTarget(null)}>
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={() => deleteTarget && handleDelete(deleteTarget)}
            >
              Delete
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
"use client";

import { useCallback, useEffect, useRef, useState } from "react";
import { useRouter, useParams } from "next/navigation";
import { toast } from "sonner";
import {
  ArrowLeft,
  Download,
  Printer,
  ExternalLink,
  FileText,
  PenSquare,
  ChevronDown,
  ChevronUp,
  Trash2,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { ELBadge } from "@/components/students/el-badge";
import { formatDate } from "@/lib/utils";
import { useGoogleDocsExport } from "@/lib/hooks/use-google-docs-export";
import type { DifferentiatedAssignment, ELLevel } from "@/types";

export default function LibraryDetailPage() {
  const router = useRouter();
  const params = useParams();
  const [entry, setEntry] = useState<DifferentiatedAssignment | null>(null);
  const [notFound, setNotFound] = useState(false);
  const [showOriginal, setShowOriginal] = useState(false);
  const [notes, setNotes] = useState("");
  const [isExporting, setIsExporting] = useState(false);
  const [showDelete, setShowDelete] = useState(false);
  const debounceRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const {
    isGoogleConnected,
    isExporting: isGDocsExporting,
    exportToGoogleDocs,
  } = useGoogleDocsExport();

  const id = params.id as string;

  useEffect(() => {
    if (!id) {
      setNotFound(true);
      return;
    }
    async function load() {
      try {
        const res = await fetch(`/api/library/${id}`);
        if (!res.ok) {
          setNotFound(true);
          return;
        }
        const data = await res.json();
        setEntry(data);
        setNotes(data.teacher_notes ?? "");
      } catch {
        setNotFound(true);
      }
    }
    load();
  }, [id]);

  const handleNotesChange = useCallback(
    (value: string) => {
      setNotes(value);
      if (debounceRef.current) clearTimeout(debounceRef.current);
      debounceRef.current = setTimeout(async () => {
        if (id) {
          try {
            await fetch(`/api/library/${id}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ teacher_notes: value }),
            });
          } catch {
            // Silent fail on note save
          }
        }
      }, 500);
    },
    [id]
  );

  async function handleDownloadPdf() {
    if (!entry) return;
    setIsExporting(true);
    try {
      const { downloadScaffoldPdf } = await import("@/lib/export-pdf");
      await downloadScaffoldPdf({
        html: entry.output_html,
        title: entry.assignment_title,
        elLevel: entry.el_level as ELLevel,
        filename: `${entry.assignment_title}-${entry.el_level}-scaffolded.pdf`,
      });
      toast.success("PDF downloaded successfully!");
    } catch {
      toast.error("Failed to generate PDF. Please try again.");
    } finally {
      setIsExporting(false);
    }
  }

  async function handleDelete() {
    try {
      const res = await fetch(`/api/library/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error();
      toast.success("Assignment removed from library.");
      router.push("/library");
    } catch {
      toast.error("Failed to delete assignment.");
    }
  }

  if (notFound) {
    return (
      <div className="flex flex-col items-center justify-center py-20 text-center">
        <FileText className="h-12 w-12 text-muted-foreground mb-4" />
        <h2 className="text-lg font-semibold">Assignment Not Found</h2>
        <p className="text-sm text-muted-foreground mt-1 mb-4">
          This assignment may have been deleted.
        </p>
        <Button onClick={() => router.push("/library")}>
          <ArrowLeft className="h-4 w-4 mr-2" />
          Back to Library
        </Button>
      </div>
    );
  }

  if (!entry) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="h-6 w-6 animate-spin rounded-full border-2 border-eld-space-indigo border-t-transparent dark:border-eld-dusty-grape dark:border-t-transparent" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 className="scaffold-heading">{entry.assignment_title}</h1>
          <p className="scaffold-description mt-1">
            Generated {formatDate(entry.created_at)}
            {entry.is_demo && " (Demo)"}
          </p>
        </div>
        <div className="flex gap-2 shrink-0">
          <Button
            variant="outline"
            onClick={() => setShowDelete(true)}
            className="gap-2 text-destructive hover:text-destructive"
          >
            <Trash2 className="h-4 w-4" />
            Delete
          </Button>
          <Button
            variant="outline"
            onClick={() => router.push("/create")}
            className="gap-2"
          >
            <PenSquare className="h-4 w-4" />
            Create New
          </Button>
        </div>
      </div>

      {/* Metadata Card */}
      <Card>
        <CardContent className="pt-6">
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div>
              <p className="text-theme-xs font-medium text-muted-foreground">
                Student
              </p>
              <p className="text-sm font-medium mt-0.5">{entry.student_name}</p>
            </div>
            <div>
              <p className="text-theme-xs font-medium text-muted-foreground">
                EL Level
              </p>
              <div className="mt-1">
                <ELBadge level={entry.el_level as ELLevel} />
              </div>
            </div>
            <div>
              <p className="text-theme-xs font-medium text-muted-foreground">
                Scaffolds Applied
              </p>
              <p className="text-sm font-medium mt-0.5">
                {entry.scaffolds_applied.length} scaffold
                {entry.scaffolds_applied.length !== 1 ? "s" : ""}
              </p>
            </div>
          </div>

          <div className="mt-4 flex flex-wrap gap-1.5">
            {entry.scaffolds_applied.map((name) => (
              <span
                key={name}
                className="inline-flex items-center rounded-full bg-eld-almond-silk/20 px-2.5 py-0.5 text-xs font-medium text-eld-space-indigo"
              >
                {name}
              </span>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Original Content Toggle */}
      {entry.original_content && (
        <Card>
          <CardHeader className="pb-0">
            <button
              onClick={() => setShowOriginal(!showOriginal)}
              className="flex items-center gap-2 text-left"
            >
              <CardTitle className="text-sm">Original Assignment</CardTitle>
              {showOriginal ? (
                <ChevronUp className="h-4 w-4 text-muted-foreground" />
              ) : (
                <ChevronDown className="h-4 w-4 text-muted-foreground" />
              )}
            </button>
          </CardHeader>
          {showOriginal && (
            <CardContent className="pt-3">
              <div className="rounded-xl border border-eld-almond-silk/40 bg-eld-seashell/50 p-4 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto scrollbar-thin dark:border-gray-700 dark:bg-gray-800/30">
                {entry.original_content}
              </div>
            </CardContent>
          )}
        </Card>
      )}

      {/* Generated HTML Preview */}
      <Card>
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle className="text-lg">Preview</CardTitle>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={handleDownloadPdf}
              disabled={isExporting}
              className="gap-1.5"
            >
              <Download className="h-3.5 w-3.5" />
              {isExporting ? "Exporting..." : "Download PDF"}
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => window.print()}
              className="gap-1.5"
            >
              <Printer className="h-3.5 w-3.5" />
              Print
            </Button>
            <Button
              variant="outline"
              size="sm"
              disabled={!isGoogleConnected || isGDocsExporting}
              onClick={() =>
                entry &&
                exportToGoogleDocs({
                  title: entry.assignment_title,
                  outputHtml: entry.output_html,
                  elLevel: entry.el_level as ELLevel,
                  scaffoldsApplied: entry.scaffolds_applied,
                })
              }
              className="gap-1.5"
              title={
                isGoogleConnected
                  ? "Export to Google Docs"
                  : "Connect Google account in Settings"
              }
            >
              <ExternalLink className="h-3.5 w-3.5" />
              <span className="hidden sm:inline">
                {isGDocsExporting ? "Exporting..." : "Google Docs"}
              </span>
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <div
            id="scaffold-preview-content"
            className="scaffold-preview rounded-xl border bg-white p-6 dark:bg-gray-50"
            dangerouslySetInnerHTML={{ __html: entry.output_html }}
          />
        </CardContent>
      </Card>

      {/* Teacher Notes */}
      <Card>
        <CardHeader>
          <CardTitle className="text-sm">Teacher Notes</CardTitle>
        </CardHeader>
        <CardContent>
          <textarea
            value={notes}
            onChange={(e) => handleNotesChange(e.target.value)}
            placeholder="Add notes about this scaffolded assignment..."
            className="w-full rounded-lg border border-eld-almond-silk/60 bg-white px-4 py-2.5 text-sm shadow-theme-xs placeholder:text-gray-400 focus:border-eld-space-indigo focus:outline-none focus:ring-3 focus:ring-eld-space-indigo/10 min-h-[80px] resize-y dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"
          />
          <p className="mt-1.5 text-xs text-muted-foreground">
            Notes are auto-saved.
          </p>
        </CardContent>
      </Card>

      {/* Bottom Actions */}
      <div className="flex justify-between">
        <Button
          variant="outline"
          onClick={() => router.push("/library")}
          className="gap-2"
        >
          <ArrowLeft className="h-4 w-4" />
          Back to Library
        </Button>
      </div>

      {/* Delete Confirmation Dialog */}
      <Dialog open={showDelete} onOpenChange={setShowDelete}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Delete Assignment?</DialogTitle>
            <DialogDescription>
              This will permanently remove &quot;{entry.assignment_title}&quot;
              from your library. This action cannot be undone.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowDelete(false)}>
              Cancel
            </Button>
            <Button variant="destructive" onClick={handleDelete}>
              Delete
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
"use client";

import { Suspense, useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";
import { toast } from "sonner";
import {
  Settings,
  Link2,
  Link2Off,
  Loader2,
  AlertCircle,
  CheckCircle2,
  Palette,
  Info,
  User,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { ThemeToggle } from "@/components/layout/theme-toggle";
import { useUserProfile } from "@/lib/hooks/use-user-profile";

interface GoogleStatus {
  configured: boolean;
  connected: boolean;
  email: string | null;
}

function SettingsContent() {
  const searchParams = useSearchParams();
  const [googleStatus, setGoogleStatus] = useState<GoogleStatus | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isDisconnecting, setIsDisconnecting] = useState(false);
  const { profile, saveProfile, isLoaded, isSaving } = useUserProfile();
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");

  useEffect(() => {
    if (isLoaded) {
      setFirstName(profile.firstName);
      setLastName(profile.lastName);
    }
  }, [isLoaded, profile.firstName, profile.lastName]);

  async function handleSaveProfile() {
    const ok = await saveProfile({ firstName: firstName.trim(), lastName: lastName.trim() });
    if (ok) {
      toast.success("Profile saved!");
    } else {
      toast.error("Failed to save profile. Please try again.");
    }
  }

  useEffect(() => {
    async function checkStatus() {
      try {
        const res = await fetch("/api/google-auth/status");
        const data = await res.json();
        setGoogleStatus(data);
      } catch {
        setGoogleStatus({ configured: false, connected: false, email: null });
      } finally {
        setIsLoading(false);
      }
    }
    checkStatus();
  }, []);

  // Handle redirect params from OAuth callback
  useEffect(() => {
    if (searchParams.get("connected") === "true") {
      toast.success("Google account connected successfully!");
      // Re-check status to get email
      fetch("/api/google-auth/status")
        .then((r) => r.json())
        .then((data) => setGoogleStatus(data))
        .catch(() => {});
    }
    const googleError = searchParams.get("google_error");
    if (googleError) {
      const messages: Record<string, string> = {
        access_denied: "Google account connection was cancelled.",
        no_refresh_token:
          "Could not get a refresh token. Please try again and grant offline access.",
        token_exchange_failed:
          "Failed to exchange authorization code. Please try again.",
      };
      toast.error(messages[googleError] ?? "Google connection failed.");
    }
  }, [searchParams]);

  async function handleDisconnect() {
    setIsDisconnecting(true);
    try {
      await fetch("/api/google-auth/disconnect", { method: "POST" });
      setGoogleStatus((prev) =>
        prev ? { ...prev, connected: false, email: null } : prev
      );
      toast.success("Google account disconnected.");
    } catch {
      toast.error("Failed to disconnect. Please try again.");
    } finally {
      setIsDisconnecting(false);
    }
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="scaffold-heading">Settings</h1>
        <p className="scaffold-description mt-1">
          Manage your account and application preferences.
        </p>
      </div>

      {/* Profile */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-base">
            <User className="h-4 w-4" />
            Profile
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <p className="text-sm text-muted-foreground">
              Your name is used for personalized greetings on the dashboard.
            </p>
            <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div className="space-y-1.5">
                <label htmlFor="firstName" className="text-sm font-medium">
                  First Name
                </label>
                <Input
                  id="firstName"
                  placeholder="e.g. Maria"
                  value={firstName}
                  onChange={(e) => setFirstName(e.target.value)}
                />
              </div>
              <div className="space-y-1.5">
                <label htmlFor="lastName" className="text-sm font-medium">
                  Last Name
                </label>
                <Input
                  id="lastName"
                  placeholder="e.g. Garcia"
                  value={lastName}
                  onChange={(e) => setLastName(e.target.value)}
                />
              </div>
            </div>
            <Button onClick={handleSaveProfile} size="sm" disabled={isSaving}>
              {isSaving ? "Savingâ€¦" : "Save Profile"}
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Google Account Connection */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-base">
            <Settings className="h-4 w-4" />
            Google Account
          </CardTitle>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="flex items-center gap-2 text-sm text-muted-foreground">
              <Loader2 className="h-4 w-4 animate-spin" />
              Checking connection status...
            </div>
          ) : !googleStatus?.configured ? (
            /* Google OAuth not configured */
            <div className="rounded-xl border border-amber-200 bg-amber-50 p-4 dark:border-amber-800 dark:bg-amber-950/30">
              <div className="flex gap-3">
                <AlertCircle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-amber-800 dark:text-amber-300">
                    Google OAuth Not Configured
                  </p>
                  <p className="mt-1 text-sm text-amber-700 dark:text-amber-400">
                    To enable Google Docs export, add your Google OAuth
                    credentials to{" "}
                    <code className="rounded bg-amber-100 px-1 py-0.5 text-xs dark:bg-amber-900/50">
                      .env.local
                    </code>
                    :
                  </p>
                  <pre className="mt-2 rounded bg-amber-100 p-2 text-xs text-amber-900 dark:bg-amber-900/50 dark:text-amber-200">
                    {`GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_SECRET=your_client_secret
GOOGLE_REDIRECT_URI=http://localhost:3000/api/google-auth/callback`}
                  </pre>
                </div>
              </div>
            </div>
          ) : googleStatus.connected ? (
            /* Connected */
            <div className="space-y-4">
              <div className="flex items-center gap-3 rounded-xl border border-green-200 bg-green-50 p-4 dark:border-green-800 dark:bg-green-950/30">
                <CheckCircle2 className="h-5 w-5 text-green-600 shrink-0" />
                <div className="flex-1">
                  <p className="text-sm font-medium text-green-800 dark:text-green-300">
                    Connected
                  </p>
                  <p className="text-sm text-green-700 dark:text-green-400">
                    {googleStatus.email}
                  </p>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleDisconnect}
                  disabled={isDisconnecting}
                  className="gap-1.5"
                >
                  {isDisconnecting ? (
                    <Loader2 className="h-3.5 w-3.5 animate-spin" />
                  ) : (
                    <Link2Off className="h-3.5 w-3.5" />
                  )}
                  Disconnect
                </Button>
              </div>
              <p className="text-xs text-muted-foreground">
                You can export scaffolded assignments directly to Google Docs.
              </p>
            </div>
          ) : (
            /* Configured but not connected */
            <div className="space-y-4">
              <p className="text-sm text-muted-foreground">
                Connect your Google account to export scaffolded assignments
                directly to Google Docs.
              </p>
              <Button asChild className="gap-2">
                <a href="/api/google-auth/authorize">
                  <Link2 className="h-4 w-4" />
                  Connect Google Account
                </a>
              </Button>
              <p className="text-xs text-muted-foreground">
                We&apos;ll request access to create Google Docs on your behalf.
                You can disconnect at any time.
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Theme */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-base">
            <Palette className="h-4 w-4" />
            Appearance
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium">Theme</p>
              <p className="text-xs text-muted-foreground">
                Choose your preferred color scheme.
              </p>
            </div>
            <ThemeToggle />
          </div>
        </CardContent>
      </Card>

      {/* About */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-base">
            <Info className="h-4 w-4" />
            About
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-sm">
            <div className="flex justify-between py-3 border-b border-eld-almond-silk/40 dark:border-gray-800">
              <span className="text-muted-foreground">Application</span>
              <span className="font-medium">VAMS ELD Scaffolding Platform</span>
            </div>
            <div className="flex justify-between py-3 border-b border-eld-almond-silk/40 dark:border-gray-800">
              <span className="text-muted-foreground">Version</span>
              <span className="font-medium">1.0.0</span>
            </div>
            <div className="flex justify-between py-3">
              <span className="text-muted-foreground">School</span>
              <span className="font-medium">Valor Academy Middle School</span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

export default function SettingsPage() {
  return (
    <Suspense
      fallback={
        <div className="flex items-center justify-center py-20">
          <div className="h-6 w-6 animate-spin rounded-full border-2 border-eld-space-indigo border-t-transparent dark:border-eld-dusty-grape dark:border-t-transparent" />
        </div>
      }
    >
      <SettingsContent />
    </Suspense>
  );
}
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import { Upload } from "lucide-react";
import { StudentsTable } from "@/components/students/students-table";
import { StudentFormModal } from "@/components/students/student-form-modal";
import { DeleteStudentDialog } from "@/components/students/delete-student-dialog";
import { BulkImportModal } from "@/components/students/bulk-import-modal";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { useIsAdmin } from "@/lib/hooks/use-admin";
import {
  getAllStudents,
  createStudent,
  updateStudent,
  deleteStudent,
  bulkImportStudents,
} from "@/lib/queries/students";
import type { Student } from "@/types";
import type { StudentFormValues } from "@/lib/validations";

export default function StudentsPage() {
  const { isAdmin, isLoading: isAdminLoading } = useIsAdmin();
  const [students, setStudents] = useState<Student[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Modal states
  const [addModalOpen, setAddModalOpen] = useState(false);
  const [editModalOpen, setEditModalOpen] = useState(false);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [bulkImportOpen, setBulkImportOpen] = useState(false);
  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null);

  const fetchStudents = useCallback(async () => {
    try {
      const data = await getAllStudents();
      setStudents(data);
    } catch {
      setStudents([]);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchStudents();
  }, [fetchStudents]);

  async function handleAddStudent(data: StudentFormValues) {
    setIsSubmitting(true);
    try {
      const newStudent = await createStudent({
        ssid: data.ssid ?? "",
        name: data.name,
        grade: data.grade,
        homeroom: data.homeroom ?? "",
        el_level: data.el_level,
        overall_level: data.overall_level ?? 0,
        oral_language_level: data.oral_language_level ?? 0,
        written_language_level: data.written_language_level ?? 0,
        primary_language: data.primary_language,
        notes: data.notes,
        created_by: "",
      });
      setStudents((prev) => [...prev, newStudent].sort((a, b) => a.name.localeCompare(b.name)));
      setAddModalOpen(false);
      toast.success(`${data.name} added successfully`);
    } catch {
      toast.error("Failed to add student.");
    } finally {
      setIsSubmitting(false);
    }
  }

  async function handleEditStudent(data: StudentFormValues) {
    if (!selectedStudent) return;
    setIsSubmitting(true);
    try {
      const updated = await updateStudent(selectedStudent.id, data);
      setStudents((prev) =>
        prev.map((s) => (s.id === updated.id ? updated : s))
      );
      setEditModalOpen(false);
      setSelectedStudent(null);
      toast.success(`${data.name} updated successfully`);
    } catch {
      toast.error("Failed to update student.");
    } finally {
      setIsSubmitting(false);
    }
  }

  async function handleDeleteStudent() {
    if (!selectedStudent) return;
    setIsSubmitting(true);
    try {
      await deleteStudent(selectedStudent.id);
      setStudents((prev) => prev.filter((s) => s.id !== selectedStudent.id));
      setDeleteDialogOpen(false);
      toast.success(`${selectedStudent.name} deleted`);
      setSelectedStudent(null);
    } catch {
      toast.error("Failed to delete student.");
    } finally {
      setIsSubmitting(false);
    }
  }

  async function handleBulkImport(
    studentData: Array<{
      name: string;
      grade: number;
      el_level: string;
      primary_language: string;
      notes?: string;
    }>
  ) {
    const result = await bulkImportStudents(studentData);
    if (result.imported > 0) {
      await fetchStudents();
      toast.success(`${result.imported} student${result.imported !== 1 ? "s" : ""} imported`);
    }
    return result;
  }

  if (isLoading || isAdminLoading) {
    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-10 w-32" />
        </div>
        <div className="flex gap-2">
          <Skeleton className="h-10 flex-1 max-w-sm" />
          <Skeleton className="h-10 w-32" />
          <Skeleton className="h-10 w-32" />
        </div>
        <div className="rounded-2xl border border-eld-almond-silk/40 dark:border-gray-800">
          {Array.from({ length: 5 }).map((_, i) => (
            <div key={i} className="flex items-center gap-4 border-b px-4 py-3">
              <Skeleton className="h-4 w-40" />
              <Skeleton className="h-4 w-12" />
              <Skeleton className="h-5 w-20 rounded-full" />
              <Skeleton className="h-4 w-24" />
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="scaffold-heading">Students</h1>
          <p className="scaffold-description mt-1">
            {isAdmin
              ? "Manage the school-wide student roster and EL proficiency levels."
              : "View the school-wide student roster and EL proficiency levels."}
          </p>
        </div>
        {isAdmin && (
          <Button
            variant="outline"
            onClick={() => setBulkImportOpen(true)}
            className="gap-2"
          >
            <Upload className="h-4 w-4" />
            Bulk Import
          </Button>
        )}
      </div>

      <StudentsTable
        students={students}
        isAdmin={isAdmin}
        onAdd={() => setAddModalOpen(true)}
        onEdit={(student) => {
          setSelectedStudent(student);
          setEditModalOpen(true);
        }}
        onDelete={(student) => {
          setSelectedStudent(student);
          setDeleteDialogOpen(true);
        }}
      />

      {isAdmin && (
        <>
          <StudentFormModal
            open={addModalOpen}
            onOpenChange={setAddModalOpen}
            onSubmit={handleAddStudent}
            isLoading={isSubmitting}
          />

          <StudentFormModal
            key={selectedStudent?.id ?? "new"}
            open={editModalOpen}
            onOpenChange={(open) => {
              setEditModalOpen(open);
              if (!open) setSelectedStudent(null);
            }}
            onSubmit={handleEditStudent}
            student={selectedStudent}
            isLoading={isSubmitting}
          />

          <DeleteStudentDialog
            open={deleteDialogOpen}
            onOpenChange={(open) => {
              setDeleteDialogOpen(open);
              if (!open) setSelectedStudent(null);
            }}
            student={selectedStudent}
            onConfirm={handleDeleteStudent}
            isLoading={isSubmitting}
          />

          <BulkImportModal
            open={bulkImportOpen}
            onOpenChange={setBulkImportOpen}
            onImport={handleBulkImport}
          />
        </>
      )}
    </div>
  );
}
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import Link from "next/link";
import {
  ArrowLeft,
  PenSquare,
  Palette,
  Layers,
  Type,
  BookOpen,
  LayoutGrid,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { ELBadge } from "@/components/students/el-badge";
import { getStudentById } from "@/lib/queries/students";
import { defaultScaffolds } from "@/lib/seed-scaffolds";
import type { Student } from "@/types";
import { formatDate } from "@/lib/utils";

const categoryIcons: Record<string, React.ElementType> = {
  color_coding: Palette,
  chunking: Layers,
  sentence_frames: Type,
  word_banks: BookOpen,
  visual_organizers: LayoutGrid,
};

const categoryLabels: Record<string, string> = {
  color_coding: "Color Coding",
  chunking: "Chunking",
  sentence_frames: "Sentence Frames",
  word_banks: "Word Banks",
  visual_organizers: "Visual Organizers",
};

export default function StudentDetailPage() {
  const params = useParams();
  const studentId = params.id as string;

  const [student, setStudent] = useState<Student | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchStudent() {
      try {
        const data = await getStudentById(studentId);
        setStudent(data);
      } catch {
        setError("Failed to load student. Check your Supabase connection.");
      } finally {
        setIsLoading(false);
      }
    }
    fetchStudent();
  }, [studentId]);

  // Get recommended scaffolds for this student's EL level
  const recommendedScaffolds = student
    ? defaultScaffolds.filter((s) =>
        s.el_level_target.includes(student.el_level)
      )
    : [];

  if (isLoading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-6 w-32" />
        <div className="space-y-2">
          <Skeleton className="h-8 w-64" />
          <div className="flex gap-2">
            <Skeleton className="h-5 w-16 rounded-full" />
            <Skeleton className="h-5 w-20" />
            <Skeleton className="h-5 w-24" />
          </div>
        </div>
        <div className="grid gap-4 md:gap-6 md:grid-cols-2">
          {Array.from({ length: 4 }).map((_, i) => (
            <Skeleton key={i} className="h-24 rounded-lg" />
          ))}
        </div>
      </div>
    );
  }

  if (error || !student) {
    return (
      <div className="space-y-4">
        <Link
          href="/students"
          className="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          <ArrowLeft className="h-4 w-4" />
          Back to Students
        </Link>
        <div className="flex flex-col items-center justify-center py-16 text-center">
          <p className="text-lg font-medium text-foreground">Student not found</p>
          <p className="mt-1 text-sm text-muted-foreground">
            {error || "This student may have been deleted."}
          </p>
          <Button asChild className="mt-4" variant="outline">
            <Link href="/students">View All Students</Link>
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Back link */}
      <Link
        href="/students"
        className="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <ArrowLeft className="h-4 w-4" />
        Back to Students
      </Link>

      {/* Student header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 className="scaffold-heading">{student.name}</h1>
          <div className="mt-2 flex flex-wrap items-center gap-2 text-sm text-muted-foreground">
            <ELBadge level={student.el_level} />
            <span>Grade {student.grade}</span>
            <span>&middot;</span>
            <span>{student.primary_language}</span>
          </div>
          {student.notes && (
            <p className="mt-3 text-sm text-muted-foreground max-w-xl">
              {student.notes}
            </p>
          )}
          <p className="mt-2 text-xs text-muted-foreground">
            Added {formatDate(student.created_at)}
          </p>
        </div>
        <Button asChild className="gap-2 shrink-0">
          <Link href={`/create?student=${student.id}`}>
            <PenSquare className="h-4 w-4" />
            Create Assignment for {student.name.split(" ")[0]}
          </Link>
        </Button>
      </div>

      {/* Recommended Scaffolds */}
      <div>
        <h2 className="scaffold-subheading mb-4">
          Recommended Scaffolds for {student.el_level}
        </h2>
        <div className="grid gap-4 md:gap-6 md:grid-cols-2">
          {recommendedScaffolds.map((scaffold, idx) => {
            const Icon = categoryIcons[scaffold.category] || BookOpen;
            return (
              <Card key={idx}>
                <CardHeader className="pb-2">
                  <div className="flex items-center gap-2">
                    <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-eld-almond-silk/30">
                      <Icon className="h-4 w-4 text-primary" />
                    </div>
                    <div>
                      <CardTitle className="text-sm font-medium">
                        {scaffold.name}
                      </CardTitle>
                      <span className="text-xs text-muted-foreground">
                        {categoryLabels[scaffold.category]}
                      </span>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-muted-foreground">
                    {scaffold.description}
                  </p>
                  <div className="mt-2 flex flex-wrap gap-1">
                    {scaffold.el_level_target.map((level) => (
                      <span
                        key={level}
                        className="rounded-full bg-eld-almond-silk/20 px-2 py-0.5 text-xs text-eld-dusty-grape dark:bg-gray-800 dark:text-gray-400"
                      >
                        {level}
                      </span>
                    ))}
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      </div>

      {/* Past Differentiated Assignments */}
      <div>
        <h2 className="scaffold-subheading mb-4">Past Differentiated Assignments</h2>
        <div className="flex flex-col items-center justify-center rounded-lg border border-dashed py-12 text-center">
          <p className="text-sm text-muted-foreground">No assignments yet</p>
          <p className="mt-1 text-xs text-muted-foreground">
            Create a scaffolded assignment for {student.name.split(" ")[0]} to see it here.
          </p>
        </div>
      </div>
    </div>
  );
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { isAdminEmail } from "@/lib/admin";

export async function GET(request: NextRequest) {
  const response = NextResponse.next({ request });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user?.email) {
    return NextResponse.json({ role: "teacher" }, { status: 401 });
  }

  const role = isAdminEmail(user.email) ? "admin" : "teacher";
  return NextResponse.json({ role });
}
import { NextRequest, NextResponse } from "next/server";
import nodemailer from "nodemailer";

const RECIPIENT_EMAIL = "dvandiest@brightstarschools.org";

function escapeHtml(str: string): string {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function row(label: string, value: string | undefined) {
  if (!value?.trim()) return "";
  return `
    <tr>
      <td style="padding: 8px 12px; font-weight: 600; color: #444; background: #f0f0f4; white-space: nowrap; vertical-align: top; border-bottom: 1px solid #e0e0e8;">${label}</td>
      <td style="padding: 8px 12px; color: #333; border-bottom: 1px solid #e0e0e8; white-space: pre-wrap;">${escapeHtml(value.trim())}</td>
    </tr>`;
}

export async function POST(req: NextRequest) {
  const body = await req.json();

  const {
    reporterName,
    reporterEmail,
    category,
    severity,
    affectedPage,
    description,
    stepsToReproduce,
    expectedBehavior,
    actualBehavior,
    browserDevice,
    additionalNotes,
  } = body as Record<string, string | undefined>;

  const smtpHost = process.env.SMTP_HOST;
  const smtpPort = parseInt(process.env.SMTP_PORT ?? "587", 10);
  const smtpUser = process.env.SMTP_USER;
  const smtpPass = process.env.SMTP_PASS;

  if (!smtpHost || !smtpUser || !smtpPass) {
    return NextResponse.json(
      { error: "Email service is not configured. Please contact your administrator." },
      { status: 503 }
    );
  }

  const transporter = nodemailer.createTransport({
    host: smtpHost,
    port: smtpPort,
    secure: smtpPort === 465,
    auth: { user: smtpUser, pass: smtpPass },
  });

  const severityColor: Record<string, string> = {
    Critical: "#dc2626",
    High: "#ea580c",
    Medium: "#d97706",
    Low: "#16a34a",
  };
  const sev = severity?.trim() ?? "Not specified";
  const sevColor = severityColor[sev] ?? "#555";

  const subjectName = reporterName?.trim() ? reporterName.trim() : "Anonymous";
  const subjectCategory = category?.trim() ? ` [${category.trim()}]` : "";

  await transporter.sendMail({
    from: `"VAMS ELD Platform" <${smtpUser}>`,
    to: RECIPIENT_EMAIL,
    subject: `Bug Report${subjectCategory} from ${subjectName} â€“ VAMS ELD`,
    text: [
      `Bug Report â€“ VAMS ELD Platform`,
      `---`,
      reporterName ? `Reporter: ${reporterName.trim()}` : "",
      reporterEmail ? `Email: ${reporterEmail.trim()}` : "",
      category ? `Category: ${category.trim()}` : "",
      severity ? `Severity: ${severity.trim()}` : "",
      affectedPage ? `Affected Page: ${affectedPage.trim()}` : "",
      description ? `Description:\n${description.trim()}` : "",
      stepsToReproduce ? `Steps to Reproduce:\n${stepsToReproduce.trim()}` : "",
      expectedBehavior ? `Expected Behavior:\n${expectedBehavior.trim()}` : "",
      actualBehavior ? `Actual Behavior:\n${actualBehavior.trim()}` : "",
      browserDevice ? `Browser / Device:\n${browserDevice.trim()}` : "",
      additionalNotes ? `Additional Notes:\n${additionalNotes.trim()}` : "",
    ]
      .filter(Boolean)
      .join("\n\n"),
    html: `
      <div style="font-family: sans-serif; max-width: 640px; margin: 0 auto; color: #333;">
        <h2 style="color: #22223b; border-bottom: 3px solid #22223b; padding-bottom: 10px; margin-bottom: 20px;">
          ðŸ› Bug Report â€“ VAMS ELD Platform
        </h2>

        <div style="margin-bottom: 16px;">
          <span style="display: inline-block; background: ${sevColor}; color: #fff; font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 12px; letter-spacing: 0.05em;">
            ${escapeHtml(sev)} Severity
          </span>
          ${category?.trim() ? `<span style="display: inline-block; background: #e8e8f0; color: #22223b; font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 12px; margin-left: 6px;">${escapeHtml(category.trim())}</span>` : ""}
        </div>

        <table style="width: 100%; border-collapse: collapse; border: 1px solid #e0e0e8; border-radius: 6px; overflow: hidden; margin-bottom: 24px;">
          ${row("Reporter", reporterName)}
          ${row("Email", reporterEmail)}
          ${row("Category", category)}
          ${row("Severity", severity)}
          ${row("Affected Page", affectedPage)}
          ${row("Browser / Device", browserDevice)}
        </table>

        ${description?.trim() ? `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #22223b; font-size: 14px; margin-bottom: 6px;">Description</h3>
          <div style="background: #f5f5f5; border-left: 4px solid #22223b; padding: 14px 16px; border-radius: 4px; white-space: pre-wrap; font-size: 14px;">${escapeHtml(description.trim())}</div>
        </div>` : ""}

        ${stepsToReproduce?.trim() ? `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #22223b; font-size: 14px; margin-bottom: 6px;">Steps to Reproduce</h3>
          <div style="background: #f5f5f5; border-left: 4px solid #6366f1; padding: 14px 16px; border-radius: 4px; white-space: pre-wrap; font-size: 14px;">${escapeHtml(stepsToReproduce.trim())}</div>
        </div>` : ""}

        ${expectedBehavior?.trim() || actualBehavior?.trim() ? `
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          ${expectedBehavior?.trim() ? `
          <div style="flex: 1;">
            <h3 style="color: #16a34a; font-size: 14px; margin-bottom: 6px;">Expected Behavior</h3>
            <div style="background: #f0fdf4; border-left: 4px solid #16a34a; padding: 12px 14px; border-radius: 4px; white-space: pre-wrap; font-size: 14px;">${escapeHtml(expectedBehavior.trim())}</div>
          </div>` : ""}
          ${actualBehavior?.trim() ? `
          <div style="flex: 1;">
            <h3 style="color: #dc2626; font-size: 14px; margin-bottom: 6px;">Actual Behavior</h3>
            <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 12px 14px; border-radius: 4px; white-space: pre-wrap; font-size: 14px;">${escapeHtml(actualBehavior.trim())}</div>
          </div>` : ""}
        </div>` : ""}

        ${additionalNotes?.trim() ? `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #22223b; font-size: 14px; margin-bottom: 6px;">Additional Notes</h3>
          <div style="background: #f5f5f5; border-left: 4px solid #94a3b8; padding: 14px 16px; border-radius: 4px; white-space: pre-wrap; font-size: 14px;">${escapeHtml(additionalNotes.trim())}</div>
        </div>` : ""}

        <p style="color: #999; font-size: 12px; margin-top: 28px; border-top: 1px solid #e0e0e8; padding-top: 12px;">
          Submitted via the VAMS ELD Scaffolding Platform Bug Report form
        </p>
      </div>
    `,
  });

  return NextResponse.json({ success: true });
}
import { NextRequest, NextResponse } from "next/server";
import nodemailer from "nodemailer";

const RECIPIENT_EMAIL = "dvandiest@brightstarschools.org";

export async function POST(req: NextRequest) {
  const { firstName, lastName, message } = await req.json();

  if (!firstName?.trim() || !lastName?.trim() || !message?.trim()) {
    return NextResponse.json(
      { error: "First name, last name, and message are required." },
      { status: 400 }
    );
  }

  const smtpHost = process.env.SMTP_HOST;
  const smtpPort = parseInt(process.env.SMTP_PORT ?? "587", 10);
  const smtpUser = process.env.SMTP_USER;
  const smtpPass = process.env.SMTP_PASS;

  if (!smtpHost || !smtpUser || !smtpPass) {
    return NextResponse.json(
      { error: "Email service is not configured. Please contact your administrator." },
      { status: 503 }
    );
  }

  const transporter = nodemailer.createTransport({
    host: smtpHost,
    port: smtpPort,
    secure: smtpPort === 465,
    auth: {
      user: smtpUser,
      pass: smtpPass,
    },
  });

  await transporter.sendMail({
    from: `"VAMS ELD Platform" <${smtpUser}>`,
    to: RECIPIENT_EMAIL,
    subject: `Message from ${firstName.trim()} ${lastName.trim()} â€“ VAMS ELD`,
    text: `You have a new message from ${firstName.trim()} ${lastName.trim()}:\n\n${message.trim()}`,
    html: `
      <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #22223b; border-bottom: 2px solid #22223b; padding-bottom: 8px;">
          New Message â€“ VAMS ELD Platform
        </h2>
        <p style="color: #555; margin-bottom: 4px;"><strong>From:</strong> ${firstName.trim()} ${lastName.trim()}</p>
        <div style="background: #f5f5f5; border-left: 4px solid #22223b; padding: 16px; margin-top: 16px; border-radius: 4px;">
          <p style="margin: 0; white-space: pre-wrap; color: #333;">${message.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
        </div>
        <p style="color: #999; font-size: 12px; margin-top: 24px;">
          Sent via the VAMS ELD Scaffolding Platform
        </p>
      </div>
    `,
  });

  return NextResponse.json({ success: true });
}
import { NextResponse } from "next/server";
import { isGoogleConfigured, getAuthUrl } from "@/lib/google-oauth";

export async function GET() {
  if (!isGoogleConfigured()) {
    return NextResponse.json(
      {
        error: "Google OAuth not configured",
        message:
          "Add GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET to your .env.local file.",
      },
      { status: 503 }
    );
  }

  const url = getAuthUrl();
  return NextResponse.redirect(url);
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import {
  isGoogleConfigured,
  exchangeCodeForTokens,
  getUserEmail,
  saveGoogleToken,
  GOOGLE_TOKEN_COOKIE,
} from "@/lib/google-oauth";

/**
 * Read the Supabase user directly from the request cookies.
 *
 * We intentionally avoid the shared `getAuthUser` helper here because this
 * route is hit via a cross-origin redirect from Google.  The helper creates a
 * throw-away NextResponse for the Supabase cookie writer â€” if the session
 * needs a token refresh during the redirect the refreshed cookies are lost and
 * `getUser()` can return null.
 *
 * Instead we create a Supabase client whose `setAll` writes refreshed tokens
 * directly onto the redirect `response` we already have, so they travel back
 * to the browser together with the Google token cookie.
 */
async function getCallbackUser(
  request: NextRequest,
  response: NextResponse
) {
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // Write refreshed Supabase tokens onto the redirect response so the
          // browser receives them in the same round-trip.
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}

export async function GET(request: NextRequest) {
  if (!isGoogleConfigured()) {
    return NextResponse.json(
      { error: "Google OAuth not configured" },
      { status: 503 }
    );
  }

  const { searchParams } = new URL(request.url);
  const code = searchParams.get("code");
  const error = searchParams.get("error");

  if (error) {
    // User denied consent or some error
    const redirectUrl = new URL("/settings", request.url);
    redirectUrl.searchParams.set("google_error", error);
    return NextResponse.redirect(redirectUrl);
  }

  if (!code) {
    return NextResponse.json(
      { error: "Authorization code missing" },
      { status: 400 }
    );
  }

  try {
    const tokens = await exchangeCodeForTokens(code);

    if (!tokens.refresh_token) {
      const redirectUrl = new URL("/settings", request.url);
      redirectUrl.searchParams.set("google_error", "no_refresh_token");
      return NextResponse.redirect(redirectUrl);
    }

    const redirectUrl = new URL("/settings", request.url);
    redirectUrl.searchParams.set("connected", "true");

    const response = NextResponse.redirect(redirectUrl);

    // Store refresh token in httpOnly cookie
    response.cookies.set(GOOGLE_TOKEN_COOKIE, tokens.refresh_token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: "lax",
      path: "/",
      maxAge: 60 * 60 * 24 * 365, // 1 year
    });

    // Persist to database so the connection survives cookie clears / logouts.
    // Use getCallbackUser which writes refreshed Supabase session cookies onto
    // the same redirect response, avoiding the stale-token problem.
    const user = await getCallbackUser(request, response);
    if (user) {
      const email = await getUserEmail(tokens.refresh_token);
      await saveGoogleToken(user.id, tokens.refresh_token, email);
    } else {
      // Log so we can diagnose â€” the token is still in the cookie and the
      // status route will back-fill the DB row on the next check.
      console.warn(
        "Google OAuth callback: could not resolve Supabase user â€” " +
          "token saved to cookie only; DB will be synced on next status check."
      );
    }

    return response;
  } catch (err) {
    console.error("Google OAuth callback error:", err);
    const redirectUrl = new URL("/settings", request.url);
    redirectUrl.searchParams.set("google_error", "token_exchange_failed");
    return NextResponse.redirect(redirectUrl);
  }
}
import { NextRequest, NextResponse } from "next/server";
import { GOOGLE_TOKEN_COOKIE, deleteGoogleToken } from "@/lib/google-oauth";
import { getAuthUser } from "@/lib/get-auth-user";

export async function POST(request: NextRequest) {
  const response = NextResponse.json({ success: true });

  // Clear the cookie
  response.cookies.set(GOOGLE_TOKEN_COOKIE, "", {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    path: "/",
    maxAge: 0, // Delete the cookie
  });

  // Also remove from database
  const user = await getAuthUser(request);
  if (user) {
    await deleteGoogleToken(user.id);
  }

  return response;
}
import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import {
  isGoogleConfigured,
  getUserEmail,
  loadGoogleToken,
  saveGoogleToken,
  GOOGLE_TOKEN_COOKIE,
} from "@/lib/google-oauth";
import { getAuthUser } from "@/lib/get-auth-user";

export async function GET(request: NextRequest) {
  const configured = isGoogleConfigured();

  if (!configured) {
    return NextResponse.json({
      configured: false,
      connected: false,
      email: null,
    });
  }

  const cookieStore = await cookies();
  const tokenCookie = cookieStore.get(GOOGLE_TOKEN_COOKIE);
  let refreshToken = tokenCookie?.value ?? null;
  let tokenSource: "cookie" | "db" | null = refreshToken ? "cookie" : null;

  // If the cookie is missing, try to restore from the database
  if (!refreshToken) {
    const user = await getAuthUser(request);
    if (user) {
      const stored = await loadGoogleToken(user.id);
      if (stored) {
        refreshToken = stored.refreshToken;
        tokenSource = "db";
      }
    }
  }

  if (!refreshToken) {
    return NextResponse.json({
      configured: true,
      connected: false,
      email: null,
    });
  }

  // Verify the token is still valid by fetching the user's email
  const email = await getUserEmail(refreshToken);

  if (!email) {
    // Token is invalid or expired beyond refresh
    return NextResponse.json({
      configured: true,
      connected: false,
      email: null,
    });
  }

  // --- Sync: ensure BOTH cookie and DB are populated -----------------------
  // If the token came from the cookie but the DB row is missing (e.g. the
  // callback couldn't resolve the Supabase user), back-fill the DB now.
  const user = await getAuthUser(request);
  if (tokenSource === "cookie" && user) {
    const stored = await loadGoogleToken(user.id);
    if (!stored) {
      await saveGoogleToken(user.id, refreshToken, email);
    }
  }

  // Build response â€” restore the cookie if it was missing
  const body = { configured: true, connected: true, email };
  const response = NextResponse.json(body);

  if (!tokenCookie?.value) {
    response.cookies.set(GOOGLE_TOKEN_COOKIE, refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: "lax",
      path: "/",
      maxAge: 60 * 60 * 24 * 365, // 1 year
    });
  }

  return response;
}
import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { google } from "googleapis";
import {
  isGoogleConfigured,
  getAuthenticatedClient,
  loadGoogleToken,
  GOOGLE_TOKEN_COOKIE,
} from "@/lib/google-oauth";
import { getAuthUser } from "@/lib/get-auth-user";
import { buildDocumentRequests } from "@/lib/html-to-google-docs";

export async function POST(request: NextRequest) {
  try {
    if (!isGoogleConfigured()) {
      return NextResponse.json(
        {
          error: "Google OAuth not configured",
          message:
            "Add GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET to .env.local",
        },
        { status: 503 }
      );
    }

    const cookieStore = await cookies();
    const tokenCookie = cookieStore.get(GOOGLE_TOKEN_COOKIE);
    let refreshToken = tokenCookie?.value ?? null;

    // Fall back to database if cookie is missing
    if (!refreshToken) {
      const user = await getAuthUser(request);
      if (user) {
        const stored = await loadGoogleToken(user.id);
        if (stored) refreshToken = stored.refreshToken;
      }
    }

    if (!refreshToken) {
      return NextResponse.json(
        {
          error: "Not connected",
          message: "Connect your Google account in Settings first.",
        },
        { status: 401 }
      );
    }

    const body = await request.json();
    const {
      title,
      outputHtml,
      elLevel,
      scaffoldsApplied,
      wordBank,
      teacherInstructions,
    } = body;

    if (!title || !outputHtml) {
      return NextResponse.json(
        { error: "Title and outputHtml are required" },
        { status: 400 }
      );
    }

    const auth = await getAuthenticatedClient(refreshToken);
    const docs = google.docs({ version: "v1", auth });

    // 1. Create a new Google Doc
    const createResponse = await docs.documents.create({
      requestBody: {
        title: `${title} - ${elLevel} Scaffolded`,
      },
    });

    const docId = createResponse.data.documentId;
    if (!docId) {
      throw new Error("Failed to create Google Doc");
    }

    // 2. Build formatted document content via HTML-to-Docs converter
    const requests = buildDocumentRequests({
      title,
      elLevel,
      scaffoldsApplied: scaffoldsApplied as string[],
      outputHtml,
      wordBank: wordBank ?? null,
      teacherInstructions: teacherInstructions ?? null,
    });

    // 3. Apply batch update
    if (requests.length > 0) {
      await docs.documents.batchUpdate({
        documentId: docId,
        requestBody: { requests },
      });
    }

    const docUrl = `https://docs.google.com/document/d/${docId}/edit`;

    return NextResponse.json({
      success: true,
      docId,
      docUrl,
    });
  } catch (error) {
    console.error("Google Docs export error:", error);

    const message =
      error instanceof Error ? error.message : "Export failed";

    // Check if it's an auth error
    if (message.includes("invalid_grant") || message.includes("Token")) {
      return NextResponse.json(
        {
          error: "Authentication expired",
          message:
            "Your Google connection has expired. Please reconnect in Settings.",
        },
        { status: 401 }
      );
    }

    return NextResponse.json(
      { error: "Export failed", message },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { google } from "googleapis";
import {
  isGoogleConfigured,
  getAuthenticatedClient,
  loadGoogleToken,
  GOOGLE_TOKEN_COOKIE,
} from "@/lib/google-oauth";
import { getAuthUser } from "@/lib/get-auth-user";

// Extract document ID from various Google Docs URL formats
function extractDocId(url: string): string | null {
  // Format: https://docs.google.com/document/d/DOCUMENT_ID/...
  const match = url.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);
  return match?.[1] ?? null;
}

// Convert Google Docs structural elements to plain text
function extractText(
  elements: Array<Record<string, unknown>>
): string {
  let text = "";

  for (const element of elements) {
    if (element.paragraph) {
      const paragraph = element.paragraph as {
        elements?: Array<{
          textRun?: { content?: string };
        }>;
      };
      for (const el of paragraph.elements ?? []) {
        if (el.textRun?.content) {
          text += el.textRun.content;
        }
      }
    } else if (element.table) {
      const table = element.table as {
        tableRows?: Array<{
          tableCells?: Array<{
            content?: Array<Record<string, unknown>>;
          }>;
        }>;
      };
      for (const row of table.tableRows ?? []) {
        const cells: string[] = [];
        for (const cell of row.tableCells ?? []) {
          cells.push(extractText(cell.content ?? []).trim());
        }
        text += cells.join("\t") + "\n";
      }
    }
  }

  return text;
}

export async function POST(request: NextRequest) {
  try {
    if (!isGoogleConfigured()) {
      return NextResponse.json(
        {
          error: "Google OAuth not configured",
          message: "Add GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET to .env.local",
        },
        { status: 503 }
      );
    }

    const cookieStore = await cookies();
    const tokenCookie = cookieStore.get(GOOGLE_TOKEN_COOKIE);
    let refreshToken = tokenCookie?.value ?? null;

    // Fall back to database if cookie is missing
    if (!refreshToken) {
      const user = await getAuthUser(request);
      if (user) {
        const stored = await loadGoogleToken(user.id);
        if (stored) refreshToken = stored.refreshToken;
      }
    }

    if (!refreshToken) {
      return NextResponse.json(
        {
          error: "Not connected",
          message: "Connect your Google account in Settings first.",
        },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { url } = body as { url?: string };

    if (!url || typeof url !== "string") {
      return NextResponse.json(
        { error: "A Google Docs URL is required." },
        { status: 400 }
      );
    }

    const docId = extractDocId(url);
    if (!docId) {
      return NextResponse.json(
        {
          error: "Invalid Google Docs URL",
          message:
            "Please paste a valid link like https://docs.google.com/document/d/...",
        },
        { status: 400 }
      );
    }

    const auth = await getAuthenticatedClient(refreshToken);
    const docs = google.docs({ version: "v1", auth });

    // Fetch the document
    const doc = await docs.documents.get({ documentId: docId });

    const title = doc.data.title ?? "Untitled";
    const body2 = doc.data.body;

    if (!body2?.content) {
      return NextResponse.json(
        { error: "Document is empty or could not be read." },
        { status: 400 }
      );
    }

    // Extract plain text from the document structure
    const content = extractText(
      body2.content as Array<Record<string, unknown>>
    ).trim();

    if (!content) {
      return NextResponse.json(
        { error: "No text content found in this document." },
        { status: 400 }
      );
    }

    return NextResponse.json({
      success: true,
      title,
      content,
      docId,
    });
  } catch (error) {
    console.error("Google Docs import error:", error);

    const message =
      error instanceof Error ? error.message : "Import failed";

    if (message.includes("invalid_grant") || message.includes("Token")) {
      return NextResponse.json(
        {
          error: "Authentication expired",
          message:
            "Your Google connection has expired. Please reconnect in Settings.",
        },
        { status: 401 }
      );
    }

    if (message.includes("not found") || message.includes("404")) {
      return NextResponse.json(
        {
          error: "Document not found",
          message:
            "Could not access this document. Make sure it exists and your Google account has permission to view it.",
        },
        { status: 404 }
      );
    }

    return NextResponse.json(
      { error: "Import failed", message },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { getAuthUser } from "@/lib/get-auth-user";

export async function GET(request: NextRequest) {
  try {
    const user = await getAuthUser(request);
    if (!user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { getDifferentiatedAssignmentsByTeacher } = await import(
      "@/lib/queries/differentiated-assignments"
    );
    const entries = await getDifferentiatedAssignmentsByTeacher(user.id);
    return NextResponse.json(entries);
  } catch (err) {
    console.error("Failed to fetch library:", err);
    return NextResponse.json(
      { error: "Failed to fetch library" },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { getAuthUser } from "@/lib/get-auth-user";

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await getAuthUser(request);
    if (!user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await params;
    const { getDifferentiatedAssignmentById } = await import(
      "@/lib/queries/differentiated-assignments"
    );
    const entry = await getDifferentiatedAssignmentById(id);
    if (!entry || entry.teacher_id !== user.id) {
      return NextResponse.json({ error: "Not found" }, { status: 404 });
    }
    return NextResponse.json(entry);
  } catch {
    return NextResponse.json(
      { error: "Failed to fetch entry" },
      { status: 500 }
    );
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await getAuthUser(request);
    if (!user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await params;
    const body = await request.json();
    const { teacher_notes } = body;

    const { updateDifferentiatedAssignmentNotes } = await import(
      "@/lib/queries/differentiated-assignments"
    );
    await updateDifferentiatedAssignmentNotes(id, user.id, teacher_notes);
    return NextResponse.json({ success: true });
  } catch {
    return NextResponse.json(
      { error: "Failed to update" },
      { status: 500 }
    );
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await getAuthUser(request);
    if (!user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await params;
    const { deleteDifferentiatedAssignment } = await import(
      "@/lib/queries/differentiated-assignments"
    );
    await deleteDifferentiatedAssignment(id, user.id);
    return NextResponse.json({ success: true });
  } catch {
    return NextResponse.json(
      { error: "Failed to delete" },
      { status: 500 }
    );
  }
}
import { NextResponse } from "next/server";
import { PDFParse } from "pdf-parse";

export async function POST(request: Request) {
  try {
    const formData = await request.formData();
    const file = formData.get("file") as File | null;

    if (!file) {
      return NextResponse.json({ error: "No file provided" }, { status: 400 });
    }

    if (file.size > 10 * 1024 * 1024) {
      return NextResponse.json(
        { error: "File must be under 10MB" },
        { status: 400 }
      );
    }

    const arrayBuffer = await file.arrayBuffer();
    const uint8 = new Uint8Array(arrayBuffer);

    const parser = new PDFParse({ data: uint8 });
    const result = await parser.getText();
    const text = result.text.trim();

    if (!text) {
      return NextResponse.json(
        { error: "Could not extract text from PDF. The file may be image-based." },
        { status: 422 }
      );
    }

    return NextResponse.json({ text });
  } catch (error) {
    console.error("PDF parse error:", error);
    return NextResponse.json(
      { error: "Failed to parse PDF. Try pasting the text manually." },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { getAuthUser } from "@/lib/get-auth-user";
import { createClient } from "@/lib/supabase-server";

/**
 * GET /api/profile â€” returns the authenticated user's saved profile.
 */
export async function GET(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const supabase = createClient();
  const { data, error } = await supabase
    .from("profiles")
    .select("first_name, last_name")
    .eq("user_id", user.id)
    .maybeSingle();

  if (error) {
    console.error("[profile GET]", error);
    return NextResponse.json({ error: "Database error" }, { status: 500 });
  }

  return NextResponse.json({
    firstName: data?.first_name ?? "",
    lastName: data?.last_name ?? "",
  });
}

/**
 * PUT /api/profile â€” upserts the authenticated user's profile.
 * Body: { firstName: string, lastName: string }
 */
export async function PUT(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const body = await request.json();
  const firstName = typeof body.firstName === "string" ? body.firstName.trim() : "";
  const lastName = typeof body.lastName === "string" ? body.lastName.trim() : "";

  const supabase = createClient();
  const { error } = await supabase.from("profiles").upsert(
    {
      user_id: user.id,
      first_name: firstName,
      last_name: lastName,
      updated_at: new Date().toISOString(),
    },
    { onConflict: "user_id" }
  );

  if (error) {
    console.error("[profile PUT]", error);
    return NextResponse.json({ error: "Database error" }, { status: 500 });
  }

  return NextResponse.json({ firstName, lastName });
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { generateScaffoldedAssignment } from "@/lib/gemini";
import { defaultScaffolds } from "@/lib/seed-scaffolds";
import { scaffoldRequestSchema } from "@/lib/validations";
import { checkRateLimit, checkGlobalRateLimit } from "@/lib/rate-limit";

const DAILY_GLOBAL_LIMIT = parseInt(process.env.DAILY_GLOBAL_LIMIT ?? "250", 10);
const DAILY_PER_USER_LIMIT = parseInt(process.env.DAILY_PER_USER_LIMIT ?? "10", 10);

async function getAuthUser(request: NextRequest) {
  const response = NextResponse.next({ request });
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}

export async function POST(request: NextRequest) {
  try {
    // Auth check â€” only authenticated teachers can generate
    const user = await getAuthUser(request);
    if (!user?.email) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // 1. Global RPM rate limit (protects Gemini free tier 10 RPM)
    if (!checkGlobalRateLimit(10)) {
      return NextResponse.json(
        { error: "Platform rate limit reached. Please wait a moment and try again." },
        { status: 429 }
      );
    }

    // 2. Per-user RPM (secondary protection)
    if (!checkRateLimit(user.id, 5)) {
      return NextResponse.json(
        { error: "Rate limit exceeded. Please wait a moment before generating again." },
        { status: 429 }
      );
    }

    // 3. Daily usage limits (database-backed)
    try {
      const { getTodayGlobalUsage, getTodayUserUsage } = await import(
        "@/lib/queries/differentiated-assignments"
      );
      const [globalUsed, userUsed] = await Promise.all([
        getTodayGlobalUsage(),
        getTodayUserUsage(user.id),
      ]);

      if (globalUsed >= DAILY_GLOBAL_LIMIT) {
        return NextResponse.json(
          { error: "Platform daily limit reached. Scaffold generation will reset at midnight Pacific time." },
          { status: 429 }
        );
      }

      if (userUsed >= DAILY_PER_USER_LIMIT) {
        return NextResponse.json(
          { error: `You've reached your daily limit of ${DAILY_PER_USER_LIMIT} scaffold generations. Resets at midnight Pacific time.` },
          { status: 429 }
        );
      }
    } catch {
      // Database not configured â€” skip daily limit enforcement
    }

    const body = await request.json();

    // Zod validation
    const parsed = scaffoldRequestSchema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json(
        { error: "Validation failed", details: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const { content, title, subject, gradeLevel, elLevel, scaffoldNames: requestedNames, studentName } = parsed.data;

    // Look up scaffolds by name instead of fragile indices
    const selectedScaffolds = defaultScaffolds.filter((s) =>
      requestedNames.includes(s.name)
    );

    if (selectedScaffolds.length === 0) {
      return NextResponse.json(
        { error: "No valid scaffolds selected" },
        { status: 400 }
      );
    }

    const scaffoldPrompts = selectedScaffolds.map(
      (s) => s.ai_prompt_template
    );
    const scaffoldNames = selectedScaffolds.map((s) => s.name);

    // Generate scaffolded assignment (returns structured JSON from Gemini)
    const result = await generateScaffoldedAssignment({
      originalContent: content,
      elLevel,
      scaffoldPrompts,
      scaffoldNames,
      title,
      subject: subject || undefined,
      gradeLevel: gradeLevel || undefined,
    });

    // Store in database with all library fields (graceful failure)
    let storedId: string | null = null;
    try {
      const { createDifferentiatedAssignment } = await import(
        "@/lib/queries/differentiated-assignments"
      );
      const stored = await createDifferentiatedAssignment({
        assignment_id: body.assignmentId || "draft",
        teacher_id: user.id,
        student_id: body.studentId || undefined,
        student_name: studentName || undefined,
        assignment_title: title,
        el_level: elLevel,
        scaffolds_applied: scaffoldNames,
        output_html: result.html,
        original_content: content,
        word_bank: result.wordBank,
        teacher_instructions: result.teacherInstructions,
        is_demo: result.isDemo,
      });
      storedId = stored.id;
    } catch (err) {
      console.error("Failed to store differentiated assignment:", err);
    }

    // Log usage analytic with real teacher ID
    try {
      const { logUsageAnalytic } = await import(
        "@/lib/queries/differentiated-assignments"
      );
      await logUsageAnalytic(user.id, "scaffold_generated", {
        title,
        elLevel,
        scaffoldCount: selectedScaffolds.length,
        contentLength: content.length,
        isDemo: result.isDemo,
      });
    } catch (err) {
      console.error("Failed to log usage analytic:", err);
    }

    // Fetch updated usage count for immediate client-side counter update
    let updatedUsage: number | undefined;
    try {
      const { getTodayUserUsage } = await import(
        "@/lib/queries/differentiated-assignments"
      );
      updatedUsage = await getTodayUserUsage(user.id);
    } catch {
      // Non-critical
    }

    return NextResponse.json({
      success: true,
      outputHtml: result.html,
      wordBank: result.wordBank,
      scaffoldsUsed: result.scaffoldsUsed,
      teacherInstructions: result.teacherInstructions,
      isDemo: result.isDemo,
      scaffoldsApplied: scaffoldNames,
      storedId,
      updatedUsage,
    });
  } catch (error) {
    const message =
      error instanceof Error ? error.message : String(error);
    console.error("Scaffold generation error:", message, error);

    // Surface Gemini quota/rate-limit errors clearly
    if (message.includes("429") || message.includes("quota")) {
      return NextResponse.json(
        { error: "Gemini API quota exceeded. Please wait a few minutes or check your Google AI billing plan." },
        { status: 429 }
      );
    }

    return NextResponse.json(
      {
        error: "Failed to generate scaffolded assignment. Please try again.",
        ...(process.env.NODE_ENV === "development" && { detail: message }),
      },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { seedScaffoldTemplates } from "@/lib/seed-scaffolds";
import { seedStudents } from "@/lib/seed-students";

export async function POST(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const target = searchParams.get("target");

  try {
    if (target === "students") {
      const result = await seedStudents();
      return NextResponse.json(result);
    }

    if (target === "scaffolds") {
      const result = await seedScaffoldTemplates();
      return NextResponse.json(result);
    }

    // Seed everything
    const scaffoldResult = await seedScaffoldTemplates();
    const studentResult = await seedStudents();

    return NextResponse.json({
      message: "Full seed completed",
      scaffolds: scaffoldResult,
      students: studentResult,
    });
  } catch (error) {
    console.error("Seed error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Failed to seed" },
      { status: 500 }
    );
  }
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { createClient as createServiceClient } from "@/lib/supabase-server";
import { isAdminEmail } from "@/lib/admin";
import { studentSchema } from "@/lib/validations";

async function getAuthUser(request: NextRequest) {
  const response = NextResponse.next({ request });
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}

// GET /api/students â€” all authenticated users can read
export async function GET(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("students")
    .select("*")
    .order("name", { ascending: true });

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data);
}

// POST /api/students â€” admin only
export async function POST(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user?.email) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!isAdminEmail(user.email)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await request.json();
  const parsed = studentSchema.safeParse(body);
  if (!parsed.success) {
    return NextResponse.json(
      { error: "Validation failed", details: parsed.error.flatten() },
      { status: 400 }
    );
  }

  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("students")
    .insert({
      ssid: parsed.data.ssid ?? null,
      name: parsed.data.name,
      grade: parsed.data.grade,
      homeroom: parsed.data.homeroom ?? null,
      el_level: parsed.data.el_level,
      overall_level: parsed.data.overall_level ?? null,
      oral_language_level: parsed.data.oral_language_level ?? null,
      written_language_level: parsed.data.written_language_level ?? null,
      primary_language: parsed.data.primary_language,
      notes: parsed.data.notes ?? null,
      custom_scaffolds: [],
      created_by: user.email,
    })
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data, { status: 201 });
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { createClient as createServiceClient } from "@/lib/supabase-server";
import { isAdminEmail } from "@/lib/admin";
import { studentSchema } from "@/lib/validations";

async function getAuthUser(request: NextRequest) {
  const response = NextResponse.next({ request });
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}

// POST /api/students/bulk â€” admin only
export async function POST(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user?.email) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!isAdminEmail(user.email)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await request.json();
  if (!Array.isArray(body.students)) {
    return NextResponse.json(
      { error: "Expected { students: [...] }" },
      { status: 400 }
    );
  }

  const valid: Array<{
    ssid?: string;
    name: string;
    grade: number;
    homeroom?: string;
    el_level: string;
    overall_level?: number;
    oral_language_level?: number;
    written_language_level?: number;
    primary_language: string;
    notes?: string;
    custom_scaffolds: string[];
    created_by: string;
  }> = [];
  const errors: Array<{ row: number; issues: string[] }> = [];

  for (let i = 0; i < body.students.length; i++) {
    const parsed = studentSchema.safeParse(body.students[i]);
    if (parsed.success) {
      valid.push({
        ssid: parsed.data.ssid ?? undefined,
        name: parsed.data.name,
        grade: parsed.data.grade,
        homeroom: parsed.data.homeroom ?? undefined,
        el_level: parsed.data.el_level,
        overall_level: parsed.data.overall_level ?? undefined,
        oral_language_level: parsed.data.oral_language_level ?? undefined,
        written_language_level: parsed.data.written_language_level ?? undefined,
        primary_language: parsed.data.primary_language,
        notes: parsed.data.notes ?? undefined,
        custom_scaffolds: [],
        created_by: user.email,
      });
    } else {
      errors.push({
        row: i + 1,
        issues: parsed.error.issues.map((iss) => iss.message),
      });
    }
  }

  if (valid.length === 0) {
    return NextResponse.json(
      { error: "No valid students to import", errors },
      { status: 400 }
    );
  }

  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("students")
    .insert(valid)
    .select();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({
    imported: data?.length ?? 0,
    errors,
  });
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { createClient as createServiceClient } from "@/lib/supabase-server";
import { isAdminEmail } from "@/lib/admin";
import { studentSchema } from "@/lib/validations";

async function getAuthUser(request: NextRequest) {
  const response = NextResponse.next({ request });
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}

// GET /api/students/[id] â€” any authenticated user
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const user = await getAuthUser(request);
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { id } = await params;
  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("students")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 404 });
  }

  return NextResponse.json(data);
}

// PUT /api/students/[id] â€” admin only
export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const user = await getAuthUser(request);
  if (!user?.email) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!isAdminEmail(user.email)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id } = await params;
  const body = await request.json();
  const parsed = studentSchema.partial().safeParse(body);
  if (!parsed.success) {
    return NextResponse.json(
      { error: "Validation failed", details: parsed.error.flatten() },
      { status: 400 }
    );
  }

  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("students")
    .update({
      ...parsed.data,
      updated_at: new Date().toISOString(),
    })
    .eq("id", id)
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data);
}

// DELETE /api/students/[id] â€” admin only
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const user = await getAuthUser(request);
  if (!user?.email) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!isAdminEmail(user.email)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id } = await params;
  const supabase = createServiceClient();
  const { error } = await supabase.from("students").delete().eq("id", id);

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ success: true });
}
import { NextRequest, NextResponse } from "next/server";
import { getAuthUser } from "@/lib/get-auth-user";

const DAILY_GLOBAL_LIMIT = parseInt(process.env.DAILY_GLOBAL_LIMIT ?? "250", 10);
const DAILY_PER_USER_LIMIT = parseInt(process.env.DAILY_PER_USER_LIMIT ?? "10", 10);

export async function GET(request: NextRequest) {
  try {
    const user = await getAuthUser(request);
    if (!user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { getTodayGlobalUsage, getTodayUserUsage } = await import(
      "@/lib/queries/differentiated-assignments"
    );

    const [globalUsed, userUsed] = await Promise.all([
      getTodayGlobalUsage(),
      getTodayUserUsage(user.id),
    ]);

    return NextResponse.json({
      used: userUsed,
      limit: DAILY_PER_USER_LIMIT,
      globalUsed,
      globalLimit: DAILY_GLOBAL_LIMIT,
    });
  } catch {
    // Database not available â€” return defaults
    return NextResponse.json({
      used: 0,
      limit: DAILY_PER_USER_LIMIT,
      globalUsed: 0,
      globalLimit: DAILY_GLOBAL_LIMIT,
    });
  }
}
import { NextRequest, NextResponse } from "next/server";

// Server-side email validation endpoint.
// Call this before or during sign-up to double-check the domain.
// This blocks requests from non-Bright Star users even if they
// bypass the client-side form validation.

const ALLOWED_DOMAIN =
  process.env.ALLOWED_EMAIL_DOMAIN ?? "@brightstarschools.org";

export async function POST(req: NextRequest) {
  try {
    const { email } = (await req.json()) as { email?: string };

    if (!email || typeof email !== "string") {
      return NextResponse.json(
        { allowed: false, message: "Email is required." },
        { status: 400 }
      );
    }

    const normalizedEmail = email.toLowerCase().trim();

    if (!normalizedEmail.endsWith(ALLOWED_DOMAIN)) {
      return NextResponse.json(
        {
          allowed: false,
          message: "Please use your Bright Star Schools email to register.",
        },
        { status: 403 }
      );
    }

    return NextResponse.json({ allowed: true });
  } catch {
    return NextResponse.json(
      { allowed: false, message: "Invalid request." },
      { status: 400 }
    );
  }
}
import { NextResponse } from "next/server";

export async function POST() {
  return NextResponse.json({ message: "Webhook endpoint ready" }, { status: 200 });
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";

// This route handles Supabase email confirmation links.
// When a user clicks "Confirm your email" in their inbox, Supabase
// redirects them here with a ?code= parameter. We exchange that code
// for a session, then redirect them to the dashboard.

export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get("code");
  const redirect = searchParams.get("redirect") ?? "/dashboard";

  if (code) {
    const response = NextResponse.redirect(new URL(redirect, origin));

    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return request.cookies.getAll();
          },
          setAll(cookiesToSet) {
            cookiesToSet.forEach(({ name, value, options }) => {
              response.cookies.set(name, value, options);
            });
          },
        },
      }
    );

    // Exchange the code for a session
    const { error } = await supabase.auth.exchangeCodeForSession(code);

    if (!error) {
      return response;
    }
  }

  // If no code or exchange failed, redirect to sign-in with error
  return NextResponse.redirect(
    new URL("/sign-in?error=confirmation_failed", request.url)
  );
}
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { ArrowLeft, ArrowRight } from "lucide-react";
import {
  assignmentDetailsSchema,
  type AssignmentDetailsFormValues,
} from "@/lib/validations";
import { SUBJECTS, GRADES } from "@/types";

interface AssignmentDetailsFormProps {
  defaultValues: {
    title: string;
    subject: string;
    gradeLevel: number | undefined;
  };
  onSubmit: (data: AssignmentDetailsFormValues) => void;
  onBack: () => void;
}

export function AssignmentDetailsForm({
  defaultValues,
  onSubmit,
  onBack,
}: AssignmentDetailsFormProps) {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<AssignmentDetailsFormValues>({
    resolver: zodResolver(assignmentDetailsSchema),
    defaultValues: {
      title: defaultValues.title,
      subject: defaultValues.subject || undefined,
      grade_level: defaultValues.gradeLevel,
    },
  });

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="space-y-2">
        <Label htmlFor="title">Assignment Title *</Label>
        <Input
          id="title"
          placeholder='e.g., "Chapter 5 Reading Comprehension Questions"'
          {...register("title")}
        />
        {errors.title && (
          <p className="text-sm text-destructive">{errors.title.message}</p>
        )}
      </div>

      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div className="space-y-2">
          <Label htmlFor="subject">Subject (optional)</Label>
          <Select id="subject" {...register("subject")}>
            <option value="">Select subject...</option>
            {SUBJECTS.map((s) => (
              <option key={s} value={s}>
                {s}
              </option>
            ))}
          </Select>
        </div>

        <div className="space-y-2">
          <Label htmlFor="grade_level">Grade Level (optional)</Label>
          <Select
            id="grade_level"
            {...register("grade_level", {
              setValueAs: (v: string) => (v === "" ? undefined : Number(v)),
            })}
          >
            <option value="">Select grade...</option>
            {GRADES.map((g) => (
              <option key={g} value={g}>
                Grade {g}
              </option>
            ))}
          </Select>
        </div>
      </div>

      <div className="flex justify-between pt-4">
        <Button type="button" variant="outline" onClick={onBack} className="gap-2">
          <ArrowLeft className="h-4 w-4" />
          Back to Input
        </Button>
        <Button type="submit" className="gap-2">
          Continue to Selection
          <ArrowRight className="h-4 w-4" />
        </Button>
      </div>
    </form>
  );
}
"use client";

import { useState } from "react";
import { FileText, Upload, Link2 } from "lucide-react";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { TextInputTab } from "./text-input-tab";
import { FileUploadTab } from "./file-upload-tab";
import { GoogleLinkTab } from "./google-link-tab";
import type { SourceType } from "@/lib/hooks/use-assignment-form";

interface AssignmentInputTabsProps {
  content: string;
  sourceType: SourceType;
  onContentChange: (content: string, sourceType: SourceType, fileName?: string) => void;
}

export function AssignmentInputTabs({
  content,
  sourceType,
  onContentChange,
}: AssignmentInputTabsProps) {
  const [activeTab, setActiveTab] = useState<string>(sourceType);

  return (
    <Tabs value={activeTab} onValueChange={setActiveTab}>
      <TabsList className="w-full grid grid-cols-3">
        <TabsTrigger value="text" className="gap-2">
          <FileText className="h-4 w-4" />
          <span className="hidden sm:inline">Type or Paste</span>
          <span className="sm:hidden">Text</span>
        </TabsTrigger>
        <TabsTrigger value="upload" className="gap-2">
          <Upload className="h-4 w-4" />
          <span className="hidden sm:inline">Upload File</span>
          <span className="sm:hidden">Upload</span>
        </TabsTrigger>
        <TabsTrigger value="google_doc" className="gap-2">
          <Link2 className="h-4 w-4" />
          <span className="hidden sm:inline">Google Docs</span>
          <span className="sm:hidden">Google</span>
        </TabsTrigger>
      </TabsList>

      <TabsContent value="text">
        <TextInputTab
          content={activeTab === "text" ? content : ""}
          onChange={(text) => onContentChange(text, "text")}
        />
      </TabsContent>

      <TabsContent value="upload">
        <FileUploadTab
          content={activeTab === "upload" ? content : ""}
          onChange={(text, fileName) =>
            onContentChange(text, "upload", fileName)
          }
        />
      </TabsContent>

      <TabsContent value="google_doc">
        <GoogleLinkTab
          content={activeTab === "google_doc" ? content : ""}
          onChange={(text) => onContentChange(text, "google_doc")}
        />
      </TabsContent>
    </Tabs>
  );
}
"use client";

import { useState, useCallback } from "react";
import { useDropzone } from "react-dropzone";
import { Upload, File, X, Loader2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { cn } from "@/lib/utils";

interface FileUploadTabProps {
  content: string;
  onChange: (content: string, fileName?: string) => void;
}

const MAX_SIZE = 10 * 1024 * 1024; // 10MB
const ACCEPTED = {
  "application/pdf": [".pdf"],
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document": [".docx"],
  "text/plain": [".txt"],
};

export function FileUploadTab({ content, onChange }: FileUploadTabProps) {
  const [fileName, setFileName] = useState<string | null>(null);
  const [fileSize, setFileSize] = useState<number>(0);
  const [isParsing, setIsParsing] = useState(false);
  const [parseError, setParseError] = useState<string | null>(null);

  const onDrop = useCallback(
    async (acceptedFiles: File[]) => {
      const file = acceptedFiles[0];
      if (!file) return;

      setFileName(file.name);
      setFileSize(file.size);
      setParseError(null);
      setIsParsing(true);

      try {
        // For .txt files, read directly
        if (file.name.endsWith(".txt")) {
          const text = await file.text();
          onChange(text, file.name);
          setIsParsing(false);
          return;
        }

        // For PDF and DOCX, use client-side parsing via dynamic import
        const { parseFile } = await import("@/lib/parsers");
        const text = await parseFile(file);
        onChange(text, file.name);
      } catch (error) {
        const message =
          error instanceof Error
            ? error.message
            : "Could not extract text. Try pasting the text manually.";
        setParseError(message);
        onChange("", undefined);
      } finally {
        setIsParsing(false);
      }
    },
    [onChange]
  );

  const { getRootProps, getInputProps, isDragActive, fileRejections } =
    useDropzone({
      onDrop,
      accept: ACCEPTED,
      maxSize: MAX_SIZE,
      maxFiles: 1,
    });

  function handleRemove() {
    setFileName(null);
    setFileSize(0);
    setParseError(null);
    onChange("", undefined);
  }

  const rejectionMessage = fileRejections[0]?.errors[0]?.code === "file-too-large"
    ? "File must be under 10MB."
    : fileRejections[0]?.errors[0]?.code === "file-invalid-type"
    ? "Only PDF, Word (.docx), and text files are supported."
    : fileRejections[0]?.errors[0]?.message;

  // Show extracted content for editing
  if (content && fileName && !isParsing) {
    return (
      <div className="space-y-3">
        <div className="flex items-center justify-between rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 px-3 py-2">
          <div className="flex items-center gap-2 text-sm">
            <File className="h-4 w-4 text-muted-foreground" />
            <span className="font-medium">{fileName}</span>
            <span className="text-muted-foreground">
              ({(fileSize / 1024).toFixed(1)} KB)
            </span>
          </div>
          <Button
            type="button"
            variant="ghost"
            size="icon"
            className="h-6 w-6"
            onClick={handleRemove}
            aria-label="Remove file"
          >
            <X className="h-3 w-3" />
          </Button>
        </div>
        <p className="text-xs text-muted-foreground">
          Extracted text shown below. You can edit it before proceeding.
        </p>
        <Textarea
          value={content}
          onChange={(e) => onChange(e.target.value, fileName)}
          rows={12}
          className="resize-y min-h-[240px]"
        />
        <div className="text-right text-xs text-muted-foreground">
          {content.length.toLocaleString()} characters
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      <div
        {...getRootProps()}
        className={cn(
          "flex flex-col items-center justify-center rounded-2xl border-2 border-dashed p-12 text-center transition-colors cursor-pointer",
          isDragActive
            ? "border-eld-space-indigo bg-eld-space-indigo/5"
            : "border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500",
          isParsing && "pointer-events-none opacity-60"
        )}
      >
        <input {...getInputProps()} />
        {isParsing ? (
          <>
            <Loader2 className="h-10 w-10 animate-spin text-primary mb-3" />
            <p className="text-sm font-medium">Processing {fileName}...</p>
            <p className="text-xs text-muted-foreground mt-1">
              Extracting text from your document
            </p>
          </>
        ) : (
          <>
            <Upload className="h-10 w-10 text-muted-foreground mb-3" />
            <p className="text-sm font-medium">
              {isDragActive ? "Drop file here" : "Drag file here or click to browse"}
            </p>
            <p className="text-xs text-muted-foreground mt-1">
              PDF, Word (.docx), or text files up to 10MB
            </p>
          </>
        )}
      </div>

      {(parseError || rejectionMessage) && (
        <p className="text-sm text-destructive">
          {parseError || rejectionMessage}
        </p>
      )}
    </div>
  );
}
"use client";

import { useState, useEffect } from "react";
import { Link2, Loader2, CheckCircle2, AlertCircle, Settings } from "lucide-react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import Link from "next/link";

interface GoogleLinkTabProps {
  content: string;
  onChange: (content: string) => void;
}

export function GoogleLinkTab({ content, onChange }: GoogleLinkTabProps) {
  const [url, setUrl] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [docTitle, setDocTitle] = useState("");
  const [imported, setImported] = useState(false);

  // Check Google connection status
  const [connected, setConnected] = useState<boolean | null>(null);
  useEffect(() => {
    fetch("/api/google-auth/status")
      .then((res) => res.json())
      .then((data) => setConnected(data.connected ?? false))
      .catch(() => setConnected(false));
  }, []);

  const handleImport = async () => {
    if (!url.trim()) return;
    setError("");
    setLoading(true);
    setImported(false);

    try {
      const res = await fetch("/api/google-docs/import", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: url.trim() }),
      });

      const data = await res.json();

      if (!res.ok) {
        setError(data.message ?? data.error ?? "Failed to import document.");
        return;
      }

      onChange(data.content);
      setDocTitle(data.title);
      setImported(true);
    } catch {
      setError("Failed to fetch document. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  // Still loading connection status
  if (connected === null) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />
      </div>
    );
  }

  // Not connected â€” prompt to connect in Settings
  if (!connected) {
    return (
      <div className="rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/30 p-8 text-center">
        <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
          <Link2 className="h-6 w-6 text-primary" />
        </div>
        <h3 className="text-sm font-semibold text-foreground">
          Connect Google Account
        </h3>
        <p className="mt-2 text-sm text-muted-foreground max-w-md mx-auto">
          Connect your Google account in Settings to import assignments
          directly from Google Docs.
        </p>
        <Link href="/settings">
          <Button variant="outline" className="mt-4 gap-2">
            <Settings className="h-4 w-4" />
            Go to Settings
          </Button>
        </Link>
      </div>
    );
  }

  // Connected â€” show import UI
  return (
    <div className="space-y-4">
      {/* Success state */}
      {imported && docTitle && (
        <div className="flex items-start gap-2 rounded-lg bg-green-50 p-3 text-sm text-green-700 dark:bg-green-900/20 dark:text-green-400">
          <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0" />
          <span>
            Imported <strong>{docTitle}</strong> successfully. The content is
            ready â€” proceed to the next step.
          </span>
        </div>
      )}

      {/* Error state */}
      {error && (
        <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3 text-sm text-red-600 dark:bg-red-900/20 dark:text-red-400">
          <AlertCircle className="mt-0.5 h-4 w-4 shrink-0" />
          <span>{error}</span>
        </div>
      )}

      {/* URL input + fetch button */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-foreground">
          Google Docs URL
        </label>
        <div className="flex gap-2">
          <Input
            placeholder="https://docs.google.com/document/d/..."
            value={url}
            onChange={(e) => {
              setUrl(e.target.value);
              if (error) setError("");
              if (imported) setImported(false);
            }}
          />
          <Button
            onClick={handleImport}
            disabled={!url.trim() || loading}
            className="shrink-0"
          >
            {loading ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              "Import"
            )}
          </Button>
        </div>
        <p className="text-xs text-muted-foreground">
          Paste the URL of any Google Doc your account has access to. The text
          content will be extracted for scaffolding.
        </p>
      </div>

      {/* Preview of imported content */}
      {content && (
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground">
            Imported Content
          </label>
          <div className="max-h-64 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm whitespace-pre-wrap dark:border-gray-700 dark:bg-gray-800/30">
            {content}
          </div>
        </div>
      )}
    </div>
  );
}
"use client";

import { useMemo, useState } from "react";
import {
  Palette,
  Layers,
  Type,
  BookOpen,
  LayoutGrid,
  Languages,
  Info,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { ELBadge } from "@/components/students/el-badge";
import { cn } from "@/lib/utils";
import { defaultScaffolds } from "@/lib/seed-scaffolds";
import type { ELLevel } from "@/types";

const categoryIcons: Record<string, React.ElementType> = {
  color_coding: Palette,
  chunking: Layers,
  sentence_frames: Type,
  word_banks: BookOpen,
  visual_organizers: LayoutGrid,
  bilingual_support: Languages,
};

const categoryLabels: Record<string, string> = {
  color_coding: "Color Coding",
  chunking: "Chunking",
  sentence_frames: "Sentence Frames",
  word_banks: "Word Banks",
  visual_organizers: "Visual Organizers",
  bilingual_support: "Bilingual Support",
};

interface ScaffoldPickerProps {
  elLevel?: ELLevel;
  elLevels?: ELLevel[];
  selectedNames: Set<string>;
  onToggle: (name: string) => void;
  onSelectAll: () => void;
  onClearAll: () => void;
}

export function ScaffoldPicker({
  elLevel,
  elLevels,
  selectedNames,
  onToggle,
  onSelectAll,
  onClearAll,
}: ScaffoldPickerProps) {
  const [detailName, setDetailName] = useState<string | null>(null);

  const levels = elLevels ?? (elLevel ? [elLevel] : []);

  const filteredScaffolds = useMemo(
    () => defaultScaffolds.filter((s) => levels.some((l) => s.el_level_target.includes(l))),
    // eslint-disable-next-line react-hooks/exhaustive-deps
    [levels.join(",")]
  );

  // Group by category
  const grouped = useMemo(() => {
    const map = new Map<string, typeof filteredScaffolds>();
    filteredScaffolds.forEach((s) => {
      const arr = map.get(s.category) ?? [];
      arr.push(s);
      map.set(s.category, arr);
    });
    return map;
  }, [filteredScaffolds]);

  const detailScaffold = detailName
    ? defaultScaffolds.find((s) => s.name === detailName) ?? null
    : null;

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <label className="text-sm font-medium">
          Which scaffolds would you like to apply?
        </label>
        <div className="flex gap-2">
          <Button variant="ghost" size="sm" onClick={onSelectAll}>
            Select All
          </Button>
          <Button variant="ghost" size="sm" onClick={onClearAll}>
            Clear All
          </Button>
        </div>
      </div>

      <p className="text-xs text-muted-foreground">
        Showing scaffolds recommended for{" "}
        <strong>{levels.join(", ")}</strong> level{levels.length !== 1 ? "s" : ""}.
        {selectedNames.size === 0 && " Select at least one scaffold."}
      </p>

      <div className="space-y-4">
        {Array.from(grouped.entries()).map(([category, scaffolds]) => {
          const Icon = categoryIcons[category] || BookOpen;
          return (
            <div key={category}>
              <div className="flex items-center gap-2 mb-2">
                <Icon className="h-4 w-4 text-eld-lilac-ash" />
                <span className="text-sm font-medium text-muted-foreground">
                  {categoryLabels[category] || category}
                </span>
              </div>
              <div className="space-y-2">
                {scaffolds.map((scaffold) => {
                  const isChecked = selectedNames.has(scaffold.name);
                  const isComingSoon = "comingSoon" in scaffold && scaffold.comingSoon;
                  return (
                    <label
                      key={scaffold.name}
                      className={cn(
                        "flex items-start gap-3 rounded-xl border border-gray-200 dark:border-gray-800 p-3 transition-colors",
                        isComingSoon
                          ? "opacity-60 cursor-not-allowed"
                          : "cursor-pointer",
                        !isComingSoon && isChecked
                          ? "border-eld-space-indigo bg-eld-space-indigo/5"
                          : !isComingSoon
                            ? "hover:bg-gray-50 dark:hover:bg-gray-800/30"
                            : ""
                      )}
                    >
                      <input
                        type="checkbox"
                        checked={isChecked}
                        disabled={isComingSoon}
                        onChange={() => onToggle(scaffold.name)}
                        className="mt-0.5 h-4 w-4 rounded border-gray-300 text-eld-space-indigo focus:ring-eld-space-indigo/20 dark:border-gray-600"
                      />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium">
                            {scaffold.name}
                          </span>
                          {isComingSoon && (
                            <span className="text-[10px] font-semibold uppercase tracking-wide text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30 px-1.5 py-0.5 rounded">
                              Coming soon
                            </span>
                          )}
                          {!isComingSoon && (
                            <button
                              type="button"
                              onClick={(e) => {
                                e.preventDefault();
                                setDetailName(scaffold.name);
                              }}
                              className="text-muted-foreground hover:text-foreground"
                              aria-label={`Details for ${scaffold.name}`}
                            >
                              <Info className="h-3.5 w-3.5" />
                            </button>
                          )}
                        </div>
                        <p className="text-xs text-muted-foreground mt-0.5">
                          {scaffold.description}
                        </p>
                      </div>
                    </label>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>

      {/* Scaffold Detail Modal */}
      <Dialog
        open={detailName !== null}
        onOpenChange={(open) => {
          if (!open) setDetailName(null);
        }}
      >
        <DialogContent className="sm:max-w-md">
          {detailScaffold && (
            <>
              <DialogHeader>
                <DialogTitle>{detailScaffold.name}</DialogTitle>
                <DialogDescription>
                  {categoryLabels[detailScaffold.category] ||
                    detailScaffold.category}
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <p className="text-sm text-muted-foreground">
                  {detailScaffold.description}
                </p>
                <div>
                  <p className="text-xs font-medium text-muted-foreground mb-1">
                    Target EL Levels
                  </p>
                  <div className="flex gap-1">
                    {detailScaffold.el_level_target.map((level) => (
                      <ELBadge
                        key={level}
                        level={level as ELLevel}
                      />
                    ))}
                  </div>
                </div>
                <div className="flex justify-end">
                  <Button
                    variant={
                      detailName !== null && selectedNames.has(detailName)
                        ? "outline"
                        : "default"
                    }
                    size="sm"
                    onClick={() => {
                      if (detailName !== null) {
                        onToggle(detailName);
                      }
                    }}
                  >
                    {detailName !== null && selectedNames.has(detailName)
                      ? "Remove from Selection"
                      : "Add to Selection"}
                  </Button>
                </div>
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
"use client";

import { useState, useEffect, useMemo, useCallback } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { ArrowLeft, Loader2, Sparkles } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { StudentSelector, type StudentSelection } from "./student-selector";
import { ScaffoldPicker } from "./scaffold-picker";
import { getAllStudents } from "@/lib/queries/students";
import { defaultScaffolds } from "@/lib/seed-scaffolds";
import type { Student, ELLevel } from "@/types";

interface StudentScaffoldSelectionProps {
  assignmentTitle: string;
  content: string;
  subject?: string;
  sourceType?: string;
  gradeLevel?: number;
  contentLength: number;
  onBack: () => void;
}

export function StudentScaffoldSelection({
  assignmentTitle,
  content,
  subject,
  gradeLevel,
  contentLength,
  onBack,
}: StudentScaffoldSelectionProps) {
  const router = useRouter();
  const [students, setStudents] = useState<Student[]>([]);
  const [selection, setSelection] = useState<StudentSelection | null>(null);
  const [selectedScaffoldNames, setSelectedScaffoldNames] = useState<Set<string>>(
    new Set()
  );
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false);

  // Fetch students
  useEffect(() => {
    async function load() {
      try {
        const data = await getAllStudents();
        setStudents(data);
      } catch {
        setStudents([]);
      } finally {
        setIsLoading(false);
      }
    }
    load();
  }, []);

  // Get all unique EL levels from selection
  const selectedElLevels: ELLevel[] = useMemo(() => {
    if (!selection) return [];
    const levels = new Set<ELLevel>();
    selection.students.forEach((s) => levels.add(s.el_level));
    return Array.from(levels);
  }, [selection]);

  // Stable key for tracking level changes
  const elLevelsKey = selectedElLevels.join(",");

  // Auto-select recommended scaffolds when EL levels change
  useEffect(() => {
    if (selectedElLevels.length === 0) {
      setSelectedScaffoldNames(new Set());
      return;
    }
    const recommended = new Set<string>();
    defaultScaffolds.forEach((s) => {
      if ("comingSoon" in s && s.comingSoon) return;
      if (selectedElLevels.some((level) => s.el_level_target.includes(level))) {
        recommended.add(s.name);
      }
    });
    setSelectedScaffoldNames(recommended);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [elLevelsKey]);

  const handleToggleScaffold = useCallback((name: string) => {
    const scaffold = defaultScaffolds.find((s) => s.name === name);
    if (scaffold && "comingSoon" in scaffold && scaffold.comingSoon) return;
    setSelectedScaffoldNames((prev) => {
      const next = new Set(prev);
      if (next.has(name)) {
        next.delete(name);
      } else {
        next.add(name);
      }
      return next;
    });
  }, []);

  const handleSelectAllScaffolds = useCallback(() => {
    if (selectedElLevels.length === 0) return;
    const all = new Set<string>();
    defaultScaffolds.forEach((s) => {
      if ("comingSoon" in s && s.comingSoon) return;
      if (selectedElLevels.some((level) => s.el_level_target.includes(level))) {
        all.add(s.name);
      }
    });
    setSelectedScaffoldNames(all);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [elLevelsKey]);

  const handleClearAllScaffolds = useCallback(() => {
    setSelectedScaffoldNames(new Set());
  }, []);

  const canGenerate =
    selection !== null &&
    selection.students.length > 0 &&
    selectedScaffoldNames.size > 0;

  // Batch-by-level: group students by EL level so we make at most 3 Gemini calls
  const batchLevels = useMemo(() => {
    if (!selection) return null;
    const levelMap = new Map<ELLevel, Student[]>();
    selection.students.forEach((s) => {
      const arr = levelMap.get(s.el_level) ?? [];
      arr.push(s);
      levelMap.set(s.el_level, arr);
    });
    return levelMap;
  }, [selection]);

  const generationCount = batchLevels ? batchLevels.size : 0;

  /** Dispatch usage-updated event so sidebar counter updates immediately */
  function dispatchUsageUpdate(data: Record<string, unknown>) {
    if (typeof data.updatedUsage === "number") {
      window.dispatchEvent(
        new CustomEvent("usage-updated", { detail: { used: data.updatedUsage } })
      );
    }
  }

  async function handleGenerate() {
    if (!canGenerate || !batchLevels) return;
    setIsGenerating(true);
    setShowConfirm(false);

    try {
      const scaffoldNames = Array.from(selectedScaffoldNames);
      const levels = Array.from(batchLevels.entries());

      if (levels.length === 1) {
        const [level, levelStudents] = levels[0];
        const isSingle = levelStudents.length === 1;
        const studentName = isSingle
          ? levelStudents[0].name
          : `${levelStudents.length} ${level} students`;

        // Single level â€” one Gemini call
        const result = await callScaffoldAPI({
          content,
          title: assignmentTitle,
          subject,
          gradeLevel,
          elLevel: level,
          scaffoldNames,
          studentId: isSingle ? levelStudents[0].id : undefined,
          studentIds: !isSingle ? levelStudents.map((s) => s.id) : undefined,
          studentName,
        });

        storeAndNavigate(result, studentName, level);
      } else {
        // Batch mode: generate per-level (max 3 calls)
        const totalStudents = selection.students.length;
        const results = await Promise.all(
          levels.map(([level, levelStudents]) =>
            callScaffoldAPI({
              content,
              title: assignmentTitle,
              subject,
              gradeLevel,
              elLevel: level,
              scaffoldNames,
              studentIds: levelStudents.map((s) => s.id),
              studentName: `Batch: ${totalStudents} students (${levels.map(([l]) => l).join(", ")})`,
            })
          )
        );

        // Use the first result's storedId as the primary ID for navigation
        const resultId = results[0].storedId || crypto.randomUUID();
        const generatedAt = new Date().toISOString();

        const batchResult = {
          isBatch: true,
          levels: levels.map(([level, levelStudents], i) => ({
            level,
            studentCount: levelStudents.length,
            studentNames: levelStudents.map((s) => s.name),
            outputHtml: results[i].outputHtml,
            wordBank: results[i].wordBank,
            scaffoldsUsed: results[i].scaffoldsUsed,
            teacherInstructions: results[i].teacherInstructions,
            scaffoldsApplied: results[i].scaffoldsApplied,
            isDemo: results[i].isDemo,
          })),
          assignmentTitle,
          originalContent: content,
          generatedAt,
        };

        sessionStorage.setItem(
          `scaffold-result-${resultId}`,
          JSON.stringify(batchResult)
        );

        // Dispatch usage update from last result (most up-to-date count)
        dispatchUsageUpdate(results[results.length - 1]);

        toast.success(
          `Generated scaffolded versions for ${levels.length} level(s) (${totalStudents} students)`
        );

        router.push(`/create/result?id=${resultId}`);
      }
    } catch (error) {
      toast.error(
        error instanceof Error
          ? error.message
          : "Failed to generate. Please try again."
      );
    } finally {
      setIsGenerating(false);
    }
  }

  async function callScaffoldAPI(params: {
    content: string;
    title: string;
    subject?: string;
    gradeLevel?: number;
    elLevel: ELLevel;
    scaffoldNames: string[];
    studentId?: string;
    studentIds?: string[];
    studentName?: string;
  }) {
    const response = await fetch("/api/scaffold", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(params),
    });

    const data = await response.json();

    if (!response.ok) {
      const msg = data.detail
        ? `${data.error}: ${data.detail}`
        : data.error || "Generation failed";
      throw new Error(msg);
    }

    return data;
  }

  function storeAndNavigate(
    data: Record<string, unknown>,
    studentName: string,
    elLevel: ELLevel
  ) {
    const resultId = (data.storedId as string) || crypto.randomUUID();
    const generatedAt = new Date().toISOString();

    // Store in sessionStorage for immediate display on result page
    sessionStorage.setItem(
      `scaffold-result-${resultId}`,
      JSON.stringify({
        outputHtml: data.outputHtml,
        wordBank: data.wordBank,
        scaffoldsUsed: data.scaffoldsUsed,
        teacherInstructions: data.teacherInstructions,
        isDemo: data.isDemo,
        scaffoldsApplied: data.scaffoldsApplied,
        assignmentTitle,
        elLevel,
        studentName,
        originalContent: content,
        generatedAt,
      })
    );

    // Dispatch usage update so sidebar counter updates immediately
    dispatchUsageUpdate(data);

    toast.success(
      data.isDemo
        ? "Demo preview generated! Connect Gemini API key for real results."
        : "Scaffolded assignment generated successfully!"
    );

    router.push(`/create/result?id=${resultId}`);
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-6 w-6 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Student Selector */}
      <StudentSelector
        students={students}
        selection={selection}
        onSelect={setSelection}
        gradeLevel={gradeLevel}
      />

      {/* Scaffold Picker */}
      {selectedElLevels.length > 0 && (
        <ScaffoldPicker
          elLevels={selectedElLevels}
          selectedNames={selectedScaffoldNames}
          onToggle={handleToggleScaffold}
          onSelectAll={handleSelectAllScaffolds}
          onClearAll={handleClearAllScaffolds}
        />
      )}

      {/* Selection Summary */}
      {selection && selection.students.length > 0 && (
        <div className="rounded-xl bg-gray-50 dark:bg-gray-800/30 border border-gray-200 dark:border-gray-700 p-4">
          <h4 className="text-sm font-medium mb-2">Summary</h4>
          <div className="space-y-1 text-sm text-muted-foreground">
            <p>
              <strong>Assignment:</strong> {assignmentTitle} (
              {contentLength.toLocaleString()} chars)
            </p>
            <p>
              <strong>For:</strong>{" "}
              {selection.students.length === 1
                ? `${selection.students[0].name} (${selection.students[0].el_level})`
                : `${selection.students.length} students`}
            </p>
            <p>
              <strong>Scaffolds:</strong> {selectedScaffoldNames.size} selected
            </p>
            {batchLevels && batchLevels.size > 1 && (
              <p>
                <strong>AI Calls:</strong> {batchLevels.size} (grouped by level:{" "}
                {Array.from(batchLevels.entries())
                  .map(([level, levelStudents]) => `${level}: ${levelStudents.length}`)
                  .join(", ")}
                )
              </p>
            )}
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="flex justify-between pt-2">
        <Button
          variant="outline"
          onClick={onBack}
          className="gap-2"
          disabled={isGenerating}
        >
          <ArrowLeft className="h-4 w-4" />
          Back to Details
        </Button>
        <Button
          onClick={() => setShowConfirm(true)}
          disabled={!canGenerate || isGenerating}
          className="gap-2"
        >
          {isGenerating ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" />
              Generating...
            </>
          ) : (
            <>
              <Sparkles className="h-4 w-4" />
              Generate Scaffolded Assignment
            </>
          )}
        </Button>
      </div>

      {/* Confirmation Dialog */}
      <Dialog open={showConfirm} onOpenChange={setShowConfirm}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Generate Scaffolded Assignment?</DialogTitle>
            <DialogDescription>
              {generationCount === 1
                ? `This will generate a scaffolded version of "${assignmentTitle}" with ${selectedScaffoldNames.size} scaffold(s) applied.`
                : `This will generate ${generationCount} scaffolded version(s) of "${assignmentTitle}" grouped by EL level.`}
            </DialogDescription>
          </DialogHeader>
          <div className="rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 p-3 text-sm text-muted-foreground">
            <p>
              This will use{" "}
              <strong>
                {generationCount} of your daily AI generations
              </strong>
              .
            </p>
            {batchLevels && batchLevels.size > 1 && (
              <p className="mt-1">
                Students grouped by level â€” same level students share one scaffold output.
              </p>
            )}
            <p className="mt-1">Estimated time: ~{generationCount * 10}-{generationCount * 15} seconds</p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowConfirm(false)}>
              Cancel
            </Button>
            <Button onClick={handleGenerate} className="gap-2">
              <Sparkles className="h-4 w-4" />
              Confirm & Generate
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
"use client";

import { useState, useMemo, useCallback, useEffect } from "react";
import { Search, Check, X, UserCheck, Filter } from "lucide-react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { ELBadge } from "@/components/students/el-badge";
import { cn } from "@/lib/utils";
import type { Student, ELLevel } from "@/types";
import { EL_LEVELS, GRADES } from "@/types";

export type StudentSelection = { type: "multi"; students: Student[] };

interface StudentSelectorProps {
  students: Student[];
  selection: StudentSelection | null;
  onSelect: (selection: StudentSelection | null) => void;
  /** Grade level from Step 2 â€” when set, EL level / grade buttons filter to this grade */
  gradeLevel?: number;
}

export function StudentSelector({
  students,
  selection,
  onSelect,
  gradeLevel,
}: StudentSelectorProps) {
  const [search, setSearch] = useState("");

  // Filter state â€” each category tracks which values are active
  const [activeGrades, setActiveGrades] = useState<Set<number>>(new Set());
  const [activeELLevels, setActiveELLevels] = useState<Set<ELLevel>>(new Set());
  const [activeHomerooms, setActiveHomerooms] = useState<Set<string>>(new Set());

  const selectedIds = useMemo(() => {
    if (!selection) return new Set<string>();
    return new Set(selection.students.map((s) => s.id));
  }, [selection]);

  // Students scoped to the assignment grade level (if specified)
  const gradeScopedStudents = useMemo(() => {
    if (!gradeLevel) return students;
    return students.filter((s) => s.grade === gradeLevel);
  }, [students, gradeLevel]);

  const hasActiveFilters = activeGrades.size > 0 || activeELLevels.size > 0 || activeHomerooms.size > 0;

  // Compute students that match ALL active filter categories (intersection across categories, union within)
  const filteredByFilters = useMemo(() => {
    let pool = gradeScopedStudents;
    if (activeGrades.size > 0) {
      pool = pool.filter((s) => activeGrades.has(s.grade));
    }
    if (activeELLevels.size > 0) {
      pool = pool.filter((s) => activeELLevels.has(s.el_level));
    }
    if (activeHomerooms.size > 0) {
      pool = pool.filter((s) => activeHomerooms.has(s.homeroom || "Unassigned"));
    }
    return pool;
  }, [gradeScopedStudents, activeGrades, activeELLevels, activeHomerooms]);

  // When filters change, auto-select matching students
  useEffect(() => {
    if (!hasActiveFilters) {
      onSelect(null);
      return;
    }
    onSelect(
      filteredByFilters.length > 0
        ? { type: "multi", students: filteredByFilters }
        : null
    );
  }, [filteredByFilters, hasActiveFilters]); // eslint-disable-line react-hooks/exhaustive-deps

  // Count how many students each filter value would yield given the OTHER active filters
  const countsForGrade = useMemo(() => {
    const map: Partial<Record<number, number>> = {};
    for (const g of GRADES) {
      let pool = students.filter((s) => s.grade === g);
      if (activeELLevels.size > 0) pool = pool.filter((s) => activeELLevels.has(s.el_level));
      if (activeHomerooms.size > 0) pool = pool.filter((s) => activeHomerooms.has(s.homeroom || "Unassigned"));
      map[g] = pool.length;
    }
    return map;
  }, [students, activeELLevels, activeHomerooms]);

  const countsForEL = useMemo(() => {
    const map: Record<ELLevel, number> = { Emerging: 0, Expanding: 0, Bridging: 0 };
    for (const level of EL_LEVELS) {
      let pool = gradeScopedStudents.filter((s) => s.el_level === level);
      if (activeGrades.size > 0 && !gradeLevel) pool = pool.filter((s) => activeGrades.has(s.grade));
      if (activeHomerooms.size > 0) pool = pool.filter((s) => activeHomerooms.has(s.homeroom || "Unassigned"));
      map[level] = pool.length;
    }
    return map;
  }, [gradeScopedStudents, activeGrades, activeHomerooms, gradeLevel]);

  const countsForHomeroom = useMemo(() => {
    const map: Record<string, number> = {};
    gradeScopedStudents.forEach((s) => {
      const hr = s.homeroom || "Unassigned";
      if (!map[hr]) map[hr] = 0;
    });
    for (const hr of Object.keys(map)) {
      let pool = gradeScopedStudents.filter((s) => (s.homeroom || "Unassigned") === hr);
      if (activeGrades.size > 0 && !gradeLevel) pool = pool.filter((s) => activeGrades.has(s.grade));
      if (activeELLevels.size > 0) pool = pool.filter((s) => activeELLevels.has(s.el_level));
      map[hr] = pool.length;
    }
    return Object.fromEntries(
      Object.entries(map).sort(([a], [b]) => a.localeCompare(b))
    );
  }, [gradeScopedStudents, activeGrades, activeELLevels, gradeLevel]);

  const studentsByLevel = useMemo(() => {
    const map: Record<ELLevel, Student[]> = {
      Emerging: [],
      Expanding: [],
      Bridging: [],
    };
    gradeScopedStudents.forEach((s) => map[s.el_level].push(s));
    return map;
  }, [gradeScopedStudents]);

  const studentsByHomeroom = useMemo(() => {
    const map: Record<string, Student[]> = {};
    gradeScopedStudents.forEach((s) => {
      const hr = s.homeroom || "Unassigned";
      if (!map[hr]) map[hr] = [];
      map[hr].push(s);
    });
    return Object.fromEntries(
      Object.entries(map).sort(([a], [b]) => a.localeCompare(b))
    );
  }, [gradeScopedStudents]);

  const studentsByGrade = useMemo(() => {
    const map: Partial<Record<number, Student[]>> = {};
    GRADES.forEach((g) => (map[g] = []));
    students.forEach((s) => {
      if (map[s.grade]) map[s.grade]!.push(s);
    });
    return map;
  }, [students]);

  const filtered = useMemo(() => {
    const pool = hasActiveFilters ? filteredByFilters : gradeScopedStudents;
    if (!search) return pool;
    const lower = search.toLowerCase();
    return pool.filter(
      (s) =>
        s.name.toLowerCase().includes(lower) ||
        s.primary_language.toLowerCase().includes(lower)
    );
  }, [gradeScopedStudents, filteredByFilters, hasActiveFilters, search]);

  const toggleGrade = useCallback((grade: number) => {
    setActiveGrades((prev) => {
      const next = new Set(prev);
      if (next.has(grade)) next.delete(grade);
      else next.add(grade);
      return next;
    });
  }, []);

  const toggleELLevel = useCallback((level: ELLevel) => {
    setActiveELLevels((prev) => {
      const next = new Set(prev);
      if (next.has(level)) next.delete(level);
      else next.add(level);
      return next;
    });
  }, []);

  const toggleHomeroom = useCallback((homeroom: string) => {
    setActiveHomerooms((prev) => {
      const next = new Set(prev);
      if (next.has(homeroom)) next.delete(homeroom);
      else next.add(homeroom);
      return next;
    });
  }, []);

  const toggleStudent = useCallback(
    (student: Student) => {
      const current = selection?.students ?? [];
      const exists = current.some((s) => s.id === student.id);
      const next = exists
        ? current.filter((s) => s.id !== student.id)
        : [...current, student];
      onSelect(next.length > 0 ? { type: "multi", students: next } : null);
    },
    [selection, onSelect]
  );

  const selectAll = useCallback(() => {
    const pool = hasActiveFilters ? filteredByFilters : gradeScopedStudents;
    onSelect(
      pool.length > 0
        ? { type: "multi", students: [...pool] }
        : null
    );
  }, [gradeScopedStudents, filteredByFilters, hasActiveFilters, onSelect]);

  const clearAll = useCallback(() => {
    setActiveGrades(new Set());
    setActiveELLevels(new Set());
    setActiveHomerooms(new Set());
    onSelect(null);
  }, [onSelect]);

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <label className="text-sm font-medium">
          Who is this assignment for?
        </label>
        {selectedIds.size > 0 && (
          <span className="text-xs font-medium text-eld-space-indigo dark:text-eld-seashell">
            {selectedIds.size} student{selectedIds.size !== 1 ? "s" : ""} selected
          </span>
        )}
      </div>

      {gradeLevel && (
        <p className="text-xs text-muted-foreground">
          Showing students in <strong>Grade {gradeLevel}</strong> (set in Step 2).
        </p>
      )}

      {hasActiveFilters && (
        <div className="flex items-center gap-2 text-xs text-muted-foreground">
          <Filter className="h-3 w-3" />
          <span>
            Filters narrow results â€” students must match <strong>all</strong> selected categories.
            {" "}<strong>{filteredByFilters.length}</strong> student{filteredByFilters.length !== 1 ? "s" : ""} match.
          </span>
        </div>
      )}

      {/* Filter by Grade Level â€” only show when no grade is locked from Step 2 */}
      {!gradeLevel && (
        <div className="space-y-2">
          <p className="text-xs font-medium text-muted-foreground">Select by Grade Level</p>
          <div className="grid grid-cols-2 gap-2 sm:grid-cols-4">
            {GRADES.map((grade) => {
              const isActive = activeGrades.has(grade);
              const count = countsForGrade[grade] ?? 0;
              const totalCount = (studentsByGrade[grade] ?? []).length;
              return (
                <button
                  key={grade}
                  onClick={() => toggleGrade(grade)}
                  disabled={totalCount === 0}
                  className={cn(
                    "flex items-center justify-between rounded-xl border p-2.5 text-left text-sm transition-colors",
                    isActive
                      ? "border-eld-space-indigo bg-eld-space-indigo/10 dark:border-eld-dusty-grape dark:bg-eld-dusty-grape/20"
                      : "border-gray-200 dark:border-gray-800",
                    totalCount > 0
                      ? "hover:border-eld-space-indigo hover:bg-eld-space-indigo/5 cursor-pointer"
                      : "opacity-50 cursor-not-allowed"
                  )}
                >
                  <div>
                    <span className="font-medium">Grade {grade}</span>
                    <p className="text-[10px] text-muted-foreground">
                      {count} student{count !== 1 ? "s" : ""}
                    </p>
                  </div>
                  {isActive && (
                    <Check className="h-4 w-4 text-black dark:text-eld-seashell" />
                  )}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* Filter by EL Level */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-muted-foreground">Select by EL Level</p>
        <div className="grid grid-cols-1 gap-2 sm:grid-cols-3">
          {EL_LEVELS.map((level) => {
            const isActive = activeELLevels.has(level);
            const count = countsForEL[level];
            const totalCount = studentsByLevel[level].length;
            return (
              <button
                key={level}
                onClick={() => toggleELLevel(level)}
                disabled={totalCount === 0}
                className={cn(
                  "flex items-center justify-between rounded-xl border p-2.5 text-left transition-colors",
                  isActive
                    ? "border-eld-space-indigo bg-eld-space-indigo/10 dark:border-eld-dusty-grape dark:bg-eld-dusty-grape/20"
                    : "border-gray-200 dark:border-gray-800",
                  totalCount > 0
                    ? "hover:border-eld-space-indigo hover:bg-eld-space-indigo/5 cursor-pointer"
                    : "opacity-50 cursor-not-allowed"
                )}
              >
                <div>
                  <div className="flex items-center gap-2">
                    <ELBadge level={level} />
                  </div>
                  <p className="mt-1 text-[10px] text-muted-foreground">
                    {count} student{count !== 1 ? "s" : ""}
                  </p>
                </div>
                {isActive && (
                  <Check className="h-4 w-4 text-black dark:text-eld-seashell" />
                )}
              </button>
            );
          })}
        </div>
      </div>

      {/* Filter by Homeroom */}
      {Object.keys(studentsByHomeroom).length > 0 && (
        <div className="space-y-2">
          <p className="text-xs font-medium text-muted-foreground">
            Select by Homeroom{gradeLevel ? ` (Grade ${gradeLevel})` : ""}
          </p>
          <div className="grid grid-cols-2 gap-2 sm:grid-cols-4">
            {Object.entries(countsForHomeroom).map(([homeroom, count]) => {
              const isActive = activeHomerooms.has(homeroom);
              const totalCount = (studentsByHomeroom[homeroom] ?? []).length;
              return (
                <button
                  key={homeroom}
                  onClick={() => toggleHomeroom(homeroom)}
                  className={cn(
                    "flex items-center justify-between rounded-xl border p-2.5 text-left text-sm transition-colors",
                    isActive
                      ? "border-eld-space-indigo bg-eld-space-indigo/10 dark:border-eld-dusty-grape dark:bg-eld-dusty-grape/20"
                      : "border-gray-200 dark:border-gray-800",
                    "hover:border-eld-space-indigo hover:bg-eld-space-indigo/5 cursor-pointer"
                  )}
                >
                  <div>
                    <span className="font-medium">{homeroom}</span>
                    <p className="text-[10px] text-muted-foreground">
                      {count} student{count !== 1 ? "s" : ""}
                    </p>
                  </div>
                  {isActive && (
                    <Check className="h-4 w-4 text-black dark:text-eld-seashell" />
                  )}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* Select All / Clear All */}
      <div className="flex items-center gap-2">
        <Button variant="outline" size="sm" onClick={selectAll} className="text-xs">
          Select All{hasActiveFilters ? " Matching" : gradeLevel ? ` Grade ${gradeLevel}` : ""}
        </Button>
        {(selectedIds.size > 0 || hasActiveFilters) && (
          <Button variant="ghost" size="sm" onClick={clearAll} className="text-xs gap-1">
            <X className="h-3 w-3" />
            Clear{hasActiveFilters ? " Filters" : " All"}
          </Button>
        )}
      </div>

      <div className="relative flex items-center">
        <div className="flex-grow border-t" />
        <span className="px-3 text-xs text-muted-foreground">or select individual students</span>
        <div className="flex-grow border-t" />
      </div>

      {/* Search */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
        <Input
          placeholder="Search students by name..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="pl-9"
        />
      </div>

      {/* Student list with checkboxes */}
      <div className="max-h-56 overflow-y-auto rounded-xl border border-gray-200 dark:border-gray-800 scrollbar-thin">
        {filtered.length === 0 ? (
          <div className="px-4 py-6 text-center text-sm text-muted-foreground">
            {gradeScopedStudents.length === 0
              ? gradeLevel
                ? `No students in Grade ${gradeLevel}.`
                : "No students in your roster yet."
              : hasActiveFilters && !search
              ? "No students match all selected filters."
              : "No students match your search."}
          </div>
        ) : (
          filtered.map((student) => {
            const isSelected = selectedIds.has(student.id);
            return (
              <button
                key={student.id}
                onClick={() => toggleStudent(student)}
                className={cn(
                  "flex w-full items-center gap-3 border-b border-gray-100 px-4 py-2.5 text-left transition-colors last:border-b-0 dark:border-gray-800",
                  isSelected
                    ? "bg-eld-space-indigo/5 dark:bg-eld-dusty-grape/10"
                    : "hover:bg-gray-50 dark:hover:bg-gray-800/30"
                )}
              >
                {/* Checkbox */}
                <div
                  className={cn(
                    "flex h-4 w-4 shrink-0 items-center justify-center rounded border",
                    isSelected
                      ? "border-gray-900 bg-gray-900 dark:border-eld-dusty-grape dark:bg-eld-dusty-grape"
                      : "border-gray-300 dark:border-gray-600"
                  )}
                >
                  {isSelected && <Check className="h-3 w-3 text-white" strokeWidth={3} />}
                </div>
                <div className="flex flex-1 items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium">{student.name}</span>
                    <span className="text-xs text-muted-foreground">
                      Grade {student.grade}
                    </span>
                  </div>
                  <ELBadge level={student.el_level} />
                </div>
              </button>
            );
          })
        )}
      </div>

      {/* Selected students review section */}
      {selection && selection.students.length > 0 && (
        <div className="rounded-xl bg-gray-50 dark:bg-gray-800/30 border border-gray-200 dark:border-gray-700 p-4 space-y-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <UserCheck className="h-4 w-4 text-black dark:text-eld-seashell" />
              <span className="text-sm font-medium">
                Selected Students ({selection.students.length})
              </span>
            </div>
            <Button
              variant="ghost"
              size="sm"
              onClick={clearAll}
              className="text-xs gap-1 h-7"
            >
              <X className="h-3 w-3" />
              Clear
            </Button>
          </div>
          <div className="max-h-40 overflow-y-auto space-y-1 scrollbar-thin">
            {selection.students.map((student) => (
              <div
                key={student.id}
                className="flex items-center justify-between rounded-lg px-3 py-1.5 text-sm hover:bg-white dark:hover:bg-gray-800/50 group"
              >
                <div className="flex items-center gap-2">
                  <span className="font-medium">{student.name}</span>
                  <span className="text-xs text-muted-foreground">
                    Grade {student.grade}
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <ELBadge level={student.el_level} />
                  <button
                    onClick={() => toggleStudent(student)}
                    className="opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-destructive"
                    aria-label={`Remove ${student.name}`}
                  >
                    <X className="h-3.5 w-3.5" />
                  </button>
                </div>
              </div>
            ))}
          </div>
          {/* EL level breakdown */}
          <div className="flex flex-wrap gap-2 text-xs text-muted-foreground border-t border-gray-200 dark:border-gray-700 pt-2">
            {EL_LEVELS.map((level) => {
              const count = selection.students.filter((s) => s.el_level === level).length;
              if (count === 0) return null;
              return (
                <span key={level} className="flex items-center gap-1">
                  <ELBadge level={level} />
                  <span>{count}</span>
                </span>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
"use client";

import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { X } from "lucide-react";

interface TextInputTabProps {
  content: string;
  onChange: (content: string) => void;
}

const MAX_CHARS = 50000;

export function TextInputTab({ content, onChange }: TextInputTabProps) {
  return (
    <div className="space-y-2">
      <div className="relative">
        <Textarea
          value={content}
          onChange={(e) => onChange(e.target.value)}
          placeholder="Paste your assignment here... Include all instructions, questions, and reading passages."
          rows={14}
          maxLength={MAX_CHARS}
          className="resize-y min-h-[280px]"
        />
        {content.length > 0 && (
          <Button
            type="button"
            variant="ghost"
            size="icon"
            className="absolute right-2 top-2 h-6 w-6"
            onClick={() => onChange("")}
            aria-label="Clear text"
          >
            <X className="h-3 w-3" />
          </Button>
        )}
      </div>
      <div className="flex justify-between text-xs text-gray-500 dark:text-gray-400">
        <span>
          {content.length < 50 && content.length > 0
            ? `${50 - content.length} more characters needed`
            : "\u00A0"}
        </span>
        <span
          className={
            content.length > MAX_CHARS * 0.9
              ? "text-warning"
              : ""
          }
        >
          {content.length.toLocaleString()} / {MAX_CHARS.toLocaleString()}
        </span>
      </div>
    </div>
  );
}
"use client";

import { Zap } from "lucide-react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { useUsage } from "@/lib/hooks/use-usage";

export function AIUsageCard() {
  const { used, limit } = useUsage();
  const percentage = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">
          Today&apos;s AI Usage
        </CardTitle>
        <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-eld-almond-silk/30">
          <Zap className="h-6 w-6 text-eld-space-indigo dark:text-eld-almond-silk" />
        </div>
      </CardHeader>
      <CardContent>
        <div className="text-title-sm font-bold text-foreground">{used}</div>
        <p className="text-theme-xs text-muted-foreground">
          of {limit} daily limit
        </p>
        <div className="mt-3 h-2 rounded-full bg-eld-almond-silk/30 dark:bg-gray-700">
          <div
            className="h-2 rounded-full bg-eld-space-indigo transition-all dark:bg-eld-dusty-grape"
            style={{ width: `${percentage}%` }}
          />
        </div>
      </CardContent>
    </Card>
  );
}
"use client";

import { useEffect, useState } from "react";
import { useUserProfile } from "@/lib/hooks/use-user-profile";

const GREETINGS = [
  (name: string) => `Welcome back, ${name}!`,
  (name: string) => `Good to see you, ${name}!`,
  (name: string) => `Ready to inspire, ${name}?`,
  (name: string) => `Let's make a difference today, ${name}!`,
  (name: string) => `Hey ${name}, your students need you!`,
  (name: string) => `You're doing great work, ${name}!`,
  (name: string) => `Another great day to scaffold, ${name}!`,
  (name: string) => `Rise and shine, ${name}!`,
  (name: string) => `Hello, ${name}! Let's get to it.`,
  (name: string) => `Welcome, ${name} â€” let's inspire some learners!`,
];

const FALLBACK = "Welcome back!";

export function DashboardGreeting() {
  const { profile, isLoaded } = useUserProfile();
  const [greeting, setGreeting] = useState(FALLBACK);

  useEffect(() => {
    if (!isLoaded) return;
    const name = profile.firstName.trim();
    if (name) {
      const index = Math.floor(Math.random() * GREETINGS.length);
      setGreeting(GREETINGS[index](name));
    } else {
      setGreeting(FALLBACK);
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLoaded]);

  return <>{greeting}</>;
}
import Link from "next/link";

export function Footer() {
  return (
    <footer className="border-t border-white/10 bg-[#22223b] px-4 py-4 lg:px-6">
      <div className="flex flex-col items-center justify-between gap-1 sm:flex-row">
        <p className="text-theme-xs text-white/70">
          &copy; {new Date().getFullYear()} Valor Academy Middle School &mdash; ELD Scaffolding Platform
        </p>
        <Link
          href="/bug-report"
          className="text-theme-xs text-white/50 underline-offset-2 transition-colors hover:text-white/80 hover:underline"
        >
          Report a Bug
        </Link>
      </div>
    </footer>
  );
}
"use client";

import { useEffect, useState } from "react";
import { useRouter, usePathname } from "next/navigation";
import Link from "next/link";
import Image from "next/image";
import {
  Menu,
  X,
  LogOut,
  Shield,
  MessageSquare,
  LayoutDashboard,
  Users,
  PenSquare,
  BookOpen,
  Settings,
  GraduationCap,
  Layers,
} from "lucide-react";
import { createClient } from "@/lib/supabase-browser";
import { useIsAdmin } from "@/lib/hooks/use-admin";
import { ThemeToggle } from "./theme-toggle";
import { cn } from "@/lib/utils";

const navItems = [
  { title: "Dashboard", href: "/dashboard", icon: LayoutDashboard },
  { title: "Students", href: "/students", icon: Users, divider: true },
  { title: "Create Assignment", href: "/create", icon: PenSquare },
  { title: "Library", href: "/library", icon: BookOpen },
  { title: "Scaffolds", href: "/eld-guide/scaffolds", icon: Layers, divider: true },
  { title: "ELD Guide", href: "/eld-guide", icon: GraduationCap },
  { title: "Settings", href: "/settings", icon: Settings, divider: true },
];

export function Header() {
  const router = useRouter();
  const pathname = usePathname();
  const supabase = createClient();
  const { isAdmin } = useIsAdmin();
  const [email, setEmail] = useState<string | null>(null);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  useEffect(() => {
    supabase.auth.getUser().then(({ data: { user } }) => {
      setEmail(user?.email ?? null);
    });
  }, [supabase.auth]);

  // Close drawer on route change
  useEffect(() => {
    setIsMenuOpen(false);
  }, [pathname]);

  const handleSignOut = async () => {
    await supabase.auth.signOut();
    router.push("/sign-in");
    router.refresh();
  };

  return (
    <>
      <header className="sticky top-0 z-40 flex h-[68px] items-center justify-between border-b border-white/10 bg-[#22223b] px-4 py-3 lg:px-6">
        {/* Left side - mobile menu button */}
        <div className="flex items-center gap-3">
          <button
            className="flex h-10 w-10 items-center justify-center rounded-lg text-white/70 hover:bg-white/10 hover:text-white lg:hidden"
            aria-label="Toggle menu"
            onClick={() => setIsMenuOpen(true)}
          >
            <Menu className="h-5 w-5" />
          </button>
        </div>

        {/* Right side - user email + theme toggle + sign out */}
        <div className="flex items-center gap-3">
          {isAdmin && (
            <span className="hidden items-center gap-1 rounded-full bg-white/15 px-2.5 py-1 text-xs font-medium text-white sm:flex">
              <Shield className="h-3 w-3" />
              Admin
            </span>
          )}
          {email && (
            <span className="hidden text-sm text-white/80 sm:block">
              {email}
            </span>
          )}
          <Link
            href="/contact"
            title="Message the ELD Teacher"
            className="flex h-10 w-10 items-center justify-center rounded-full text-white/70 transition-colors duration-200 hover:bg-white/10 hover:text-white"
          >
            <MessageSquare className="h-5 w-5" />
          </Link>
          <ThemeToggle />
          <button
            onClick={handleSignOut}
            title="Sign out"
            className="flex h-10 w-10 items-center justify-center rounded-full text-white/70 transition-colors duration-200 hover:bg-white/10 hover:text-red-300"
          >
            <LogOut className="h-5 w-5" />
          </button>
        </div>
      </header>

      {/* Mobile nav drawer */}
      {isMenuOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-50 bg-black/60 lg:hidden"
            onClick={() => setIsMenuOpen(false)}
            aria-hidden="true"
          />

          {/* Drawer */}
          <div className="fixed inset-y-0 left-0 z-50 flex w-72 flex-col bg-[#4a4e69] shadow-2xl lg:hidden">
            {/* Drawer header */}
            <div className="flex items-center justify-between px-5 py-5">
              <Link
                href="/dashboard"
                className="flex items-center gap-3"
                onClick={() => setIsMenuOpen(false)}
              >
                <Image
                  src="/eldlogo.png"
                  alt="Valor Academy Middle School"
                  width={44}
                  height={44}
                  className="rounded-lg shrink-0"
                />
                <div className="flex flex-col leading-tight">
                  <span className="text-sm font-bold text-white">Valor Academy</span>
                  <span className="text-sm font-bold text-white">Middle School</span>
                  <span className="text-xs text-white/70">English Language Development</span>
                </div>
              </Link>
              <button
                className="flex h-9 w-9 items-center justify-center rounded-lg text-white/70 hover:bg-white/10 hover:text-white"
                onClick={() => setIsMenuOpen(false)}
                aria-label="Close menu"
              >
                <X className="h-5 w-5" />
              </button>
            </div>

            {/* Nav items */}
            <nav className="flex-1 overflow-y-auto px-3 pb-6">
              <div className="space-y-1">
                {navItems.map((item) => {
                  const isActive =
                    pathname === item.href ||
                    (pathname?.startsWith(item.href + "/") &&
                      !navItems.some(
                        (other) => other.href !== item.href && pathname === other.href
                      ));
                  return (
                    <div key={item.href}>
                      {item.divider && (
                        <hr className="my-2 border-white/15" />
                      )}
                      <Link
                        href={item.href}
                        className={cn(
                          "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-all duration-200",
                          isActive
                            ? "bg-white/15 text-white"
                            : "text-white/80 hover:bg-white/10 hover:text-white"
                        )}
                      >
                        <item.icon className="h-5 w-5 shrink-0" />
                        <span>{item.title}</span>
                      </Link>
                    </div>
                  );
                })}
              </div>
            </nav>

            {/* Drawer footer */}
            <div className="border-t border-white/20 px-4 py-4">
              {email && (
                <p className="mb-3 truncate text-xs text-white/60">{email}</p>
              )}
              <button
                onClick={handleSignOut}
                className="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-white/80 hover:bg-white/10 hover:text-red-300 transition-colors duration-200"
              >
                <LogOut className="h-4 w-4" />
                Sign out
              </button>
            </div>
          </div>
        </>
      )}
    </>
  );
}
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  Users,
  PenSquare,
  BookOpen,
  Settings,
  GraduationCap,
  Layers,
} from "lucide-react";
import { cn } from "@/lib/utils";

const navItems = [
  { title: "Home", href: "/dashboard", icon: LayoutDashboard },
  { title: "Students", href: "/students", icon: Users },
  { title: "Create", href: "/create", icon: PenSquare },
  { title: "Library", href: "/library", icon: BookOpen },
  { title: "Scaffolds", href: "/eld-guide/scaffolds", icon: Layers },
  { title: "ELD Guide", href: "/eld-guide", icon: GraduationCap },
  { title: "Settings", href: "/settings", icon: Settings },
];

export function MobileNav() {
  const pathname = usePathname();

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50 border-t border-eld-almond-silk/30 bg-eld-seashell shadow-theme-lg dark:border-gray-800 dark:bg-gray-900 lg:hidden">
      <div className="flex items-center justify-around py-2">
        {navItems.map((item) => {
          const isActive =
            pathname === item.href ||
            (pathname?.startsWith(item.href + "/") &&
              !navItems.some(
                (other) => other.href !== item.href && pathname === other.href
              ));
          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "flex flex-col items-center gap-1 px-3 py-1 text-xs transition-colors duration-200",
                isActive
                  ? "text-eld-space-indigo dark:text-eld-almond-silk"
                  : "text-eld-dusty-grape hover:text-eld-space-indigo dark:text-gray-400 dark:hover:text-gray-200"
              )}
            >
              <item.icon className="h-5 w-5" />
              <span>{item.title}</span>
            </Link>
          );
        })}
      </div>
    </nav>
  );
}
"use client";

import Link from "next/link";
import Image from "next/image";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  Users,
  PenSquare,
  BookOpen,
  Settings,
  GraduationCap,
  Layers,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { UsageCounter } from "./usage-counter";
import { useUsage } from "@/lib/hooks/use-usage";

const navItems = [
  {
    title: "Dashboard",
    href: "/dashboard",
    icon: LayoutDashboard,
  },
  {
    title: "Students",
    href: "/students",
    icon: Users,
    divider: true,
  },
  {
    title: "Create Assignment",
    href: "/create",
    icon: PenSquare,
  },
  {
    title: "Library",
    href: "/library",
    icon: BookOpen,
  },
  {
    title: "Scaffolds",
    href: "/eld-guide/scaffolds",
    icon: Layers,
    divider: true,
  },
  {
    title: "ELD Guide",
    href: "/eld-guide",
    icon: GraduationCap,
  },
  {
    title: "Settings",
    href: "/settings",
    icon: Settings,
    divider: true,
  },
];

export function Sidebar() {
  const pathname = usePathname();
  const { used, limit } = useUsage();

  return (
    <aside className="hidden lg:flex flex-col fixed inset-y-0 left-0 z-50 w-[290px] bg-[#4a4e69] dark:bg-eld-space-indigo overflow-hidden shadow-[6px_0_24px_rgba(0,0,0,0.35)]">
      {/* Logo */}
      <Link
        href="/dashboard"
        className="flex items-center gap-3 px-5 py-6 shrink-0"
      >
        <Image
          src="/eldlogo.png"
          alt="Valor Academy Middle School"
          width={56}
          height={56}
          className="rounded-lg shrink-0"
        />
        <div className="flex flex-col leading-tight">
          <span className="text-sm font-bold text-white dark:text-eld-seashell">
            Valor Academy
          </span>
          <span className="text-sm font-bold text-white dark:text-eld-seashell">
            Middle School
          </span>
          <span className="text-xs text-white/70 dark:text-eld-seashell/70">
            English Language Development
          </span>
        </div>
      </Link>

      {/* Navigation */}
      <nav className="flex-1 px-3 overflow-y-auto custom-scrollbar">
        <div className="space-y-1 dark:space-y-1">
          {navItems.map((item) => {
            const isActive =
              pathname === item.href ||
              (pathname?.startsWith(item.href + "/") &&
                !navItems.some(
                  (other) => other.href !== item.href && pathname === other.href
                ));
            return (
              <div key={item.href}>
                {item.divider && (
                  <hr className="my-2 border-white/15 dark:border-eld-lilac-ash/15" />
                )}
                <Link
                  href={item.href}
                  className={cn(
                    "flex items-center gap-3 rounded-lg px-3 py-2.5 text-theme-sm font-medium transition-all duration-200",
                    isActive
                      ? "bg-white/15 text-white dark:bg-eld-dusty-grape dark:text-white"
                      : "text-white/80 hover:bg-white/10 hover:text-white hover:translate-x-1 dark:text-eld-seashell/80 dark:hover:bg-eld-dusty-grape/50 dark:hover:text-white"
                  )}
                >
                  <item.icon className="h-5 w-5 shrink-0" />
                  <span>{item.title}</span>
                </Link>
              </div>
            );
          })}
        </div>
      </nav>

      {/* Bottom Section */}
      <div className="mt-auto shrink-0 border-t border-white/20 dark:border-eld-lilac-ash/20 px-3 py-4">
        <UsageCounter used={used} limit={limit} isCollapsed={false} />
      </div>
    </aside>
  );
}
"use client";

import { useTheme } from "next-themes";
import { useEffect, useState } from "react";
import { Moon, Sun, Monitor } from "lucide-react";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

export function ThemeToggle() {
  const { setTheme, theme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) {
    return (
      <button className="flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 text-gray-500 dark:border-white/30 dark:text-white/70">
        <Sun className="h-5 w-5" />
      </button>
    );
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <button className="flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 text-gray-600 transition-colors duration-200 hover:bg-gray-100 hover:text-gray-900 dark:border-white/30 dark:text-white/70 dark:hover:bg-white/10 dark:hover:text-white">
          {theme === "dark" ? (
            <Moon className="h-5 w-5" />
          ) : theme === "light" ? (
            <Sun className="h-5 w-5" />
          ) : (
            <Monitor className="h-5 w-5" />
          )}
        </button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={() => setTheme("light")}>
          <Sun className="mr-2 h-4 w-4" />
          Light
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => setTheme("dark")}>
          <Moon className="mr-2 h-4 w-4" />
          Dark
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => setTheme("system")}>
          <Monitor className="mr-2 h-4 w-4" />
          System
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
"use client";

import { Zap } from "lucide-react";
import { cn } from "@/lib/utils";

interface UsageCounterProps {
  used: number;
  limit: number;
  className?: string;
  isCollapsed?: boolean;
}

export function UsageCounter({
  used = 0,
  limit = 1000,
  className,
  isCollapsed = false,
}: UsageCounterProps) {
  const remaining = limit - used;
  const isWarning = remaining > 0 && remaining <= Math.max(2, Math.ceil(limit * 0.2));
  const isExhausted = remaining <= 0;
  const percentage = Math.min((used / limit) * 100, 100);

  if (isCollapsed) {
    return (
      <div
        className={cn(
          "flex items-center justify-center",
          className
        )}
        title={`${used} / ${limit.toLocaleString()} AI generations used`}
      >
        <div
          className={cn(
            "relative flex h-10 w-10 items-center justify-center rounded-lg",
            isExhausted
              ? "bg-red-500/20 text-red-400"
              : isWarning
              ? "bg-amber-500/20 text-amber-400"
              : "bg-white/20 text-white dark:text-eld-lilac-ash"
          )}
        >
          <Zap className="h-4 w-4" />
        </div>
      </div>
    );
  }

  return (
    <div
      className={cn(
        "rounded-xl p-3",
        isExhausted
          ? "bg-red-500/10"
          : isWarning
          ? "bg-amber-500/10"
          : "bg-white/10",
        className
      )}
    >
      <div className="flex items-center gap-2 mb-2">
        <Zap
          className={cn(
            "h-4 w-4",
            isExhausted
              ? "text-red-400"
              : isWarning
              ? "text-amber-400"
              : "text-white dark:text-eld-lilac-ash"
          )}
        />
        <span className="text-theme-xs font-medium text-white/90 dark:text-eld-seashell/80">
          {used} / {limit.toLocaleString()}
        </span>
      </div>
      <div className="h-1.5 w-full rounded-full bg-white/20">
        <div
          className={cn(
            "h-1.5 rounded-full transition-all duration-300",
            isExhausted
              ? "bg-red-400"
              : isWarning
              ? "bg-amber-400"
              : "bg-white dark:bg-eld-lilac-ash"
          )}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}
"use client";

import { AlertCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";

interface ErrorMessageProps {
  title?: string;
  message?: string;
  retry?: () => void;
  className?: string;
}

export function ErrorMessage({
  title = "Something went wrong",
  message = "An unexpected error occurred. Please try again.",
  retry,
  className,
}: ErrorMessageProps) {
  return (
    <div
      className={cn(
        "flex flex-col items-center justify-center gap-4 rounded-2xl border border-red-200 dark:border-red-800/30 bg-red-50 dark:bg-red-900/10 shadow-theme-xs p-8 text-center",
        className
      )}
    >
      <AlertCircle className="h-10 w-10 text-red-500" />
      <div>
        <h3 className="text-lg font-semibold text-foreground">{title}</h3>
        <p className="mt-1 text-sm text-muted-foreground">{message}</p>
      </div>
      {retry && (
        <Button onClick={retry} variant="outline" size="sm">
          Try again
        </Button>
      )}
    </div>
  );
}
"use client";

import { useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { ELBadge } from "./el-badge";
import { Upload, AlertCircle, CheckCircle2 } from "lucide-react";
import type { ELLevel } from "@/types";

interface ParsedStudent {
  name: string;
  grade: number;
  el_level: string;
  primary_language: string;
  notes?: string;
}

interface BulkImportModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onImport: (
    students: ParsedStudent[]
  ) => Promise<{ imported: number; errors: Array<{ row: number; issues: string[] }> }>;
}

const VALID_EL_LEVELS = ["Emerging", "Expanding", "Bridging"];

function parseCSV(text: string): { students: ParsedStudent[]; errors: string[] } {
  const lines = text
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  if (lines.length === 0) {
    return { students: [], errors: ["No data to import."] };
  }

  // Check if first line is a header row
  const firstLine = lines[0].toLowerCase();
  const hasHeader =
    firstLine.includes("name") ||
    firstLine.includes("grade") ||
    firstLine.includes("level") ||
    firstLine.includes("language");
  const dataLines = hasHeader ? lines.slice(1) : lines;

  const students: ParsedStudent[] = [];
  const errors: string[] = [];

  for (let i = 0; i < dataLines.length; i++) {
    const lineNum = hasHeader ? i + 2 : i + 1;
    const parts = dataLines[i].split(",").map((p) => p.trim());

    if (parts.length < 4) {
      errors.push(
        `Row ${lineNum}: Expected at least 4 columns (Name, Grade, EL Level, Language). Got ${parts.length}.`
      );
      continue;
    }

    const [name, gradeStr, elLevel, language, ...rest] = parts;
    const notes = rest.join(", ").trim() || undefined;

    if (!name || name.length < 2) {
      errors.push(`Row ${lineNum}: Name must be at least 2 characters.`);
      continue;
    }

    const grade = parseInt(gradeStr, 10);
    if (isNaN(grade) || grade < 5 || grade > 8) {
      errors.push(`Row ${lineNum}: Grade must be 5, 6, 7, or 8. Got "${gradeStr}".`);
      continue;
    }

    // Normalize EL level (case-insensitive match)
    const normalizedLevel = VALID_EL_LEVELS.find(
      (l) => l.toLowerCase() === elLevel.toLowerCase()
    );
    if (!normalizedLevel) {
      errors.push(
        `Row ${lineNum}: EL Level must be Emerging, Expanding, or Bridging. Got "${elLevel}".`
      );
      continue;
    }

    if (!language || language.length < 2) {
      errors.push(`Row ${lineNum}: Language must be at least 2 characters.`);
      continue;
    }

    students.push({
      name,
      grade,
      el_level: normalizedLevel,
      primary_language: language,
      notes,
    });
  }

  return { students, errors };
}

export function BulkImportModal({
  open,
  onOpenChange,
  onImport,
}: BulkImportModalProps) {
  const [csvText, setCsvText] = useState("");
  const [parsed, setParsed] = useState<ParsedStudent[] | null>(null);
  const [parseErrors, setParseErrors] = useState<string[]>([]);
  const [isImporting, setIsImporting] = useState(false);
  const [result, setResult] = useState<{
    imported: number;
    errors: Array<{ row: number; issues: string[] }>;
  } | null>(null);

  function handleParse() {
    const { students, errors } = parseCSV(csvText);
    setParsed(students);
    setParseErrors(errors);
    setResult(null);
  }

  async function handleImport() {
    if (!parsed || parsed.length === 0) return;
    setIsImporting(true);
    try {
      const res = await onImport(parsed);
      setResult(res);
      if (res.imported > 0) {
        setParsed(null);
        setCsvText("");
      }
    } catch {
      setResult({ imported: 0, errors: [{ row: 0, issues: ["Import failed. Check your connection."] }] });
    } finally {
      setIsImporting(false);
    }
  }

  function handleClose(isOpen: boolean) {
    if (!isOpen) {
      setCsvText("");
      setParsed(null);
      setParseErrors([]);
      setResult(null);
    }
    onOpenChange(isOpen);
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-2xl max-h-[85vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Bulk Import Students</DialogTitle>
          <DialogDescription>
            Paste CSV data with columns: Name, Grade, EL Level, Primary Language, Notes (optional)
          </DialogDescription>
        </DialogHeader>

        {/* Success result */}
        {result && result.imported > 0 && (
          <div className="flex items-center gap-2 rounded-lg bg-green-50 dark:bg-green-950/30 p-3 text-sm text-green-700 dark:text-green-400">
            <CheckCircle2 className="h-4 w-4 shrink-0" />
            Successfully imported {result.imported} student{result.imported !== 1 ? "s" : ""}.
            {result.errors.length > 0 && ` ${result.errors.length} row(s) had errors.`}
          </div>
        )}

        {/* Error result */}
        {result && result.imported === 0 && result.errors.length > 0 && (
          <div className="rounded-lg bg-red-50 dark:bg-red-950/30 p-3 text-sm text-red-700 dark:text-red-400 space-y-1">
            <div className="flex items-center gap-2 font-medium">
              <AlertCircle className="h-4 w-4 shrink-0" />
              Import failed
            </div>
            {result.errors.map((e, i) => (
              <p key={i}>Row {e.row}: {e.issues.join(", ")}</p>
            ))}
          </div>
        )}

        {/* CSV Input */}
        {!parsed && !result?.imported && (
          <div className="space-y-3">
            <Textarea
              placeholder={`Name, Grade, EL Level, Language, Notes (optional)\nMaria Garcia, 6, Emerging, Spanish\nLi Wei, 7, Expanding, Mandarin, Transfer student\nAhmed Hassan, 5, Bridging, Arabic`}
              rows={10}
              value={csvText}
              onChange={(e) => setCsvText(e.target.value)}
              className="font-mono text-sm"
            />

            {parseErrors.length > 0 && (
              <div className="rounded-lg bg-yellow-50 dark:bg-yellow-950/30 p-3 text-sm text-yellow-700 dark:text-yellow-400 space-y-1">
                <div className="flex items-center gap-2 font-medium">
                  <AlertCircle className="h-4 w-4 shrink-0" />
                  {parseErrors.length} error{parseErrors.length !== 1 ? "s" : ""} found
                </div>
                {parseErrors.map((err, i) => (
                  <p key={i}>{err}</p>
                ))}
              </div>
            )}

            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => handleClose(false)}>
                Cancel
              </Button>
              <Button onClick={handleParse} disabled={!csvText.trim()}>
                Preview
              </Button>
            </div>
          </div>
        )}

        {/* Preview Table */}
        {parsed && parsed.length > 0 && !result?.imported && (
          <div className="space-y-3">
            <p className="text-sm text-muted-foreground">
              {parsed.length} student{parsed.length !== 1 ? "s" : ""} ready to import
              {parseErrors.length > 0 && ` (${parseErrors.length} row(s) skipped due to errors)`}
            </p>

            <div className="max-h-64 overflow-y-auto rounded-lg border border-eld-almond-silk/40 dark:border-gray-800">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-eld-seashell/50 dark:bg-gray-800/50">
                    <th className="px-3 py-2 text-left font-medium">Name</th>
                    <th className="px-3 py-2 text-left font-medium">Grade</th>
                    <th className="px-3 py-2 text-left font-medium">EL Level</th>
                    <th className="px-3 py-2 text-left font-medium">Language</th>
                  </tr>
                </thead>
                <tbody>
                  {parsed.map((s, i) => (
                    <tr key={i} className="border-b last:border-0">
                      <td className="px-3 py-2">{s.name}</td>
                      <td className="px-3 py-2">{s.grade}</td>
                      <td className="px-3 py-2">
                        <ELBadge level={s.el_level as ELLevel} />
                      </td>
                      <td className="px-3 py-2">{s.primary_language}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {parseErrors.length > 0 && (
              <div className="rounded-lg bg-yellow-50 dark:bg-yellow-950/30 p-3 text-sm text-yellow-700 dark:text-yellow-400 space-y-1">
                <p className="font-medium">Skipped rows:</p>
                {parseErrors.map((err, i) => (
                  <p key={i}>{err}</p>
                ))}
              </div>
            )}

            <div className="flex justify-end gap-2">
              <Button
                variant="outline"
                onClick={() => {
                  setParsed(null);
                  setParseErrors([]);
                }}
              >
                Back
              </Button>
              <Button onClick={handleImport} disabled={isImporting} className="gap-2">
                <Upload className="h-4 w-4" />
                {isImporting ? "Importing..." : `Import ${parsed.length} Student${parsed.length !== 1 ? "s" : ""}`}
              </Button>
            </div>
          </div>
        )}

        {/* All done â€” close */}
        {result && result.imported > 0 && (
          <div className="flex justify-end">
            <Button onClick={() => handleClose(false)}>Done</Button>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
"use client";

import {
  AlertDialog,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogCancel,
  AlertDialogAction,
} from "@/components/ui/alert-dialog";
import type { Student } from "@/types";

interface DeleteStudentDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  student: Student | null;
  onConfirm: () => Promise<void>;
  isLoading?: boolean;
}

export function DeleteStudentDialog({
  open,
  onOpenChange,
  student,
  onConfirm,
  isLoading = false,
}: DeleteStudentDialogProps) {
  if (!student) return null;

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Delete {student.name}?</AlertDialogTitle>
          <AlertDialogDescription>
            This action cannot be undone. This will permanently delete{" "}
            <strong>{student.name}</strong> from your student roster.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={isLoading}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            disabled={isLoading}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {isLoading ? "Deleting..." : "Delete"}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
import { cn } from "@/lib/utils";
import type { ELLevel } from "@/types";

const levelStyles: Record<ELLevel, string> = {
  Emerging: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
  Expanding: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
  Bridging: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
};

interface ELBadgeProps {
  level: ELLevel;
  className?: string;
}

export function ELBadge({ level, className }: ELBadgeProps) {
  return (
    <span
      className={cn(
        "inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium",
        levelStyles[level],
        className
      )}
    >
      {level}
    </span>
  );
}
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { studentSchema, type StudentFormValues } from "@/lib/validations";
import { EL_LEVELS, GRADES } from "@/types";
import type { Student } from "@/types";

interface StudentFormModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSubmit: (data: StudentFormValues) => Promise<void>;
  student?: Student | null;
  isLoading?: boolean;
}

export function StudentFormModal({
  open,
  onOpenChange,
  onSubmit,
  student,
  isLoading = false,
}: StudentFormModalProps) {
  const isEditing = !!student;

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<StudentFormValues>({
    resolver: zodResolver(studentSchema),
    defaultValues: student
      ? {
          ssid: student.ssid ?? "",
          name: student.name,
          grade: student.grade,
          homeroom: student.homeroom ?? "",
          el_level: student.el_level,
          overall_level: student.overall_level ?? undefined,
          oral_language_level: student.oral_language_level ?? undefined,
          written_language_level: student.written_language_level ?? undefined,
          primary_language: student.primary_language,
          notes: student.notes ?? "",
        }
      : {
          ssid: "",
          name: "",
          grade: 5,
          homeroom: "",
          el_level: "Emerging",
          primary_language: "",
          notes: "",
        },
  });

  async function handleFormSubmit(data: StudentFormValues) {
    await onSubmit(data);
    reset();
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>{isEditing ? "Edit Student" : "Add Student"}</DialogTitle>
          <DialogDescription>
            {isEditing
              ? "Update the student's information."
              : "Add a new student to your roster."}
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(handleFormSubmit)} className="space-y-4">
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="ssid">Student SSID</Label>
              <Input
                id="ssid"
                placeholder="e.g., 7726495983"
                {...register("ssid")}
              />
              {errors.ssid && (
                <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.ssid.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="homeroom">Homeroom</Label>
              <Input
                id="homeroom"
                placeholder="e.g., USC, UCLA, LMU, CSUN"
                {...register("homeroom")}
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="name">Full Name</Label>
            <Input
              id="name"
              placeholder="Student's full name (First Last)"
              {...register("name")}
            />
            {errors.name && (
              <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.name.message}</p>
            )}
          </div>

          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="grade">Grade</Label>
              <Select
                id="grade"
                {...register("grade", { valueAsNumber: true })}
              >
                {GRADES.map((g) => (
                  <option key={g} value={g}>
                    Grade {g}
                  </option>
                ))}
              </Select>
              {errors.grade && (
                <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.grade.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="el_level">EL Level</Label>
              <Select id="el_level" {...register("el_level")}>
                {EL_LEVELS.map((l) => (
                  <option key={l} value={l}>
                    {l}
                  </option>
                ))}
              </Select>
              {errors.el_level && (
                <p className="text-xs text-red-500 dark:text-red-400 mt-1">
                  {errors.el_level.message}
                </p>
              )}
            </div>
          </div>

          <div className="grid grid-cols-3 gap-3">
            <div className="space-y-2">
              <Label htmlFor="overall_level">Overall Level</Label>
              <Select
                id="overall_level"
                {...register("overall_level", { valueAsNumber: true })}
              >
                <option value="">-</option>
                {[1, 2, 3, 4].map((l) => (
                  <option key={l} value={l}>{l}</option>
                ))}
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="oral_language_level">Oral Level</Label>
              <Select
                id="oral_language_level"
                {...register("oral_language_level", { valueAsNumber: true })}
              >
                <option value="">-</option>
                {[1, 2, 3, 4].map((l) => (
                  <option key={l} value={l}>{l}</option>
                ))}
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="written_language_level">Written Level</Label>
              <Select
                id="written_language_level"
                {...register("written_language_level", { valueAsNumber: true })}
              >
                <option value="">-</option>
                {[1, 2, 3, 4].map((l) => (
                  <option key={l} value={l}>{l}</option>
                ))}
              </Select>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="primary_language">Primary Language</Label>
            <Input
              id="primary_language"
              placeholder="e.g., Spanish, Mandarin, Arabic"
              {...register("primary_language")}
            />
            {errors.primary_language && (
              <p className="text-xs text-red-500 dark:text-red-400 mt-1">
                {errors.primary_language.message}
              </p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="notes">Notes (optional)</Label>
            <Textarea
              id="notes"
              placeholder="Any additional notes about this student..."
              rows={3}
              {...register("notes")}
            />
            {errors.notes && (
              <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.notes.message}</p>
            )}
          </div>

          <div className="flex justify-end gap-2 pt-2">
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading
                ? isEditing
                  ? "Saving..."
                  : "Adding..."
                : isEditing
                ? "Save Changes"
                : "Add Student"}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
"use client";

import { useState, useMemo } from "react";
import Link from "next/link";
import { Search, Plus, Pencil, Trash2, ArrowUpDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select } from "@/components/ui/select";
import { ELBadge } from "./el-badge";
import type { Student, ELLevel } from "@/types";
import { EL_LEVELS, GRADES } from "@/types";

type SortField = "name" | "grade" | "el_level" | "homeroom" | "overall_level";
type SortDirection = "asc" | "desc";

interface StudentsTableProps {
  students: Student[];
  isAdmin?: boolean;
  onAdd?: () => void;
  onEdit?: (student: Student) => void;
  onDelete?: (student: Student) => void;
}

export function StudentsTable({
  students,
  isAdmin = false,
  onAdd,
  onEdit,
  onDelete,
}: StudentsTableProps) {
  const [search, setSearch] = useState("");
  const [gradeFilter, setGradeFilter] = useState<string>("all");
  const [elFilter, setElFilter] = useState<string>("all");
  const [homeroomFilter, setHomeroomFilter] = useState<string>("all");
  const [sortField, setSortField] = useState<SortField>("name");
  const [sortDirection, setSortDirection] = useState<SortDirection>("asc");

  const homeroomOptions = useMemo(() => {
    const pool = gradeFilter !== "all"
      ? students.filter((s) => s.grade === parseInt(gradeFilter))
      : students;
    const set = new Set(pool.map((s) => s.homeroom).filter(Boolean));
    return Array.from(set).sort();
  }, [students, gradeFilter]);

  const filteredAndSorted = useMemo(() => {
    let result = [...students];

    // Search filter
    if (search) {
      const lowerSearch = search.toLowerCase();
      result = result.filter(
        (s) =>
          s.name.toLowerCase().includes(lowerSearch) ||
          s.ssid?.toLowerCase().includes(lowerSearch) ||
          s.homeroom?.toLowerCase().includes(lowerSearch) ||
          s.primary_language.toLowerCase().includes(lowerSearch)
      );
    }

    // Grade filter
    if (gradeFilter !== "all") {
      result = result.filter((s) => s.grade === parseInt(gradeFilter));
    }

    // EL level filter
    if (elFilter !== "all") {
      result = result.filter((s) => s.el_level === elFilter);
    }

    // Homeroom filter
    if (homeroomFilter !== "all") {
      result = result.filter((s) => s.homeroom === homeroomFilter);
    }

    // Sort
    result.sort((a, b) => {
      const aVal = a[sortField];
      const bVal = b[sortField];
      const comparison =
        typeof aVal === "string"
          ? aVal.localeCompare(bVal as string)
          : (aVal as number) - (bVal as number);
      return sortDirection === "asc" ? comparison : -comparison;
    });

    return result;
  }, [students, search, gradeFilter, elFilter, homeroomFilter, sortField, sortDirection]);

  function toggleSort(field: SortField) {
    if (sortField === field) {
      setSortDirection((d) => (d === "asc" ? "desc" : "asc"));
    } else {
      setSortField(field);
      setSortDirection("asc");
    }
  }

  function SortButton({
    field,
    children,
  }: {
    field: SortField;
    children: React.ReactNode;
  }) {
    return (
      <button
        onClick={() => toggleSort(field)}
        className="flex items-center gap-1 font-medium hover:text-foreground transition-colors"
      >
        {children}
        <ArrowUpDown className="h-3 w-3" />
      </button>
    );
  }

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div className="flex flex-1 gap-2">
          <div className="relative flex-1 max-w-sm">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Search students..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
          <Select
            value={gradeFilter}
            onChange={(e) => { setGradeFilter(e.target.value); setHomeroomFilter("all"); }}
            className="w-36 flex-none"
          >
            <option value="all">All Grades</option>
            {GRADES.map((g) => (
              <option key={g} value={g}>
                Grade {g}
              </option>
            ))}
          </Select>
          <Select
            value={elFilter}
            onChange={(e) => setElFilter(e.target.value)}
            className="w-36 flex-none"
          >
            <option value="all">All Levels</option>
            {EL_LEVELS.map((l) => (
              <option key={l} value={l}>
                {l}
              </option>
            ))}
          </Select>
          <Select
            value={homeroomFilter}
            onChange={(e) => setHomeroomFilter(e.target.value)}
            className="w-40 flex-none"
          >
            <option value="all">All Homerooms</option>
            {homeroomOptions.map((hr) => (
              <option key={hr} value={hr}>
                {hr}
              </option>
            ))}
          </Select>
        </div>
        {isAdmin && onAdd && (
          <Button onClick={onAdd} className="gap-2">
            <Plus className="h-4 w-4" />
            Add Student
          </Button>
        )}
      </div>

      {/* Results count */}
      <p className="text-sm text-muted-foreground">
        {filteredAndSorted.length} student{filteredAndSorted.length !== 1 ? "s" : ""}
        {(search || gradeFilter !== "all" || elFilter !== "all" || homeroomFilter !== "all") && " (filtered)"}
      </p>

      {/* Desktop Table */}
      <div className="hidden md:block rounded-2xl border border-eld-almond-silk/40 dark:border-gray-800 overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="border-b bg-eld-seashell/50 dark:bg-gray-800/50">
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                <SortButton field="name">Name</SortButton>
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                <SortButton field="grade">Grade</SortButton>
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                <SortButton field="homeroom">Homeroom</SortButton>
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                <SortButton field="el_level">EL Level</SortButton>
              </th>
              <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                <SortButton field="overall_level">Overall</SortButton>
              </th>
              <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                Oral
              </th>
              <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                Written
              </th>
              {isAdmin && (
                <th className="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-eld-dusty-grape dark:text-gray-400">
                  Actions
                </th>
              )}
            </tr>
          </thead>
          <tbody>
            {filteredAndSorted.length === 0 ? (
              <tr>
                <td colSpan={isAdmin ? 8 : 7} className="px-4 py-12 text-center text-sm text-muted-foreground">
                  {students.length === 0
                    ? isAdmin
                      ? "No students yet. Click \"Add Student\" to begin."
                      : "No students have been added yet. Contact an admin to add students."
                    : "No students match your filters."}
                </td>
              </tr>
            ) : (
              filteredAndSorted.map((student) => (
                <tr
                  key={student.id}
                  className="border-b hover:bg-eld-almond-silk/20 dark:hover:bg-gray-800/30 transition-colors"
                >
                  <td className="px-4 py-3">
                    <Link
                      href={`/students/${student.id}`}
                      className="font-medium text-foreground hover:text-primary transition-colors"
                    >
                      {student.name}
                    </Link>
                    {student.ssid && (
                      <span className="block text-xs text-muted-foreground">{student.ssid}</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-sm">{student.grade}</td>
                  <td className="px-4 py-3 text-sm">{student.homeroom}</td>
                  <td className="px-4 py-3">
                    <ELBadge level={student.el_level} />
                  </td>
                  <td className="px-4 py-3 text-center text-sm font-medium">{student.overall_level || "-"}</td>
                  <td className="px-4 py-3 text-center text-sm">{student.oral_language_level || "-"}</td>
                  <td className="px-4 py-3 text-center text-sm">{student.written_language_level || "-"}</td>
                  {isAdmin && (
                    <td className="px-4 py-3">
                      <div className="flex items-center justify-end gap-1">
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => onEdit?.(student)}
                          aria-label={`Edit ${student.name}`}
                        >
                          <Pencil className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => onDelete?.(student)}
                          aria-label={`Delete ${student.name}`}
                        >
                          <Trash2 className="h-4 w-4 text-destructive" />
                        </Button>
                      </div>
                    </td>
                  )}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Mobile Card Grid */}
      <div className="grid grid-cols-1 gap-3 sm:grid-cols-2 md:hidden">
        {filteredAndSorted.length === 0 ? (
          <div className="col-span-full py-12 text-center text-sm text-muted-foreground">
            {students.length === 0
              ? isAdmin
                ? "No students yet. Click \"Add Student\" to begin."
                : "No students have been added yet. Contact an admin to add students."
              : "No students match your filters."}
          </div>
        ) : (
          filteredAndSorted.map((student) => (
            <div
              key={student.id}
              className="rounded-2xl border border-eld-almond-silk/40 bg-white p-4 space-y-2 dark:border-gray-800 dark:bg-white/[0.03]"
            >
              <div className="flex items-start justify-between">
                <Link
                  href={`/students/${student.id}`}
                  className="font-medium text-foreground hover:text-primary transition-colors"
                >
                  {student.name}
                </Link>
                <ELBadge level={student.el_level} />
              </div>
              <div className="text-sm text-muted-foreground">
                Grade {student.grade} &middot; {student.homeroom}
              </div>
              <div className="flex gap-3 text-xs text-muted-foreground">
                <span>Overall: {student.overall_level || "-"}</span>
                <span>Oral: {student.oral_language_level || "-"}</span>
                <span>Written: {student.written_language_level || "-"}</span>
              </div>
              {isAdmin && (
                <div className="flex items-center gap-1 pt-1">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => onEdit?.(student)}
                  >
                    <Pencil className="h-3 w-3 mr-1" />
                    Edit
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => onDelete?.(student)}
                    className="text-destructive hover:text-destructive"
                  >
                    <Trash2 className="h-3 w-3 mr-1" />
                    Delete
                  </Button>
                </div>
              )}
            </div>
          ))
        )}
      </div>
    </div>
  );
}
"use client";

import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-dialog";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

const AlertDialog = AlertDialogPrimitive.Root;
const AlertDialogTrigger = AlertDialogPrimitive.Trigger;
const AlertDialogPortal = AlertDialogPrimitive.Portal;

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/50 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
));
AlertDialogOverlay.displayName = "AlertDialogOverlay";

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-5 border border-eld-almond-silk/40 bg-white text-eld-space-indigo p-5 shadow-theme-2xl duration-200 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-100 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-2xl md:p-6",
        className
      )}
      {...props}
    >
      {children}
      <AlertDialogPrimitive.Close className="absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full text-eld-dusty-grape transition-colors duration-200 hover:bg-eld-almond-silk/30 hover:text-eld-space-indigo focus:outline-none dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-gray-200">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </AlertDialogPrimitive.Close>
    </AlertDialogPrimitive.Content>
  </AlertDialogPortal>
));
AlertDialogContent.displayName = "AlertDialogContent";

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
);
AlertDialogHeader.displayName = "AlertDialogHeader";

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
);
AlertDialogFooter.displayName = "AlertDialogFooter";

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
));
AlertDialogTitle.displayName = "AlertDialogTitle";

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
AlertDialogDescription.displayName = "AlertDialogDescription";

const AlertDialogAction = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement>
>(({ className, ...props }, ref) => (
  <button
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
));
AlertDialogAction.displayName = "AlertDialogAction";

const AlertDialogCancel = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement>
>(({ className, ...props }, ref) => (
  <button
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
));
AlertDialogCancel.displayName = "AlertDialogCancel";

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium transition-colors duration-200 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-eld-space-indigo/10 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default:
          "bg-eld-space-indigo/10 text-eld-space-indigo shadow-theme-xs hover:bg-eld-space-indigo/20 dark:bg-eld-space-indigo dark:text-white dark:hover:bg-eld-dusty-grape",
        destructive:
          "bg-red-100 text-red-700 shadow-theme-xs hover:bg-red-200 dark:bg-red-500 dark:text-white dark:hover:bg-red-600",
        outline:
          "ring-1 ring-inset ring-eld-almond-silk bg-white text-eld-space-indigo hover:bg-eld-seashell dark:bg-transparent dark:text-eld-seashell dark:ring-gray-700 dark:hover:bg-gray-800",
        secondary:
          "bg-eld-seashell text-eld-space-indigo hover:bg-eld-almond-silk/50 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700",
        ghost:
          "text-eld-space-indigo hover:bg-eld-almond-silk/30 dark:text-gray-300 dark:hover:bg-gray-800",
        link: "text-eld-space-indigo underline-offset-4 hover:underline dark:text-eld-almond-silk",
      },
      size: {
        default: "h-11 px-4 py-2",
        sm: "h-9 rounded-lg px-3",
        lg: "h-12 rounded-lg px-8 text-base",
        icon: "h-11 w-11",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
Button.displayName = "Button";

export { Button, buttonVariants };
import * as React from "react";

import { cn } from "@/lib/utils";

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-2xl border border-eld-almond-silk/40 bg-white text-eld-space-indigo shadow-theme-xs dark:border-gray-800 dark:bg-white/[0.03] dark:text-gray-100",
      className
    )}
    {...props}
  />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-5 md:p-6", className)}
    {...props}
  />
));
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
));
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("px-5 pb-5 pt-0 md:px-6 md:pb-6", className)} {...props} />
));
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center px-5 pb-5 pt-0 md:px-6 md:pb-6", className)}
    {...props}
  />
));
CardFooter.displayName = "CardFooter";

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
"use client";

import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const Dialog = DialogPrimitive.Root;
const DialogTrigger = DialogPrimitive.Trigger;
const DialogPortal = DialogPrimitive.Portal;
const DialogClose = DialogPrimitive.Close;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/50 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-5 border border-eld-almond-silk/40 bg-white text-eld-space-indigo p-5 shadow-theme-2xl duration-200 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-100 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-2xl md:p-6",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full text-eld-dusty-grape transition-colors duration-200 hover:bg-eld-almond-silk/30 hover:text-eld-space-indigo focus:outline-none disabled:pointer-events-none dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-gray-200">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
));
DialogContent.displayName = DialogPrimitive.Content.displayName;

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
);
DialogHeader.displayName = "DialogHeader";

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
);
DialogFooter.displayName = "DialogFooter";

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
};
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;
const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;
const DropdownMenuGroup = DropdownMenuPrimitive.Group;
const DropdownMenuPortal = DropdownMenuPrimitive.Portal;
const DropdownMenuSub = DropdownMenuPrimitive.Sub;
const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors duration-150 focus:bg-eld-almond-silk/30 dark:focus:bg-gray-800 data-[state=open]:bg-eld-almond-silk/30 dark:data-[state=open]:bg-gray-800",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-xl border border-eld-almond-silk/40 bg-white p-1.5 text-eld-space-indigo shadow-theme-lg dark:border-gray-800 dark:bg-gray-900 dark:text-gray-100 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-xl border border-eld-almond-silk/40 bg-white p-1.5 text-eld-space-indigo shadow-theme-lg dark:border-gray-800 dark:bg-gray-900 dark:text-gray-100 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors duration-150 focus:bg-eld-almond-silk/30 focus:text-foreground dark:focus:bg-gray-800 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-lg py-2 pl-8 pr-3 text-sm outline-none transition-colors duration-150 focus:bg-eld-almond-silk/30 focus:text-foreground dark:focus:bg-gray-800 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-lg py-2 pl-8 pr-3 text-sm outline-none transition-colors duration-150 focus:bg-eld-almond-silk/30 focus:text-foreground dark:focus:bg-gray-800 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-eld-almond-silk/40 dark:bg-gray-800", className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  );
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
import * as React from "react";

import { cn } from "@/lib/utils";

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-11 w-full rounded-lg border border-eld-almond-silk/60 bg-white px-4 py-2.5 text-sm text-eld-space-indigo shadow-theme-xs transition-colors duration-200 file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-eld-lilac-ash focus:border-eld-space-indigo focus:outline-none focus:ring-3 focus:ring-eld-space-indigo/10 disabled:cursor-not-allowed disabled:opacity-50 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-eld-dusty-grape dark:focus:ring-eld-dusty-grape/20",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Input.displayName = "Input";

export { Input };
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const labelVariants = cva(
  "text-sm font-medium leading-none text-gray-700 dark:text-gray-300 peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
);

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
import * as React from "react";
import { cn } from "@/lib/utils";

export interface SelectProps
  extends React.SelectHTMLAttributes<HTMLSelectElement> {}

const Select = React.forwardRef<HTMLSelectElement, SelectProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <select
        className={cn(
          "flex h-11 w-full rounded-lg border border-eld-almond-silk/60 bg-white px-4 py-2.5 text-sm text-eld-space-indigo shadow-theme-xs transition-colors duration-200 focus:border-eld-space-indigo focus:outline-none focus:ring-3 focus:ring-eld-space-indigo/10 disabled:cursor-not-allowed disabled:opacity-50 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:focus:border-eld-dusty-grape dark:focus:ring-eld-dusty-grape/20",
          className
        )}
        ref={ref}
        {...props}
      >
        {children}
      </select>
    );
  }
);
Select.displayName = "Select";

export { Select };
import { cn } from "@/lib/utils";

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-lg bg-gray-200 dark:bg-gray-800", className)}
      {...props}
    />
  );
}

export { Skeleton };
"use client";

import * as React from "react";
import { cn } from "@/lib/utils";

interface TabsContextValue {
  value: string;
  onValueChange: (value: string) => void;
}

const TabsContext = React.createContext<TabsContextValue | null>(null);

function useTabs() {
  const context = React.useContext(TabsContext);
  if (!context) throw new Error("Tabs components must be used within <Tabs>");
  return context;
}

interface TabsProps extends React.HTMLAttributes<HTMLDivElement> {
  value: string;
  onValueChange: (value: string) => void;
}

function Tabs({ value, onValueChange, className, ...props }: TabsProps) {
  return (
    <TabsContext.Provider value={{ value, onValueChange }}>
      <div className={cn("w-full", className)} {...props} />
    </TabsContext.Provider>
  );
}

const TabsList = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "inline-flex h-auto w-full items-center gap-1 border-b border-eld-almond-silk/40 bg-transparent p-0 text-muted-foreground dark:border-gray-700",
      className
    )}
    {...props}
  />
));
TabsList.displayName = "TabsList";

interface TabsTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  value: string;
}

const TabsTrigger = React.forwardRef<HTMLButtonElement, TabsTriggerProps>(
  ({ className, value, ...props }, ref) => {
    const { value: selectedValue, onValueChange } = useTabs();
    const isActive = selectedValue === value;
    return (
      <button
        ref={ref}
        type="button"
        role="tab"
        aria-selected={isActive}
        onClick={() => onValueChange(value)}
        className={cn(
          "inline-flex items-center justify-center whitespace-nowrap border-b-2 px-4 pb-3 pt-1.5 text-sm font-medium transition-all focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50",
          isActive
            ? "border-eld-space-indigo text-eld-space-indigo dark:border-eld-almond-silk dark:text-eld-almond-silk"
            : "border-transparent text-eld-dusty-grape hover:text-eld-space-indigo dark:text-gray-400 dark:hover:text-gray-200",
          className
        )}
        {...props}
      />
    );
  }
);
TabsTrigger.displayName = "TabsTrigger";

interface TabsContentProps extends React.HTMLAttributes<HTMLDivElement> {
  value: string;
}

const TabsContent = React.forwardRef<HTMLDivElement, TabsContentProps>(
  ({ className, value, ...props }, ref) => {
    const { value: selectedValue } = useTabs();
    if (selectedValue !== value) return null;
    return (
      <div
        ref={ref}
        role="tabpanel"
        className={cn(
          "mt-6 focus-visible:outline-none",
          className
        )}
        {...props}
      />
    );
  }
);
TabsContent.displayName = "TabsContent";

export { Tabs, TabsList, TabsTrigger, TabsContent };
import * as React from "react";

import { cn } from "@/lib/utils";

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-lg border border-eld-almond-silk/60 bg-white px-4 py-2.5 text-sm text-eld-space-indigo shadow-theme-xs transition-colors duration-200 placeholder:text-eld-lilac-ash focus:border-eld-space-indigo focus:outline-none focus:ring-3 focus:ring-eld-space-indigo/10 disabled:cursor-not-allowed disabled:opacity-50 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-eld-dusty-grape dark:focus:ring-eld-dusty-grape/20",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = "Textarea";

export { Textarea };
const ADMIN_EMAILS = (process.env.ADMIN_EMAILS ?? "")
  .split(",")
  .map((e) => e.trim().toLowerCase())
  .filter(Boolean);

export function isAdminEmail(email: string): boolean {
  return ADMIN_EMAILS.includes(email.toLowerCase());
}
/**
 * California ELD/ELD Standards Reference Data (2012 CA ELD Standards & ELA/ELD Framework)
 *
 * Hardcoded scaffold strategies organized by proficiency level.
 * Used to auto-select scaffolds and enrich Gemini prompts with
 * level-appropriate CA ELD strategies.
 */

import type { ELLevel } from "@/types";

export interface ScaffoldStrategy {
  category: "visuals" | "language" | "activities";
  name: string;
  description: string;
}

export interface LevelProfile {
  level: ELLevel;
  label: string;
  supportIntensity: string;
  description: string;
  strategies: ScaffoldStrategy[];
  promptContext: string;
}

export const CA_ELD_LEVELS: Record<ELLevel, LevelProfile> = {
  Emerging: {
    level: "Emerging",
    label: "Emerging (Substantial Support)",
    supportIntensity: "substantial",
    description:
      "Students at this level need substantial scaffolding to access grade-level content. Focus on making input comprehensible through visuals, simplified language, and native language support.",
    strategies: [
      // Visuals
      {
        category: "visuals",
        name: "Pictures & Diagrams",
        description: "Use pictures, diagrams, gestures, realia, and videos to make content comprehensible",
      },
      // Language
      {
        category: "language",
        name: "Sentence Starters & Frames",
        description: 'Provide sentence starters/frames (e.g., "I see __ because __")',
      },
      {
        category: "language",
        name: "Word Banks",
        description: "Provide word banks with key vocabulary and simple definitions",
      },
      {
        category: "language",
        name: "Bilingual Glossaries",
        description: "Include bilingual glossaries for key academic terms",
      },
      {
        category: "language",
        name: "Modeled Talk",
        description: "Include examples of modeled academic talk and responses",
      },
      // Activities
      {
        category: "activities",
        name: "Simplified Texts",
        description: "Use simplified texts with shorter sentences and common vocabulary",
      },
      {
        category: "activities",
        name: "Audio Support",
        description: "Provide audio support or read-aloud instructions",
      },
      {
        category: "activities",
        name: "TPR (Total Physical Response)",
        description: "Incorporate physical movement and gestures to reinforce meaning",
      },
      {
        category: "activities",
        name: "Pre-taught Vocabulary",
        description: "Pre-teach key vocabulary with visuals before the assignment",
      },
      {
        category: "activities",
        name: "Think-Pair-Share with Visuals",
        description: "Structure collaborative discussion with visual supports",
      },
      {
        category: "activities",
        name: "Graphic Organizers",
        description: "Provide graphic organizers to structure thinking and writing",
      },
      {
        category: "activities",
        name: "Native Language Notes",
        description: "Allow students to take notes in their native language",
      },
    ],
    promptContext: `This student is at the EMERGING level of English proficiency and needs SUBSTANTIAL scaffolding support. Apply these CA ELD Framework strategies:
- Use visuals (pictures, diagrams, realia) to make content comprehensible
- Provide sentence starters and frames (e.g., "I see __ because __", "The main idea is __")
- Include a word bank with simple definitions for all academic vocabulary
- Simplify sentence structures â€” use shorter sentences and common vocabulary
- Add graphic organizers to structure thinking
- Allow native language notes where appropriate
- Pre-teach vocabulary with visual supports
The goal is making grade-level content ACCESSIBLE, not dumbing it down.`,
  },

  Expanding: {
    level: "Expanding",
    label: "Expanding (Moderate Support)",
    supportIntensity: "moderate",
    description:
      "Students at this level can engage with age-appropriate content with moderate scaffolding. Focus on building academic language and independent work skills.",
    strategies: [
      // Visuals/Language
      {
        category: "visuals",
        name: "Anchor Charts",
        description: "Use anchor charts summarizing key concepts and academic language",
      },
      {
        category: "language",
        name: "Word Maps",
        description: "Provide word maps connecting new vocabulary to known concepts",
      },
      {
        category: "language",
        name: "Sentence Unpacking",
        description: "Break down complex sentences to show how academic language works",
      },
      {
        category: "language",
        name: "Paragraph Jumbles",
        description: "Use paragraph jumbles to teach text organization",
      },
      // Activities
      {
        category: "activities",
        name: "Collaborative Text Reconstruction",
        description: "Reconstruct texts collaboratively to build language awareness",
      },
      {
        category: "activities",
        name: "Sorting Activities",
        description: "Sort and classify ideas, vocabulary, or text features",
      },
      {
        category: "activities",
        name: "Role-plays",
        description: "Use role-plays to practice academic language in context",
      },
      {
        category: "activities",
        name: "Peer Modeling",
        description: "Pair with peers who model academic language use",
      },
      {
        category: "activities",
        name: "Tiered Assignments",
        description: "Provide tiered options with varying levels of language complexity",
      },
      {
        category: "activities",
        name: "Modified Texts",
        description: "Use moderately modified texts with key vocabulary highlighted",
      },
      {
        category: "activities",
        name: "Think-Write-Pair-Share",
        description: "Add writing step before discussion to build confidence",
      },
      {
        category: "activities",
        name: "Gallery Walks",
        description: "Use gallery walks for collaborative analysis and feedback",
      },
    ],
    promptContext: `This student is at the EXPANDING level of English proficiency and needs MODERATE scaffolding support. Apply these CA ELD Framework strategies:
- Use anchor charts and word maps to build academic vocabulary
- Unpack complex sentences to show how academic language works
- Provide moderately modified text with key vocabulary highlighted
- Include sentence frames for academic discourse (not basic starters)
- Add tiered response options with varying language complexity
- Structure collaborative work (Think-Write-Pair-Share)
The goal is building ACADEMIC LANGUAGE proficiency while engaging with age-appropriate content.`,
  },

  Bridging: {
    level: "Bridging",
    label: "Bridging (Light Support)",
    supportIntensity: "light",
    description:
      "Students at this level are approaching grade-level independence. Focus on nuanced academic language, self-monitoring, and complex text structures.",
    strategies: [
      // Language
      {
        category: "language",
        name: "Complex Sentence Frames",
        description: 'Provide complex frames for cause-effect, comparison, and analysis (e.g., "Although __, the evidence suggests __")',
      },
      {
        category: "language",
        name: "Academic Discourse Posters",
        description: "Reference posters for academic discussion language",
      },
      {
        category: "language",
        name: "Nuanced Vocabulary",
        description: "Focus on nuanced, domain-specific vocabulary and register",
      },
      // Activities
      {
        category: "activities",
        name: "Peer Editing",
        description: "Structured peer editing with academic language feedback criteria",
      },
      {
        category: "activities",
        name: "Journals & Exit Tickets",
        description: "Use journals and exit tickets for self-reflection on language use",
      },
      {
        category: "activities",
        name: "Debates with Rubrics",
        description: "Structure debates with rubrics emphasizing academic register",
      },
      {
        category: "activities",
        name: "Self-Assessment",
        description: "Provide self-assessment checklists for academic language use",
      },
      {
        category: "activities",
        name: "Collaborative Writing",
        description: "Use collaborative writing (e.g., Google Docs) with structured roles",
      },
    ],
    promptContext: `This student is at the BRIDGING level of English proficiency and needs LIGHT scaffolding support. Apply these CA ELD Framework strategies:
- Provide complex sentence frames for academic analysis (cause-effect, comparison, argumentation)
- Focus on nuanced, domain-specific vocabulary rather than basic word banks
- Include self-assessment checklists for monitoring academic language use
- Add peer editing prompts with language-focused criteria
- Structure higher-order thinking activities (debates, analysis)
The goal is developing INDEPENDENCE with grade-level academic language and complex text structures.`,
  },
};

/**
 * Get the prompt context string for a given EL level.
 * Used to enrich Gemini prompts with level-appropriate CA ELD strategies.
 */
export function getELDPromptContext(level: ELLevel): string {
  return CA_ELD_LEVELS[level].promptContext;
}

/**
 * Get strategy names for a given EL level.
 */
export function getStrategiesForLevel(level: ELLevel): string[] {
  return CA_ELD_LEVELS[level].strategies.map((s) => s.name);
}
import { jsPDF } from "jspdf";
import {
  parseHtmlToBlocks,
  buildWordBankBlocks,
  buildTeacherInstructionsBlocks,
} from "./html-to-google-docs";

export interface ScaffoldPdfOptions {
  html: string;
  title: string;
  elLevel?: string;
  wordBank?: { term: string; definition: string }[];
  teacherInstructions?: string;
  filename: string;
}

// ---------------------------------------------------------------------------
// Page geometry (US Letter, points)
// ---------------------------------------------------------------------------

const PAGE_H = 792;
const MARGIN_TOP = 54;
const MARGIN_BOTTOM = 54;
const MARGIN_LEFT = 54;
const MARGIN_RIGHT = 54;
const CONTENT_W = 612 - MARGIN_LEFT - MARGIN_RIGHT; // 504 pt

// ---------------------------------------------------------------------------
// Font sizing
// ---------------------------------------------------------------------------

const FONT_SIZE: Record<string, number> = {
  heading1: 18,
  heading2: 14,
  heading3: 12,
  heading4: 11,
  paragraph: 11,
  "list-bullet": 11,
  "list-number": 11,
};

const LINE_HEIGHT_FACTOR = 1.55;

// ---------------------------------------------------------------------------
// Colour helpers
// ---------------------------------------------------------------------------

interface RGB {
  red: number;
  green: number;
  blue: number;
}

function rgbTo255(c: RGB): [number, number, number] {
  return [
    Math.round(c.red * 255),
    Math.round(c.green * 255),
    Math.round(c.blue * 255),
  ];
}

// ---------------------------------------------------------------------------
// Styled segment: a word (or whitespace) with its visual properties
// ---------------------------------------------------------------------------

interface Segment {
  text: string;
  bold: boolean;
  italic: boolean;
  size: number;
  color?: RGB;
  bgColor?: RGB;
}

// ---------------------------------------------------------------------------
// Main export
// ---------------------------------------------------------------------------

export async function downloadScaffoldPdf(
  opts: ScaffoldPdfOptions,
): Promise<void> {
  const doc = new jsPDF({
    unit: "pt",
    format: "letter",
    orientation: "portrait",
  });

  let y = MARGIN_TOP;
  let listCounter = 0;

  function checkPage(needed: number) {
    if (y + needed > PAGE_H - MARGIN_BOTTOM) {
      doc.addPage();
      y = MARGIN_TOP;
    }
  }

  function applyFont(seg: Segment) {
    let style = "normal";
    if (seg.bold && seg.italic) style = "bolditalic";
    else if (seg.bold) style = "bold";
    else if (seg.italic) style = "italic";
    doc.setFont("helvetica", style);
    doc.setFontSize(seg.size);
    if (seg.color) {
      const [r, g, b] = rgbTo255(seg.color);
      doc.setTextColor(r, g, b);
    } else {
      doc.setTextColor(30, 30, 30);
    }
  }

  /**
   * Render a paragraph's worth of styled segments with proper inline flow
   * and word-wrapping.  Handles multiple runs on the same line.
   */
  function renderSegments(segments: Segment[], startX: number, maxW: number) {
    let cursorX = startX;
    const lineH =
      (segments.length ? segments[0].size : 11) * LINE_HEIGHT_FACTOR;

    for (const seg of segments) {
      const lh = seg.size * LINE_HEIGHT_FACTOR;

      // Handle explicit newlines
      const sublines = seg.text.split("\n");
      for (let si = 0; si < sublines.length; si++) {
        if (si > 0) {
          // explicit newline
          y += lh;
          cursorX = startX;
          checkPage(lh);
        }

        const sub = sublines[si];
        if (!sub) continue;

        // Split into words for wrapping
        const words = sub.split(/( +)/); // keep spaces as separate tokens
        for (const word of words) {
          if (!word) continue;
          applyFont(seg);
          const ww = doc.getTextWidth(word);

          // Wrap if this word would overflow (but not if cursor is at line start)
          if (cursorX + ww > startX + maxW && cursorX > startX) {
            y += lh;
            cursorX = startX;
            checkPage(lh);
            // Skip leading spaces on wrapped line
            if (!word.trim()) continue;
          }

          checkPage(lh);

          // Background highlight
          if (seg.bgColor) {
            const [r, g, b] = rgbTo255(seg.bgColor);
            doc.setFillColor(r, g, b);
            doc.rect(cursorX - 0.5, y - seg.size + 2, ww + 1, lh - 2, "F");
            applyFont(seg); // restore text color after fill
          }

          doc.text(word, cursorX, y);
          cursorX += ww;
        }
      }
    }

    // Advance y past the last rendered line
    y += lineH;
  }

  // -----------------------------------------------------------------------
  // Build structured blocks (reuses the Google Docs HTML parser)
  // -----------------------------------------------------------------------

  const headerHtml = [
    `<h1>${escHtml(opts.title)}</h1>`,
    opts.elLevel
      ? `<p style="font-size:10pt;color:#666;">${escHtml(opts.elLevel)} Level \u2014 Scaffolded Assignment</p>`
      : "",
    `<hr />`,
  ].join("");

  const headerBlocks = parseHtmlToBlocks(headerHtml);
  const contentBlocks = parseHtmlToBlocks(opts.html);

  const wordBankBlocks =
    opts.wordBank?.length ? buildWordBankBlocks(opts.wordBank) : [];
  const instructionBlocks = opts.teacherInstructions
    ? buildTeacherInstructionsBlocks(opts.teacherInstructions)
    : [];

  const allBlocks = [
    ...headerBlocks,
    ...contentBlocks,
    ...wordBankBlocks,
    ...instructionBlocks,
  ];

  // -----------------------------------------------------------------------
  // Render blocks into the PDF
  // -----------------------------------------------------------------------

  for (const block of allBlocks) {
    if (block.type === "divider") {
      checkPage(14);
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.5);
      doc.line(MARGIN_LEFT, y, MARGIN_LEFT + CONTENT_W, y);
      y += 14;
      continue;
    }

    const fontSize = FONT_SIZE[block.type] ?? 11;
    const lineH = fontSize * LINE_HEIGHT_FACTOR;
    const isHeading = block.type.startsWith("heading");
    const isList =
      block.type === "list-bullet" || block.type === "list-number";

    // Spacing before headings
    if (isHeading && y > MARGIN_TOP + 10) {
      y += lineH * 0.5;
    }

    // Calculate indent
    let indentX = MARGIN_LEFT;
    const indentLevel = block.indent ?? 0;

    if (isList) {
      indentX += 18 + indentLevel * 18;
      checkPage(lineH);

      if (block.type === "list-bullet") {
        listCounter = 0;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(fontSize);
        doc.setTextColor(30, 30, 30);
        doc.text("\u2022", MARGIN_LEFT + 6 + indentLevel * 18, y);
      } else {
        listCounter++;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(fontSize);
        doc.setTextColor(30, 30, 30);
        doc.text(`${listCounter}.`, MARGIN_LEFT + 2 + indentLevel * 18, y);
      }
    }

    const maxW = CONTENT_W - (indentX - MARGIN_LEFT);

    if (block.runs.length === 0) {
      y += lineH;
      continue;
    }

    // Build flat segment list from runs
    const segments: Segment[] = block.runs.map((run) => ({
      text: run.text,
      bold: isHeading || !!run.style.bold,
      italic: !!run.style.italic,
      size: run.style.fontSize ?? fontSize,
      color: run.style.textColor,
      bgColor: run.style.backgroundColor,
    }));

    renderSegments(segments, indentX, maxW);

    // Reset list counter when leaving numbered lists
    if (!isList) listCounter = 0;

    // Small gap after paragraphs
    if (!isHeading) y += lineH * 0.15;
  }

  // -----------------------------------------------------------------------
  // Save
  // -----------------------------------------------------------------------
  doc.save(opts.filename);
}

function escHtml(s: string): string {
  return s
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}
import { GoogleGenerativeAI, SchemaType, type Schema } from "@google/generative-ai";
import { getELDPromptContext } from "@/lib/eld-standards";
import type { ELLevel, ScaffoldGenerationResult } from "@/types";

const apiKey = process.env.GEMINI_API_KEY ?? "";

function isPlaceholder(): boolean {
  return !apiKey || apiKey === "placeholder_gemini_key" || apiKey.length < 10;
}

/** JSON schema for structured Gemini output */
const scaffoldResponseSchema: Schema = {
  type: SchemaType.OBJECT,
  properties: {
    scaffolded_html: {
      type: SchemaType.STRING,
      description:
        "The full scaffolded assignment as clean HTML with inline CSS styles. Wrap in a single <div>.",
    },
    scaffolds_used: {
      type: SchemaType.ARRAY,
      items: { type: SchemaType.STRING },
      description:
        "List of scaffold technique names that were actually applied.",
    },
    word_bank: {
      type: SchemaType.ARRAY,
      items: {
        type: SchemaType.OBJECT,
        properties: {
          term: { type: SchemaType.STRING },
          definition: { type: SchemaType.STRING },
        },
        required: ["term", "definition"],
      },
      description:
        "Key vocabulary terms with simple definitions appropriate for the EL level. 6-12 terms.",
    },
    teacher_instructions: {
      type: SchemaType.STRING,
      description:
        "Brief instructions for the teacher on how to use this scaffolded assignment (2-3 sentences).",
    },
  },
  required: [
    "scaffolded_html",
    "scaffolds_used",
    "word_bank",
    "teacher_instructions",
  ],
};

function getGeminiModel() {
  if (isPlaceholder()) {
    return null;
  }
  const genAI = new GoogleGenerativeAI(apiKey);
  return genAI.getGenerativeModel({
    model: "gemini-2.5-flash",
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: scaffoldResponseSchema,
    },
  });
}

export interface GenerateParams {
  originalContent: string;
  elLevel: ELLevel;
  scaffoldPrompts: string[];
  scaffoldNames: string[];
  title: string;
  subject?: string;
  gradeLevel?: number;
}

export async function generateScaffoldedAssignment(
  params: GenerateParams
): Promise<ScaffoldGenerationResult> {
  const model = getGeminiModel();

  if (!model) {
    return buildMockResult(params);
  }

  const prompt = buildPrompt(params);

  try {
    const result = await model.generateContent(prompt);
    const text = result.response.text();
    const parsed = JSON.parse(text);

    return {
      html: parsed.scaffolded_html,
      wordBank: parsed.word_bank || null,
      scaffoldsUsed: parsed.scaffolds_used || params.scaffoldNames,
      teacherInstructions: parsed.teacher_instructions || null,
      isDemo: false,
    };
  } catch (error) {
    // If JSON parsing fails, try extracting HTML from raw text
    console.error("[Gemini] Structured output parsing failed, falling back:", error);

    const result = await getGeminiModelFallback()!.generateContent(prompt);
    let html = result.response.text();
    html = html.replace(/^```html?\n?/i, "").replace(/\n?```$/i, "").trim();

    return {
      html,
      wordBank: null,
      scaffoldsUsed: params.scaffoldNames,
      teacherInstructions: null,
      isDemo: false,
    };
  }
}

/** Fallback model without JSON schema constraints */
function getGeminiModelFallback() {
  if (isPlaceholder()) return null;
  const genAI = new GoogleGenerativeAI(apiKey);
  return genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
}

function buildPrompt(params: GenerateParams): string {
  const {
    originalContent,
    elLevel,
    scaffoldPrompts,
    scaffoldNames,
    title,
    subject,
    gradeLevel,
  } = params;

  const scaffoldInstructions = scaffoldPrompts
    .map((prompt, i) => `${i + 1}. **${scaffoldNames[i]}**: ${prompt}`)
    .join("\n");

  const metaContext = [
    `Assignment title: "${title}"`,
    subject ? `Subject: ${subject}` : null,
    gradeLevel ? `Grade level: ${gradeLevel}` : null,
    `Student EL level: ${elLevel}`,
  ]
    .filter(Boolean)
    .join("\n");

  // Pull CA ELD Framework context for this level
  const eldContext = getELDPromptContext(elLevel);

  return `You are an expert ELD (English Language Development) scaffolding specialist for California middle school teachers, aligned with the 2012 CA ELD Standards and ELA/ELD Framework.

## Context
${metaContext}

## CA ELD Framework Guidance for ${elLevel} Level
${eldContext}

## Instructions
Apply the following scaffold modifications to the assignment below. Follow each scaffold's instructions precisely.

### Scaffolds to Apply:
${scaffoldInstructions}

## Rules for scaffolded_html
- Preserve ALL original assignment content â€” do not remove, summarize, or rewrite the text
- Apply scaffolds by ADDING HTML elements (highlights, section dividers, word banks, sentence frames, etc.) around or alongside the original content
- Use inline CSS styles only (no class names that require external stylesheets)
- Wrap the entire output in a single <div> element
- Make the output clean, readable, and well-structured for printing
- Target the scaffolding complexity for ${elLevel}-level ELL students
- If a scaffold instruction says to add something "before" or "after" content, place it logically relative to the relevant section

## Rules for word_bank
- Select 6-12 academic or challenging vocabulary words from the assignment
- The word_bank field must ALWAYS be in English (terms and definitions), even when a bilingual translation scaffold is applied
- Definitions should be appropriate for the ${elLevel} EL level
- For Emerging: use simple, everyday language definitions
- For Expanding: use clear academic definitions
- For Bridging: focus on nuanced/domain-specific terms

## Rules for teacher_instructions
- Brief (2-3 sentences) guidance on implementing the scaffolded assignment
- Include any verbal or physical scaffolds the teacher should add beyond the written scaffolds

## Original Assignment:
${originalContent}`;
}

function buildMockResult(params: GenerateParams): ScaffoldGenerationResult {
  const { originalContent, elLevel, scaffoldNames, title } = params;

  const scaffoldList = scaffoldNames
    .map((name) => `<li>${name}</li>`)
    .join("\n          ");

  const paragraphs = originalContent
    .split(/\n\n+/)
    .map(
      (p) =>
        `<p style="margin: 0.75rem 0; line-height: 1.7;">${p.trim()}</p>`
    )
    .join("\n      ");

  const html = `<div style="font-family: system-ui, sans-serif; max-width: 800px;">
    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
      <strong style="color: #92400e;">Demo Preview</strong>
      <p style="margin: 0.5rem 0 0 0; color: #78350f; font-size: 0.875rem;">
        This is a demo preview. Connect your Gemini API key in <code>.env.local</code> for real AI scaffolding.
      </p>
    </div>

    <h2 style="margin: 0 0 0.5rem 0; color: #1e40af;">${title}</h2>
    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
      EL Level: <strong>${elLevel}</strong>
    </p>

    <div style="background: #eff6ff; border-left: 4px solid #2563eb; padding: 0.75rem 1rem; margin-bottom: 1.5rem; border-radius: 0 6px 6px 0;">
      <strong style="color: #1e40af; font-size: 0.875rem;">Scaffolds Applied:</strong>
      <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0; font-size: 0.875rem; color: #374151;">
          ${scaffoldList}
      </ul>
    </div>

    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; background: white;">
      ${paragraphs}
    </div>

    <div style="border: 2px solid #2563eb; padding: 1.25rem; margin: 2rem 0; background: #eff6ff; border-radius: 8px;">
      <h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">Word Bank (Demo)</h3>
      <div style="display: grid; gap: 0.5rem;">
        <div><strong style="color: #1e40af;">scaffold:</strong> A support structure to help with learning</div>
        <div><strong style="color: #1e40af;">differentiate:</strong> To make different versions for different needs</div>
        <div><strong style="color: #1e40af;">assignment:</strong> A task or piece of work given to a student</div>
      </div>
    </div>
  </div>`;

  return {
    html,
    wordBank: [
      { term: "scaffold", definition: "A support structure to help with learning" },
      { term: "differentiate", definition: "To make different versions for different needs" },
      { term: "assignment", definition: "A task or piece of work given to a student" },
    ],
    scaffoldsUsed: scaffoldNames,
    teacherInstructions:
      "This is a demo preview. Connect your Gemini API key for real scaffolding with teacher-specific instructions.",
    isDemo: true,
  };
}
import { NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";

/**
 * Reads the Supabase auth session from request cookies and returns
 * the authenticated user (or null).  Re-usable across API routes.
 */
export async function getAuthUser(request: NextRequest) {
  const response = NextResponse.next({ request });
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  return user;
}
import { google } from "googleapis";
import { createClient as createServiceClient } from "@/lib/supabase-server";

const clientId = process.env.GOOGLE_CLIENT_ID ?? "";
const clientSecret = process.env.GOOGLE_CLIENT_SECRET ?? "";
const redirectUri =
  process.env.GOOGLE_REDIRECT_URI ??
  "http://localhost:3000/api/google-auth/callback";

const SCOPES = [
  "https://www.googleapis.com/auth/documents",
  "https://www.googleapis.com/auth/drive.file",
  "https://www.googleapis.com/auth/userinfo.email",
];

export function isGoogleConfigured(): boolean {
  return (
    !!clientId &&
    clientId !== "placeholder_client_id" &&
    clientId.length > 10 &&
    !!clientSecret &&
    clientSecret !== "placeholder_client_secret" &&
    clientSecret.length > 10
  );
}

export function getOAuthClient() {
  return new google.auth.OAuth2(clientId, clientSecret, redirectUri);
}

export function getAuthUrl(): string {
  const client = getOAuthClient();
  return client.generateAuthUrl({
    access_type: "offline",
    scope: SCOPES,
    prompt: "consent select_account",
  });
}

export async function exchangeCodeForTokens(code: string) {
  const client = getOAuthClient();
  const { tokens } = await client.getToken(code);
  return tokens;
}

export async function getAuthenticatedClient(refreshToken: string) {
  const client = getOAuthClient();
  client.setCredentials({ refresh_token: refreshToken });
  // Force a token refresh to ensure we have a valid access token
  await client.getAccessToken();
  return client;
}

export async function getUserEmail(refreshToken: string): Promise<string | null> {
  try {
    const client = await getAuthenticatedClient(refreshToken);
    const oauth2 = google.oauth2({ version: "v2", auth: client });
    const { data } = await oauth2.userinfo.get();
    return data.email ?? null;
  } catch {
    return null;
  }
}

// Cookie name for storing the refresh token
export const GOOGLE_TOKEN_COOKIE = "vams-google-token";

// ---------------------------------------------------------------------------
// Database persistence helpers  (google_tokens table)
// ---------------------------------------------------------------------------

/** Save (or update) the Google refresh token for a user. */
export async function saveGoogleToken(
  userId: string,
  refreshToken: string,
  googleEmail: string | null
) {
  const supabase = createServiceClient();
  const { error } = await supabase.from("google_tokens").upsert(
    {
      user_id: userId,
      refresh_token: refreshToken,
      google_email: googleEmail,
      updated_at: new Date().toISOString(),
    },
    { onConflict: "user_id" }
  );
  if (error) console.error("Failed to save Google token:", error.message);
}

/** Load the stored Google refresh token for a user (returns null if none). */
export async function loadGoogleToken(
  userId: string
): Promise<{ refreshToken: string; googleEmail: string | null } | null> {
  const supabase = createServiceClient();
  const { data, error } = await supabase
    .from("google_tokens")
    .select("refresh_token, google_email")
    .eq("user_id", userId)
    .single();

  if (error || !data) return null;
  return { refreshToken: data.refresh_token, googleEmail: data.google_email };
}

/** Delete the stored Google token when a user disconnects. */
export async function deleteGoogleToken(userId: string) {
  const supabase = createServiceClient();
  const { error } = await supabase
    .from("google_tokens")
    .delete()
    .eq("user_id", userId);
  if (error) console.error("Failed to delete Google token:", error.message);
}
/**
 * HTML-to-Google-Docs converter
 *
 * Parses scaffolded HTML (with inline CSS) into Google Docs API batch-update
 * requests that preserve headings, bold/italic, text colours, background
 * colours, lists, and table-like structures.
 */

// ---------------------------------------------------------------------------
// Types
// ---------------------------------------------------------------------------

interface RGBColor {
  red: number;
  green: number;
  blue: number;
}

interface TextStyle {
  bold?: boolean;
  italic?: boolean;
  underline?: boolean;
  fontSize?: number;
  textColor?: RGBColor;
  backgroundColor?: RGBColor;
}

interface TextRun {
  text: string;
  style: TextStyle;
}

type BlockType =
  | "heading1"
  | "heading2"
  | "heading3"
  | "heading4"
  | "paragraph"
  | "list-bullet"
  | "list-number"
  | "divider";

interface DocumentBlock {
  type: BlockType;
  runs: TextRun[];
  indent?: number;
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
type DocsRequest = Record<string, any>;

export interface ConversionResult {
  /** Full plain-text content that was inserted into the doc. */
  text: string;
  /** Google Docs batchUpdate requests (insertText + all formatting). */
  requests: DocsRequest[];
}

// ---------------------------------------------------------------------------
// CSS / colour helpers
// ---------------------------------------------------------------------------

function parseInlineStyle(styleStr: string): Record<string, string> {
  const styles: Record<string, string> = {};
  if (!styleStr) return styles;
  for (const decl of styleStr.split(";")) {
    const [prop, ...rest] = decl.split(":");
    if (prop && rest.length) {
      styles[prop.trim().toLowerCase()] = rest.join(":").trim();
    }
  }
  return styles;
}

function parseColor(raw: string): RGBColor | null {
  if (!raw) return null;
  const c = raw.trim();

  // #fff / #ffffff / #ffffffaa
  const hex = c.match(/^#([0-9a-f]{3,8})$/i);
  if (hex) {
    let h = hex[1];
    if (h.length === 3) h = h[0] + h[0] + h[1] + h[1] + h[2] + h[2];
    return {
      red: parseInt(h.slice(0, 2), 16) / 255,
      green: parseInt(h.slice(2, 4), 16) / 255,
      blue: parseInt(h.slice(4, 6), 16) / 255,
    };
  }

  // rgb(r,g,b) or rgba(r,g,b,a)
  const rgb = c.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
  if (rgb) {
    return {
      red: +rgb[1] / 255,
      green: +rgb[2] / 255,
      blue: +rgb[3] / 255,
    };
  }

  const named: Record<string, RGBColor> = {
    red: { red: 1, green: 0, blue: 0 },
    blue: { red: 0, green: 0, blue: 1 },
    green: { red: 0, green: 0.502, blue: 0 },
    yellow: { red: 1, green: 1, blue: 0 },
    orange: { red: 1, green: 0.647, blue: 0 },
    purple: { red: 0.502, green: 0, blue: 0.502 },
    white: { red: 1, green: 1, blue: 1 },
    black: { red: 0, green: 0, blue: 0 },
    gray: { red: 0.502, green: 0.502, blue: 0.502 },
    grey: { red: 0.502, green: 0.502, blue: 0.502 },
  };
  return named[c.toLowerCase()] ?? null;
}

function decodeEntities(text: string): string {
  return text
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&#x27;/gi, "'")
    .replace(/&#(\d+);/g, (_, n) => String.fromCharCode(+n))
    .replace(/&#x([0-9a-f]+);/gi, (_, n) => String.fromCharCode(parseInt(n, 16)));
}

// ---------------------------------------------------------------------------
// HTML tokeniser (server-safe, no DOM required)
// ---------------------------------------------------------------------------

type Token =
  | { type: "open"; tag: string; attrs: Record<string, string>; selfClosing: boolean }
  | { type: "close"; tag: string }
  | { type: "text"; content: string };

function tokenizeHtml(html: string): Token[] {
  const tokens: Token[] = [];

  // Strip script / style / comment blocks
  let clean = html.replace(/<(script|style)[^>]*>[\s\S]*?<\/\1>/gi, "");
  clean = clean.replace(/<!--[\s\S]*?-->/g, "");

  const re = /<\/?([a-z][a-z0-9]*)\b([^>]*?)(\/?)\s*>|([^<]+)/gi;
  let m: RegExpExecArray | null;

  while ((m = re.exec(clean)) !== null) {
    if (m[4]) {
      const text = decodeEntities(m[4]);
      if (text) tokens.push({ type: "text", content: text });
    } else if (m[0].startsWith("</")) {
      tokens.push({ type: "close", tag: m[1].toLowerCase() });
    } else {
      const tag = m[1].toLowerCase();
      const selfClosing = !!m[3] || ["br", "hr", "img", "input"].includes(tag);
      const attrs: Record<string, string> = {};
      const attrRe = /([a-z\-]+)\s*=\s*(?:"([^"]*)"|'([^']*)'|(\S+))/gi;
      let am: RegExpExecArray | null;
      while ((am = attrRe.exec(m[2] || "")) !== null) {
        attrs[am[1].toLowerCase()] = am[2] ?? am[3] ?? am[4] ?? "";
      }
      tokens.push({ type: "open", tag, attrs, selfClosing });
    }
  }
  return tokens;
}

// ---------------------------------------------------------------------------
// Tag classification
// ---------------------------------------------------------------------------

const BLOCK_TAGS = new Set([
  "div", "p", "h1", "h2", "h3", "h4", "h5", "h6",
  "li", "ul", "ol", "table", "tr", "td", "th",
  "blockquote", "section", "article", "header", "footer",
  "main", "aside", "nav", "figure", "figcaption", "details", "summary",
]);

const BOLD_TAGS = new Set(["strong", "b"]);
const ITALIC_TAGS = new Set(["em", "i"]);
const UNDERLINE_TAGS = new Set(["u", "ins"]);

const HEADING_MAP: Record<string, BlockType> = {
  h1: "heading1",
  h2: "heading2",
  h3: "heading3",
  h4: "heading4",
  h5: "heading4",
  h6: "heading4",
};

// ---------------------------------------------------------------------------
// Style stack
// ---------------------------------------------------------------------------

interface StyleFrame {
  bold?: boolean;
  italic?: boolean;
  underline?: boolean;
  textColor?: RGBColor;
  backgroundColor?: RGBColor;
  fontSize?: number;
}

function extractStyleFrame(tag: string, attrs: Record<string, string>): StyleFrame {
  const frame: StyleFrame = {};
  const css = parseInlineStyle(attrs.style || "");

  if (BOLD_TAGS.has(tag)) frame.bold = true;
  if (ITALIC_TAGS.has(tag)) frame.italic = true;
  if (UNDERLINE_TAGS.has(tag)) frame.underline = true;

  const fw = css["font-weight"];
  if (fw === "bold" || fw === "700" || fw === "800" || fw === "900") frame.bold = true;
  if (css["font-style"] === "italic") frame.italic = true;
  if (css["text-decoration"]?.includes("underline")) frame.underline = true;

  const colorStr = css["color"];
  if (colorStr) {
    const c = parseColor(colorStr);
    if (c) frame.textColor = c;
  }

  const bg = css["background-color"] || css["background"];
  if (bg && !bg.includes("url(") && !bg.includes("gradient")) {
    const c = parseColor(bg);
    // Skip near-white backgrounds (not useful as highlight)
    if (c && !(c.red > 0.95 && c.green > 0.95 && c.blue > 0.95)) {
      frame.backgroundColor = c;
    }
  }

  const fs = css["font-size"];
  if (fs) {
    const pt = fs.match(/^(\d+(?:\.\d+)?)\s*pt$/i);
    const px = fs.match(/^(\d+(?:\.\d+)?)\s*px$/i);
    const rem = fs.match(/^(\d+(?:\.\d+)?)\s*rem$/i);
    if (pt) frame.fontSize = +pt[1];
    else if (px) frame.fontSize = +px[1] * 0.75;
    else if (rem) frame.fontSize = +rem[1] * 12;
  }

  return frame;
}

function mergeFrames(stack: StyleFrame[]): TextStyle {
  const out: TextStyle = {};
  for (const f of stack) {
    if (f.bold) out.bold = true;
    if (f.italic) out.italic = true;
    if (f.underline) out.underline = true;
    if (f.textColor) out.textColor = f.textColor;
    if (f.backgroundColor) out.backgroundColor = f.backgroundColor;
    if (f.fontSize) out.fontSize = f.fontSize;
  }
  return out;
}

function stylesEqual(a: TextStyle, b: TextStyle): boolean {
  return (
    a.bold === b.bold &&
    a.italic === b.italic &&
    a.underline === b.underline &&
    a.fontSize === b.fontSize &&
    colorsEqual(a.textColor, b.textColor) &&
    colorsEqual(a.backgroundColor, b.backgroundColor)
  );
}

function colorsEqual(a?: RGBColor, b?: RGBColor): boolean {
  if (!a && !b) return true;
  if (!a || !b) return false;
  return (
    Math.abs(a.red - b.red) < 0.01 &&
    Math.abs(a.green - b.green) < 0.01 &&
    Math.abs(a.blue - b.blue) < 0.01
  );
}

// ---------------------------------------------------------------------------
// HTML â†’ DocumentBlock[]
// ---------------------------------------------------------------------------

export function parseHtmlToBlocks(html: string): DocumentBlock[] {
  const tokens = tokenizeHtml(html);
  const blocks: DocumentBlock[] = [];

  const styleStack: StyleFrame[] = [];
  const tagStack: string[] = [];
  let currentBlock: DocumentBlock | null = null;
  let listType: ("ul" | "ol")[] = [];

  function ensureBlock(type?: BlockType): DocumentBlock {
    if (!currentBlock) currentBlock = { type: type ?? "paragraph", runs: [] };
    return currentBlock;
  }

  function flushBlock() {
    if (!currentBlock) return;
    // Trim trailing whitespace from last run
    const last = currentBlock.runs[currentBlock.runs.length - 1];
    if (last) last.text = last.text.replace(/[\n\r\t ]+$/, "");
    // Keep if it has any visible content, or is a divider
    if (
      currentBlock.type === "divider" ||
      currentBlock.runs.some((r) => r.text.trim())
    ) {
      blocks.push(currentBlock);
    }
    currentBlock = null;
  }

  function addText(text: string) {
    if (!text) return;
    const block = ensureBlock();
    const style = mergeFrames(styleStack);
    const prev = block.runs[block.runs.length - 1];
    if (prev && stylesEqual(prev.style, style)) {
      prev.text += text;
    } else {
      block.runs.push({ text, style });
    }
  }

  for (const token of tokens) {
    if (token.type === "text") {
      let text = token.content.replace(/[\s\n\r]+/g, " ");
      if (!currentBlock || currentBlock.runs.length === 0) {
        text = text.replace(/^\s+/, "");
      }
      if (text) addText(text);
      continue;
    }

    if (token.type === "open") {
      const { tag, attrs, selfClosing } = token;

      if (tag === "br") {
        addText("\n");
        continue;
      }
      if (tag === "hr") {
        flushBlock();
        blocks.push({ type: "divider", runs: [] });
        continue;
      }

      if (BLOCK_TAGS.has(tag)) {
        if (tag === "ul" || tag === "ol") {
          flushBlock();
          listType.push(tag);
        } else if (tag === "li") {
          flushBlock();
          const lt = listType[listType.length - 1];
          currentBlock = {
            type: lt === "ol" ? "list-number" : "list-bullet",
            runs: [],
            indent: Math.max(0, listType.length - 1),
          };
        } else if (tag === "td" || tag === "th") {
          if (currentBlock && currentBlock.runs.length > 0) addText("    ");
          if (tag === "th") {
            styleStack.push({ bold: true });
            tagStack.push(tag);
          }
        } else if (tag === "tr") {
          flushBlock();
          currentBlock = { type: "paragraph", runs: [] };
        } else if (tag === "table") {
          flushBlock();
        } else {
          flushBlock();
          currentBlock = { type: HEADING_MAP[tag] ?? "paragraph", runs: [] };
        }
      }

      if (!selfClosing) {
        const frame = extractStyleFrame(tag, attrs);
        styleStack.push(frame);
        tagStack.push(tag);
      }
      continue;
    }

    // token.type === "close"
    const { tag } = token;

    const idx = tagStack.lastIndexOf(tag);
    if (idx !== -1) {
      tagStack.splice(idx, 1);
      styleStack.splice(idx, 1);
    }

    if (tag === "ul" || tag === "ol") {
      flushBlock();
      listType.pop();
    } else if (
      tag === "li" ||
      tag === "tr" ||
      tag === "p" ||
      tag === "div" ||
      tag === "blockquote" ||
      tag === "section" ||
      tag === "article" ||
      HEADING_MAP[tag]
    ) {
      flushBlock();
    }
  }

  flushBlock();
  return blocks;
}

// ---------------------------------------------------------------------------
// DocumentBlock[] â†’ Google Docs API requests
// ---------------------------------------------------------------------------

export function blocksToDocsRequests(
  blocks: DocumentBlock[],
  startIndex: number,
): ConversionResult {
  const requests: DocsRequest[] = [];

  interface FmtRange {
    start: number;
    end: number;
    style: TextStyle;
  }
  interface ParaInfo {
    start: number;
    end: number;
    type: BlockType;
    indent?: number;
  }

  const fmtRanges: FmtRange[] = [];
  const paraInfos: ParaInfo[] = [];
  let fullText = "";

  for (const block of blocks) {
    if (block.type === "divider") {
      const line = "\u2501".repeat(40) + "\n";
      const s = fullText.length;
      fullText += line;
      fmtRanges.push({
        start: s,
        end: s + line.length - 1,
        style: { textColor: { red: 0.75, green: 0.75, blue: 0.75 }, fontSize: 8 },
      });
      continue;
    }

    const blockStart = fullText.length;

    for (const run of block.runs) {
      const rs = fullText.length;
      fullText += run.text;
      const re = fullText.length;
      const hasStyle =
        run.style.bold ||
        run.style.italic ||
        run.style.underline ||
        run.style.fontSize ||
        run.style.textColor ||
        run.style.backgroundColor;
      if (hasStyle && re > rs) {
        fmtRanges.push({ start: rs, end: re, style: run.style });
      }
    }

    fullText += "\n";
    paraInfos.push({
      start: blockStart,
      end: fullText.length,
      type: block.type,
      indent: block.indent,
    });
  }

  // --- 1. Insert text ---
  if (fullText) {
    requests.push({
      insertText: {
        location: { index: startIndex },
        text: fullText,
      },
    });
  }

  // --- 2. Paragraph styles (headings, bullets) ---
  const headingStyleMap: Record<string, string> = {
    heading1: "HEADING_1",
    heading2: "HEADING_2",
    heading3: "HEADING_3",
    heading4: "HEADING_4",
  };

  for (const p of paraInfos) {
    const absS = startIndex + p.start;
    const absE = startIndex + p.end;

    const ns = headingStyleMap[p.type];
    if (ns) {
      requests.push({
        updateParagraphStyle: {
          range: { startIndex: absS, endIndex: absE },
          paragraphStyle: { namedStyleType: ns },
          fields: "namedStyleType",
        },
      });
    }

    if (p.type === "list-bullet") {
      requests.push({
        createParagraphBullets: {
          range: { startIndex: absS, endIndex: absE },
          bulletPreset: "BULLET_DISC_CIRCLE_SQUARE",
        },
      });
    } else if (p.type === "list-number") {
      requests.push({
        createParagraphBullets: {
          range: { startIndex: absS, endIndex: absE },
          bulletPreset: "NUMBERED_DECIMAL_ALPHA_ROMAN",
        },
      });
    }

    if (p.indent && p.indent > 0) {
      requests.push({
        updateParagraphStyle: {
          range: { startIndex: absS, endIndex: absE },
          paragraphStyle: {
            indentStart: { magnitude: p.indent * 36, unit: "PT" },
          },
          fields: "indentStart",
        },
      });
    }
  }

  // --- 3. Text styles ---
  for (const r of fmtRanges) {
    const absS = startIndex + r.start;
    const absE = startIndex + r.end;
    if (absE <= absS) continue;

    const ts: Record<string, unknown> = {};
    const fields: string[] = [];

    if (r.style.bold) {
      ts.bold = true;
      fields.push("bold");
    }
    if (r.style.italic) {
      ts.italic = true;
      fields.push("italic");
    }
    if (r.style.underline) {
      ts.underline = true;
      fields.push("underline");
    }
    if (r.style.fontSize) {
      ts.fontSize = { magnitude: r.style.fontSize, unit: "PT" };
      fields.push("fontSize");
    }
    if (r.style.textColor) {
      ts.foregroundColor = { color: { rgbColor: r.style.textColor } };
      fields.push("foregroundColor");
    }
    if (r.style.backgroundColor) {
      ts.backgroundColor = { color: { rgbColor: r.style.backgroundColor } };
      fields.push("backgroundColor");
    }

    if (fields.length) {
      requests.push({
        updateTextStyle: {
          range: { startIndex: absS, endIndex: absE },
          textStyle: ts,
          fields: fields.join(","),
        },
      });
    }
  }

  return { text: fullText, requests };
}

// ---------------------------------------------------------------------------
// Section builders (word bank, teacher instructions)
// ---------------------------------------------------------------------------

const BRAND_BLUE: RGBColor = { red: 0.118, green: 0.251, blue: 0.686 };
const SUBTLE_GRAY: RGBColor = { red: 0.4, green: 0.4, blue: 0.4 };

export function buildWordBankBlocks(
  wordBank: { term: string; definition: string }[],
): DocumentBlock[] {
  const blocks: DocumentBlock[] = [];
  blocks.push({ type: "divider", runs: [] });
  blocks.push({
    type: "heading2",
    runs: [{ text: "Word Bank", style: {} }],
  });

  for (const entry of wordBank) {
    blocks.push({
      type: "paragraph",
      runs: [
        { text: entry.term, style: { bold: true, textColor: BRAND_BLUE } },
        { text: `  \u2014  ${entry.definition}`, style: {} },
      ],
    });
  }

  return blocks;
}

export function buildTeacherInstructionsBlocks(
  instructions: string,
): DocumentBlock[] {
  return [
    { type: "divider", runs: [] },
    { type: "heading2", runs: [{ text: "Teacher Instructions", style: {} }] },
    {
      type: "paragraph",
      runs: [
        {
          text: instructions,
          style: { italic: true, textColor: SUBTLE_GRAY },
        },
      ],
    },
  ];
}

// ---------------------------------------------------------------------------
// High-level: build the full Google Docs document body
// ---------------------------------------------------------------------------

export interface ExportDocumentParams {
  title: string;
  elLevel: string;
  scaffoldsApplied: string[];
  outputHtml: string;
  wordBank?: { term: string; definition: string }[] | null;
  teacherInstructions?: string | null;
}

/**
 * Build all Google Docs batchUpdate requests for a scaffolded assignment.
 * Returns the full list of requests ready to pass to `docs.documents.batchUpdate`.
 */
export function buildDocumentRequests(params: ExportDocumentParams): DocsRequest[] {
  const {
    title,
    elLevel,
    scaffoldsApplied,
    outputHtml,
    wordBank,
    teacherInstructions,
  } = params;

  // -- Header blocks --
  const headerBlocks: DocumentBlock[] = [
    {
      type: "heading1",
      runs: [{ text: title, style: {} }],
    },
    {
      type: "paragraph",
      runs: [
        {
          text: `${elLevel} Level \u2014 Scaffolded Assignment`,
          style: { fontSize: 11, textColor: SUBTLE_GRAY },
        },
      ],
    },
    {
      type: "paragraph",
      runs: [
        {
          text: `Scaffolds Applied: ${scaffoldsApplied.join(", ")}`,
          style: { fontSize: 10, textColor: SUBTLE_GRAY, italic: true },
        },
      ],
    },
    { type: "divider", runs: [] },
  ];

  // -- Content blocks (from scaffolded HTML) --
  const contentBlocks = parseHtmlToBlocks(outputHtml);

  // -- Optional sections --
  // NOTE: Word bank is already embedded in the scaffolded HTML by Gemini,
  // so we only append teacher instructions (which are NOT in the HTML).
  const instructionBlocks = teacherInstructions
    ? buildTeacherInstructionsBlocks(teacherInstructions)
    : [];

  const allBlocks = [
    ...headerBlocks,
    ...contentBlocks,
    ...instructionBlocks,
  ];

  // Convert to Google Docs requests (insert at index 1 = start of doc body)
  const { requests } = blocksToDocsRequests(allBlocks, 1);
  return requests;
}
import type { ELLevel } from "@/types";

const STORAGE_KEY = "vams-scaffold-library";
const MAX_ENTRIES = 50;

export interface LibraryEntry {
  id: string;
  assignmentTitle: string;
  elLevel: ELLevel;
  studentName: string;
  scaffoldsApplied: string[];
  outputHtml: string;
  originalContent: string;
  isDemo: boolean;
  teacherNotes: string;
  createdAt: string;
}

function readStore(): LibraryEntry[] {
  if (typeof window === "undefined") return [];
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    return JSON.parse(raw) as LibraryEntry[];
  } catch {
    return [];
  }
}

function writeStore(entries: LibraryEntry[]): void {
  if (typeof window === "undefined") return;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}

export function saveToLibrary(entry: LibraryEntry): void {
  const entries = readStore();
  entries.unshift(entry);
  // Trim to max entries
  if (entries.length > MAX_ENTRIES) {
    entries.length = MAX_ENTRIES;
  }
  writeStore(entries);
}

export function getLibrary(): LibraryEntry[] {
  return readStore();
}

export function getLibraryEntry(id: string): LibraryEntry | null {
  const entries = readStore();
  return entries.find((e) => e.id === id) ?? null;
}

export function deleteFromLibrary(id: string): void {
  const entries = readStore().filter((e) => e.id !== id);
  writeStore(entries);
}

export function updateTeacherNotes(id: string, notes: string): void {
  const entries = readStore();
  const entry = entries.find((e) => e.id === id);
  if (entry) {
    entry.teacherNotes = notes;
    writeStore(entries);
  }
}
export async function parseWord(buffer: ArrayBuffer): Promise<string> {
  try {
    const mammoth = await import("mammoth");
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    return result.value.trim();
  } catch (error) {
    console.error("Word parse error:", error);
    throw new Error("Failed to parse Word document. Try pasting the text manually.");
  }
}

export async function parsePDFViaAPI(file: File): Promise<string> {
  const formData = new FormData();
  formData.append("file", file);

  const response = await fetch("/api/parse-pdf", {
    method: "POST",
    body: formData,
  });

  if (!response.ok) {
    const data = await response.json().catch(() => ({ error: "Unknown error" }));
    throw new Error(data.error || "Failed to parse PDF.");
  }

  const data = await response.json();
  return data.text;
}

export async function parseFile(file: File): Promise<string> {
  const ext = file.name.split(".").pop()?.toLowerCase();

  switch (ext) {
    case "pdf":
      return parsePDFViaAPI(file);
    case "docx":
    case "doc": {
      const buffer = await file.arrayBuffer();
      return parseWord(buffer);
    }
    case "txt": {
      const text = await file.text();
      return text.trim();
    }
    default:
      throw new Error(`Unsupported file type: .${ext}. Use PDF, Word, or text files.`);
  }
}
/**
 * In-memory rate limiter for Gemini API calls.
 * Protects against overuse on the free tier (10 RPM / 250K TPM / 250 RPD).
 * Resets naturally as timestamps age out of the window.
 */

const requests = new Map<string, number[]>();

const GLOBAL_KEY = "__global__";

/**
 * Check if a user can make another request within the rate limit window.
 * @param userId - Unique identifier for the user
 * @param maxPerMinute - Maximum requests allowed per 60-second window (default: 10)
 * @returns true if the request is allowed, false if rate limited
 */
export function checkRateLimit(userId: string, maxPerMinute = 10): boolean {
  const now = Date.now();
  const windowMs = 60_000;

  // Get existing timestamps, filter to current window
  const userRequests = (requests.get(userId) ?? []).filter(
    (t) => now - t < windowMs
  );

  if (userRequests.length >= maxPerMinute) {
    // Update with cleaned timestamps even on rejection
    requests.set(userId, userRequests);
    return false;
  }

  userRequests.push(now);
  requests.set(userId, userRequests);
  return true;
}

/**
 * Check if the platform-wide RPM limit has been reached.
 * Uses a single global key to track all requests across all users.
 * @param maxPerMinute - Global RPM cap (default: 10, matching Gemini Flash free tier)
 */
export function checkGlobalRateLimit(maxPerMinute = 10): boolean {
  return checkRateLimit(GLOBAL_KEY, maxPerMinute);
}

/**
 * Get remaining requests available for a user in the current window.
 */
export function getRemainingRequests(
  userId: string,
  maxPerMinute = 10
): number {
  const now = Date.now();
  const windowMs = 60_000;
  const userRequests = (requests.get(userId) ?? []).filter(
    (t) => now - t < windowMs
  );
  return Math.max(0, maxPerMinute - userRequests.length);
}
import { createClient } from "@/lib/supabase";

const defaultScaffolds = [
  {
    name: "Color Coding: Main Ideas & Evidence",
    description:
      "Highlights topic sentences in yellow, evidence in green, transitions in blue",
    category: "color_coding",
    el_level_target: ["Emerging", "Expanding", "Bridging"],
    ai_prompt_template:
      'Apply HTML with inline styles: topic sentences get <span style="background-color: #FFF176; padding: 2px 4px; border-radius: 2px;">text</span>, evidence gets <span style="background-color: #AED581; padding: 2px 4px; border-radius: 2px;">text</span>, transition words get <span style="background-color: #90CAF9; padding: 2px 4px; border-radius: 2px;">text</span>. Identify and wrap appropriate text.',
    is_default: true,
  },
  {
    name: "Chunking: Break Into Sections",
    description:
      "Divides text into 3-5 manageable sections with numbered headers",
    category: "chunking",
    el_level_target: ["Emerging", "Expanding"],
    ai_prompt_template:
      'Divide the assignment text into 3-5 logical chunks. Between each chunk, insert: <div class="chunk-header" style="font-weight: 600; margin: 1.5rem 0 0.5rem 0; padding: 0.75rem; background: #e5e7eb; border-left: 4px solid #2563eb; color: #1e40af;">Section X of Y</div>. Choose logical breaking points (after paragraphs, before new concepts).',
    is_default: true,
  },
  {
    name: "Sentence Frames: Opinion Writing",
    description:
      "Provides sentence starters for opinion/argument responses",
    category: "sentence_frames",
    el_level_target: ["Emerging", "Expanding"],
    ai_prompt_template:
      'Before any writing prompt or question, insert: <div class="sentence-frame" style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Sentence Frames:</strong><br/>- I think ___ because ___.<br/>- In my opinion, ___.<br/>- I agree/disagree with ___ because ___.</div>',
    is_default: true,
  },
  {
    name: "Sentence Frames: Summary Writing",
    description: "Provides sentence starters for summarizing text",
    category: "sentence_frames",
    el_level_target: ["Emerging", "Expanding"],
    ai_prompt_template:
      'Before summary prompts, insert: <div class="sentence-frame" style="font-style: italic; color: #6b7280; margin: 1rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af;"><strong>Sentence Frames:</strong><br/>- The main idea is ___.<br/>- First, ___. Then, ___. Finally, ___.<br/>- This text is about ___.</div>',
    is_default: true,
  },
  {
    name: "Word Bank: Academic Vocabulary",
    description:
      "Identifies challenging words and provides simple definitions",
    category: "word_banks",
    el_level_target: ["Emerging", "Expanding", "Bridging"],
    ai_prompt_template:
      'Identify 8-12 academic or challenging vocabulary words in the assignment. At the bottom, create: <div class="word-bank" style="border: 2px solid #2563eb; padding: 1.25rem; margin: 2rem 0; background: #eff6ff; border-radius: 8px;"><h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">Word Bank</h3><div style="display: grid; gap: 0.75rem;"><div><strong style="color: #1e40af;">Word:</strong> Simple definition for middle school ELL student</div></div></div>. Include only words that are challenging for the target EL level.',
    is_default: true,
  },
  {
    name: "Chunking: Paragraph-by-Paragraph",
    description:
      "Breaks long paragraphs into smaller, numbered chunks",
    category: "chunking",
    el_level_target: ["Emerging"],
    ai_prompt_template:
      'For each paragraph longer than 4 sentences, break it into smaller chunks of 2-3 sentences. Add between chunks: <div style="margin: 0.75rem 0; padding: 0.5rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.875rem; font-weight: 500;">Pause here and re-read before continuing.</div>',
    is_default: true,
  },
  {
    name: "Visual Organizer: Venn Diagram Prompt",
    description:
      "Adds a simple text-based Venn diagram template for comparisons",
    category: "visual_organizers",
    el_level_target: ["Emerging", "Expanding"],
    ai_prompt_template:
      'If the assignment asks students to compare two things, insert after the prompt: <div style="border: 2px dashed #6b7280; padding: 1.5rem; margin: 1rem 0; background: #f9fafb;"><strong>Compare & Contrast:</strong><br/><br/><strong>Only in [Item A]:</strong><br/>- _____<br/>- _____<br/><br/><strong>Only in [Item B]:</strong><br/>- _____<br/>- _____<br/><br/><strong>Both have:</strong><br/>- _____<br/>- _____</div>',
    is_default: true,
    comingSoon: true,
  },
  {
    name: "Bilingual Support: Spanish Translation",
    description:
      "Translates assignment content to Spanish while keeping scaffold labels in English",
    category: "bilingual_support",
    el_level_target: ["Emerging", "Expanding", "Bridging"],
    ai_prompt_template:
      "Translate ONLY the student-facing assignment content to Spanish â€” this includes the original assignment text, reading passages, questions, directions for students, and any text the student would read or respond to. DO NOT translate any teacher-facing or scaffold-generated elements. Keep ALL of the following in English: the assignment title, teacher instructions, scaffold labels and headings ('Word Bank', 'Sentence Frames:', 'Section X of Y', 'Pause here and re-read before continuing', 'Compare & Contrast', 'Scaffolds Applied', etc.), section divider text, and Word Bank terms/definitions. Preserve all HTML structure, inline styles, and formatting. Keep proper nouns, names, and numbers unchanged. The translated student content should read naturally in Spanish. If a Word Bank section exists in the HTML, keep the original English word bank intact and add a second word bank directly below it with the heading 'Banco de Palabras' containing the same terms translated to Spanish with Spanish definitions.",
    is_default: true,
  },
];

export async function seedScaffoldTemplates(): Promise<{
  inserted: number;
  skipped: number;
}> {
  const supabase = createClient();

  // Check if scaffolds already exist
  const { count } = await supabase
    .from("scaffold_templates")
    .select("*", { count: "exact", head: true })
    .eq("is_default", true);

  if (count && count > 0) {
    return { inserted: 0, skipped: count };
  }

  const { data, error } = await supabase
    .from("scaffold_templates")
    .insert(defaultScaffolds)
    .select();

  if (error) throw error;

  return { inserted: data?.length ?? 0, skipped: 0 };
}

export { defaultScaffolds };
import { createClient } from "@/lib/supabase-server";
import type { ELLevel } from "@/types";

function overallToELLevel(level: number): ELLevel {
  if (level === 1) return "Emerging";
  if (level <= 3) return "Expanding";
  return "Bridging";
}

interface StudentSeed {
  ssid: string;
  first_name: string;
  last_name: string;
  homeroom: string;
  overall: number;
  oral: number;
  written: number;
}

// 5th Grade â€” 32 students
const grade5: StudentSeed[] = [
  { ssid: "7726495983", first_name: "Jacob", last_name: "Amezcua", homeroom: "USC", overall: 3, oral: 2, written: 2 },
  { ssid: "3934420229", first_name: "Destiny", last_name: "Arana Vazquez", homeroom: "UCLA", overall: 3, oral: 2, written: 2 },
  { ssid: "7069462874", first_name: "David", last_name: "Barco", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
  { ssid: "6294172285", first_name: "Jaime", last_name: "Cano Silva", homeroom: "UCLA", overall: 3, oral: 3, written: 2 },
  { ssid: "2074202807", first_name: "Alexis", last_name: "Cerna Velasquez", homeroom: "UCLA", overall: 2, oral: 2, written: 2 },
  { ssid: "3273149294", first_name: "Mia", last_name: "De La Cruz", homeroom: "CSUN", overall: 3, oral: 2, written: 2 },
  { ssid: "9919493998", first_name: "Bryana", last_name: "Del Cid", homeroom: "LMU", overall: 3, oral: 2, written: 1 },
  { ssid: "3197699234", first_name: "Oscar", last_name: "Duque Gonzalez", homeroom: "USC", overall: 2, oral: 2, written: 2 },
  { ssid: "3492307743", first_name: "Aubrey", last_name: "Escobedo Estrada", homeroom: "CSUN", overall: 3, oral: 2, written: 2 },
  { ssid: "7093566077", first_name: "Fernanda", last_name: "Fuentes", homeroom: "CSUN", overall: 3, oral: 2, written: 2 },
  { ssid: "2185913261", first_name: "Sofia", last_name: "Fuentes Martinez", homeroom: "LMU", overall: 2, oral: 2, written: 1 },
  { ssid: "9051329395", first_name: "Sarah", last_name: "Guevara Flores", homeroom: "USC", overall: 2, oral: 2, written: 1 },
  { ssid: "2536649076", first_name: "Adriana", last_name: "Hernandez", homeroom: "USC", overall: 2, oral: 2, written: 1 },
  { ssid: "7076749037", first_name: "Gael", last_name: "Hernandez Chavez", homeroom: "CSUN", overall: 2, oral: 2, written: 1 },
  { ssid: "8722926325", first_name: "Ayleen", last_name: "Huerta Hernandez", homeroom: "UCLA", overall: 2, oral: 3, written: 2 },
  { ssid: "4713951453", first_name: "Robert", last_name: "Jimenez", homeroom: "LMU", overall: 1, oral: 1, written: 1 },
  { ssid: "7431813123", first_name: "Ariana", last_name: "Jimenez", homeroom: "USC", overall: 1, oral: 2, written: 1 },
  { ssid: "8497622801", first_name: "Mariana Sofia", last_name: "Leal Hernandez", homeroom: "LMU", overall: 1, oral: 1, written: 1 },
  { ssid: "8787288262", first_name: "Diego", last_name: "Martinez", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
  { ssid: "7634928982", first_name: "Nicolle", last_name: "Mejia", homeroom: "USC", overall: 3, oral: 3, written: 2 },
  { ssid: "4582894274", first_name: "Stephanie", last_name: "Melendez", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "3345067732", first_name: "Pablo", last_name: "Morales", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
  { ssid: "7425244225", first_name: "Bella", last_name: "Pacheco", homeroom: "UCLA", overall: 3, oral: 3, written: 2 },
  { ssid: "7431251264", first_name: "Victor", last_name: "Prudencio", homeroom: "CSUN", overall: 2, oral: 2, written: 2 },
  { ssid: "2552928478", first_name: "Dylan", last_name: "Ramirez Martinez", homeroom: "USC", overall: 4, oral: 3, written: 2 },
  { ssid: "5963573744", first_name: "Alexander", last_name: "Reyes Luna", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "5911884540", first_name: "Neymar", last_name: "Sacayon Gonzalez", homeroom: "USC", overall: 3, oral: 3, written: 1 },
  { ssid: "6846608430", first_name: "Cristina", last_name: "Segovia", homeroom: "LMU", overall: 1, oral: 2, written: 2 },
  { ssid: "3234782406", first_name: "Sofia", last_name: "Valles Jaco", homeroom: "LMU", overall: 1, oral: 1, written: 1 },
  { ssid: "4547883745", first_name: "Nicole", last_name: "Vasquez", homeroom: "UCLA", overall: 3, oral: 3, written: 2 },
  { ssid: "1787343401", first_name: "Jacob", last_name: "Villalobos", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
];

// 6th Grade â€” 28 students
const grade6: StudentSeed[] = [
  { ssid: "1249979449", first_name: "Caleb", last_name: "Aguilar Chavez", homeroom: "CSUN", overall: 3, oral: 4, written: 2 },
  { ssid: "3679284778", first_name: "Melvin", last_name: "Aguilar Chavez", homeroom: "LMU", overall: 4, oral: 4, written: 3 },
  { ssid: "2323319883", first_name: "Leonardo", last_name: "Alvarez", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "6052440521", first_name: "Allyson", last_name: "Arzeta-Sotelo", homeroom: "CSUN", overall: 4, oral: 4, written: 3 },
  { ssid: "6632210362", first_name: "Jocelyn", last_name: "Ayala Pulido", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "7127783965", first_name: "Victor", last_name: "Bautista", homeroom: "CSUN", overall: 4, oral: 4, written: 3 },
  { ssid: "1095350174", first_name: "Mateo", last_name: "Carballo", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "1136498005", first_name: "Elijah", last_name: "Cervantes Tellez", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "9612585538", first_name: "Pedro", last_name: "Cifuentes Miranda", homeroom: "USC", overall: 2, oral: 3, written: 2 },
  { ssid: "9036841285", first_name: "Nathalie", last_name: "Cruz", homeroom: "UCLA", overall: 3, oral: 4, written: 2 },
  { ssid: "4392299441", first_name: "Livana", last_name: "Cruz Sandoval", homeroom: "UCLA", overall: 1, oral: 2, written: 1 },
  { ssid: "5013003374", first_name: "Cristina", last_name: "De La Torre Garcia", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "8198384940", first_name: "Isaias", last_name: "Gomez", homeroom: "CSUN", overall: 4, oral: 4, written: 2 },
  { ssid: "7577282880", first_name: "Sergio", last_name: "Gonzalez De La Cruz", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "5978094974", first_name: "Clesmin", last_name: "Gonzalez Villatoro", homeroom: "UCLA", overall: 1, oral: 1, written: 1 },
  { ssid: "4163953138", first_name: "Harold", last_name: "Hernandez", homeroom: "LMU", overall: 4, oral: 4, written: 3 },
  { ssid: "9761859246", first_name: "Yeshaya", last_name: "Martinez Amaya", homeroom: "UCLA", overall: 2, oral: 4, written: 1 },
  { ssid: "5406960587", first_name: "Genesis", last_name: "Martinez Enriquez", homeroom: "UCLA", overall: 2, oral: 3, written: 1 },
  { ssid: "7676632056", first_name: "John", last_name: "Molina Perez", homeroom: "LMU", overall: 4, oral: 4, written: 4 },
  { ssid: "7736305882", first_name: "Kimberly", last_name: "Ordonez Hernandez", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "8075985118", first_name: "Elizabeth", last_name: "Ramirez", homeroom: "CSUN", overall: 4, oral: 4, written: 3 },
  { ssid: "4807640790", first_name: "Melanie", last_name: "Rivera Godines", homeroom: "LMU", overall: 2, oral: 3, written: 2 },
  { ssid: "3757008205", first_name: "Logan", last_name: "Rodriguez Ponciano", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
  { ssid: "7009683028", first_name: "Shadani", last_name: "Sandoval Reyes", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "2967720805", first_name: "Jeffrey", last_name: "Soc Duarte", homeroom: "USC", overall: 3, oral: 3, written: 3 },
  { ssid: "3811658556", first_name: "Martin", last_name: "Suarez Angulo", homeroom: "CSUN", overall: 2, oral: 3, written: 2 },
  { ssid: "2235872610", first_name: "Gilmer", last_name: "Zabala Ramos", homeroom: "USC", overall: 2, oral: 3, written: 1 },
  { ssid: "2563756547", first_name: "Jason", last_name: "Zepeda", homeroom: "USC", overall: 3, oral: 3, written: 2 },
];

// 7th Grade â€” 26 students
const grade7: StudentSeed[] = [
  { ssid: "8194424455", first_name: "Ana", last_name: "Alvarado De Rosas", homeroom: "LMU", overall: 2, oral: 3, written: 1 },
  { ssid: "5907682978", first_name: "Jacob", last_name: "Armas-Sanchez", homeroom: "UCLA", overall: 3, oral: 4, written: 3 },
  { ssid: "4294421245", first_name: "Isaac", last_name: "Arroyo", homeroom: "UCLA", overall: 3, oral: 4, written: 2 },
  { ssid: "6672097890", first_name: "Nathanael", last_name: "Baez", homeroom: "CSUN", overall: 2, oral: 2, written: 2 },
  { ssid: "1771360288", first_name: "Belen", last_name: "Barbosa", homeroom: "UCLA", overall: 3, oral: 4, written: 2 },
  { ssid: "1270083047", first_name: "Steven", last_name: "Campos Vasquez", homeroom: "CSUN", overall: 2, oral: 3, written: 2 },
  { ssid: "1332748440", first_name: "Jose", last_name: "Carrillo", homeroom: "USC", overall: 4, oral: 3, written: 4 },
  { ssid: "5204173004", first_name: "Liliana", last_name: "Casiano Lopez", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "2970858598", first_name: "Eric", last_name: "Clemente", homeroom: "UCLA", overall: 3, oral: 4, written: 2 },
  { ssid: "5187430889", first_name: "Cristy", last_name: "Gallegos Nieto", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "3244119243", first_name: "Matthew", last_name: "Garcia", homeroom: "LMU", overall: 2, oral: 3, written: 2 },
  { ssid: "7540122418", first_name: "Jose", last_name: "Gerardo Martinez", homeroom: "USC", overall: 1, oral: 3, written: 1 },
  { ssid: "5532005463", first_name: "Ariana", last_name: "Guerrero Murcia", homeroom: "UCLA", overall: 3, oral: 3, written: 2 },
  { ssid: "4370317626", first_name: "Neymar", last_name: "Gutierrez-Garcia", homeroom: "USC", overall: 2, oral: 3, written: 1 },
  { ssid: "8631256173", first_name: "Jesus", last_name: "Martinez Gomez", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "4345510410", first_name: "Michael", last_name: "Martinez-Rojas", homeroom: "CSUN", overall: 2, oral: 3, written: 1 },
  { ssid: "6290340535", first_name: "Jacob", last_name: "Mejia", homeroom: "LMU", overall: 3, oral: 4, written: 2 },
  { ssid: "5952443837", first_name: "Larissa", last_name: "Morales", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "2655671591", first_name: "Andrea", last_name: "Padilla", homeroom: "CSUN", overall: 3, oral: 4, written: 1 },
  { ssid: "3210835173", first_name: "Abdel", last_name: "Palma Mendoza", homeroom: "LMU", overall: 2, oral: 3, written: 2 },
  { ssid: "1335168347", first_name: "Kevin", last_name: "Prudencio", homeroom: "CSUN", overall: 3, oral: 4, written: 2 },
  { ssid: "5972565420", first_name: "Mathew", last_name: "Rivera", homeroom: "CSUN", overall: 3, oral: 4, written: 1 },
  { ssid: "3600165418", first_name: "Samantha", last_name: "Rodriguez", homeroom: "LMU", overall: 2, oral: 3, written: 2 },
  { ssid: "9537905564", first_name: "Gerson", last_name: "Sensente Manchan", homeroom: "USC", overall: 1, oral: 1, written: 1 },
  { ssid: "1627050396", first_name: "Kevin", last_name: "Zamora Machado", homeroom: "LMU", overall: 3, oral: 4, written: 3 },
];

// 8th Grade â€” 28 students
const grade8: StudentSeed[] = [
  { ssid: "3623626315", first_name: "David", last_name: "Alejandro", homeroom: "LMU", overall: 2, oral: 3, written: 2 },
  { ssid: "1097486550", first_name: "Alexis", last_name: "Barrios", homeroom: "USC", overall: 3, oral: 3, written: 2 },
  { ssid: "7055622134", first_name: "Axel", last_name: "Bracamontes", homeroom: "LMU", overall: 3, oral: 3, written: 3 },
  { ssid: "9402719894", first_name: "Lizbeth", last_name: "Cerda Alejo", homeroom: "UCLA", overall: 2, oral: 3, written: 2 },
  { ssid: "6731748742", first_name: "Ashley", last_name: "Gonzalez Arellano", homeroom: "UCLA", overall: 3, oral: 4, written: 2 },
  { ssid: "4681908988", first_name: "Erick", last_name: "Gonzalez Garcia", homeroom: "LMU", overall: 2, oral: 1, written: 1 },
  { ssid: "5661994656", first_name: "Sophie", last_name: "Guardado", homeroom: "CSUN", overall: 3, oral: 4, written: 2 },
  { ssid: "5125568692", first_name: "Andrea", last_name: "Gutierrez", homeroom: "CSUN", overall: 3, oral: 4, written: 3 },
  { ssid: "2247007724", first_name: "Emmalee", last_name: "Gutierrez", homeroom: "USC", overall: 2, oral: 3, written: 2 },
  { ssid: "5691914065", first_name: "Alexander", last_name: "Lopez", homeroom: "USC", overall: 3, oral: 4, written: 2 },
  { ssid: "9106674513", first_name: "Melanie", last_name: "Rivas Tecun", homeroom: "UCLA", overall: 3, oral: 3, written: 2 },
  { ssid: "2071829507", first_name: "Mariela", last_name: "Mendez Cid", homeroom: "LMU", overall: 4, oral: 4, written: 2 },
  { ssid: "8441226595", first_name: "Jaimy", last_name: "Palacios Monge", homeroom: "CSUN", overall: 3, oral: 3, written: 3 },
  { ssid: "3731567411", first_name: "Coraline", last_name: "Pineda", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "5588345643", first_name: "Jonathan", last_name: "Pineda Hernandez", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "8460953155", first_name: "Jessica", last_name: "Ramos", homeroom: "UCLA", overall: 2, oral: 2, written: 2 },
  { ssid: "2385987491", first_name: "Gabriel", last_name: "Romero", homeroom: "USC", overall: 3, oral: 3, written: 3 },
  { ssid: "4329473602", first_name: "Karla", last_name: "Sandoval", homeroom: "CSUN", overall: 3, oral: 3, written: 2 },
  { ssid: "6474241225", first_name: "Chelsea", last_name: "Santos Ruiz", homeroom: "USC", overall: 2, oral: 1, written: 1 },
  { ssid: "4112459627", first_name: "Daniel", last_name: "Soriano", homeroom: "LMU", overall: 3, oral: 3, written: 2 },
  { ssid: "4308451356", first_name: "Haily", last_name: "Sotarriba", homeroom: "USC", overall: 2, oral: 3, written: 2 },
  { ssid: "7932543581", first_name: "Miguel", last_name: "Trinidad", homeroom: "LMU", overall: 1, oral: 2, written: 2 },
  { ssid: "7928847450", first_name: "Rigo", last_name: "Vasquez Ambriz", homeroom: "UCLA", overall: 3, oral: 3, written: 4 },
  { ssid: "2281077437", first_name: "Angel", last_name: "Villatoro", homeroom: "UCLA", overall: 3, oral: 4, written: 3 },
];

function buildStudentRows(students: StudentSeed[], grade: number, createdBy: string) {
  return students.map((s) => ({
    ssid: s.ssid,
    name: `${s.first_name} ${s.last_name}`,
    grade,
    homeroom: s.homeroom,
    el_level: overallToELLevel(s.overall),
    overall_level: s.overall,
    oral_language_level: s.oral,
    written_language_level: s.written,
    primary_language: "Spanish",
    custom_scaffolds: [],
    created_by: createdBy,
  }));
}

export async function seedStudents(createdBy: string = "system@brightstarschools.org") {
  const supabase = createClient();

  // Check if students already exist
  const { count } = await supabase
    .from("students")
    .select("*", { count: "exact", head: true });

  if (count && count > 0) {
    return {
      seeded: false,
      message: `Students table already has ${count} records. Skipping seed to avoid duplicates.`,
      count,
    };
  }

  const allStudents = [
    ...buildStudentRows(grade5, 5, createdBy),
    ...buildStudentRows(grade6, 6, createdBy),
    ...buildStudentRows(grade7, 7, createdBy),
    ...buildStudentRows(grade8, 8, createdBy),
  ];

  const { data, error } = await supabase
    .from("students")
    .insert(allStudents)
    .select();

  if (error) {
    throw new Error(`Failed to seed students: ${error.message}`);
  }

  return {
    seeded: true,
    message: `Successfully seeded ${data.length} students`,
    count: data.length,
    breakdown: {
      grade5: grade5.length,
      grade6: grade6.length,
      grade7: grade7.length,
      grade8: grade8.length,
    },
  };
}
import { createBrowserClient } from "@supabase/ssr";

// Client-side Supabase client (used in "use client" components).
// Uses cookies to persist the auth session across page loads.
// Falls back to placeholder values during build/prerender when env vars are missing.
export function createClient() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || "https://placeholder.supabase.co";
  const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || "placeholder_anon_key";

  return createBrowserClient(url, key);
}
import { createServerClient } from "@supabase/ssr";
import { NextRequest, NextResponse } from "next/server";

// Creates a Supabase client for use in Next.js middleware.
// Handles reading/writing auth cookies on the request/response.
export function createClient(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request });

  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || "https://placeholder.supabase.co";
  const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || "placeholder_anon_key";

  const supabase = createServerClient(
    url,
    key,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          supabaseResponse = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  return { supabase, response: supabaseResponse };
}
import { createClient as createSupabaseClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

export function createClient() {
  if (!supabaseUrl || supabaseUrl === "https://placeholder.supabase.co") {
    console.warn(
      "[Supabase Server] Using placeholder credentials. Database operations will not work."
    );
  }

  return createSupabaseClient(supabaseUrl, supabaseServiceKey, {
    auth: {
      persistSession: false,
    },
  });
}
import { createClient as createSupabaseClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export function createClient() {
  if (!supabaseUrl || supabaseUrl === "https://placeholder.supabase.co") {
    console.warn(
      "[Supabase] Using placeholder credentials. Database operations will not work."
    );
  }
  return createSupabaseClient(supabaseUrl, supabaseAnonKey);
}
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

export function formatDate(date: string | Date): string {
  return new Intl.DateTimeFormat("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  }).format(new Date(date));
}

export function formatRelativeDate(date: string | Date): string {
  const now = new Date();
  const target = new Date(date);
  const diffMs = now.getTime() - target.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return "just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return formatDate(date);
}
import { z } from "zod";

export const elLevelSchema = z.enum(["Emerging", "Expanding", "Bridging"]);

export const studentSchema = z.object({
  ssid: z.string().min(1, "SSID is required").max(20).optional(),
  name: z.string().min(2, "Name must be at least 2 characters").max(100),
  grade: z.number().int().min(5, "Grade must be 5-8").max(8, "Grade must be 5-8"),
  homeroom: z.string().max(50).optional(),
  el_level: elLevelSchema,
  overall_level: z.number().int().min(1).max(4).optional(),
  oral_language_level: z.number().int().min(1).max(4).optional(),
  written_language_level: z.number().int().min(1).max(4).optional(),
  primary_language: z.string().min(2, "Language is required").max(50),
  notes: z.string().optional(),
});

export const assignmentDetailsSchema = z.object({
  title: z.string().min(3, "Title must be at least 3 characters").max(200),
  subject: z.string().optional(),
  grade_level: z.number().int().min(5).max(8).optional(),
});

export const assignmentContentSchema = z.object({
  content: z.string().min(50, "Assignment must be at least 50 characters").max(50000),
  source_type: z.enum(["text", "upload", "google_doc", "google_slides"]),
});

/** Validates the POST /api/scaffold request body */
export const scaffoldRequestSchema = z.object({
  content: z.string().min(50, "Assignment must be at least 50 characters").max(50000),
  title: z.string().min(3).max(200),
  subject: z.string().optional(),
  gradeLevel: z.number().int().min(5).max(8).optional(),
  elLevel: elLevelSchema,
  // Scaffold names instead of fragile array indices
  scaffoldNames: z
    .array(z.string().min(1))
    .min(1, "At least one scaffold must be selected"),
  // Optional: link to specific student or assignment
  studentId: z.string().uuid().optional(),
  studentIds: z.array(z.string().uuid()).optional(),
  assignmentId: z.string().optional(),
  studentName: z.string().max(200).optional(),
});

export type StudentFormValues = z.infer<typeof studentSchema>;
export type AssignmentDetailsFormValues = z.infer<typeof assignmentDetailsSchema>;
export type AssignmentContentFormValues = z.infer<typeof assignmentContentSchema>;
export type ScaffoldRequestValues = z.infer<typeof scaffoldRequestSchema>;
"use client";

import { useState, useEffect } from "react";

export function useIsAdmin() {
  const [isAdmin, setIsAdmin] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetch("/api/auth/role")
      .then((res) => res.json())
      .then((data: { role: string }) => {
        setIsAdmin(data.role === "admin");
      })
      .catch(() => {
        setIsAdmin(false);
      })
      .finally(() => {
        setIsLoading(false);
      });
  }, []);

  return { isAdmin, isLoading };
}
"use client";

import { useState, useCallback } from "react";

export type AssignmentStep = 1 | 2 | 3;
export type SourceType = "text" | "upload" | "google_doc";

interface AssignmentFormState {
  // Step 1: Content
  content: string;
  sourceType: SourceType;
  fileName?: string;

  // Step 2: Details
  title: string;
  subject: string;
  gradeLevel: number | undefined;

  // Step 3: Selection (Phase 4)
  assignmentId?: string;
  selectedStudentId?: string;
  selectedScaffoldIds: string[];

  // UI state
  currentStep: AssignmentStep;
  isGenerating: boolean;
}

const initialState: AssignmentFormState = {
  content: "",
  sourceType: "text",
  fileName: undefined,
  title: "",
  subject: "",
  gradeLevel: undefined,
  assignmentId: undefined,
  selectedStudentId: undefined,
  selectedScaffoldIds: [],
  currentStep: 1,
  isGenerating: false,
};

export function useAssignmentForm() {
  const [state, setState] = useState<AssignmentFormState>(initialState);

  const updateContent = useCallback((content: string, sourceType: SourceType, fileName?: string) => {
    setState((prev) => ({ ...prev, content, sourceType, fileName }));
  }, []);

  const updateDetails = useCallback((details: { title: string; subject: string; gradeLevel?: number }) => {
    setState((prev) => ({
      ...prev,
      title: details.title,
      subject: details.subject,
      gradeLevel: details.gradeLevel,
    }));
  }, []);

  const setAssignmentId = useCallback((id: string) => {
    setState((prev) => ({ ...prev, assignmentId: id }));
  }, []);

  const nextStep = useCallback(() => {
    setState((prev) => ({
      ...prev,
      currentStep: Math.min(prev.currentStep + 1, 3) as AssignmentStep,
    }));
  }, []);

  const prevStep = useCallback(() => {
    setState((prev) => ({
      ...prev,
      currentStep: Math.max(prev.currentStep - 1, 1) as AssignmentStep,
    }));
  }, []);

  const goToStep = useCallback((step: AssignmentStep) => {
    setState((prev) => ({ ...prev, currentStep: step }));
  }, []);

  const resetForm = useCallback(() => {
    setState(initialState);
  }, []);

  const canProceedToStep2 = state.content.length >= 50;
  const canProceedToStep3 = state.title.length >= 3;

  return {
    ...state,
    updateContent,
    updateDetails,
    setAssignmentId,
    nextStep,
    prevStep,
    goToStep,
    resetForm,
    canProceedToStep2,
    canProceedToStep3,
  };
}
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";

interface GoogleStatus {
  configured: boolean;
  connected: boolean;
  email: string | null;
}

interface ExportParams {
  title: string;
  outputHtml: string;
  elLevel: string;
  scaffoldsApplied: string[];
  wordBank?: { term: string; definition: string }[] | null;
  teacherInstructions?: string | null;
}

export function useGoogleDocsExport() {
  const [status, setStatus] = useState<GoogleStatus>({
    configured: false,
    connected: false,
    email: null,
  });
  const [isChecking, setIsChecking] = useState(true);
  const [isExporting, setIsExporting] = useState(false);

  useEffect(() => {
    async function check() {
      try {
        const res = await fetch("/api/google-auth/status");
        const data = await res.json();
        setStatus(data);
      } catch {
        // Leave as disconnected
      } finally {
        setIsChecking(false);
      }
    }
    check();
  }, []);

  const exportToGoogleDocs = useCallback(
    async (params: ExportParams): Promise<string | null> => {
      if (!status.connected) {
        toast.error("Connect your Google account in Settings first.");
        return null;
      }

      setIsExporting(true);
      try {
        const res = await fetch("/api/google-docs/export", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(params),
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message || data.error || "Export failed");
        }

        toast.success("Exported to Google Docs!", {
          action: {
            label: "Open",
            onClick: () => window.open(data.docUrl, "_blank"),
          },
        });

        return data.docUrl;
      } catch (error) {
        const message =
          error instanceof Error ? error.message : "Export failed";
        toast.error(message);
        return null;
      } finally {
        setIsExporting(false);
      }
    },
    [status.connected]
  );

  return {
    isGoogleConnected: status.connected,
    isGoogleConfigured: status.configured,
    isChecking,
    isExporting,
    googleEmail: status.email,
    exportToGoogleDocs,
  };
}
"use client";

import { useState, useEffect, useCallback } from "react";
import { usePathname } from "next/navigation";

interface UsageData {
  used: number;
  limit: number;
  globalUsed: number;
  globalLimit: number;
}

const DEFAULT_USAGE: UsageData = { used: 0, limit: 10, globalUsed: 0, globalLimit: 250 };

/**
 * Fetches current AI usage from /api/usage.
 * Refreshes on route changes and polls every 60 seconds.
 * Listens for "usage-updated" custom events for immediate updates.
 * Exposes a manual refresh function.
 */
export function useUsage() {
  const [usage, setUsage] = useState<UsageData>(DEFAULT_USAGE);
  const pathname = usePathname();

  const refresh = useCallback(async () => {
    try {
      const res = await fetch("/api/usage");
      if (res.ok) {
        setUsage(await res.json());
      }
    } catch {
      // Silently ignore â€” keep previous state
    }
  }, []);

  // Refresh on mount, on route change, and poll every 60s
  useEffect(() => {
    refresh();
    const id = setInterval(refresh, 60_000);
    return () => clearInterval(id);
  }, [refresh, pathname]);

  // Listen for immediate usage updates dispatched after scaffold generation
  useEffect(() => {
    function handleUsageUpdate(e: Event) {
      const detail = (e as CustomEvent).detail;
      if (typeof detail?.used === "number") {
        setUsage((prev) => ({ ...prev, used: detail.used }));
      }
    }
    window.addEventListener("usage-updated", handleUsageUpdate);
    return () => window.removeEventListener("usage-updated", handleUsageUpdate);
  }, []);

  return { ...usage, refresh };
}
"use client";

import { useState, useEffect, useCallback } from "react";

interface UserProfile {
  firstName: string;
  lastName: string;
}

const STORAGE_KEY = "vams-user-profile";
const EMPTY: UserProfile = { firstName: "", lastName: "" };

/**
 * Loads the user profile from the database (primary) with localStorage as a
 * fast cache so the greeting doesn't flash empty on every page load.
 *
 * On save, writes to the database first, then mirrors to localStorage.
 */
export function useUserProfile() {
  const [profile, setProfile] = useState<UserProfile>(EMPTY);
  const [isLoaded, setIsLoaded] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // 1. Immediately show cached value from localStorage, then fetch from DB.
  useEffect(() => {
    // Fast local cache
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        setProfile(JSON.parse(stored));
      }
    } catch {
      // ignore
    }

    // Authoritative fetch from database
    fetch("/api/profile")
      .then((res) => {
        if (!res.ok) throw new Error("not authed");
        return res.json();
      })
      .then((data: UserProfile) => {
        const next: UserProfile = {
          firstName: data.firstName ?? "",
          lastName: data.lastName ?? "",
        };
        setProfile(next);
        // Mirror to localStorage for fast cache
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
        } catch {
          // ignore
        }
      })
      .catch(() => {
        // If the API call fails (e.g. not logged in), keep whatever
        // localStorage had â€” better than showing nothing.
      })
      .finally(() => {
        setIsLoaded(true);
      });
  }, []);

  // 2. Save to database, then update localStorage cache.
  const saveProfile = useCallback(
    async (updates: Partial<UserProfile>) => {
      const next = { ...profile, ...updates };
      setProfile(next);
      setIsSaving(true);

      try {
        const res = await fetch("/api/profile", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(next),
        });

        if (!res.ok) throw new Error("save failed");

        // Mirror to localStorage
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
        } catch {
          // ignore
        }

        return true;
      } catch {
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [profile]
  );

  return { profile, saveProfile, isLoaded, isSaving };
}
import { createClient } from "@/lib/supabase";
import type { Assignment } from "@/types";

export async function createAssignment(data: {
  teacher_id: string;
  title: string;
  subject?: string;
  grade_level?: number;
  original_content: string;
  source_type: "text" | "upload" | "google_doc" | "google_slides";
  source_url?: string;
  file_url?: string;
}): Promise<Assignment> {
  const supabase = createClient();
  const { data: assignment, error } = await supabase
    .from("assignments")
    .insert(data)
    .select()
    .single();

  if (error) throw error;
  return assignment as Assignment;
}

export async function getAssignmentById(id: string): Promise<Assignment | null> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("assignments")
    .select("*")
    .eq("id", id)
    .single();

  if (error) throw error;
  return data as Assignment | null;
}

export async function getAssignmentsByTeacher(teacherId: string): Promise<Assignment[]> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("assignments")
    .select("*")
    .eq("teacher_id", teacherId)
    .order("created_at", { ascending: false });

  if (error) throw error;
  return (data as Assignment[]) ?? [];
}
import { createClient } from "@/lib/supabase-server";
import type { DifferentiatedAssignment, ELLevel } from "@/types";

export async function createDifferentiatedAssignment(data: {
  assignment_id: string;
  teacher_id: string;
  student_id?: string;
  student_name?: string;
  assignment_title?: string;
  el_level?: ELLevel;
  scaffolds_applied: string[];
  output_html: string;
  original_content?: string;
  word_bank?: { term: string; definition: string }[] | null;
  teacher_instructions?: string | null;
  is_demo?: boolean;
  teacher_notes?: string;
}): Promise<DifferentiatedAssignment> {
  const supabase = createClient();
  const { data: result, error } = await supabase
    .from("differentiated_assignments")
    .insert({
      ...data,
      word_bank: data.word_bank ?? null,
    })
    .select()
    .single();

  if (error) throw error;
  return result as DifferentiatedAssignment;
}

export async function getDifferentiatedAssignmentById(
  id: string
): Promise<DifferentiatedAssignment | null> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("differentiated_assignments")
    .select("*")
    .eq("id", id)
    .single();

  if (error) throw error;
  return data as DifferentiatedAssignment | null;
}

export async function getDifferentiatedAssignmentsByAssignment(
  assignmentId: string
): Promise<DifferentiatedAssignment[]> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("differentiated_assignments")
    .select("*")
    .eq("assignment_id", assignmentId)
    .order("created_at", { ascending: false });

  if (error) throw error;
  return (data as DifferentiatedAssignment[]) ?? [];
}

export async function getDifferentiatedAssignmentsByTeacher(
  teacherId: string
): Promise<DifferentiatedAssignment[]> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("differentiated_assignments")
    .select("*")
    .eq("teacher_id", teacherId)
    .order("created_at", { ascending: false });

  if (error) throw error;
  return (data as DifferentiatedAssignment[]) ?? [];
}

export async function deleteDifferentiatedAssignment(
  id: string,
  teacherId: string
): Promise<void> {
  const supabase = createClient();
  const { error } = await supabase
    .from("differentiated_assignments")
    .delete()
    .eq("id", id)
    .eq("teacher_id", teacherId);
  if (error) throw error;
}

export async function updateDifferentiatedAssignmentNotes(
  id: string,
  teacherId: string,
  notes: string
): Promise<void> {
  const supabase = createClient();
  const { error } = await supabase
    .from("differentiated_assignments")
    .update({ teacher_notes: notes })
    .eq("id", id)
    .eq("teacher_id", teacherId);
  if (error) throw error;
}

export async function logUsageAnalytic(
  teacherId: string,
  actionType: "scaffold_generated" | "student_viewed" | "assignment_created" | "google_doc_created",
  metadata?: Record<string, unknown>
): Promise<void> {
  const supabase = createClient();
  const { error } = await supabase.from("usage_analytics").insert({
    teacher_id: teacherId,
    action_type: actionType,
    metadata,
  });
  if (error) throw error;
}

/**
 * Get today's global scaffold generation count (all users).
 * Gemini RPD resets at midnight Pacific time.
 */
export async function getTodayGlobalUsage(): Promise<number> {
  const supabase = createClient();
  const todayStartPT = getTodayStartPacific();

  const { count, error } = await supabase
    .from("usage_analytics")
    .select("*", { count: "exact", head: true })
    .eq("action_type", "scaffold_generated")
    .gte("created_at", todayStartPT);

  if (error) throw error;
  return count ?? 0;
}

/**
 * Get today's scaffold generation count for a specific user.
 */
export async function getTodayUserUsage(teacherId: string): Promise<number> {
  const supabase = createClient();
  const todayStartPT = getTodayStartPacific();

  const { count, error } = await supabase
    .from("usage_analytics")
    .select("*", { count: "exact", head: true })
    .eq("action_type", "scaffold_generated")
    .eq("teacher_id", teacherId)
    .gte("created_at", todayStartPT);

  if (error) throw error;
  return count ?? 0;
}

/** Midnight Pacific time today as ISO string (for Gemini RPD reset boundary). */
function getTodayStartPacific(): string {
  const now = new Date();
  // Today's date in Pacific time (YYYY-MM-DD, handles DST)
  const ptDate = now.toLocaleDateString("en-CA", {
    timeZone: "America/Los_Angeles",
  });
  // Detect PST vs PDT from timezone abbreviation
  const tzAbbr = new Intl.DateTimeFormat("en-US", {
    timeZone: "America/Los_Angeles",
    timeZoneName: "short",
  })
    .formatToParts(now)
    .find((p) => p.type === "timeZoneName")?.value;
  const offset = tzAbbr === "PDT" ? "-07:00" : "-08:00";
  return `${ptDate}T00:00:00${offset}`;
}
import { createClient } from "@/lib/supabase";
import type { ScaffoldTemplate, ELLevel } from "@/types";

export async function getScaffoldTemplates(): Promise<ScaffoldTemplate[]> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("scaffold_templates")
    .select("*")
    .order("category", { ascending: true });

  if (error) throw error;
  return (data as ScaffoldTemplate[]) ?? [];
}

export async function getScaffoldsByElLevel(
  level: ELLevel
): Promise<ScaffoldTemplate[]> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("scaffold_templates")
    .select("*")
    .contains("el_level_target", [level])
    .order("category", { ascending: true });

  if (error) throw error;
  return (data as ScaffoldTemplate[]) ?? [];
}
import type { Student } from "@/types";

export async function getStudentById(id: string): Promise<Student | null> {
  const res = await fetch(`/api/students/${id}`);
  if (!res.ok) return null;
  return res.json();
}

export async function getAllStudents(): Promise<Student[]> {
  const res = await fetch("/api/students");
  if (!res.ok) throw new Error("Failed to fetch students");
  return res.json();
}

export async function createStudent(
  studentData: Omit<Student, "id" | "created_at" | "updated_at" | "custom_scaffolds">
): Promise<Student> {
  const res = await fetch("/api/students", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(studentData),
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error ?? "Failed to create student");
  }
  return res.json();
}

export async function updateStudent(
  id: string,
  studentData: Partial<Pick<Student, "ssid" | "name" | "grade" | "homeroom" | "el_level" | "overall_level" | "oral_language_level" | "written_language_level" | "primary_language" | "notes">>
): Promise<Student> {
  const res = await fetch(`/api/students/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(studentData),
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error ?? "Failed to update student");
  }
  return res.json();
}

export async function deleteStudent(id: string): Promise<void> {
  const res = await fetch(`/api/students/${id}`, { method: "DELETE" });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error ?? "Failed to delete student");
  }
}

export async function bulkImportStudents(
  students: Array<{
    ssid?: string;
    name: string;
    grade: number;
    homeroom?: string;
    el_level: string;
    overall_level?: number;
    oral_language_level?: number;
    written_language_level?: number;
    primary_language: string;
    notes?: string;
  }>
): Promise<{ imported: number; errors: Array<{ row: number; issues: string[] }> }> {
  const res = await fetch("/api/students/bulk", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ students }),
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error ?? "Failed to import students");
  }
  return res.json();
}
// Database table types matching the Supabase schema

export interface User {
  id: string;
  email: string;
  name: string;
  google_refresh_token?: string;
  preferences: {
    theme: "light" | "dark";
    defaultView: "grid" | "list";
  };
  created_at: string;
  last_login?: string;
}

export interface Student {
  id: string;
  ssid: string;
  name: string;
  grade: number;
  homeroom: string;
  el_level: ELLevel;
  overall_level: number;
  oral_language_level: number;
  written_language_level: number;
  primary_language: string;
  custom_scaffolds: string[];
  notes?: string;
  created_by: string;
  created_at: string;
  updated_at: string;
}

export interface ScaffoldTemplate {
  id: string;
  name: string;
  description: string;
  category: ScaffoldCategory;
  el_level_target: ELLevel[];
  ai_prompt_template: string;
  example_html?: string;
  is_default: boolean;
  created_by?: string;
  created_at: string;
}

export interface Assignment {
  id: string;
  teacher_id: string;
  title: string;
  subject?: string;
  grade_level?: number;
  original_content: string;
  source_type: "text" | "upload" | "google_doc" | "google_slides";
  source_url?: string;
  file_url?: string;
  created_at: string;
}

export interface DifferentiatedAssignment {
  id: string;
  assignment_id: string;
  teacher_id: string;
  student_id?: string;
  student_name?: string;
  assignment_title: string;
  el_level?: ELLevel;
  scaffolds_applied: string[];
  output_html: string;
  original_content?: string;
  word_bank?: { term: string; definition: string }[] | null;
  teacher_instructions?: string | null;
  is_demo: boolean;
  google_doc_id?: string;
  google_doc_url?: string;
  pdf_url?: string;
  teacher_notes?: string;
  created_at: string;
}

/** Structured output from Gemini scaffold generation */
export interface ScaffoldGenerationResult {
  html: string;
  wordBank: { term: string; definition: string }[] | null;
  scaffoldsUsed: string[];
  teacherInstructions: string | null;
  isDemo: boolean;
}

export interface UsageAnalytic {
  id: string;
  teacher_id: string;
  action_type: "scaffold_generated" | "student_viewed" | "assignment_created" | "google_doc_created";
  metadata?: Record<string, unknown>;
  created_at: string;
}

// Enums and union types

export type ELLevel = "Emerging" | "Expanding" | "Bridging";

export const EL_LEVELS: ELLevel[] = ["Emerging", "Expanding", "Bridging"];

export type ScaffoldCategory =
  | "color_coding"
  | "chunking"
  | "sentence_frames"
  | "word_banks"
  | "visual_organizers";

export const SCAFFOLD_CATEGORIES: ScaffoldCategory[] = [
  "color_coding",
  "chunking",
  "sentence_frames",
  "word_banks",
  "visual_organizers",
];

export const GRADES = [5, 6, 7, 8] as const;
export type Grade = (typeof GRADES)[number];

export const SUBJECTS = ["ELA", "ELD", "IST", "Math", "Science", "Social Studies", "Other"] as const;
export type Subject = (typeof SUBJECTS)[number];

// Navigation types

export interface NavItem {
  title: string;
  href: string;
  icon: string;
  description?: string;
}

// Dashboard types

export interface DashboardStats {
  studentsByLevel: Record<ELLevel, number>;
  todayAIUsage: number;
  dailyAILimit: number;
  recentAssignments: Assignment[];
}
